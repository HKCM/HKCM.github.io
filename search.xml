<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>CVE-2021-3156</title>
      <link href="2021/02/18/%E6%BC%8F%E6%B4%9E/CVE-2021-3156/"/>
      <url>2021/02/18/%E6%BC%8F%E6%B4%9E/CVE-2021-3156/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-CVE-2021-3156-sudo"><a href="#描述-CVE-2021-3156-sudo" class="headerlink" title="描述: CVE-2021-3156 sudo"></a>描述: CVE-2021-3156 sudo</h2><a id="more"></a><h3 id="漏洞概述"><a href="#漏洞概述" class="headerlink" title="漏洞概述"></a>漏洞概述</h3><p>Sudo是一个功能强大的工具，其允许普通用户执行root权限命令，大多数基于Unix和Linux的操作系统都包含sudo。</p><p>2021年01月26日，sudo被披露存在一个基于堆的缓冲区溢出漏洞（CVE-2021-3156，该漏洞被命名为“Baron Samedit”），可导致本地权限提升。<br>当在类Unix的操作系统上执行命令时，非root用户可以使用sudo命令来以root用户身份执行命令。由于sudo错误地在参数中转义了反斜杠导致堆缓冲区溢出，从而允许任何本地用户（无论是否在sudoers文件中）获得root权限，无需进行身份验证，且攻击者不需要知道用户密码。</p><p>安全研究人员于2021年1月26日公开披露了此漏洞，并表示该漏洞已经隐藏了近十年。</p><h3 id="受影响版本"><a href="#受影响版本" class="headerlink" title="受影响版本"></a>受影响版本</h3><ul><li>Sudo 1.8.2 - 1.8.31p2</li><li>Sudo 1.9.0 - 1.9.5p1</li></ul><h3 id="不受影响版本"><a href="#不受影响版本" class="headerlink" title="不受影响版本"></a>不受影响版本</h3><p>Sudo =&gt;1.9.5p2</p><ul><li>Ubuntu 20.04 LTS版本用户，建议升级到如下版本：<br>  sudo - 1.8.31-1ubuntu1.2<br>  sudo-ldap - 1.8.31-1ubuntu1.2</li><li>Ubuntu 18.04 LTS版本用户，建议升级到如下版本：<br>  sudo - 1.8.21p2-3ubuntu1.4<br>  sudo-ldap - 1.8.21p2-3ubuntu1.4</li><li>Ubuntu 16.04 LTS版本用户，建议升级到如下版本：<br>  sudo - 1.8.16-0ubuntu1.10<br>  sudo-ldap - 1.8.16-0ubuntu1.10</li></ul><h3 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h3><ul><li><p>Ubuntu</p>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt list sudo</span><br></pre></td></tr></table></figure></li><li><p>CentOS</p>  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list sudo</span><br></pre></td></tr></table></figure></li><li><p>命令检测<br>  用户可以使用非root的账户登录系统，运行<code>sudoedit -s /</code>命令</p><ul><li>若返回以“ sudoedit：”开头的错误，则当前系统可能存在安全风险。</li><li>不受影响的系统将显示以“ usage：”开头的错误响应。</li></ul></li></ul><h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://haxx.in/CVE-2021-3156_nss_poc_ubuntu.tar.gz</span><br><span class="line">tar -zxvf CVE-2021-3156_nss_poc_ubuntu.tar.gz</span><br><span class="line">make</span><br><span class="line"><span class="meta">#</span> make过程中需要gcc</span><br><span class="line"><span class="meta">#</span> apt install gcc -y</span><br><span class="line">./sudo-hax-me-a-sandwich 0</span><br></pre></td></tr></table></figure><p>之后执行<code>whoami</code>以及<code>id</code>命令会显示root用户身份</p><h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>sudo下载: <a href="https://www.sudo.ws/download.html" target="_blank" rel="noopener">https://www.sudo.ws/download.html</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://www.sudo.ws/dist/sudo-1.9.5p2.tar.gz</span><br><span class="line">sha256sum sudo-1.9.5p2.tar.gz</span><br><span class="line">tar -zxvf sudo-1.9.5p2.tar.gz </span><br><span class="line">cd sudo-1.9.5p2/</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 漏洞 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EC2-使卷可用</title>
      <link href="2021/02/09/AWS/EC2/EC2-%E4%BD%BF%E5%8D%B7%E5%8F%AF%E7%94%A8/"/>
      <url>2021/02/09/AWS/EC2/EC2-%E4%BD%BF%E5%8D%B7%E5%8F%AF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-为AWS-EC2挂载新卷后使新卷可用"><a href="#描述-为AWS-EC2挂载新卷后使新卷可用" class="headerlink" title="描述: 为AWS EC2挂载新卷后使新卷可用"></a>描述: 为AWS EC2挂载新卷后使新卷可用</h2><a id="more"></a><ol><li><p>查看当前快设备</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ip-10-100-0-79:~$ lsblk</span><br><span class="line">NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0         7:0    0   55M  1 loop /snap/core18/1754</span><br><span class="line">loop1         7:1    0   18M  1 loop /snap/amazon-ssm-agent/1566</span><br><span class="line">loop3         7:3    0 97.9M  1 loop /snap/core/10583</span><br><span class="line">loop4         7:4    0 71.4M  1 loop /snap/lxd/19300</span><br><span class="line">loop5         7:5    0 98.4M  1 loop /snap/core/10823</span><br><span class="line">loop6         7:6    0 55.5M  1 loop /snap/core18/1988</span><br><span class="line">loop7         7:7    0 32.3M  1 loop /snap/amazon-ssm-agent/2996</span><br><span class="line">loop8         7:8    0 71.4M  1 loop /snap/lxd/19164</span><br><span class="line">nvme0n1     259:0    0   55G  0 disk </span><br><span class="line">└─nvme0n1p1 259:1    0   55G  0 part /</span><br><span class="line">nvme1n1     259:2    0   10G  0 disk</span><br></pre></td></tr></table></figure><p> 可以看到<code>nvme0n1</code>是其中一个存储设备,<code>nvme0n1p1</code>是根目录的分区.<code>nvme1n1</code>是另外一个存储设备并且没有分区.<code>nvme1n1</code>为原始的块储存设备，必须先在这种设备上创建文件系统，然后才能够挂载并使用它们.<br> 也可以使用 <code>file -s</code> 命令获取设备信息，例如其文件系统类型。如果输出仅显示 data（如以下示例输出），则说明设备上没有文件系统，必须创建一个文件系统。</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">    ubuntu@ip-10-100-0-79:~$ sudo file -s /dev/nvme1n1</span><br><span class="line">    /dev/nvme1n1: data</span><br><span class="line">    ``` </span><br><span class="line">2. 创建文件系统</span><br><span class="line">    创建文件系统最好和原本文件系统相同,这里以`ext4`为例.</span><br><span class="line">    ```shell</span><br><span class="line">    ubuntu@ip-10-100-0-79:~$ sudo mkfs -t ext4 /dev/nvme1n1</span><br><span class="line">    mke2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">    Creating filesystem with 2621440 4k blocks and 655360 inodes</span><br><span class="line">    Filesystem UUID: 3c01c114-e29d-4166-a703-3b5db31c7253</span><br><span class="line">    Superblock backups stored on blocks: </span><br><span class="line">        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632</span><br><span class="line"></span><br><span class="line">    Allocating group tables: done                            </span><br><span class="line">    Writing inode tables: done                            </span><br><span class="line">    Creating journal (16384 blocks): done</span><br><span class="line">    Writing superblocks and filesystem accounting information: done </span><br><span class="line"></span><br><span class="line">    # 再次查看</span><br><span class="line">    ubuntu@ip-10-100-0-79:~$ sudo file -s /dev/nvme1n1</span><br><span class="line">    /dev/nvme1n1: Linux rev 1.0 ext4 filesystem data, UUID=3c01c114-e29d-4166-a703-3b5db31c7253 (extents) (64bit) (large files) (huge files)</span><br></pre></td></tr></table></figure><p> 可以看到<code>ext4</code>文件系统已经创建好了.</p><p> 创建<code>xfs</code>文件系统(可选)</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo mkfs -t xfs /dev/nvme1n1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 再次查看</span><br><span class="line">ubuntu@ip-10-100-0-79:~$ sudo file -s /dev/nvme1n1</span><br><span class="line">/dev/nvme1n1: SGI XFS filesystem data (blksz 4096, inosz 512, v2 dirs)</span><br></pre></td></tr></table></figure><p> 如果出现“找不到 mkfs.xfs”错误，请使用以下命令安装 XFS 工具，然后重复上一命令：</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo yum install xfsprogs</span><br><span class="line"><span class="meta">#</span> 或</span><br><span class="line"><span class="meta">$</span> sudo apt install xfsprogs</span><br></pre></td></tr></table></figure></li><li><p>创建挂载目录</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ip-10-100-0-79:~$ sudo mkdir /data</span><br><span class="line">ubuntu@ip-10-100-0-79:~$ sudo mount /dev/nvme1n1 /data</span><br></pre></td></tr></table></figure><p> 查看文件系统类型和挂在情况</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ip-10-100-0-79:~$ df -hT</span><br><span class="line">Filesystem     Type      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/root      ext4       54G  2.0G   52G   4% /</span><br><span class="line">devtmpfs       devtmpfs  465M     0  465M   0% /dev</span><br><span class="line">tmpfs          tmpfs     477M     0  477M   0% /dev/shm</span><br><span class="line">tmpfs          tmpfs      96M  812K   95M   1% /run</span><br><span class="line">tmpfs          tmpfs     5.0M     0  5.0M   0% /run/lock</span><br><span class="line">tmpfs          tmpfs     477M     0  477M   0% /sys/fs/cgroup</span><br><span class="line">/dev/loop1     squashfs   18M   18M     0 100% /snap/amazon-ssm-agent/1566</span><br><span class="line">/dev/loop0     squashfs   55M   55M     0 100% /snap/core18/1754</span><br><span class="line">/dev/loop6     squashfs   56M   56M     0 100% /snap/core18/1988</span><br><span class="line">/dev/loop3     squashfs   98M   98M     0 100% /snap/core/10583</span><br><span class="line">/dev/loop7     squashfs   33M   33M     0 100% /snap/amazon-ssm-agent/2996</span><br><span class="line">/dev/loop8     squashfs   72M   72M     0 100% /snap/lxd/19164</span><br><span class="line">tmpfs          tmpfs      96M     0   96M   0% /run/user/1001</span><br><span class="line">/dev/loop4     squashfs   72M   72M     0 100% /snap/lxd/19300</span><br><span class="line">tmpfs          tmpfs      96M     0   96M   0% /run/user/1000</span><br><span class="line">/dev/loop5     squashfs   99M   99M     0 100% /snap/core/10823</span><br><span class="line">/dev/nvme1n1   xfs        10G  104M  9.9G   2% /data</span><br><span class="line"></span><br><span class="line">ubuntu@ip-10-100-0-79:~$ lsblk</span><br><span class="line">NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0         7:0    0   55M  1 loop /snap/core18/1754</span><br><span class="line">loop1         7:1    0   18M  1 loop /snap/amazon-ssm-agent/1566</span><br><span class="line">loop3         7:3    0 97.9M  1 loop /snap/core/10583</span><br><span class="line">loop4         7:4    0 71.4M  1 loop /snap/lxd/19300</span><br><span class="line">loop5         7:5    0 98.4M  1 loop /snap/core/10823</span><br><span class="line">loop6         7:6    0 55.5M  1 loop /snap/core18/1988</span><br><span class="line">loop7         7:7    0 32.3M  1 loop /snap/amazon-ssm-agent/2996</span><br><span class="line">loop8         7:8    0 71.4M  1 loop /snap/lxd/19164</span><br><span class="line">nvme0n1     259:0    0   55G  0 disk </span><br><span class="line">└─nvme0n1p1 259:1    0   55G  0 part /</span><br><span class="line">nvme1n1     259:2    0   10G  0 disk /data</span><br></pre></td></tr></table></figure></li><li><p>重启后自动挂载附加的卷</p><h4 id="创建-etc-fstab-文件的备份"><a href="#创建-etc-fstab-文件的备份" class="headerlink" title="创建 /etc/fstab 文件的备份"></a>创建 <code>/etc/fstab</code> 文件的备份</h4> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo cp /etc/fstab /etc/fstab.orig</span><br></pre></td></tr></table></figure><h4 id="使用-blkid-命令查找设备的-UUID"><a href="#使用-blkid-命令查找设备的-UUID" class="headerlink" title="使用 blkid 命令查找设备的 UUID"></a>使用 blkid 命令查找设备的 UUID</h4> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ip-10-100-0-79:~$ sudo blkid</span><br><span class="line">/dev/nvme0n1p1: LABEL="cloudimg-rootfs" UUID="fdd49fba-0340-4ed1-b0fc-8da187913fec" TYPE="ext4" PARTUUID="093eb684-01"</span><br><span class="line">/dev/loop0: TYPE="squashfs"</span><br><span class="line">/dev/loop1: TYPE="squashfs"</span><br><span class="line">/dev/loop3: TYPE="squashfs"</span><br><span class="line">/dev/loop4: TYPE="squashfs"</span><br><span class="line">/dev/loop5: TYPE="squashfs"</span><br><span class="line">/dev/loop6: TYPE="squashfs"</span><br><span class="line">/dev/loop7: TYPE="squashfs"</span><br><span class="line">/dev/loop8: TYPE="squashfs"</span><br><span class="line">/dev/nvme1n1: UUID="f55bd613-b470-45b5-8cbb-7713ac77ddd5" TYPE="xfs"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 或者使用lsblk, 查看lsblk --help</span><br><span class="line">ubuntu@ip-10-100-0-79:~$ sudo lsblk -o +UUID</span><br><span class="line">NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT                  UUID</span><br><span class="line">loop0         7:0    0   55M  1 loop /snap/core18/1754           </span><br><span class="line">loop1         7:1    0   18M  1 loop /snap/amazon-ssm-agent/1566 </span><br><span class="line">loop3         7:3    0 97.9M  1 loop /snap/core/10583            </span><br><span class="line">loop4         7:4    0 71.4M  1 loop /snap/lxd/19300             </span><br><span class="line">loop5         7:5    0 98.4M  1 loop /snap/core/10823            </span><br><span class="line">loop6         7:6    0 55.5M  1 loop /snap/core18/1988           </span><br><span class="line">loop7         7:7    0 32.3M  1 loop /snap/amazon-ssm-agent/2996 </span><br><span class="line">loop8         7:8    0 71.4M  1 loop /snap/lxd/19164             </span><br><span class="line">nvme0n1     259:0    0   55G  0 disk                             </span><br><span class="line">└─nvme0n1p1 259:1    0   55G  0 part /                           fdd49fba-0340-4ed1-b0fc-8da187913fec</span><br><span class="line">nvme1n1     259:2    0   10G  0 disk /data                       f55bd613-b470-45b5-8cbb-7713ac77ddd5</span><br></pre></td></tr></table></figure><h4 id="编辑-etc-fstab文件"><a href="#编辑-etc-fstab文件" class="headerlink" title="编辑/etc/fstab文件"></a>编辑/etc/fstab文件</h4><p> 在<code>etc/fstab</code>文件中添加条目</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UUID=aebf131c-6957-451e-8d34-ec978d9581ae  /data  xfs  defaults,nofail  0  2</span><br></pre></td></tr></table></figure><h4 id="检测"><a href="#检测" class="headerlink" title="检测"></a>检测</h4><p> 卸载设备并重新挂载测试有效性</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ip-10-100-0-79:~$ sudo umount /data</span><br><span class="line">ubuntu@ip-10-100-0-79:~$ sudo mount -a</span><br></pre></td></tr></table></figure><p> 如果出现错误,则还原<code>/etc/fstab</code></p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo mv /etc/fstab.orig /etc/fstab</span><br></pre></td></tr></table></figure></li></ol><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> EC2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS EC2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EC2-扩展EBS</title>
      <link href="2021/02/09/AWS/EC2/EC2-%E6%89%A9%E5%B1%95EBS/"/>
      <url>2021/02/09/AWS/EC2/EC2-%E6%89%A9%E5%B1%95EBS/</url>
      
        <content type="html"><![CDATA[<h2 id="描述"><a href="#描述" class="headerlink" title="描述:"></a>描述:</h2><a id="more"></a><ol><li><p>验证每个卷的文件系统，使用 df -hT 命令</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ip-10-100-0-79:~$ df -hT</span><br><span class="line">Filesystem     Type      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/root      ext4       49G  1.9G   47G   4% /</span><br><span class="line">devtmpfs       devtmpfs  465M     0  465M   0% /dev</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p> 可以看到,目前/root大小为49G,type为ext4</p></li><li><p>使用 lsblk 命令显示有关附加到实例的块储存设备的信息</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ip-10-100-0-79:~$ lsblk</span><br><span class="line">NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0         7:0    0   55M  1 loop /snap/core18/1754</span><br><span class="line">loop1         7:1    0   18M  1 loop /snap/amazon-ssm-agent/1566</span><br><span class="line">loop2         7:2    0 93.9M  1 loop /snap/core/9066</span><br><span class="line">loop3         7:3    0 97.9M  1 loop /snap/core/10583</span><br><span class="line">loop4         7:4    0 71.4M  1 loop /snap/lxd/19300</span><br><span class="line">loop6         7:6    0 55.5M  1 loop /snap/core18/1988</span><br><span class="line">loop7         7:7    0 32.3M  1 loop /snap/amazon-ssm-agent/2996</span><br><span class="line">loop8         7:8    0 71.4M  1 loop /snap/lxd/19164</span><br><span class="line">nvme0n1     259:0    0   55G  0 disk </span><br><span class="line">└─nvme0n1p1 259:1    0   50G  0 part /</span><br></pre></td></tr></table></figure><p> 可以看到根卷 /dev/nvme0n1 具有一个分区 /dev/nvme0n1p1。当根卷的大小反映新大小 55 GB 时，分区的大小会反映原始大小 50 GB 并且必须先进行扩展，然后才能扩展文件系统。</p></li><li><p>在根卷上扩展分区，使用 growpart 命令</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ip-10-100-0-79:~$ sudo growpart /dev/nvme0n1 1</span><br><span class="line">CHANGED: partition=1 start=2048 old: size=104855519 end=104857567 new: size=115341279 end=115343327</span><br><span class="line">``` </span><br><span class="line">/dev/nvme0n1表示磁盘，后边的空格数字`1`表示第一个分区.再次查看块储存设备的信息</span><br><span class="line">```shell</span><br><span class="line">ubuntu@ip-10-100-0-79:~$ lsblk</span><br><span class="line">NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0         7:0    0   55M  1 loop /snap/core18/1754</span><br><span class="line">loop1         7:1    0   18M  1 loop /snap/amazon-ssm-agent/1566</span><br><span class="line">loop2         7:2    0 93.9M  1 loop /snap/core/9066</span><br><span class="line">loop3         7:3    0 97.9M  1 loop /snap/core/10583</span><br><span class="line">loop4         7:4    0 71.4M  1 loop /snap/lxd/19300</span><br><span class="line">loop6         7:6    0 55.5M  1 loop /snap/core18/1988</span><br><span class="line">loop7         7:7    0 32.3M  1 loop /snap/amazon-ssm-agent/2996</span><br><span class="line">loop8         7:8    0 71.4M  1 loop /snap/lxd/19164</span><br><span class="line">nvme0n1     259:0    0   55G  0 disk </span><br><span class="line">└─nvme0n1p1 259:1    0   55G  0 part /</span><br></pre></td></tr></table></figure><p> 可以看到根卷大小为55G,分区大小也是55G.</p></li><li><p>扩展文件系统(ext4)<br> 虽然分区已经扩展,但实际文件系统还没有扩展</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ip-10-100-0-79:~$ ubuntu@ip-10-100-0-79:~$ df -hT</span><br><span class="line">Filesystem     Type      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/root      ext4       49G  1.9G   47G   4% /</span><br><span class="line">devtmpfs       devtmpfs  465M     0  465M   0% /dev</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p> 通过<code>df</code>可以看到文件系统依然是49G,下面扩展文件系统,可以看到上方文件系统Type是<code>ext4</code>,所以使用<code>resize2fs</code></p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@ip-10-100-0-79:~$ sudo resize2fs /dev/nvme0n1p1</span><br><span class="line">resize2fs 1.45.5 (07-Jan-2020)</span><br><span class="line">Filesystem at /dev/nvme0n1p1 is mounted on /; on-line resizing required</span><br><span class="line">old_desc_blocks = 7, new_desc_blocks = 7</span><br><span class="line">The filesystem on /dev/nvme0n1p1 is now 14417659 (4k) blocks long.</span><br></pre></td></tr></table></figure><p> 然后就完成了.</p></li><li><p>扩展文件系统(XFS)<br> 如果文件系统是XFS格式,则使用 <code>xfs_growfs</code> 命令扩展每个卷上的文件系统<br> 如果尚未安装 XFS 工具，可以按如下方式安装。</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo yum install xfsprogs</span><br><span class="line"><span class="meta">#</span> 或者</span><br><span class="line"><span class="meta">$</span> sudo apt install xfsprogs</span><br></pre></td></tr></table></figure><p> 扩展命令,<code>/</code>是要扩展的挂载点</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo xfs_growfs -d /</span><br></pre></td></tr></table></figure><p> 然后就完成了</p></li></ol><h3 id="官方链接"><a href="#官方链接" class="headerlink" title="官方链接"></a>官方链接</h3><p><a href="https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/recognize-expanded-volume-linux.html#extend-linux-volume-partition" target="_blank" rel="noopener">调整卷大小后扩展 Linux 文件系统</a></p><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> EC2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS EC2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell-find</title>
      <link href="2021/02/04/Bash/shell-find/"/>
      <url>2021/02/04/Bash/shell-find/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-find命令"><a href="#描述-find命令" class="headerlink" title="描述: find命令"></a>描述: find命令</h2><a id="more"></a><h3 id="按文件名查找"><a href="#按文件名查找" class="headerlink" title="按文件名查找"></a>按文件名查找</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> find . -name "*.p y" # 在当前目录查找</span><br><span class="line"><span class="meta">$</span> find /etc /tmp /root -iname "*.sh" # 在指定目录查找 -iname 忽略大小写</span><br></pre></td></tr></table></figure><h3 id="按文件类型查找"><a href="#按文件类型查找" class="headerlink" title="按文件类型查找"></a>按文件类型查找</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> find /tmp -type f</span><br><span class="line"><span class="meta">#</span> f 普通文件 </span><br><span class="line"><span class="meta">#</span> d 目录 </span><br><span class="line"><span class="meta">#</span> l 符号链接文件 </span><br><span class="line"><span class="meta">#</span> c 字符设备文件 </span><br><span class="line"><span class="meta">#</span> p 管道文件 </span><br><span class="line"><span class="meta">#</span> b 块设备文件</span><br><span class="line"><span class="meta">#</span> s socket文件</span><br></pre></td></tr></table></figure><h3 id="按文件时间查找"><a href="#按文件时间查找" class="headerlink" title="按文件时间查找"></a>按文件时间查找</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> -atime    最近一次访问时间      单位：天</span><br><span class="line"><span class="meta">#</span> -mtime 最近一次内容修改时间  单位：天</span><br><span class="line"><span class="meta">#</span> -ctime   最近一次属性修改时间  单位：天</span><br><span class="line"><span class="meta">#</span> -amin    最近一次访问时间      单位：分钟</span><br><span class="line"><span class="meta">#</span> -mmin  最近一次内容修改时间  单位：分钟</span><br><span class="line"><span class="meta">#</span> -cmin    最近一次属性修改时间  单位：分钟</span><br><span class="line"><span class="meta">#</span> -newer file1 ! file2 查找更改时间比文件file1新但比文件file2旧的文件 </span><br><span class="line"><span class="meta">$</span> find /tmp -mtime +5 # 查找修改时间大于5天</span><br><span class="line"><span class="meta">$</span> find /tmp -mtime -5 # 查找在五天内改动过的文件</span><br><span class="line"><span class="meta">$</span> find . -newer Feb1 ! -newer Feb5 # 比二月1日新 比二月5日旧</span><br></pre></td></tr></table></figure><h3 id="按文件大小查找"><a href="#按文件大小查找" class="headerlink" title="按文件大小查找"></a>按文件大小查找</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> find /tmp -size  2M  #查找在/tmp 目录下等于2M的文件</span><br><span class="line"><span class="meta">$</span> find /tmp -size +2M  #查找在/tmp 目录下大于2M的文件</span><br><span class="line"><span class="meta">$</span> find /tmp -size -2M  #查找在/tmp 目录下小于2M的文件</span><br></pre></td></tr></table></figure><h3 id="按条件"><a href="#按条件" class="headerlink" title="按条件"></a>按条件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> -a 且</span><br><span class="line"><span class="meta">$</span> find . -name "*.sh" -a -user ubuntu # 查找以.sh结尾并且属主为ubuntu的文件</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> -o 或</span><br><span class="line"><span class="meta">$</span> find . -name "*.sh" -o -user ubuntu # 查找以.sh结尾或者属主为ubuntu的文件</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> -not 非</span><br><span class="line"><span class="meta">$</span> find . -name "*.sh" -not -user ubuntu # 查找以.sh结尾并且属主不是ubuntu的文件</span><br></pre></td></tr></table></figure><h3 id="按文件权限查找"><a href="#按文件权限查找" class="headerlink" title="按文件权限查找"></a>按文件权限查找</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> find /tmp -perm 755 </span><br><span class="line"><span class="meta">$</span> find /tmp -perm +222 # 匹配属主,属组和其他其中个一项具有写权限</span><br><span class="line"><span class="meta">$</span> find /tmp -perm -222 # 匹配属主,属组和其他全部具有写权限</span><br></pre></td></tr></table></figure><h3 id="按属主属组查找"><a href="#按属主属组查找" class="headerlink" title="按属主属组查找"></a>按属主属组查找</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> find . -user ubuntu # 查找属于ubuntu用户的文件</span><br><span class="line"><span class="meta">$</span> find . -group ubuntu # 查找属于ubuntu组的文件</span><br><span class="line"><span class="meta">$</span> find . -uid UserID # 查找属主为指定的UID号的文件</span><br><span class="line"><span class="meta">$</span> find . -gid GroupID # 查找属组为指定的GID号的文件</span><br><span class="line"><span class="meta">$</span> find . -nouser # 查找没有属主的文件</span><br><span class="line"><span class="meta">$</span> find . -nogroup # 查找没有属组的文件</span><br></pre></td></tr></table></figure><h3 id="按动作分类"><a href="#按动作分类" class="headerlink" title="按动作分类"></a>按动作分类</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> -print find默动作</span><br><span class="line"><span class="meta">#</span> -ok [commend]  查找后执行命令的时候询问用户是否要执行</span><br><span class="line"><span class="meta">#</span> -exec [commend] 查找后执行命令的时候不询问用户，直接执行</span><br><span class="line"><span class="meta">$</span> find . -name "*.sh" -ok rm &#123;&#125; \; # 会询问每一个找到的文件</span><br><span class="line"><span class="meta">$</span> find . -name "*.sh" -exec rm &#123;&#125; \; # 直接执行不询问</span><br><span class="line"><span class="meta">$</span> find . -name "*.html" -ok cp &#123;&#125; ~/test/ \; # 复制前询问</span><br><span class="line"><span class="meta">$</span> find . -name "*.html" -exec ls -hl &#123;&#125; \;</span><br></pre></td></tr></table></figure><p><strong>魔术字符串{}是-ok和-exec命令的一个特殊类型的参数，它将被当前文件的完整路径取代</strong></p><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> shell命令 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell-用户,组,权限相关命令</title>
      <link href="2021/02/02/Bash/shell-%E7%94%A8%E6%88%B7,%E7%BB%84,%E6%9D%83%E9%99%90%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/"/>
      <url>2021/02/02/Bash/shell-%E7%94%A8%E6%88%B7,%E7%BB%84,%E6%9D%83%E9%99%90%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-shell-用户-组-权限相关命令"><a href="#描述-shell-用户-组-权限相关命令" class="headerlink" title="描述: shell-用户,组,权限相关命令"></a>描述: shell-用户,组,权限相关命令</h2><a id="more"></a><!-- TOC --><ul><li><a href="#描述-shell-用户组权限相关命令">描述: shell-用户,组,权限相关命令</a><ul><li><a href="#相关文件">相关文件</a><ul><li><a href="#etcpasswd文件">/etc/passwd文件</a></li><li><a href="#etcgroup-文件">/etc/group 文件</a></li><li><a href="#etcshadow文件">/etc/shadow文件</a></li></ul></li><li><a href="#用户和组">用户和组</a><ul><li><a href="#创建和删除用户">创建和删除用户</a></li><li><a href="#创建和删除组">创建和删除组</a></li><li><a href="#用户和组-1">用户和组</a></li><li><a href="#用户密码">用户密码</a></li><li><a href="#shell脚本批量将用户添加到组">shell脚本批量将用户添加到组</a></li><li><a href="#用户资料chsh-chfn-chage">用户资料chsh, chfn, chage</a></li></ul></li><li><a href="#文件权限">文件权限</a><ul><li><a href="#可读可写可执行的意义">可读可写可执行的意义</a><ul><li><a href="#umask">umask</a></li><li><a href="#对于文件">对于文件：</a></li><li><a href="#对于目录">对于目录：</a></li></ul></li><li><a href="#chgrp">chgrp</a></li><li><a href="#chown">chown</a></li><li><a href="#chmod">chmod</a></li><li><a href="#组文件共享">组文件共享</a></li></ul></li><li><a href="#补充">补充</a></li><li><a href="#结语">结语</a></li></ul></li></ul><!-- /TOC --><h3 id="相关文件"><a href="#相关文件" class="headerlink" title="相关文件"></a>相关文件</h3><h4 id="etc-passwd文件"><a href="#etc-passwd文件" class="headerlink" title="/etc/passwd文件"></a>/etc/passwd文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:/root:/bin/bash</span><br></pre></td></tr></table></figure><ul><li>登录用户名</li><li>用户密码</li><li>用户账户的UID(数字形式)</li><li>用户账户的组ID(GID)(数字形式) </li><li>用户账户的文本描述(称为备注字段) </li><li>用户HOME目录的位置</li><li>用户的默认shell</li></ul><h4 id="etc-group-文件"><a href="#etc-group-文件" class="headerlink" title="/etc/group 文件"></a>/etc/group 文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:root</span><br></pre></td></tr></table></figure><ul><li><p>组名</p></li><li><p>组密码</p></li><li><p>GID</p></li><li><p>属于该组的用户列表<br>组密码允许非组内成员通过它临时成为该组成员。这个功能并不很普遍，但确实存在.千万不能通过直接修改/etc/group文件来添加用户到一个组，要用usermod命令.<br>当一个用户在/etc/passwd文件中指定某个组作为默认组时， 用户账户不会作为该组成员再出现在/etc/group文件中</p><h4 id="etc-shadow文件"><a href="#etc-shadow文件" class="headerlink" title="/etc/shadow文件"></a>/etc/shadow文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rich:$1$.FfcK0ns$f1UgiyHQ25wrB/hykCn020:11627:0:99999:7:::</span><br></pre></td></tr></table></figure></li><li><p>与/etc/passwd文件中的登录名字段对应的登录名</p></li><li><p>加密后的密码</p></li><li><p>自上次修改密码后过去的天数密码(自1970年1月1日开始计算) </p></li><li><p>多少天后才能更改密码</p></li><li><p>多少天后必须更改密码</p></li><li><p>密码过期前提前多少天提醒用户更改密码</p></li><li><p>密码过期后多少天禁用用户账户</p></li><li><p>用户账户被禁用的日期(用自1970年1月1日到当天的天数表示) </p></li><li><p>预留字段给将来使用</p></li></ul><h3 id="用户和组"><a href="#用户和组" class="headerlink" title="用户和组"></a>用户和组</h3><h4 id="创建和删除用户"><a href="#创建和删除用户" class="headerlink" title="创建和删除用户"></a>创建和删除用户</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 添加用户默认会创建用户家目录和用户组, 用户家目录模版源于/etc/skel,所以可以放入一些特定资料</span><br><span class="line"><span class="meta">$</span> adduser elephant </span><br><span class="line">Adding new group 'elephant' (1000) ...</span><br><span class="line">Adding new user 'elephant' (1000) with group 'elephant' ...</span><br><span class="line">Creating home directory '/home/elephant' ...</span><br><span class="line">Copying files from '/etc/skel' ...</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 查看用户信息</span><br><span class="line"><span class="meta">$</span> cat /etc/passwd</span><br><span class="line"><span class="meta">$</span> id UserName</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 删除用户</span><br><span class="line"><span class="meta">$</span> deluser elephant</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 连同家目录一起删除,注意检查是否有重要文件,用户删除后,用户曾经的文件会变原属主和属组的ID</span><br><span class="line"><span class="meta">$</span> deluser --remove-home elephant</span><br><span class="line"><span class="meta">#</span> 查找没有属主的文件</span><br><span class="line"><span class="meta">$</span> find . -nouser </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 备份并删除所有属主为elephant的文件,备份文件为username.tar.gz 或 username.tar.bz2</span><br><span class="line"><span class="meta">$</span> deluser --remove-all-files --backup --backup-to /backup elephant</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 解压bz2</span><br><span class="line"><span class="meta">$</span> tar -xvjf username.tar.bz2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 解压gzip</span><br><span class="line"><span class="meta">$</span> tar -xvzf username.tar.gz</span><br></pre></td></tr></table></figure><h4 id="创建和删除组"><a href="#创建和删除组" class="headerlink" title="创建和删除组"></a>创建和删除组</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 添加组</span><br><span class="line"><span class="meta">$</span> addgroup share</span><br><span class="line"><span class="meta">#</span> 指定组ID</span><br><span class="line"><span class="meta">$</span> addgroup -g 2000 share</span><br><span class="line"><span class="meta">#</span> 删除组</span><br><span class="line"><span class="meta">$</span> delgroup share</span><br><span class="line"><span class="meta">#</span> 查看组</span><br><span class="line"><span class="meta">$</span> cat /etc/group</span><br><span class="line"><span class="meta">$</span> getent group GroupName</span><br></pre></td></tr></table></figure><h4 id="用户和组-1"><a href="#用户和组-1" class="headerlink" title="用户和组"></a>用户和组</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 修改组内用户列表,意味着如果原来组中有用户会被覆盖,Group1中只留下User1和User2</span><br><span class="line"><span class="meta">$</span> gpasswd -M User1,User2 Group1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 将用户添加到组</span><br><span class="line"><span class="meta">$</span> adduser UserName GroupName</span><br><span class="line"><span class="meta">$</span> gpasswd -a UserName GroupName</span><br><span class="line"><span class="meta">$</span> usermod -aG GroupName UserName # -a 添加到目标组时不移除其他组 -g会修改用户的主要组,慎用</span><br><span class="line"><span class="meta">$</span> usermod -aG GroupName1,GroupName2,GroupName3 UserName # 将单个用户添加到多个组</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 将用户移除组</span><br><span class="line"><span class="meta">$</span> deluser UserName GroupName</span><br><span class="line"><span class="meta">$</span> gpasswd -d UserName GroupName</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 锁定用户</span><br><span class="line"><span class="meta">$</span> usermod -L elephant</span><br><span class="line"><span class="meta">#</span> 解锁用户</span><br><span class="line"><span class="meta">$</span> usermod -U elephant</span><br></pre></td></tr></table></figure><h4 id="用户密码"><a href="#用户密码" class="headerlink" title="用户密码"></a>用户密码</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> passwd elephant</span><br><span class="line"><span class="meta">#</span> 强制用户下次登录时修改密码</span><br><span class="line"><span class="meta">$</span> passwd -e elephant</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> chpasswd可以批量修改用户密码</span><br><span class="line"><span class="meta">$</span> chpasswd &lt; users.txt</span><br><span class="line"><span class="meta">$</span> cat users.txt</span><br><span class="line">user1:passwd1</span><br><span class="line">user2:passwd2</span><br></pre></td></tr></table></figure><h4 id="shell脚本批量将用户添加到组"><a href="#shell脚本批量将用户添加到组" class="headerlink" title="shell脚本批量将用户添加到组"></a>shell脚本批量将用户添加到组</h4><ol><li><p>将批量用户添加到单个组</p><ul><li><p>创建用户列表文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> cat userlists.txt</span><br><span class="line">user1</span><br><span class="line">user2</span><br><span class="line">user3</span><br></pre></td></tr></table></figure></li><li><p>创建脚本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line">for user in $(cat userlists.txt)</span><br><span class="line">do</span><br><span class="line">  usermod -a -G mygroup $user</span><br><span class="line">done</span><br></pre></td></tr></table></figure></li></ul></li><li><p>将批量用户添加到多个组</p><ul><li><p>创建用户列表文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> cat userlists.txt</span><br><span class="line">user1</span><br><span class="line">user2</span><br><span class="line">user3</span><br></pre></td></tr></table></figure></li><li><p>创建组列表文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> cat grouplists.txt</span><br><span class="line">group1</span><br><span class="line">group2</span><br><span class="line">group3</span><br></pre></td></tr></table></figure></li><li><p>创建脚本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/sh</span><br><span class="line">for user in $(cat userlists.txt)</span><br><span class="line">do</span><br><span class="line">  for group in $(cat grouplists.txt)</span><br><span class="line">  do</span><br><span class="line">    usermod -a -G $group $user</span><br><span class="line">  done</span><br><span class="line">done</span><br></pre></td></tr></table></figure></li></ul></li></ol><h4 id="用户资料chsh-chfn-chage"><a href="#用户资料chsh-chfn-chage" class="headerlink" title="用户资料chsh, chfn, chage"></a>用户资料chsh, chfn, chage</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 修改用户shell,必须用shell的全路径名作为参数，不能只用shell名</span><br><span class="line"><span class="meta">$</span> chsh -s /bin/bash elephant</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 修改用户的备注信息</span><br><span class="line"><span class="meta">$</span> chfn userName</span><br><span class="line">Changing the user information for userName</span><br><span class="line">Enter the new value, or press ENTER for the default</span><br><span class="line">        Full Name [Hello W]: </span><br><span class="line">        Room Number [12]: </span><br><span class="line">        Work Phone [123]: </span><br><span class="line">        Home Phone [123]: </span><br><span class="line">        Other [dddddd]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 设置账户被禁用的日期</span><br><span class="line"><span class="meta">$</span> chage -E 2021-02-05 -I 0 elephant</span><br><span class="line"><span class="meta">#</span> -d 设置上次修改密码到现在的天数</span><br><span class="line"><span class="meta">#</span> -E 设置密码过期的日期 YYYY-MM-DD</span><br><span class="line"><span class="meta">#</span> -I 设置密码过期到锁定账户的天数</span><br><span class="line"><span class="meta">#</span> -m 设置修改密码之间最少要多少天</span><br><span class="line"><span class="meta">#</span> -W 设置密码过期前多久开始出现提醒信息</span><br></pre></td></tr></table></figure><h3 id="文件权限"><a href="#文件权限" class="headerlink" title="文件权限"></a>文件权限</h3><h4 id="可读可写可执行的意义"><a href="#可读可写可执行的意义" class="headerlink" title="可读可写可执行的意义"></a>可读可写可执行的意义</h4><p>在Linux中，文件有三种权限－－可读，可写，可执行。目录也有三种权限－－可读，可写，可执行。但是实际上他们有着不同的意义。</p><h5 id="umask"><a href="#umask" class="headerlink" title="umask"></a>umask</h5><p>对文件来说，全权限的值是666(所有用户都有读和写的权限);而对目录来说，则是777(所有用户都有读、写、执行权限)。u这些默认权限是通过“umask”权限掩码控制的。一般默认的umask值为022，其最终效果就是新创建的目录权限为755，文件权限为644。所以只要修改了用户的umask值，就可以控制默认权限。</p><h5 id="对于文件："><a href="#对于文件：" class="headerlink" title="对于文件："></a>对于文件：</h5><ul><li>可读：表示可以读取文件里的数据；</li><li>可写：表示可以改变和删除文件； </li><li>可执行：表示可以执行该程序。</li></ul><h5 id="对于目录："><a href="#对于目录：" class="headerlink" title="对于目录："></a>对于目录：</h5><p>可读：表示，你可以列出目录中有什么文件；<br>示例: 用户A属于share组 shared文件夹也属于share组</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 如果对于属组来说只有读权限,只能看不能改,无法知道详情,大小,权限,创建时间</span><br><span class="line"><span class="meta">$</span> sudo chmod 744 shared/</span><br><span class="line"><span class="meta">$</span> ls -al /shared/</span><br><span class="line">ls: cannot access '/shared/.': Permission denied</span><br><span class="line">ls: cannot access '/shared/..': Permission denied</span><br><span class="line">ls: cannot access '/shared/123': Permission denied</span><br><span class="line">total 0</span><br><span class="line">d????????? ? ? ? ?            ? .</span><br><span class="line">d????????? ? ? ? ?            ? ..</span><br><span class="line">-????????? ? ? ? ?            ? 123</span><br></pre></td></tr></table></figure><p>可写：表示可以在目录中删除和增加文件；</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo chmod 722 /shared/</span><br><span class="line"><span class="meta">$</span> ls -al /shared/</span><br><span class="line">ls: cannot open directory '/shared/': Permission denied</span><br><span class="line"><span class="meta">#</span> 仅有写权限,就算已知文件夹中有文件也无法删除</span><br></pre></td></tr></table></figure><p>可执行：表示可以列出目录下文件的信息。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo chmod 710 /shared/</span><br><span class="line"><span class="meta">$</span> ./shared/test.sh</span><br><span class="line">hello</span><br><span class="line"><span class="meta">#</span> 仅有执行权限,可以执行文件夹内允许share组执行的文件</span><br></pre></td></tr></table></figure><h4 id="chgrp"><a href="#chgrp" class="headerlink" title="chgrp"></a>chgrp</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> chgrp groupName fileName</span><br></pre></td></tr></table></figure><h4 id="chown"><a href="#chown" class="headerlink" title="chown"></a>chown</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> chown ubuntu:test file.txt</span><br><span class="line"><span class="meta">#</span> 同时改变属主属组</span><br><span class="line"><span class="meta">$</span> chown test. file.txt</span><br><span class="line"><span class="meta">#</span> 仅改变属组</span><br><span class="line"><span class="meta">$</span> chown .test file.txt</span><br></pre></td></tr></table></figure><h4 id="chmod"><a href="#chmod" class="headerlink" title="chmod"></a>chmod</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> chmod +x file</span><br><span class="line"><span class="meta">$</span> chmod 755 file # 常见权限,可读可执行不可更改</span><br><span class="line"><span class="meta">$</span> chmod 755 folder # 常见权限,可读可执行不可添加和删除文件夹内文件</span><br></pre></td></tr></table></figure><h4 id="组文件共享"><a href="#组文件共享" class="headerlink" title="组文件共享"></a>组文件共享</h4><ol><li><p>创建共享组shared</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> addgroup shared</span><br></pre></td></tr></table></figure></li><li><p>创建共享目录,并修改其属组</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> mkdir /shared</span><br><span class="line"><span class="meta">$</span> chgrp shared /shared/</span><br></pre></td></tr></table></figure></li><li><p>将SGID置位</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> chmod g+s /shared/</span><br></pre></td></tr></table></figure></li><li><p>将所需用户都添加到shared组</p></li></ol><h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><ul><li>useradd单纯创建用户,不会创建用户目录，不会自动选择shell版本默认/bin/sh，没有设置密码，需要使用passwd修改密码。</li><li>userdel只能删除用户，并不会删除相关的目录文件。</li><li>adduser在使用该命令创建用户会在/home下自动创建用户目录，系统shell版本，会在创建时会提示输入密码，更加友好。</li><li>deluser -r 可以删除用户及相关目录。<br>推荐使用 <code>adduser</code> 和 <code>deluser</code></li></ul><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> shell命令 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AWS RDS概述</title>
      <link href="2021/01/19/AWS/RDS/RDS%E6%A6%82%E8%BF%B0/"/>
      <url>2021/01/19/AWS/RDS/RDS%E6%A6%82%E8%BF%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-AWS-RDS概述"><a href="#描述-AWS-RDS概述" class="headerlink" title="描述: AWS RDS概述"></a>描述: AWS RDS概述</h2><a id="more"></a><h3 id="什么是AWS-RDS"><a href="#什么是AWS-RDS" class="headerlink" title="什么是AWS RDS"></a>什么是AWS RDS</h3><p>Amazon Relational Database Service (Amazon RDS) 是一项Web服务，让用户能够在 AWS 云中更轻松地设置、操作和扩展关系数据库。它可以经济有效的为用户提供一个容量可调的行业标准的关系数据库，并承担常见的数据库管理任务。这是一个托管型的AWS服务, Amazon RDS 当前支持 MySQL、MariaDB、PostgreSQL、Oracle 和 Microsoft SQL Server 数据库引擎.</p><h3 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h3><ul><li>可以管理备份、软件修补、自动故障检测和恢复</li><li>可以在需要时执行自动备份，也可以手动创建自己的备份快照</li><li>可以使用熟悉的数据库产品：MySQL、MariaDB、PostgreSQL、Oracle 和 Microsoft SQL Server</li><li>可以通过主实例和在发生问题时可向其执行故障转移操作的同步辅助实例实现高可用性</li><li>可以将数据库置于虚拟私有云中，这样有助于保护数据库</li></ul><h3 id="定价"><a href="#定价" class="headerlink" title="定价"></a>定价</h3><p><a href="https://aws.amazon.com/cn/rds/pricing/" target="_blank" rel="noopener">https://aws.amazon.com/cn/rds/pricing/</a></p><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> RDS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS RDS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bash基础入门（15）综合</title>
      <link href="2021/01/19/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%8815%EF%BC%89%E7%BB%BC%E5%90%88/"/>
      <url>2021/01/19/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%8815%EF%BC%89%E7%BB%BC%E5%90%88/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-基础代码的基础示例"><a href="#描述-基础代码的基础示例" class="headerlink" title="描述: 基础代码的基础示例"></a>描述: 基础代码的基础示例</h2><a id="more"></a><h3 id="ls命令"><a href="#ls命令" class="headerlink" title="ls命令"></a>ls命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ls *.txt</span><br><span class="line">ls ?.txt</span><br><span class="line">ls -i ./</span><br><span class="line">ls -l f[a-i]ll</span><br><span class="line">ls -l f[!a]ll</span><br><span class="line">ls -l --time=atime test_one</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 文件按从大到小显示</span><br><span class="line">ls -lSh ./</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 文件按最近修改时间排序</span><br><span class="line"><span class="meta">$</span> ls -lth ./</span><br></pre></td></tr></table></figure><h3 id="cp"><a href="#cp" class="headerlink" title="cp"></a>cp</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> -i 复制前如果存在同名文件则询问</span><br><span class="line">cp -i source destination</span><br><span class="line">cp -R -i source/ destination</span><br></pre></td></tr></table></figure><h3 id="ln链接文件"><a href="#ln链接文件" class="headerlink" title="ln链接文件"></a>ln链接文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> -s 软连接,软链接和源文件不是同一个,文件大小不同,软链接存在断链的危险</span><br><span class="line">ln -s data_file sl_data_file</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 没有参数,硬链接</span><br><span class="line"><span class="meta">$</span> ln code_file hl_code_file</span><br><span class="line"><span class="meta">#</span> inode数量+1,硬链接文件和源文件是同一个,硬链接只能在同一个设备创建</span><br><span class="line"><span class="meta">$</span> ls –il  </span><br><span class="line">13058 -rwx - - - - - - 1 longcheng longcheng 48 8月 5 16:38 file1  </span><br><span class="line">13059 -rwx - - - - - - 2 longcheng longcheng 57 8月 5 16:40 file2  </span><br><span class="line">13059 -rwx - - - - - - 2 longcheng longcheng 57 8月 5 16:40 file2hard</span><br></pre></td></tr></table></figure><h3 id="rm"><a href="#rm" class="headerlink" title="rm"></a>rm</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> -i 删除前询问</span><br><span class="line">rm -i file</span><br><span class="line">rm -i f?ll</span><br><span class="line">rm -i f[1-5]ll</span><br><span class="line">rm -r folder/</span><br><span class="line">rm -ri folder/</span><br><span class="line">rm -rf folder/</span><br></pre></td></tr></table></figure><h3 id="mkdir"><a href="#mkdir" class="headerlink" title="mkdir"></a>mkdir</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir test&#123;1,2,3,4,5&#125;</span><br><span class="line">mkdir -p t&#123;1,2,3,4,5&#125;/&#123;a,b,c&#125;</span><br></pre></td></tr></table></figure><ol start="6"><li>查看文件<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">less file</span><br><span class="line">cat -n file</span><br><span class="line">head -n 5 file</span><br><span class="line">tail -n 5 file</span><br><span class="line"><span class="meta">#</span> 倒数第五行和第四行</span><br><span class="line">tail -n 5 123 | head -n 2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 持续查看</span><br><span class="line">tail -f a.log</span><br></pre></td></tr></table></figure></li></ol><h3 id="查看所有已挂载磁盘的使用情况"><a href="#查看所有已挂载磁盘的使用情况" class="headerlink" title="查看所有已挂载磁盘的使用情况"></a>查看所有已挂载磁盘的使用情况</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 查看所有已挂载磁盘的使用情况</span><br><span class="line"><span class="meta">$</span> df -h</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 查看当前目录大小</span><br><span class="line"><span class="meta">$</span> du -sh .</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 查看当前文件夹中文件大小并排序</span><br><span class="line"><span class="meta">$</span> du -sh * | sort -nr</span><br></pre></td></tr></table></figure><h3 id="sort排序"><a href="#sort排序" class="headerlink" title="sort排序"></a>sort排序</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 按数值大小进行排序</span><br><span class="line"><span class="meta">$</span> sort -n </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 在日志中,按月份进行排序</span><br><span class="line"><span class="meta">$</span> sort -M</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 使用-t做分隔符,-k参数来指定排序的字段</span><br><span class="line"><span class="meta">$</span> sort -t ':' -k 3 -n /etc/passwd </span><br><span class="line">root:x:0:0:root:/root:/bin/bash </span><br><span class="line">bin:x:1:1:bin:/bin:/sbin/nologin </span><br><span class="line">daemon:x:2:2:daemon:/sbin:/sbin/nologin </span><br><span class="line">adm:x:3:4:adm:/var/adm:/sbin/nologin </span><br><span class="line">lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin </span><br><span class="line">sync:x:5:0:sync:/sbin:/bin/sync </span><br><span class="line">shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown </span><br><span class="line">halt:x:7:0:halt:/sbin:/sbin/halt </span><br><span class="line">mail:x:8:12:mail:/var/spool/mail:/sbin/nologin </span><br><span class="line">news:x:9:13:news:/etc/news: </span><br><span class="line">uucp:x:10:14:uucp:/var/spool/uucp:/sbin/nologin </span><br><span class="line">operator:x:11:0:operator:/root:/sbin/nologin</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 查看当前文件夹中文件大小并排序</span><br><span class="line">du -sh * | sort -nr</span><br></pre></td></tr></table></figure><h3 id="检索数据"><a href="#检索数据" class="headerlink" title="检索数据"></a>检索数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 递归检索</span><br><span class="line"><span class="meta">$</span> grep -rn --color=auto "keyword" ./folder</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 检索以https开头,以77结尾的行</span><br><span class="line"><span class="meta">$</span> grep -rn --color=auto "^https.*77$" ./folder</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 反向检索</span><br><span class="line"><span class="meta">$</span> grep -rn -v --color=auto "^https" ./folder</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 只想知道有多少匹配的行</span><br><span class="line"><span class="meta">$</span> grep -c  "keyword" ./folder</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 指定多个匹配模式，可用-e参数来指定每个模式。</span><br><span class="line"><span class="meta">$</span> grep -e "keyword1" -e "keyword2" file1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 还有egrep和fgrep</span><br></pre></td></tr></table></figure><h3 id="压缩和解压缩"><a href="#压缩和解压缩" class="headerlink" title="压缩和解压缩"></a>压缩和解压缩</h3><p>注意分清楚压缩文件和打包文件并不是同一个概念,和Windows不同</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> gzip # 压缩文件</span><br><span class="line"><span class="meta">$</span> gzcat # 查看压缩文件</span><br><span class="line"><span class="meta">$</span> gunzip # 解压文件</span><br></pre></td></tr></table></figure><h3 id="归档和解包数据"><a href="#归档和解包数据" class="headerlink" title="归档和解包数据"></a>归档和解包数据</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> -c create -v verbose -z gzip压缩 -f 指定文件</span><br><span class="line">tar -czvf test1.tar.gz h1.html h2.html</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 列出归档中的文件不解包 -t list</span><br><span class="line">tar -tf test1.tar </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 解压并解包数据 </span><br><span class="line">tar -zxvf test1.tar.gz</span><br></pre></td></tr></table></figure><h3 id="后台进程"><a href="#后台进程" class="headerlink" title="后台进程"></a>后台进程</h3><p>生成子shell的成本不低，而且速度还慢。创建嵌套子shell更是火上浇油!</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 创建备份文件是有效利用后台进程列表的一个实用的例子</span><br><span class="line"><span class="meta">$</span> (tar -cf Rich.tar /home/rich ; tar -cf My.tar /home/christine)&amp;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 协程,My_Job是协程的名字</span><br><span class="line"><span class="meta">$</span> coproc My_Job &#123; sleep 10; &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span> jobs -l</span><br></pre></td></tr></table></figure><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>所有的环境变量名均使用大写字母，这是bash shell的标准惯例。如果是自己创建的局部变量或是shell脚本，请使用小写字母。变量名区分大小写。在涉及用户定义的局部变量时坚持使用小写字母，这能够避免重新定义系统环境变量可能带来的灾难。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> env</span><br><span class="line"><span class="meta">$</span> printenv HOME</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> set命令会显示为某个特定进程设置的所有环境变量，包括局部变量、全局变量以及用户定义变量,并按顺序排序后输出</span><br><span class="line"><span class="meta">$</span> set</span><br></pre></td></tr></table></figure><p>修改,删除子shell中全局环境变量并不会影响到父shell中该变量的值</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> my_variable="I am Global now" </span><br><span class="line"><span class="meta">$</span> export my_variable</span><br><span class="line"><span class="meta">$</span> echo $my_variable</span><br><span class="line">I am Global now $</span><br><span class="line"><span class="meta">$</span> bash</span><br><span class="line"><span class="meta">$</span> echo $my_variable I am Global now</span><br><span class="line"><span class="meta">$</span></span><br><span class="line"><span class="meta">$</span> my_variable="Null" $</span><br><span class="line"><span class="meta">$</span> echo $my_variable Null</span><br><span class="line"><span class="meta">$</span></span><br><span class="line"><span class="meta">$</span> exit</span><br><span class="line">exit</span><br><span class="line"><span class="meta">$</span></span><br><span class="line"><span class="meta">$</span> echo $my_variable I am Global now</span><br><span class="line"><span class="meta">$</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 删除环境变量,记住不要使用$</span><br><span class="line"><span class="meta">$</span> unset my_variable</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 修改PATH环境变量</span><br><span class="line"><span class="meta">$</span> echo $PATH</span><br><span class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin: /sbin:/bin:/usr/games:/usr/local/games</span><br><span class="line"><span class="meta">$</span></span><br><span class="line"><span class="meta">$</span> PATH=$PATH:/home/christine/Scripts</span><br><span class="line"><span class="meta">$</span></span><br><span class="line"><span class="meta">$</span> echo $PATH </span><br><span class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/home/christine/Scripts</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 将当前忙碌加入PATH</span><br><span class="line"><span class="meta">$</span> PATH=$PATH:.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 数组变量</span><br><span class="line"><span class="meta">$</span> mytest=(one two three four five)</span><br><span class="line"><span class="meta">$</span> echo $&#123;mytest[*]&#125;</span><br><span class="line">one two three four five</span><br><span class="line"><span class="meta">$</span> echo $&#123;mytest[2]&#125; </span><br><span class="line">three</span><br><span class="line"><span class="meta">#</span> 删除单个变量和全部变量</span><br><span class="line"><span class="meta">$</span> unset mytest[2]</span><br><span class="line"><span class="meta">$</span> unset mytest</span><br></pre></td></tr></table></figure><p>shell会按照按照下列顺序，运行第一个被找到的文件，余下的则被忽略:<br>$HOME/.bash_profile<br>$HOME/.bash_login<br>$HOME/.profile<br>注意，这个列表中并没有$HOME/.bashrc文件。这是因为该文件通常通过其他文件运行的。</p><h3 id="etc-passwd文件"><a href="#etc-passwd文件" class="headerlink" title="/etc/passwd文件"></a>/etc/passwd文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:0:root:/root:/bin/bash</span><br></pre></td></tr></table></figure><ul><li>登录用户名</li><li>用户密码</li><li>用户账户的UID(数字形式)</li><li>用户账户的组ID(GID)(数字形式) </li><li>用户账户的文本描述(称为备注字段) </li><li>用户HOME目录的位置</li><li>用户的默认shell</li></ul><h3 id="etc-shadow文件"><a href="#etc-shadow文件" class="headerlink" title="/etc/shadow文件"></a>/etc/shadow文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rich:$1$.FfcK0ns$f1UgiyHQ25wrB/hykCn020:11627:0:99999:7:::</span><br></pre></td></tr></table></figure><ul><li>与/etc/passwd文件中的登录名字段对应的登录名</li><li>加密后的密码</li><li>自上次修改密码后过去的天数密码(自1970年1月1日开始计算) </li><li>多少天后才能更改密码</li><li>多少天后必须更改密码</li><li>密码过期前提前多少天提醒用户更改密码</li><li>密码过期后多少天禁用用户账户</li><li>用户账户被禁用的日期(用自1970年1月1日到当天的天数表示) </li><li>预留字段给将来使用</li></ul><h3 id="etc-group文件"><a href="#etc-group文件" class="headerlink" title="/etc/group文件"></a>/etc/group文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root:x:0:root</span><br></pre></td></tr></table></figure><ul><li>组名</li><li>组密码</li><li>GID</li><li>属于该组的用户列表<br>组密码允许非组内成员通过它临时成为该组成员。这个功能并不很普遍，但确实存在.千万不能通过直接修改/etc/group文件来添加用户到一个组，要用usermod命令.<br>当一个用户在/etc/passwd文件中指定某个组作为默认组时， 用户账户不会作为该组成员再出现在/etc/group文件中</li></ul><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> Bash基础入门 </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>创建RDS事件订阅</title>
      <link href="2021/01/19/AWS/RDS/%E5%88%9B%E5%BB%BArds%E4%BA%8B%E4%BB%B6%E8%AE%A2%E9%98%85/"/>
      <url>2021/01/19/AWS/RDS/%E5%88%9B%E5%BB%BArds%E4%BA%8B%E4%BB%B6%E8%AE%A2%E9%98%85/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-创建RDS事件订阅"><a href="#描述-创建RDS事件订阅" class="headerlink" title="描述: 创建RDS事件订阅"></a>描述: 创建RDS事件订阅</h2><a id="more"></a><h3 id="RDS-Event-Subscription"><a href="#RDS-Event-Subscription" class="headerlink" title="RDS Event Subscription"></a>RDS Event Subscription</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">TopicName=RDS-notification</span><br><span class="line">Endpoint=email@example.com</span><br><span class="line">ClusterID=MyCluster</span><br><span class="line">Region=us-east-1</span><br><span class="line">Profile=</span><br><span class="line"></span><br><span class="line">TopicARN=$(aws sns create-topic \</span><br><span class="line">    --profile $&#123;Profile&#125; \</span><br><span class="line">    --region $&#123;Region&#125; \</span><br><span class="line">    --query 'TopicArn' \</span><br><span class="line">    --name  $&#123;TopicName&#125; \</span><br><span class="line">    --tags \</span><br><span class="line">        Key=Department,Value=dev \</span><br><span class="line">        Key=Environment,Value=dev \</span><br><span class="line">        Key=contacts,Value=Neil \</span><br><span class="line">        Key=Ticket,Value=1234 \</span><br><span class="line">    --output text)</span><br><span class="line"></span><br><span class="line">aws sns subscribe \</span><br><span class="line">    --profile $&#123;Profile&#125; \</span><br><span class="line">    --region $&#123;Region&#125; \</span><br><span class="line">    --topic-arn $&#123;TopicARN&#125; \</span><br><span class="line">    --protocol email \</span><br><span class="line">    --notification-endpoint $&#123;Endpoint&#125;</span><br><span class="line"></span><br><span class="line">aws rds create-event-subscription \</span><br><span class="line">    --profile $&#123;Profile&#125; \</span><br><span class="line">    --region $&#123;Region&#125; \</span><br><span class="line">    --subscription-name RDS-Cluster-notification \</span><br><span class="line">    --sns-topic-arn $&#123;TopicARN&#125; \</span><br><span class="line">    --source-type db-cluster \</span><br><span class="line">    --source-ids $&#123;ClusterID&#125; \</span><br><span class="line">    --tags \</span><br><span class="line">        Key=Department,Value=dev \</span><br><span class="line">        Key=Environment,Value=dev \</span><br><span class="line">        Key=Contacts,Value=Neil \</span><br><span class="line">        Key=Ticket,Value=1234 \</span><br><span class="line">    --enabled</span><br></pre></td></tr></table></figure><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> RDS </category>
          
          <category> 脚本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS RDS 脚本 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WAF 博客</title>
      <link href="2021/01/08/AWS/WAF&amp;Shield/WAF%20Article/"/>
      <url>2021/01/08/AWS/WAF&amp;Shield/WAF%20Article/</url>
      
        <content type="html"><![CDATA[<h2 id="描述"><a href="#描述" class="headerlink" title="描述:"></a>描述:</h2><a id="more"></a><p><a href="https://aws.amazon.com/cn/blogs/security/deploy-dashboard-for-aws-waf-minimal-effort/" target="_blank" rel="noopener">搭建WAF看板</a></p><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> WAF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WAF Article </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SSH Docker</title>
      <link href="2021/01/07/Docker/SSHdocker/"/>
      <url>2021/01/07/Docker/SSHdocker/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-做一个可以SSH的docker"><a href="#描述-做一个可以SSH的docker" class="headerlink" title="描述: 做一个可以SSH的docker"></a>描述: 做一个可以SSH的docker</h2><a id="more"></a><h3 id="手动创建"><a href="#手动创建" class="headerlink" title="手动创建"></a>手动创建</h3><h4 id="手动创建docker"><a href="#手动创建docker" class="headerlink" title="手动创建docker"></a>手动创建docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 拉取最新的Ubuntu</span><br><span class="line">docker pull ubuntu:20.04</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 启动</span><br><span class="line">docker run -it ubuntu:20.04 /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 更新并安装</span><br><span class="line"><span class="meta">#</span> sed -i s@/archive.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list // 换源操作</span><br><span class="line">apt-get update &amp;&amp; apt-get install -y openssh-server net-tools vim</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 配置ssh,将/root/.ssh/id_rsa.pub里的内容复制到容器内authorized_keys中去</span><br><span class="line">mkdir /root/.ssh /run/sshd</span><br><span class="line"></span><br><span class="line">touch /root/.ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 创建ssh启动脚本</span><br><span class="line">echo -e "#\!bin/bash\n/usr/sbin/sshd -D" &gt; /root/run.sh</span><br><span class="line">chmod +x /root/run.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 退出镜像</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> commit镜像</span><br><span class="line">docker commit 12345678abcd sshd:v1</span><br></pre></td></tr></table></figure><h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 启动做好的docker镜像</span><br><span class="line">docker run -p 10022:22 -d sshd:v1 /root/run.sh</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 从宿主机登录</span><br><span class="line">ssh root@localhost -p 10022</span><br></pre></td></tr></table></figure><h3 id="使用DOckerfile"><a href="#使用DOckerfile" class="headerlink" title="使用DOckerfile"></a>使用DOckerfile</h3><h4 id="dockerfile-内容"><a href="#dockerfile-内容" class="headerlink" title="dockerfile 内容"></a>dockerfile 内容</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 以最新的Ubuntu:20.4镜像为模板</span><br><span class="line">FROM ubuntu:20.04</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> PubKey</span><br><span class="line">ENV pubkey "ssh-rsa EXAMPLE/AAAABBBBCCCCc2EAAAADAQABAAABAQDBpC5L7tBkf2U9a6wIM891GUjVgZosERJSiXKHiAMAD34TUp95WN2qDgkno9b3k5FiyODSTd8aseJlBTtCvuChCjS+9tDs009aPoRk14Cwl3QiPvInJCZXYvpomwDqD3lPkMrKjqdVRT/9dDzpBsjXX/Irbm9xRkkt/aEeQCbzJ/X2Q3InwwllGZS5+rquZ8MWaOjKXITL5I3PPS2COFoRUWwsXjfknMwbMudASdeFZoO5rSsIQ7jlG9gJuWM0ZfV2F9M1Ie/hc0rkrQf2JnXOtUXhzBKOOyeSEIChQkTXj+b3tZvWU7wuT7++x2Jr01234567890 NOBODY"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 换源</span><br><span class="line">RUN sed -i s@/archive.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 更新并安装</span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y openssh-server net-tools vim</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 创建目录并写入PubKey</span><br><span class="line">RUN mkdir -p /run/sshd &amp;&amp; mkdir -p /root/.ssh/ &amp;&amp; echo $pubkey &gt; /root/.ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 开放22端口</span><br><span class="line">EXPOSE 22</span><br><span class="line"></span><br><span class="line">CMD /usr/sbin/sshd -D</span><br></pre></td></tr></table></figure><h4 id="build-并启动"><a href="#build-并启动" class="headerlink" title="build 并启动"></a>build 并启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 在Dockerfile目录下运行</span><br><span class="line">docker build -t sshd:v2 .</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 启动做好的docker镜像</span><br><span class="line">docker run -d -p 10022:22 sshd:v2 </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 从宿主机登录</span><br><span class="line">ssh root@localhost -p 10022</span><br></pre></td></tr></table></figure><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WAF CloudFormation Template</title>
      <link href="2020/12/25/AWS/WAF&amp;Shield/WAF%20Template/"/>
      <url>2020/12/25/AWS/WAF&amp;Shield/WAF%20Template/</url>
      
        <content type="html"><![CDATA[<h2 id="描述"><a href="#描述" class="headerlink" title="描述:"></a>描述:</h2><a id="more"></a><h3 id="心得"><a href="#心得" class="headerlink" title="心得"></a>心得</h3><p>防火墙如果有特殊设置,先允许特殊许可,例如内网IP可以跳过防火墙,其他</p><h4 id="Template总览"><a href="#Template总览" class="headerlink" title="Template总览"></a>Template总览</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Resources:</span></span><br><span class="line">  <span class="comment"># ===========================================WAF==================================</span></span><br><span class="line"><span class="attr">  IPSet:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::WAFv2::IPSet</span></span><br><span class="line"><span class="attr">    Properties:</span> </span><br><span class="line"><span class="attr">      Addresses:</span> </span><br><span class="line"><span class="bullet">        -</span> <span class="number">110.87</span><span class="number">.98</span><span class="number">.82</span><span class="string">/32</span></span><br><span class="line"><span class="bullet">        -</span> <span class="number">210.13</span><span class="number">.208</span><span class="number">.82</span><span class="string">/32</span></span><br><span class="line"><span class="bullet">        -</span> <span class="number">202.163</span><span class="number">.1</span><span class="number">.218</span><span class="string">/32</span></span><br><span class="line"><span class="attr">      Description:</span> <span class="type">!Sub</span> <span class="string">"XMN VPN IPs, Created by CloudFormation Stack $&#123;Name&#125;"</span></span><br><span class="line"><span class="attr">      IPAddressVersion:</span> <span class="string">IPV4</span></span><br><span class="line"><span class="attr">      Name:</span> <span class="type">!Sub</span> <span class="string">$&#123;Name&#125;-IPset</span></span><br><span class="line"><span class="attr">      Scope:</span> <span class="string">REGIONAL</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  Regex:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::WAFv2::RegexPatternSet</span></span><br><span class="line"><span class="attr">    Properties:</span> </span><br><span class="line"><span class="attr">      Description:</span> <span class="type">!Sub</span> <span class="string">"Sentry Regex, Created by CloudFormation Stack $&#123;Name&#125;"</span></span><br><span class="line"><span class="attr">      Name:</span> <span class="type">!Sub</span> <span class="string">$&#123;Name&#125;-Regex</span></span><br><span class="line"><span class="attr">      RegularExpressionList:</span> </span><br><span class="line"><span class="bullet">        -</span> <span class="string">^/api/\d/*</span></span><br><span class="line"><span class="attr">      Scope:</span> <span class="string">REGIONAL</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  WAF:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::WAFv2::WebACL</span></span><br><span class="line"><span class="attr">    Properties:</span> </span><br><span class="line"><span class="attr">      DefaultAction:</span> </span><br><span class="line"><span class="attr">        Block:</span> <span class="string">&#123;&#125;</span> </span><br><span class="line"><span class="attr">      Description:</span> <span class="type">!Sub</span> <span class="string">"A basic WAF, follow basic AWS Managed rules and a rate-limit rule, Created by CloudFormation Stack $&#123;Name&#125;"</span></span><br><span class="line"><span class="attr">      Name:</span> <span class="string">BasicWAF</span></span><br><span class="line"><span class="attr">      Rules:</span> </span><br><span class="line"><span class="attr">        - Action:</span> </span><br><span class="line"><span class="attr">            Allow:</span> <span class="string">&#123;&#125;</span> </span><br><span class="line"><span class="attr">          Name:</span> <span class="string">AllowInternalIP</span></span><br><span class="line"><span class="attr">          Priority:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          Statement:</span></span><br><span class="line"><span class="attr">            IPSetReferenceStatement:</span></span><br><span class="line"><span class="attr">              Arn:</span> <span class="type">!GetAtt</span> <span class="string">IPSet.Arn</span></span><br><span class="line"><span class="attr">          VisibilityConfig:</span> </span><br><span class="line"><span class="attr">            CloudWatchMetricsEnabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">            MetricName:</span> <span class="string">AllowInternalIP</span></span><br><span class="line"><span class="attr">            SampledRequestsEnabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        - OverrideAction:</span></span><br><span class="line"><span class="attr">            None:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">          Name:</span> <span class="string">AWSManagedRulesCommonRuleSet</span></span><br><span class="line"><span class="attr">          Priority:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">          Statement:</span> </span><br><span class="line"><span class="attr">            ManagedRuleGroupStatement:</span></span><br><span class="line"><span class="attr">              VendorName:</span> <span class="string">AWS</span></span><br><span class="line"><span class="attr">              Name:</span> <span class="string">AWSManagedRulesCommonRuleSet</span></span><br><span class="line"><span class="attr">              ExcludedRules:</span> <span class="string">[NoUserAgent_HEADER,EC2MetaDataSSRF_BODY,GenericRFI_BODY]</span></span><br><span class="line"><span class="attr">          VisibilityConfig:</span> </span><br><span class="line"><span class="attr">            CloudWatchMetricsEnabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">            MetricName:</span> <span class="string">AWSManagedRulesCommonRuleSet</span></span><br><span class="line"><span class="attr">            SampledRequestsEnabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        - OverrideAction:</span></span><br><span class="line"><span class="attr">            None:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">          Name:</span> <span class="string">AWSManagedRulesAmazonIpReputationList</span></span><br><span class="line"><span class="attr">          Priority:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">          Statement:</span> </span><br><span class="line"><span class="attr">            ManagedRuleGroupStatement:</span></span><br><span class="line"><span class="attr">              VendorName:</span> <span class="string">AWS</span></span><br><span class="line"><span class="attr">              Name:</span> <span class="string">AWSManagedRulesAmazonIpReputationList</span></span><br><span class="line"><span class="attr">              ExcludedRules:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">          VisibilityConfig:</span> </span><br><span class="line"><span class="attr">            CloudWatchMetricsEnabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">            MetricName:</span> <span class="string">AWSManagedRulesAmazonIpReputationList</span></span><br><span class="line"><span class="attr">            SampledRequestsEnabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        - Action:</span> </span><br><span class="line"><span class="attr">            Block:</span> <span class="string">&#123;&#125;</span> </span><br><span class="line"><span class="attr">          Name:</span> <span class="string">RateLimit</span></span><br><span class="line"><span class="attr">          Priority:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">          Statement:</span></span><br><span class="line"><span class="attr">            RateBasedStatement:</span></span><br><span class="line"><span class="attr">              AggregateKeyType:</span> <span class="string">IP</span></span><br><span class="line"><span class="attr">              Limit:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">          VisibilityConfig:</span> </span><br><span class="line"><span class="attr">            CloudWatchMetricsEnabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">            MetricName:</span> <span class="string">RateLimit</span></span><br><span class="line"><span class="attr">            SampledRequestsEnabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># Maybe can add "Regex pattern sets" when client post events</span></span><br><span class="line"><span class="attr">        - Action:</span> </span><br><span class="line"><span class="attr">            Allow:</span> <span class="string">&#123;&#125;</span> </span><br><span class="line"><span class="attr">          Name:</span> <span class="string">AllowPOSTMethod</span></span><br><span class="line"><span class="attr">          Priority:</span> <span class="number">4</span></span><br><span class="line"><span class="attr">          Statement:</span></span><br><span class="line"><span class="attr">            AndStatement:</span></span><br><span class="line"><span class="attr">              Statements:</span></span><br><span class="line"><span class="attr">                - ByteMatchStatement:</span></span><br><span class="line"><span class="attr">                    FieldToMatch:</span></span><br><span class="line"><span class="attr">                      Method:</span> </span><br><span class="line"><span class="attr">                        POST:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">                    SearchString:</span> <span class="string">post</span></span><br><span class="line"><span class="attr">                    PositionalConstraint:</span> <span class="string">CONTAINS_WORD</span></span><br><span class="line"><span class="attr">                    TextTransformations:</span></span><br><span class="line"><span class="attr">                      - Priority:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                        Type:</span> <span class="string">LOWERCASE</span></span><br><span class="line"><span class="attr">                - ByteMatchStatement:</span></span><br><span class="line"><span class="attr">                    FieldToMatch:</span></span><br><span class="line"><span class="attr">                      SingleHeader:</span> </span><br><span class="line"><span class="attr">                        Name:</span> <span class="string">x-sentry-auth</span></span><br><span class="line"><span class="attr">                    SearchString:</span> <span class="string">sentry</span></span><br><span class="line"><span class="attr">                    PositionalConstraint:</span> <span class="string">CONTAINS_WORD</span></span><br><span class="line"><span class="attr">                    TextTransformations:</span></span><br><span class="line"><span class="attr">                      - Priority:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                        Type:</span> <span class="string">LOWERCASE</span></span><br><span class="line"><span class="attr">                - RegexPatternSetReferenceStatement:</span></span><br><span class="line"><span class="attr">                    Arn:</span> <span class="type">!GetAtt</span> <span class="string">Regex</span></span><br><span class="line"><span class="attr">                    FieldToMatch:</span> </span><br><span class="line"><span class="attr">                      UriPath:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">                    TextTransformations:</span> </span><br><span class="line"><span class="attr">                      - Priority:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                        Type:</span> <span class="string">LOWERCASE</span></span><br><span class="line"><span class="attr">          VisibilityConfig:</span> </span><br><span class="line"><span class="attr">            CloudWatchMetricsEnabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">            MetricName:</span> <span class="string">AllowPOSTMethod</span></span><br><span class="line"><span class="attr">            SampledRequestsEnabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      Scope:</span> <span class="string">REGIONAL</span></span><br><span class="line"><span class="attr">      VisibilityConfig:</span> </span><br><span class="line"><span class="attr">        CloudWatchMetricsEnabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        MetricName:</span> <span class="string">BasicWAF</span></span><br><span class="line"><span class="attr">        SampledRequestsEnabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  WAFAssociate:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::WAFv2::WebACLAssociation</span></span><br><span class="line"><span class="attr">    DependsOn:</span> <span class="string">SentryElasticLoadBalancer</span></span><br><span class="line"><span class="attr">    Properties:</span> </span><br><span class="line"><span class="attr">      ResourceArn:</span> <span class="type">!Ref</span> <span class="string">SentryElasticLoadBalancer</span></span><br><span class="line"><span class="attr">      WebACLArn:</span> <span class="type">!GetAtt</span> <span class="string">WAF.Arn</span></span><br></pre></td></tr></table></figure><h4 id="引用官方规则"><a href="#引用官方规则" class="headerlink" title="引用官方规则"></a>引用官方规则</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- OverrideAction:</span></span><br><span class="line"><span class="attr">    None:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">  Name:</span> <span class="string">AWSManagedRulesCommonRuleSet</span></span><br><span class="line"><span class="attr">  Priority:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">  Statement:</span> </span><br><span class="line"><span class="attr">    ManagedRuleGroupStatement:</span></span><br><span class="line"><span class="attr">      VendorName:</span> <span class="string">AWS</span></span><br><span class="line"><span class="attr">      Name:</span> <span class="string">AWSManagedRulesCommonRuleSet</span></span><br><span class="line"><span class="attr">      ExcludedRules:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">  VisibilityConfig:</span> </span><br><span class="line"><span class="attr">    CloudWatchMetricsEnabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    MetricName:</span> <span class="string">AWSManagedRulesCommonRuleSet</span></span><br><span class="line"><span class="attr">    SampledRequestsEnabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="允许指定IP或POST请求"><a href="#允许指定IP或POST请求" class="headerlink" title="允许指定IP或POST请求"></a>允许指定IP或POST请求</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- Action:</span> </span><br><span class="line"><span class="attr">    Allow:</span> <span class="string">&#123;&#125;</span> </span><br><span class="line"><span class="attr">  Name:</span> <span class="string">OnlyPOSTExcludeXMNIP</span></span><br><span class="line"><span class="attr">  Priority:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  Statement:</span></span><br><span class="line"><span class="attr">    OrStatement:</span> </span><br><span class="line"><span class="attr">      Statements:</span></span><br><span class="line"><span class="attr">        - ByteMatchStatement:</span></span><br><span class="line"><span class="attr">            FieldToMatch:</span></span><br><span class="line"><span class="attr">              Method:</span> </span><br><span class="line"><span class="attr">                POST:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">            SearchString:</span> <span class="string">post</span></span><br><span class="line"><span class="attr">            PositionalConstraint:</span> <span class="string">CONTAINS_WORD</span></span><br><span class="line"><span class="attr">            TextTransformations:</span></span><br><span class="line"><span class="attr">              - Priority:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                Type:</span> <span class="string">LOWERCASE</span></span><br><span class="line"><span class="attr">        - IPSetReferenceStatement:</span></span><br><span class="line"><span class="attr">            Arn:</span> <span class="type">!GetAtt</span> <span class="string">IPSet.Arn</span></span><br></pre></td></tr></table></figure><h4 id="除了指定IP外-其他IP受速率限制"><a href="#除了指定IP外-其他IP受速率限制" class="headerlink" title="除了指定IP外,其他IP受速率限制"></a>除了指定IP外,其他IP受速率限制</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- Action:</span> </span><br><span class="line"><span class="attr">    Block:</span> <span class="string">&#123;&#125;</span> </span><br><span class="line"><span class="attr">  Name:</span> <span class="string">RateLimitExcludeXMNIP</span></span><br><span class="line"><span class="attr">  Priority:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  Statement:</span></span><br><span class="line"><span class="attr">    RateBasedStatement:</span></span><br><span class="line"><span class="attr">      AggregateKeyType:</span> <span class="string">IP</span></span><br><span class="line"><span class="attr">      Limit:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">      ScopeDownStatement:</span></span><br><span class="line"><span class="attr">        NotStatement:</span></span><br><span class="line"><span class="attr">          Statement:</span></span><br><span class="line"><span class="attr">            IPSetReferenceStatement:</span></span><br><span class="line"><span class="attr">              Arn:</span> <span class="type">!GetAtt</span> <span class="string">IPSet.Arn</span></span><br><span class="line"><span class="attr">  VisibilityConfig:</span> </span><br><span class="line"><span class="attr">    CloudWatchMetricsEnabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    MetricName:</span> <span class="string">RateLimitExcludeXMNIP</span></span><br><span class="line"><span class="attr">    SampledRequestsEnabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="指定IP受速率限制"><a href="#指定IP受速率限制" class="headerlink" title="指定IP受速率限制"></a>指定IP受速率限制</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- Action:</span> </span><br><span class="line"><span class="attr">    Block:</span> <span class="string">&#123;&#125;</span> </span><br><span class="line"><span class="attr">  Name:</span> <span class="string">RateLimitExcludeXMNIP</span></span><br><span class="line"><span class="attr">  Priority:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  Statement:</span></span><br><span class="line"><span class="attr">    RateBasedStatement:</span></span><br><span class="line"><span class="attr">      AggregateKeyType:</span> <span class="string">IP</span></span><br><span class="line"><span class="attr">      Limit:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">      ScopeDownStatement:</span></span><br><span class="line"><span class="attr">        IPSetReferenceStatement:</span></span><br><span class="line"><span class="attr">          Arn:</span> <span class="type">!GetAtt</span> <span class="string">IPSet.Arn</span></span><br><span class="line"><span class="attr">  VisibilityConfig:</span> </span><br><span class="line"><span class="attr">    CloudWatchMetricsEnabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    MetricName:</span> <span class="string">RateLimitExcludeXMNIP</span></span><br><span class="line"><span class="attr">    SampledRequestsEnabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> WAF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WAF </tag>
            
            <tag> CF Template </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell获取本机IP</title>
      <link href="2020/12/24/Bash/Shell%E6%96%87%E7%AB%A0%E9%93%BE%E6%8E%A5/"/>
      <url>2020/12/24/Bash/Shell%E6%96%87%E7%AB%A0%E9%93%BE%E6%8E%A5/</url>
      
        <content type="html"><![CDATA[<h3 id="shell获取本机IP"><a href="#shell获取本机IP" class="headerlink" title="shell获取本机IP"></a>shell获取本机IP</h3><a id="more"></a><ol><li><a href="https://www.cnblogs.com/ultranms/p/9353157.html" target="_blank" rel="noopener">&gt;/dev/null 2&gt;&amp;1</a></li></ol><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WAF&amp;Shield CLI</title>
      <link href="2020/12/21/AWS/WAF&amp;Shield/WAF&amp;Shield-CLI/"/>
      <url>2020/12/21/AWS/WAF&amp;Shield/WAF&amp;Shield-CLI/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-WAF-amp-Shield-常用的CLI命令"><a href="#描述-WAF-amp-Shield-常用的CLI命令" class="headerlink" title="描述: WAF&amp;Shield 常用的CLI命令"></a>描述: WAF&amp;Shield 常用的CLI命令</h2><a id="more"></a><h3 id="WAF"><a href="#WAF" class="headerlink" title="WAF"></a>WAF</h3><h4 id="列出托管的的规则组"><a href="#列出托管的的规则组" class="headerlink" title="列出托管的的规则组"></a>列出托管的的规则组</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aws wafv2 list-available-managed-rule-groups --scope REGIONAL</span><br><span class="line"></span><br><span class="line">aws wafv2 list-available-managed-rule-groups --scope=CLOUDFRONT --region=us-east-1</span><br></pre></td></tr></table></figure><h4 id="获取-Amazon-CloudFront-分配中使用的基于速率的规则阻止的-IP-地址列表"><a href="#获取-Amazon-CloudFront-分配中使用的基于速率的规则阻止的-IP-地址列表" class="headerlink" title="获取 Amazon CloudFront 分配中使用的基于速率的规则阻止的 IP 地址列表"></a>获取 Amazon CloudFront 分配中使用的基于速率的规则阻止的 IP 地址列表</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">aws wafv2 get-rate-based-statement-managed-keys \</span><br><span class="line">  --scope=CLOUDFRONT \</span><br><span class="line">  --region=us-east-1 \</span><br><span class="line">  --web-acl-name=my-test \</span><br><span class="line">  --web-acl-id=1234abcd-d4e3-486c-a95d-fd25c4dbabcd \</span><br><span class="line">  --rule-name=rate-limit</span><br></pre></td></tr></table></figure><h4 id="获取基于API-Gateway-REST-API、ALB-或AppSync-GraphQL-基于速率的规则阻止的-IP-地址列表"><a href="#获取基于API-Gateway-REST-API、ALB-或AppSync-GraphQL-基于速率的规则阻止的-IP-地址列表" class="headerlink" title="获取基于API Gateway REST API、ALB 或AppSync GraphQL 基于速率的规则阻止的 IP 地址列表"></a>获取基于API Gateway REST API、ALB 或AppSync GraphQL 基于速率的规则阻止的 IP 地址列表</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">aws wafv2 get-rate-based-statement-managed-keys \</span><br><span class="line">  --scope=REGIONAL \</span><br><span class="line">  --region=region \</span><br><span class="line">  --web-acl-name=WebACLName \</span><br><span class="line">  --web-acl-id=WebACLId \</span><br><span class="line">  --rule-name=RuleName</span><br></pre></td></tr></table></figure><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> WAF&amp;Shield </category>
          
      </categories>
      
      
        <tags>
            
            <tag> WAF&amp;Shield </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WAF</title>
      <link href="2020/12/21/AWS/WAF&amp;Shield/WAF/"/>
      <url>2020/12/21/AWS/WAF&amp;Shield/WAF/</url>
      
        <content type="html"><![CDATA[<h2 id="描述"><a href="#描述" class="headerlink" title="描述:"></a>描述:</h2><a id="more"></a><h3 id="AWS-WAF-如何处理-Web-ACL-中的规则操作"><a href="#AWS-WAF-如何处理-Web-ACL-中的规则操作" class="headerlink" title="AWS WAF 如何处理 Web ACL 中的规则操作"></a>AWS WAF 如何处理 Web ACL 中的规则操作</h3><p>对于 Web ACL 中的规则，可以选择计数、允许或阻止匹配的 Web 请求：</p><ul><li><p>允许和阻止操作是终止操作。它们会停止 Web ACL 对匹配的 Web 请求的所有其他处理。如果在 Web ACL 中包含具有允许或阻止操作的规则，并且该规则找到匹配项，该匹配项将为 Web ACL 确定对 Web 请求的最终处置。AWS WAF 不会处理 Web ACL 中位于匹配项之后的任何其他规则。对于直接添加到 Web ACL 的规则和添加的规则组中的规则，此原理同样适用。</p></li><li><p>计数操作是非终止操作。当具有计数操作的规则与请求匹配时，AWS WAF 会对请求进行计数，然后继续处理 Web ACL 规则集中的后续规则。如果唯一匹配的规则设置了计数操作，AWS WAF 会应用 Web ACL 默认操作设置。</p></li></ul><p>AWS WAF 对 Web 请求应用的操作受规则在 Web ACL 中的相对位置的影响。例如，如果一个 Web 请求匹配允许请求的规则，同时又匹配另一个对请求进行计数的规则，那么如果允许请求的规则先列出，AWS WAF 不会对请求进行计数。</p><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>WAF&amp;Shield-1-概述</title>
      <link href="2020/12/21/AWS/WAF&amp;Shield/WAF&amp;Shield-1-%E6%A6%82%E8%BF%B0/"/>
      <url>2020/12/21/AWS/WAF&amp;Shield/WAF&amp;Shield-1-%E6%A6%82%E8%BF%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="描述"><a href="#描述" class="headerlink" title="描述:"></a>描述:</h2><a id="more"></a><h3 id="WAF-Shield-FirewallManager概述"><a href="#WAF-Shield-FirewallManager概述" class="headerlink" title="WAF-Shield-FirewallManager概述"></a>WAF-Shield-FirewallManager概述</h3><h4 id="AWS-WAF"><a href="#AWS-WAF" class="headerlink" title="AWS WAF"></a>AWS WAF</h4><p>AWS WAF 是一种 Web 应用程序防火墙，可用于监控转发到 Amazon CloudFront，Amazon API Gateway REST API、ALB 或 AWS AppSync GraphQL API 的 HTTP 和 HTTPS 请求。</p><ul><li><p>允许指定的请求以外的所有请求</p></li><li><p>阻止指定的请求之外的所有请求</p></li><li><p>使用指定的条件针对 Web 攻击提供额外保护:</p><ul><li>请求源自的 IP 地址.</li><li>请求源自的国家/地区。</li><li>请求标头中的值.</li><li>出现在请求中的字符串 (特定字符串或与正则表达式 (regex) 模式匹配的字符串)。</li><li>请求的长度.</li><li>存在可能是恶意的 SQL 代码 (称为 SQL 注入).</li><li>存在可能是恶意的脚本 (称为跨站点脚本).</li></ul></li><li><p>规则可以允许、阻止或统计满足指定条件的 Web 请求。或者，规则可以阻止或统计不仅满足指定条件，还在任何 5 分钟周期内超过指定请求数的 Web 请求。</p></li><li><p>可以重复用于多个 Web 应用程序的规则.</p></li><li><p>来自 AWS 和 AWS Marketplace 卖家的托管规则组。</p></li><li><p>实时指标和采样的 Web 请求.</p></li><li><p>使用 AWS WAF API 的自动化管理。</p></li></ul><p><a href="https://aws.amazon.com/cn/waf/pricing/" target="_blank" rel="noopener">WAF 定价</a></p><h4 id="AWS-Shield"><a href="#AWS-Shield" class="headerlink" title="AWS Shield"></a>AWS Shield</h4><p>可以使用 AWS WAF web访问控制列表(web ACLs)帮助将分布式拒绝服务(DDoS)攻击的影响降至最低。<strong>为防止 DDoS 攻击, AWS 还提供 AWS Shield Standard 和 AWS Shield Advanced</strong>。 AWS Shield Standard 自动包含在内,无需超出您已经支付的费用 AWS WAF 和你的其他人 AWS 服务。 AWS Shield Advanced 提供扩展的 DDoS 攻击保护 Amazon EC2 实例, Elastic Load Balancing 负载均衡器, CloudFront 分布, Route 53 托管区域,以及 AWS Global Accelerator 加速器。 AWS Shield Advanced 会产生额外费用。</p><h4 id="AWS-Firewall-Manager"><a href="#AWS-Firewall-Manager" class="headerlink" title="AWS Firewall Manager"></a>AWS Firewall Manager</h4><p>AWS Firewall Manager 可针对 AWS WAF 规则、AWS Shield Advanced 保护和 Amazon VPC 安全组，简化跨多个账户和多种资源的管理和维护任务。即使您添加新的账户和资源，Firewall Manager 服务也会自动跨账户和资源应用您的规则和其他安全保护。</p><h3 id="Open-Web-Application-Security-Project"><a href="#Open-Web-Application-Security-Project" class="headerlink" title="Open Web Application Security Project"></a>Open Web Application Security Project</h3><p><a href="https://owasp.org/www-project-top-ten/" target="_blank" rel="noopener">https://owasp.org/www-project-top-ten/</a></p><p><a href="https://wiki.owasp.org/images/d/dc/OWASP_Top_10_2017_%E4%B8%AD%E6%96%87%E7%89%88v1.3.pdf" target="_blank" rel="noopener">https://wiki.owasp.org/images/d/dc/OWASP_Top_10_2017_%E4%B8%AD%E6%96%87%E7%89%88v1.3.pdf</a></p><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> WAF&amp;Shield </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>AWS-S3-6-最佳实践</title>
      <link href="2020/12/17/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/S3/AWS-S3-6-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"/>
      <url>2020/12/17/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/S3/AWS-S3-6-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-这些最佳实践可能不适合您的环境或不满足您的环境要求，因此将其视为有用的考虑因素而不是惯例。"><a href="#描述-这些最佳实践可能不适合您的环境或不满足您的环境要求，因此将其视为有用的考虑因素而不是惯例。" class="headerlink" title="描述: 这些最佳实践可能不适合您的环境或不满足您的环境要求，因此将其视为有用的考虑因素而不是惯例。"></a>描述: 这些最佳实践可能不适合您的环境或不满足您的环境要求，因此将其视为有用的考虑因素而不是惯例。</h2><a id="more"></a><!-- TOC --><ul><li><a href="#描述-这些最佳实践可能不适合您的环境或不满足您的环境要求因此将其视为有用的考虑因素而不是惯例">描述: 这些最佳实践可能不适合您的环境或不满足您的环境要求，因此将其视为有用的考虑因素而不是惯例。</a><ul><li><a href="#最佳实践">最佳实践</a><ul><li><a href="#amazon-s3-存储桶使用正确的策略且不可公有访问">Amazon S3 存储桶使用正确的策略且不可公有访问</a></li><li><a href="#"></a></li></ul></li><li><a href="#结语">结语</a></li></ul></li></ul><!-- /TOC --><h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><h4 id="Amazon-S3-存储桶使用正确的策略且不可公有访问"><a href="#Amazon-S3-存储桶使用正确的策略且不可公有访问" class="headerlink" title="Amazon S3 存储桶使用正确的策略且不可公有访问"></a>Amazon S3 存储桶使用正确的策略且不可公有访问</h4><p>除非明确地要求 Internet 上的任何人都能读写S3存储桶，否则应该确保S3存储桶不是公有的。</p><ol><li>使用 Amazon S3 阻止公有访问。</li><li>找出允许通配符标识（如委托人“<em>”，事实上这代表“任何人”）或允许通配符操作“</em>”（事实上这允许用户在 Amazon S3 存储桶中进行任何操作）的 Amazon S3 存储桶策略。</li><li>找出向“任何人”或者“任何经过身份验证的 AWS 用户”提供读、写或完整访问权限的 Amazon S3 存储桶访问控制列表 (ACL)。</li><li>使用 ListBuckets API 扫描您的所有 Amazon S3 存储桶。然后，使用 GetBucketAcl，GetBucketWebsite 和 GetBucketPolicy 确定存储桶是否拥有符合要求的访问管理和配置。</li><li>使用 AWS Trusted Advisor 检查您的 Amazon S3 实现。</li><li>考虑使用 s3-bucket-public-read-prohibited 和 s3-bucket-public-write-prohibited 托管的 AWS Config Rules 实现持续的侦测性控制。</li></ol><h4 id><a href="#" class="headerlink" title></a></h4><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> 存储类 </category>
          
          <category> S3 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> S3 最佳实践 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EC2 Article</title>
      <link href="2020/12/16/AWS/EC2/EC2-%E5%8D%9A%E5%AE%A2/"/>
      <url>2020/12/16/AWS/EC2/EC2-%E5%8D%9A%E5%AE%A2/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-记录一些有用的和EC2有关的文章"><a href="#描述-记录一些有用的和EC2有关的文章" class="headerlink" title="描述: 记录一些有用的和EC2有关的文章"></a>描述: 记录一些有用的和EC2有关的文章</h2><a id="more"></a><ol><li><a href="https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/cli-services-ec2-instance-type-script.html" target="_blank" rel="noopener">使用 bash 脚本更改 Amazon EC2 实例类型</a>(很不错的官方文档,记录了一个脚本的文档,用法和测试过程)</li></ol><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> EC2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> EC2 Article </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>通用VPCTemplate</title>
      <link href="2020/12/16/AWS/CloudFormation/CloudFormationTemplate/%E9%80%9A%E7%94%A8VPCTemplate/"/>
      <url>2020/12/16/AWS/CloudFormation/CloudFormationTemplate/%E9%80%9A%E7%94%A8VPCTemplate/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-通用VPC-Template-YAML模版"><a href="#描述-通用VPC-Template-YAML模版" class="headerlink" title="描述: 通用VPC Template YAML模版"></a>描述: 通用VPC Template YAML模版</h2><a id="more"></a><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">AWSTemplateFormatVersion:</span> <span class="string">'2010-09-09'</span></span><br><span class="line"><span class="attr">Description:</span> <span class="string">'Amazon EKS Sample VPC - Private and Public subnets'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Parameters:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  VpcBlock:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="string">String</span></span><br><span class="line"><span class="attr">    Default:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line"><span class="attr">    Description:</span> <span class="string">The</span> <span class="string">CIDR</span> <span class="string">range</span> <span class="string">for</span> <span class="string">the</span> <span class="string">VPC.</span> <span class="string">This</span> <span class="string">should</span> <span class="string">be</span> <span class="string">a</span> <span class="string">valid</span> <span class="string">private</span> <span class="string">(RFC</span> <span class="number">1918</span><span class="string">)</span> <span class="string">CIDR</span> <span class="string">range.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PublicSubnet01Block:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="string">String</span></span><br><span class="line"><span class="attr">    Default:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span><span class="string">/18</span></span><br><span class="line"><span class="attr">    Description:</span> <span class="string">CidrBlock</span> <span class="string">for</span> <span class="string">public</span> <span class="string">subnet</span> <span class="number">01</span> <span class="string">within</span> <span class="string">the</span> <span class="string">VPC</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PublicSubnet02Block:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="string">String</span></span><br><span class="line"><span class="attr">    Default:</span> <span class="number">192.168</span><span class="number">.64</span><span class="number">.0</span><span class="string">/18</span></span><br><span class="line"><span class="attr">    Description:</span> <span class="string">CidrBlock</span> <span class="string">for</span> <span class="string">public</span> <span class="string">subnet</span> <span class="number">02</span> <span class="string">within</span> <span class="string">the</span> <span class="string">VPC</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PrivateSubnet01Block:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="string">String</span></span><br><span class="line"><span class="attr">    Default:</span> <span class="number">192.168</span><span class="number">.128</span><span class="number">.0</span><span class="string">/18</span></span><br><span class="line"><span class="attr">    Description:</span> <span class="string">CidrBlock</span> <span class="string">for</span> <span class="string">private</span> <span class="string">subnet</span> <span class="number">01</span> <span class="string">within</span> <span class="string">the</span> <span class="string">VPC</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PrivateSubnet02Block:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="string">String</span></span><br><span class="line"><span class="attr">    Default:</span> <span class="number">192.168</span><span class="number">.192</span><span class="number">.0</span><span class="string">/18</span></span><br><span class="line"><span class="attr">    Description:</span> <span class="string">CidrBlock</span> <span class="string">for</span> <span class="string">private</span> <span class="string">subnet</span> <span class="number">02</span> <span class="string">within</span> <span class="string">the</span> <span class="string">VPC</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Metadata:</span></span><br><span class="line"><span class="attr">  AWS:</span><span class="string">:CloudFormation::Interface:</span></span><br><span class="line"><span class="attr">    ParameterGroups:</span></span><br><span class="line"><span class="bullet">      -</span></span><br><span class="line"><span class="attr">        Label:</span></span><br><span class="line"><span class="attr">          default:</span> <span class="string">"Worker Network Configuration"</span></span><br><span class="line"><span class="attr">        Parameters:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">VpcBlock</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">PublicSubnet01Block</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">PublicSubnet02Block</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">PrivateSubnet01Block</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">PrivateSubnet02Block</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Resources:</span></span><br><span class="line"><span class="attr">  VPC:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::VPC</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      CidrBlock:</span>  <span class="type">!Ref</span> <span class="string">VpcBlock</span></span><br><span class="line"><span class="attr">      EnableDnsSupport:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      EnableDnsHostnames:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      Tags:</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">Name</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="type">!Sub</span> <span class="string">'$&#123;AWS::StackName&#125;-VPC'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  InternetGateway:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="string">"AWS::EC2::InternetGateway"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  VPCGatewayAttachment:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="string">"AWS::EC2::VPCGatewayAttachment"</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      InternetGatewayId:</span> <span class="type">!Ref</span> <span class="string">InternetGateway</span></span><br><span class="line"><span class="attr">      VpcId:</span> <span class="type">!Ref</span> <span class="string">VPC</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PublicRouteTable:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::RouteTable</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      VpcId:</span> <span class="type">!Ref</span> <span class="string">VPC</span></span><br><span class="line"><span class="attr">      Tags:</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">Name</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="string">Public</span> <span class="string">Subnets</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">Network</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="string">Public</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PrivateRouteTable01:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::RouteTable</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      VpcId:</span> <span class="type">!Ref</span> <span class="string">VPC</span></span><br><span class="line"><span class="attr">      Tags:</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">Name</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="string">Private</span> <span class="string">Subnet</span> <span class="string">AZ1</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">Network</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="string">Private01</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PrivateRouteTable02:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::RouteTable</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      VpcId:</span> <span class="type">!Ref</span> <span class="string">VPC</span></span><br><span class="line"><span class="attr">      Tags:</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">Name</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="string">Private</span> <span class="string">Subnet</span> <span class="string">AZ2</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">Network</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="string">Private02</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PublicRoute:</span></span><br><span class="line"><span class="attr">    DependsOn:</span> <span class="string">VPCGatewayAttachment</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::Route</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      RouteTableId:</span> <span class="type">!Ref</span> <span class="string">PublicRouteTable</span></span><br><span class="line"><span class="attr">      DestinationCidrBlock:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line"><span class="attr">      GatewayId:</span> <span class="type">!Ref</span> <span class="string">InternetGateway</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PrivateRoute01:</span></span><br><span class="line"><span class="attr">    DependsOn:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">VPCGatewayAttachment</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">NatGateway01</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::Route</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      RouteTableId:</span> <span class="type">!Ref</span> <span class="string">PrivateRouteTable01</span></span><br><span class="line"><span class="attr">      DestinationCidrBlock:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line"><span class="attr">      NatGatewayId:</span> <span class="type">!Ref</span> <span class="string">NatGateway01</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PrivateRoute02:</span></span><br><span class="line"><span class="attr">    DependsOn:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">VPCGatewayAttachment</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">NatGateway02</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::Route</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      RouteTableId:</span> <span class="type">!Ref</span> <span class="string">PrivateRouteTable02</span></span><br><span class="line"><span class="attr">      DestinationCidrBlock:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line"><span class="attr">      NatGatewayId:</span> <span class="type">!Ref</span> <span class="string">NatGateway02</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  NatGateway01:</span></span><br><span class="line"><span class="attr">    DependsOn:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">NatGatewayEIP1</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">PublicSubnet01</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">VPCGatewayAttachment</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::NatGateway</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      AllocationId:</span> <span class="type">!GetAtt</span> <span class="string">'NatGatewayEIP1.AllocationId'</span></span><br><span class="line"><span class="attr">      SubnetId:</span> <span class="type">!Ref</span> <span class="string">PublicSubnet01</span></span><br><span class="line"><span class="attr">      Tags:</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">Name</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="type">!Sub</span> <span class="string">'$&#123;AWS::StackName&#125;-NatGatewayAZ1'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  NatGateway02:</span></span><br><span class="line"><span class="attr">    DependsOn:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">NatGatewayEIP2</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">PublicSubnet02</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">VPCGatewayAttachment</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::NatGateway</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      AllocationId:</span> <span class="type">!GetAtt</span> <span class="string">'NatGatewayEIP2.AllocationId'</span></span><br><span class="line"><span class="attr">      SubnetId:</span> <span class="type">!Ref</span> <span class="string">PublicSubnet02</span></span><br><span class="line"><span class="attr">      Tags:</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">Name</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="type">!Sub</span> <span class="string">'$&#123;AWS::StackName&#125;-NatGatewayAZ2'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  NatGatewayEIP1:</span></span><br><span class="line"><span class="attr">    DependsOn:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">VPCGatewayAttachment</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="string">'AWS::EC2::EIP'</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      Domain:</span> <span class="string">vpc</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  NatGatewayEIP2:</span></span><br><span class="line"><span class="attr">    DependsOn:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">VPCGatewayAttachment</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="string">'AWS::EC2::EIP'</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      Domain:</span> <span class="string">vpc</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PublicSubnet01:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::Subnet</span></span><br><span class="line"><span class="attr">    Metadata:</span></span><br><span class="line"><span class="attr">      Comment:</span> <span class="string">Subnet</span> <span class="number">01</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      MapPublicIpOnLaunch:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      AvailabilityZone:</span></span><br><span class="line"><span class="attr">        Fn:</span><span class="string">:Select:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">'0'</span></span><br><span class="line"><span class="attr">        - Fn:</span><span class="string">:GetAZs:</span></span><br><span class="line"><span class="attr">            Ref:</span> <span class="attr">AWS::Region</span></span><br><span class="line"><span class="attr">      CidrBlock:</span></span><br><span class="line"><span class="attr">        Ref:</span> <span class="string">PublicSubnet01Block</span></span><br><span class="line"><span class="attr">      VpcId:</span></span><br><span class="line"><span class="attr">        Ref:</span> <span class="string">VPC</span></span><br><span class="line"><span class="attr">      Tags:</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">Name</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="type">!Sub</span> <span class="string">"$&#123;AWS::StackName&#125;-PublicSubnet01"</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">kubernetes.io/role/elb</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PublicSubnet02:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::Subnet</span></span><br><span class="line"><span class="attr">    Metadata:</span></span><br><span class="line"><span class="attr">      Comment:</span> <span class="string">Subnet</span> <span class="number">02</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      MapPublicIpOnLaunch:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      AvailabilityZone:</span></span><br><span class="line"><span class="attr">        Fn:</span><span class="string">:Select:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">'1'</span></span><br><span class="line"><span class="attr">        - Fn:</span><span class="string">:GetAZs:</span></span><br><span class="line"><span class="attr">            Ref:</span> <span class="attr">AWS::Region</span></span><br><span class="line"><span class="attr">      CidrBlock:</span></span><br><span class="line"><span class="attr">        Ref:</span> <span class="string">PublicSubnet02Block</span></span><br><span class="line"><span class="attr">      VpcId:</span></span><br><span class="line"><span class="attr">        Ref:</span> <span class="string">VPC</span></span><br><span class="line"><span class="attr">      Tags:</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">Name</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="type">!Sub</span> <span class="string">"$&#123;AWS::StackName&#125;-PublicSubnet02"</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">kubernetes.io/role/elb</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PrivateSubnet01:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::Subnet</span></span><br><span class="line"><span class="attr">    Metadata:</span></span><br><span class="line"><span class="attr">      Comment:</span> <span class="string">Subnet</span> <span class="number">03</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      AvailabilityZone:</span></span><br><span class="line"><span class="attr">        Fn:</span><span class="string">:Select:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">'0'</span></span><br><span class="line"><span class="attr">        - Fn:</span><span class="string">:GetAZs:</span></span><br><span class="line"><span class="attr">            Ref:</span> <span class="attr">AWS::Region</span></span><br><span class="line"><span class="attr">      CidrBlock:</span></span><br><span class="line"><span class="attr">        Ref:</span> <span class="string">PrivateSubnet01Block</span></span><br><span class="line"><span class="attr">      VpcId:</span></span><br><span class="line"><span class="attr">        Ref:</span> <span class="string">VPC</span></span><br><span class="line"><span class="attr">      Tags:</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">Name</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="type">!Sub</span> <span class="string">"$&#123;AWS::StackName&#125;-PrivateSubnet01"</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">kubernetes.io/role/internal-elb</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PrivateSubnet02:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::Subnet</span></span><br><span class="line"><span class="attr">    Metadata:</span></span><br><span class="line"><span class="attr">      Comment:</span> <span class="string">Private</span> <span class="string">Subnet</span> <span class="number">02</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      AvailabilityZone:</span></span><br><span class="line"><span class="attr">        Fn:</span><span class="string">:Select:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">'1'</span></span><br><span class="line"><span class="attr">        - Fn:</span><span class="string">:GetAZs:</span></span><br><span class="line"><span class="attr">            Ref:</span> <span class="attr">AWS::Region</span></span><br><span class="line"><span class="attr">      CidrBlock:</span></span><br><span class="line"><span class="attr">        Ref:</span> <span class="string">PrivateSubnet02Block</span></span><br><span class="line"><span class="attr">      VpcId:</span></span><br><span class="line"><span class="attr">        Ref:</span> <span class="string">VPC</span></span><br><span class="line"><span class="attr">      Tags:</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">Name</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="type">!Sub</span> <span class="string">"$&#123;AWS::StackName&#125;-PrivateSubnet02"</span></span><br><span class="line"><span class="attr">      - Key:</span> <span class="string">kubernetes.io/role/internal-elb</span></span><br><span class="line"><span class="attr">        Value:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PublicSubnet01RouteTableAssociation:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::SubnetRouteTableAssociation</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      SubnetId:</span> <span class="type">!Ref</span> <span class="string">PublicSubnet01</span></span><br><span class="line"><span class="attr">      RouteTableId:</span> <span class="type">!Ref</span> <span class="string">PublicRouteTable</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PublicSubnet02RouteTableAssociation:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::SubnetRouteTableAssociation</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      SubnetId:</span> <span class="type">!Ref</span> <span class="string">PublicSubnet02</span></span><br><span class="line"><span class="attr">      RouteTableId:</span> <span class="type">!Ref</span> <span class="string">PublicRouteTable</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PrivateSubnet01RouteTableAssociation:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::SubnetRouteTableAssociation</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      SubnetId:</span> <span class="type">!Ref</span> <span class="string">PrivateSubnet01</span></span><br><span class="line"><span class="attr">      RouteTableId:</span> <span class="type">!Ref</span> <span class="string">PrivateRouteTable01</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  PrivateSubnet02RouteTableAssociation:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::SubnetRouteTableAssociation</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      SubnetId:</span> <span class="type">!Ref</span> <span class="string">PrivateSubnet02</span></span><br><span class="line"><span class="attr">      RouteTableId:</span> <span class="type">!Ref</span> <span class="string">PrivateRouteTable02</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  ControlPlaneSecurityGroup:</span></span><br><span class="line"><span class="attr">    Type:</span> <span class="attr">AWS::EC2::SecurityGroup</span></span><br><span class="line"><span class="attr">    Properties:</span></span><br><span class="line"><span class="attr">      GroupDescription:</span> <span class="string">Cluster</span> <span class="string">communication</span> <span class="string">with</span> <span class="string">worker</span> <span class="string">nodes</span></span><br><span class="line"><span class="attr">      VpcId:</span> <span class="type">!Ref</span> <span class="string">VPC</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Outputs:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  SubnetIds:</span></span><br><span class="line"><span class="attr">    Description:</span> <span class="string">Subnets</span> <span class="string">IDs</span> <span class="string">in</span> <span class="string">the</span> <span class="string">VPC</span></span><br><span class="line"><span class="attr">    Value:</span> <span class="type">!Join</span> <span class="string">[</span> <span class="string">","</span><span class="string">,</span> <span class="string">[</span> <span class="type">!Ref</span> <span class="string">PublicSubnet01,</span> <span class="type">!Ref</span> <span class="string">PublicSubnet02,</span> <span class="type">!Ref</span> <span class="string">PrivateSubnet01,</span> <span class="type">!Ref</span> <span class="string">PrivateSubnet02</span> <span class="string">]</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  SecurityGroups:</span></span><br><span class="line"><span class="attr">    Description:</span> <span class="string">Security</span> <span class="string">group</span> <span class="string">for</span> <span class="string">the</span> <span class="string">cluster</span> <span class="string">control</span> <span class="string">plane</span> <span class="string">communication</span> <span class="string">with</span> <span class="string">worker</span> <span class="string">nodes</span></span><br><span class="line"><span class="attr">    Value:</span> <span class="type">!Join</span> <span class="string">[</span> <span class="string">","</span><span class="string">,</span> <span class="string">[</span> <span class="type">!Ref</span> <span class="string">ControlPlaneSecurityGroup</span> <span class="string">]</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  VpcId:</span></span><br><span class="line"><span class="attr">    Description:</span> <span class="string">The</span> <span class="string">VPC</span> <span class="string">Id</span></span><br><span class="line"><span class="attr">    Value:</span> <span class="type">!Ref</span> <span class="string">VPC</span></span><br></pre></td></tr></table></figure><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> CloudFormation Template </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS CloudFormation Template </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="2020/12/16/AWS/CloudFormation/CFM-%E6%A6%82%E8%BF%B0-1/"/>
      <url>2020/12/16/AWS/CloudFormation/CFM-%E6%A6%82%E8%BF%B0-1/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>创建EC2 Keypair</title>
      <link href="2020/12/16/AWS/EC2/EC2%E8%84%9A%E6%9C%AC/%E5%88%9B%E5%BB%BAKeyPair/"/>
      <url>2020/12/16/AWS/EC2/EC2%E8%84%9A%E6%9C%AC/%E5%88%9B%E5%BB%BAKeyPair/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-创建EC2-Keypair"><a href="#描述-创建EC2-Keypair" class="headerlink" title="描述: 创建EC2 Keypair"></a>描述: 创建EC2 Keypair</h2><a id="more"></a><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/usr/bin/env bash</span><br><span class="line">set -x</span><br><span class="line"></span><br><span class="line">DEFAULT_REGION=us-east-1</span><br><span class="line">DEFAULT_KEYNAME=mykey</span><br><span class="line"></span><br><span class="line">function usage() &#123;</span><br><span class="line">  echo "Usage:</span><br><span class="line"></span><br><span class="line">./createKeypair.sh -p &lt;profile&gt; [-r &lt;region&gt;] -k &lt;keypair name&gt;</span><br><span class="line">Example:</span><br><span class="line"></span><br><span class="line">  ./createKeypair.sh -p admin -r us-east-1 -k mykey</span><br><span class="line">"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">while getopts "p:r:k:h" opt; do</span><br><span class="line">  case "$opt" in</span><br><span class="line">  p) PROFILE="$OPTARG" ;;</span><br><span class="line">  r) REGION="$OPTARG" </span><br><span class="line">     echo 1;;</span><br><span class="line">  k) KeyName="$OPTARG" ;;</span><br><span class="line">  [?]) usage </span><br><span class="line">     exit 0;;</span><br><span class="line">  esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Check the parameters and configure the necessary information</span><br><span class="line">function checkParameters()&#123;</span><br><span class="line">    if [ -z "$PROFILE" ]; then</span><br><span class="line">        echo "No Profile!!!"</span><br><span class="line">        usage</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line">    if [ -z "$REGION" ]; then</span><br><span class="line">        echo "No Region parameters"</span><br><span class="line">        REGION=$&#123;DEFAULT_REGION&#125;</span><br><span class="line">        echo "Set default region: $&#123;REGION&#125;"</span><br><span class="line">    fi</span><br><span class="line">    if [ -z "$KeyName" ]; then</span><br><span class="line">        echo "Checking keypair.."</span><br><span class="line">        KeyName=$&#123;DEFAULT_KEYNAME&#125;</span><br><span class="line">        echo "Set default keypair name: $&#123;KeyName&#125;"</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">checkParameters</span><br><span class="line"></span><br><span class="line">aws ec2 create-key-pair \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --key-name $&#123;KeyName&#125; \</span><br><span class="line">    --query 'KeyMaterial' \</span><br><span class="line">    --output text &gt; $&#123;KeyName&#125;.pem</span><br></pre></td></tr></table></figure><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> EC2 </category>
          
          <category> 脚本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS EC2 脚本 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>向指定SG的SSH端口添加IP</title>
      <link href="2020/12/15/AWS/EC2/EC2%E8%84%9A%E6%9C%AC/%E5%90%91%E6%8C%87%E5%AE%9ASG%E7%9A%84SSH%E7%AB%AF%E5%8F%A3%E6%B7%BB%E5%8A%A0IP/"/>
      <url>2020/12/15/AWS/EC2/EC2%E8%84%9A%E6%9C%AC/%E5%90%91%E6%8C%87%E5%AE%9ASG%E7%9A%84SSH%E7%AB%AF%E5%8F%A3%E6%B7%BB%E5%8A%A0IP/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-向指定SG的SSH端口添加IP"><a href="#描述-向指定SG的SSH端口添加IP" class="headerlink" title="描述: 向指定SG的SSH端口添加IP"></a>描述: 向指定SG的SSH端口添加IP</h2><a id="more"></a><h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/usr/bin/env bash</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Example1:</span><br><span class="line"><span class="meta">#</span> It will add the your current IP address to specified SG</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> ./Mac/OneClickTools/check_connect.sh -p int-developer</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Example2:</span><br><span class="line"><span class="meta">#</span> It will add the specified IP address and add describe to specified SG</span><br><span class="line"><span class="meta">#</span> Valid descriptions are strings less than 256 characters from the following set:  a-zA-Z0-9. _-:/()#,@[]+=&amp;;&#123;&#125;!$*</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> ./Mac/OneClickTools/check_connect.sh -p int-developer -i 10.20.30.40 -d "home IP" </span><br><span class="line"></span><br><span class="line">REGION=eu-west-1</span><br><span class="line">SECURITYGROUP=sg-056fb9a9bbd306400</span><br><span class="line">USERNAME=$USER</span><br><span class="line">CREATEDATE=`date +%Y-%m-%d`</span><br><span class="line"></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">function usage() &#123;</span><br><span class="line">  echo "Usage:</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span>0 -p &lt;aws_profile&gt; [-i Target IP] [-d Describe]</span><br><span class="line"></span><br><span class="line">Example:</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span>0 -p int-developer -i 10.10.10.10 -d HomeIP</span><br><span class="line"></span><br><span class="line">Example2:</span><br><span class="line"></span><br><span class="line">It will add your current IP to SG</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span>0 -p int-developer</span><br><span class="line">"</span><br><span class="line">  exit 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">while getopts "p:i:d:h" opt; do</span><br><span class="line">  case "$opt" in</span><br><span class="line">  p) PROFILE="$OPTARG" ;;</span><br><span class="line">  i) USERIP="$OPTARG" ;;</span><br><span class="line">  d) DESCRIBE="$OPTARG" ;;</span><br><span class="line">  h) usage ;;</span><br><span class="line">  [?]) usage ;;</span><br><span class="line">  esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">if [ -z "$&#123;PROFILE&#125;" ]; then</span><br><span class="line">    usage</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ -z "$&#123;USERIP&#125;" ]; then</span><br><span class="line">    echo -e "\nThere is no Target IP address, it will add your current IP to SG\n"</span><br><span class="line">    USERIP=$(curl http://checkip.amazonaws.com)</span><br><span class="line">    echo -e "\nYour current IP is $&#123;USERIP&#125;"</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Valid descriptions are strings less than 256 characters from the following set:  a-zA-Z0-9. _-:/()#,@[]+=&amp;;&#123;&#125;!$*</span><br><span class="line">if [ -z "$&#123;DESCRIBE&#125;" ]; then</span><br><span class="line">    echo -e "\nThere is no Describe, it will add your USER Name to SG describe\n"</span><br><span class="line">    DESCRIBE=$USERNAME</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">IPS=$(aws ec2 describe-security-groups \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --group-ids $&#123;SECURITYGROUP&#125; \</span><br><span class="line">    --query 'SecurityGroups[*].IpPermissions[*].IpRanges[*].CidrIp' \</span><br><span class="line">    --output text)</span><br><span class="line"></span><br><span class="line">if ! [[ $&#123;IPS&#125; == *$&#123;USERIP&#125;* ]]; then</span><br><span class="line">    aws ec2 authorize-security-group-ingress \</span><br><span class="line">        --profile $&#123;PROFILE&#125; \</span><br><span class="line">        --region $&#123;REGION&#125; \</span><br><span class="line">        --group-id $&#123;SECURITYGROUP&#125; \</span><br><span class="line">        --ip-permissions IpProtocol=tcp,FromPort=22,ToPort=22,IpRanges="[&#123;CidrIp=$&#123;USERIP&#125;/32,Description=\"$&#123;DESCRIBE&#125;-$&#123;CREATEDATE&#125;\"&#125;]"</span><br><span class="line">    if [ $? = 0 ]; then </span><br><span class="line">        echo "$&#123;USERIP&#125;/32 add into security group successful"</span><br><span class="line">    else</span><br><span class="line">        echo "$&#123;USERIP&#125;/32 add into security group failed. Please check"</span><br><span class="line">    fi</span><br><span class="line">else</span><br><span class="line">    echo "$&#123;USERIP&#125;/32 already exist in security group"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> EC2 </category>
          
          <category> 脚本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS EC2 脚本 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>通过Snapshot恢复脚本</title>
      <link href="2020/12/15/AWS/EC2/EC2%E8%84%9A%E6%9C%AC/%E9%80%9A%E8%BF%87Snapshot%E6%81%A2%E5%A4%8D%E8%84%9A%E6%9C%AC/"/>
      <url>2020/12/15/AWS/EC2/EC2%E8%84%9A%E6%9C%AC/%E9%80%9A%E8%BF%87Snapshot%E6%81%A2%E5%A4%8D%E8%84%9A%E6%9C%AC/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-这是一个通过EBS的snapshot还原Instance的脚本"><a href="#描述-这是一个通过EBS的snapshot还原Instance的脚本" class="headerlink" title="描述: 这是一个通过EBS的snapshot还原Instance的脚本"></a>描述: 这是一个通过EBS的snapshot还原Instance的脚本</h2><a id="more"></a><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 这是一个通过EBS的snapshot还原的脚本</span><br><span class="line"><span class="meta">#</span> 通过寻找具有指定tag的最新的snapshot创建volume</span><br><span class="line"><span class="meta">#</span> 并将旧的volume从EC2上卸下,挂载新的volume,以达到还原的目的</span><br><span class="line"><span class="meta">#</span> 也可以指定snapshot ID和instance ID</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> source ./env.sh</span><br><span class="line"><span class="meta">#</span> env.sh中包含默认的Name变量,用于指定Name</span><br><span class="line"></span><br><span class="line">function usage() &#123;</span><br><span class="line">  echo "Usage:</span><br><span class="line"></span><br><span class="line">./recovery.sh -p &lt;profile&gt; [-r &lt;region&gt;] [-s &lt;snapshotID&gt;] [-i &lt;instanceID&gt;]</span><br><span class="line"></span><br><span class="line">Example:</span><br><span class="line"></span><br><span class="line">  ./recovery.sh -p &lt;profile&gt;</span><br><span class="line">"</span><br><span class="line">  exit 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">while getopts "p:r:s:i:h" opt; do</span><br><span class="line">  case "$opt" in</span><br><span class="line">  p) PROFILE="$OPTARG" ;;</span><br><span class="line">  r) REGION="$OPTARG" ;;</span><br><span class="line">  s) SnapshotId="$OPTARG" ;;</span><br><span class="line">  i) InstanceId="$OPTARG" ;;</span><br><span class="line">  [?]) usage ;;</span><br><span class="line">  esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Check the parameters and configure the necessary informations</span><br><span class="line">function checkParameters()&#123;</span><br><span class="line">    if [ -z "$PROFILE" ]; then</span><br><span class="line">        echo "No Profile!!!"</span><br><span class="line">        usage</span><br><span class="line">    fi</span><br><span class="line">    if [ -z "$REGION" ]; then</span><br><span class="line">        echo "No Region parameters"</span><br><span class="line">        REGION=us-east-1</span><br><span class="line">        echo "Set default region: $&#123;REGION&#125;"</span><br><span class="line">    fi</span><br><span class="line">    if [ -z "$SnapshotId" ]; then</span><br><span class="line">        echo "No SnapshotId parameters"</span><br><span class="line">        getLatestSnapshot</span><br><span class="line">        echo "Get SnapshotId: $&#123;SnapshotId&#125;"</span><br><span class="line">    fi</span><br><span class="line">    if [ -z "$InstanceId" ]; then</span><br><span class="line">        echo "No InstanceId parameters"</span><br><span class="line">        getInstanceINFO</span><br><span class="line">        echo "Get InstanceId: $&#123;InstanceId&#125;"</span><br><span class="line">    else</span><br><span class="line">        echo "InstanceId: $&#123;InstanceId&#125;"</span><br><span class="line">        getInstanceINFOById</span><br><span class="line">    fi</span><br><span class="line">    echo "------------------------"</span><br><span class="line">    echo ""</span><br><span class="line">    echo "InstanceId: $&#123;InstanceId&#125;"</span><br><span class="line">    echo "OldVolumeId: $&#123;OldVolumeId&#125;"</span><br><span class="line">    echo "AvailabilityZone: $&#123;AvailabilityZone&#125;"</span><br><span class="line">    echo "SnapshotId: $&#123;SnapshotId&#125;"</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Get Snapshot ID</span><br><span class="line">function getLatestSnapshot()</span><br><span class="line">&#123;</span><br><span class="line">    SnapshotId=$(aws ec2 describe-snapshots \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --filters "Name=tag:Name,Values=$&#123;Name&#125;" \</span><br><span class="line">    --query 'reverse(sort_by(Snapshots,&amp;StartTime))[0].[SnapshotId]' \</span><br><span class="line">    --output text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Get instance ID, OldVolumeId and AvailabilityZone</span><br><span class="line">function getInstanceINFO()</span><br><span class="line">&#123;</span><br><span class="line">    InstanceINFO=($(aws ec2 describe-instances \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --filters "Name=tag:Name,Values=$&#123;Name&#125;" \</span><br><span class="line">    --query 'Reservations[*].Instances[*].[InstanceId,BlockDeviceMappings[*].Ebs.VolumeId,Placement.AvailabilityZone]' \</span><br><span class="line">    --output text))</span><br><span class="line"></span><br><span class="line">    InstanceId=$&#123;InstanceINFO[0]&#125;</span><br><span class="line">    AvailabilityZone=$&#123;InstanceINFO[1]&#125;</span><br><span class="line">    OldVolumeId=$&#123;InstanceINFO[2]&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Get OldVolumeId and AvailabilityZone by instance ID</span><br><span class="line">function getInstanceINFOById()</span><br><span class="line">&#123;</span><br><span class="line">    InstanceINFO=($(aws ec2 describe-instances \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --instance-ids $&#123;InstanceID&#125;</span><br><span class="line">    --query 'Reservations[*].Instances[*].[InstanceId,BlockDeviceMappings[*].Ebs.VolumeId,Placement.AvailabilityZone]' \</span><br><span class="line">    --output text))</span><br><span class="line"></span><br><span class="line">    InstanceId=$&#123;InstanceINFO[0]&#125;</span><br><span class="line">    AvailabilityZone=$&#123;InstanceINFO[1]&#125;</span><br><span class="line">    OldVolumeId=$&#123;InstanceINFO[2]&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">checkParameters</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Create new volume from latest snapshot</span><br><span class="line">echo "Creating new volume..."</span><br><span class="line">NewVolumeId=$(aws ec2 create-volume \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --snapshot-id $&#123;SnapshotId&#125; \</span><br><span class="line">    --availability-zone $&#123;AvailabilityZone&#125; \</span><br><span class="line">    --query 'VolumeId' \</span><br><span class="line">    --tag-specifications "ResourceType=volume,Tags=[ \</span><br><span class="line">        &#123;Key=Team,Value=$&#123;Team&#125;&#125;,&#123;Key=Department,Value=$&#123;Department&#125;&#125;, \</span><br><span class="line">        &#123;Key=Name,Value=$&#123;Name&#125;&#125;,&#123;Key=Environment,Value=$&#123;Environment&#125;&#125;]" \</span><br><span class="line">    --output text)</span><br><span class="line"></span><br><span class="line">echo "NewVolumeId: $&#123;NewVolumeId&#125;"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Stop sentry server</span><br><span class="line">echo "Stop sentry server..."</span><br><span class="line">aws ec2 stop-instances \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --instance-ids $&#123;InstanceId&#125;</span><br><span class="line"></span><br><span class="line">echo "Waiting instance server stop..."</span><br><span class="line">aws ec2 wait instance-stopped \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --instance-ids $&#123;InstanceId&#125;</span><br><span class="line"></span><br><span class="line">echo "Waiting volume available..."</span><br><span class="line">aws ec2 wait volume-available \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --volume-ids $&#123;NewVolumeId&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Deatch old volume from instance</span><br><span class="line">echo "Deatch old volume..."</span><br><span class="line">aws ec2 detach-volume \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --instance-id $&#123;InstanceId&#125; \</span><br><span class="line">    --volume-id $&#123;OldVolumeId&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> attatch new volume from instance</span><br><span class="line">echo "Attach new volume..."</span><br><span class="line">aws ec2 attach-volume \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --volume-id $&#123;NewVolumeId&#125; \</span><br><span class="line">    --instance-id $&#123;InstanceId&#125; \</span><br><span class="line">    --device /dev/sda1</span><br><span class="line"></span><br><span class="line">echo "Waiting volume in-use..."</span><br><span class="line">aws ec2 wait volume-in-use \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --volume-ids $&#123;NewVolumeId&#125;</span><br><span class="line"></span><br><span class="line">echo "Start instance server..."</span><br><span class="line">aws ec2 start-instances \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --instance-ids $&#123;InstanceId&#125;</span><br><span class="line"></span><br><span class="line">echo "Waiting instance server status-ok..."</span><br><span class="line">aws ec2 wait instance-status-ok \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --instance-ids $&#123;InstanceId&#125;</span><br><span class="line"></span><br><span class="line">read -r -p "Do you want to delete old volume?(Default No) [Y/n] " input</span><br><span class="line">echo </span><br><span class="line">case $input in</span><br><span class="line">    [yY][eE][sS]|[yY])</span><br><span class="line">        aws ec2 delete-volume \</span><br><span class="line">            --profile $&#123;PROFILE&#125; \</span><br><span class="line">            --region $&#123;REGION&#125; \</span><br><span class="line">            --volume-id $&#123;OldVolumeId&#125;</span><br><span class="line">        echo "Deleted old volume"</span><br><span class="line">        ;;</span><br><span class="line"></span><br><span class="line">    [nN][oO]|[nN])</span><br><span class="line">        echo "Keep the old volume: $&#123;OldVolumeId&#125;"       </span><br><span class="line">        ;;</span><br><span class="line"></span><br><span class="line">    *)</span><br><span class="line">        echo "Keep the old volume: $&#123;OldVolumeId&#125;"</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">echo "Everything is OK!!"</span><br></pre></td></tr></table></figure><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> EC2 </category>
          
          <category> 脚本 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS EC2 脚本 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AWS 导航链接</title>
      <link href="2020/12/15/AWS/AWS%E5%AF%BC%E8%88%AA%E9%93%BE%E6%8E%A5/"/>
      <url>2020/12/15/AWS/AWS%E5%AF%BC%E8%88%AA%E9%93%BE%E6%8E%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-记录AWS常用的网址"><a href="#描述-记录AWS常用的网址" class="headerlink" title="描述: 记录AWS常用的网址"></a>描述: 记录AWS常用的网址</h2><a id="more"></a><p>SLA(Service Level AAgreement): <a href="https://aws.amazon.com/cn/legal/service-level-agreements/" target="_blank" rel="noopener">https://aws.amazon.com/cn/legal/service-level-agreements/</a></p><p>AWS CLIV1: <a href="https://docs.aws.amazon.com/cli/latest/reference/index.html" target="_blank" rel="noopener">https://docs.aws.amazon.com/cli/latest/reference/index.html</a></p><p>AWS CLIV2: <a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/index.html" target="_blank" rel="noopener">https://awscli.amazonaws.com/v2/documentation/api/latest/reference/index.html</a></p><p>AWS 文档: <a href="https://docs.aws.amazon.com/index.html" target="_blank" rel="noopener">https://docs.aws.amazon.com/index.html</a></p><p>AWS 定价: <a href="https://amazonaws-china.com/cn/pricing/?nc2=h_ql_pr_ln" target="_blank" rel="noopener">https://amazonaws-china.com/cn/pricing/?nc2=h_ql_pr_ln</a></p><p>AWS EC2价格: <a href="https://amazonaws-china.com/cn/ec2/pricing/on-demand/" target="_blank" rel="noopener">https://amazonaws-china.com/cn/ec2/pricing/on-demand/</a></p><p>AWS 知识中心: <a href="https://amazonaws-china.com/cn/premiumsupport/knowledge-center/" target="_blank" rel="noopener">https://amazonaws-china.com/cn/premiumsupport/knowledge-center/</a></p><p>AWS 博客: <a href="https://amazonaws-china.com/cn/blogs/china/all/" target="_blank" rel="noopener">https://amazonaws-china.com/cn/blogs/china/all/</a></p><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AWS-S3-5-S3博客</title>
      <link href="2020/12/13/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/S3/AWS-S3-5-S3%E5%8D%9A%E5%AE%A2/"/>
      <url>2020/12/13/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/S3/AWS-S3-5-S3%E5%8D%9A%E5%AE%A2/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-AWS-S3相关的博客"><a href="#描述-AWS-S3相关的博客" class="headerlink" title="描述: AWS S3相关的博客"></a>描述: AWS S3相关的博客</h2><a id="more"></a><ol><li><a href="https://aws.amazon.com/cn/blogs/storage/encrypting-existing-amazon-s3-objects-with-the-aws-cli/" target="_blank" rel="noopener">通过AWS CLI加密现有的S3对象</a></li><li><a href="https://aws.amazon.com/cn/blogs/storage/changing-your-amazon-s3-encryption-from-s3-managed-encryption-sse-s3-to-aws-key-management-service-sse-kms/" target="_blank" rel="noopener">将Amazon S3加密从S3-Managed更改为AWS KMS</a></li><li><a href="https://aws.amazon.com/cn/premiumsupport/knowledge-center/s3-object-encrpytion-keys/" target="_blank" rel="noopener">我该使用 AWS KMS 管理的密钥还是自定义 AWS KMS 密钥来加密 Amazon S3 中的对象</a></li><li><a href="https://aws.amazon.com/cn/blogs/security/how-to-restrict-amazon-s3-bucket-access-to-a-specific-iam-role/" target="_blank" rel="noopener">如何将 Amazon S3 存储桶访问权限限制为特定 IAM 角色</a></li><li><a href="https://aws.amazon.com/cn/blogs/storage/encrypting-objects-with-amazon-s3-batch-operations/" target="_blank" rel="noopener">使用Amazon S3批处理操作加密对象</a></li><li><a href="https://aws.amazon.com/cn/premiumsupport/knowledge-center/s3-multipart-upload-cli/" target="_blank" rel="noopener">分段上传</a></li><li><a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/CopyingObjctsUsingLLJavaMPUapi.html" target="_blank" rel="noopener">Java使用分段上传大于5GG的对象</a></li></ol><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> 存储类 </category>
          
          <category> S3 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> S3 Article </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AWS CLI(5)常见问题</title>
      <link href="2020/12/13/AWS/CLI/AWS-CLI-5-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/"/>
      <url>2020/12/13/AWS/CLI/AWS-CLI-5-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>描述: AWS CLI的常见问题</p><a id="more"></a><h3 id="使用-–debug-选项"><a href="#使用-–debug-选项" class="headerlink" title="使用 –debug 选项"></a>使用 –debug 选项</h3><p>当 AWS CLI 报告一个你不能立即理解的错误，或者产生你不期望的结果时，首先要做的是获得关于该错误的更多详细信息。通过再次运行该命令并在命令行末尾包含 –debug 选项，即可完成此操作。这会使 AWS CLI 报告有关完成以下过程所需的每个步骤的详细信息：处理命令、将请求发送到 AWS 服务器、接收响应并将响应处理为你所看到的输出。输出中的详细信息可帮助你确定发生错误的步骤，以及获得有关是什么触发错误的线索的上下文。  </p><p>可以将输出发送到一个要捕获它的文本文件以供日后查看，或者按要求将输出发送给 AWS 技术支持。</p><details><summary><strong>不使用 `--debug` 选项运行命令的示例</strong></summary><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">aws iam list-groups --profile MyTestProfile</span><br><span class="line">&#123;</span><br><span class="line">    "Groups": [</span><br><span class="line">        &#123;</span><br><span class="line">            "Path": "/",</span><br><span class="line">            "GroupName": "MyTestGroup",</span><br><span class="line">            "GroupId": "AGPA0123456789EXAMPLE",</span><br><span class="line">            "Arn": "arn:aws:iam::123456789012:group/MyTestGroup",</span><br><span class="line">            "CreateDate": "2019-08-12T19:34:04Z"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><details><summary><strong>使用 `--debug` 选项运行命令的示例</strong></summary><p>当包含 –debug 选项时，详细信息包括（或其他）：</p><ul><li>查找凭证</li><li>解析提供的参数</li><li>构建发送到 AWS 服务器的请求</li><li>发送到 AWS 的请求的内容</li><li>原始响应的内容</li><li>带格式的输出</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">aws iam list-groups --profile MyTestProfile --debug</span><br><span class="line">2019-08-12 12:36:18,305 - MainThread - awscli.clidriver - DEBUG - CLI version: aws-cli/1.16.215 Python/3.7.3 Linux/4.14.133-113.105.amzn2.x86_64 botocore/1.12.205</span><br><span class="line">2019-08-12 12:36:18,305 - MainThread - awscli.clidriver - DEBUG - Arguments entered to CLI: ['iam', 'list-groups', '--debug']</span><br><span class="line">2019-08-12 12:36:18,305 - MainThread - botocore.hooks - DEBUG - Event session-initialized: calling handler &lt;function add_scalar_parsers at 0x7fdf173161e0&gt;</span><br><span class="line">2019-08-12 12:36:18,305 - MainThread - botocore.hooks - DEBUG - Event session-initialized: calling handler &lt;function register_uri_param_handler at 0x7fdf17dec400&gt;</span><br><span class="line">2019-08-12 12:36:18,305 - MainThread - botocore.hooks - DEBUG - Event session-initialized: calling handler &lt;function inject_assume_role_provider_cache at 0x7fdf17da9378&gt;</span><br><span class="line">2019-08-12 12:36:18,307 - MainThread - botocore.credentials - DEBUG - Skipping environment variable credential check because profile name was explicitly set.</span><br><span class="line">2019-08-12 12:36:18,307 - MainThread - botocore.hooks - DEBUG - Event session-initialized: calling handler &lt;function attach_history_handler at 0x7fdf173ed9d8&gt;</span><br><span class="line">2019-08-12 12:36:18,308 - MainThread - botocore.loaders - DEBUG - Loading JSON file: /home/ec2-user/venv/lib/python3.7/site-packages/botocore/data/iam/2010-05-08/service-2.json</span><br><span class="line">2019-08-12 12:36:18,317 - MainThread - botocore.hooks - DEBUG - Event building-command-table.iam: calling handler &lt;function add_waiters at 0x7fdf1731a840&gt;</span><br><span class="line">2019-08-12 12:36:18,320 - MainThread - botocore.loaders - DEBUG - Loading JSON file: /home/ec2-user/venv/lib/python3.7/site-packages/botocore/data/iam/2010-05-08/waiters-2.json</span><br><span class="line">2019-08-12 12:36:18,321 - MainThread - awscli.clidriver - DEBUG - OrderedDict([('path-prefix', &lt;awscli.arguments.CLIArgument object at 0x7fdf171ac780&gt;), ('marker', &lt;awscli.arguments.CLIArgument object at 0x7fdf171b09e8&gt;), ('max-items', &lt;awscli.arguments.CLIArgument object at 0x7fdf171b09b0&gt;)])</span><br><span class="line">2019-08-12 12:36:18,322 - MainThread - botocore.hooks - DEBUG - Event building-argument-table.iam.list-groups: calling handler &lt;function add_streaming_output_arg at 0x7fdf17316510&gt;</span><br><span class="line">2019-08-12 12:36:18,322 - MainThread - botocore.hooks - DEBUG - Event building-argument-table.iam.list-groups: calling handler &lt;function add_cli_input_json at 0x7fdf17da9d90&gt;</span><br><span class="line">2019-08-12 12:36:18,322 - MainThread - botocore.hooks - DEBUG - Event building-argument-table.iam.list-groups: calling handler &lt;function unify_paging_params at 0x7fdf17328048&gt;</span><br><span class="line">2019-08-12 12:36:18,326 - MainThread - botocore.loaders - DEBUG - Loading JSON file: /home/ec2-user/venv/lib/python3.7/site-packages/botocore/data/iam/2010-05-08/paginators-1.json</span><br><span class="line">2019-08-12 12:36:18,326 - MainThread - awscli.customizations.paginate - DEBUG - Modifying paging parameters for operation: ListGroups</span><br><span class="line">2019-08-12 12:36:18,326 - MainThread - botocore.hooks - DEBUG - Event building-argument-table.iam.list-groups: calling handler &lt;function add_generate_skeleton at 0x7fdf1737eae8&gt;</span><br><span class="line">2019-08-12 12:36:18,326 - MainThread - botocore.hooks - DEBUG - Event before-building-argument-table-parser.iam.list-groups: calling handler &lt;bound method OverrideRequiredArgsArgument.override_required_args of &lt;awscli.customizations.cliinputjson.CliInputJSONArgument object at 0x7fdf171b0a58&gt;&gt;</span><br><span class="line">2019-08-12 12:36:18,327 - MainThread - botocore.hooks - DEBUG - Event before-building-argument-table-parser.iam.list-groups: calling handler &lt;bound method GenerateCliSkeletonArgument.override_required_args of &lt;awscli.customizations.generatecliskeleton.GenerateCliSkeletonArgument object at 0x7fdf171c5978&gt;&gt;</span><br><span class="line">2019-08-12 12:36:18,327 - MainThread - botocore.hooks - DEBUG - Event operation-args-parsed.iam.list-groups: calling handler functools.partial(&lt;function check_should_enable_pagination at 0x7fdf17328158&gt;, ['marker', 'max-items'], &#123;'max-items': &lt;awscli.arguments.CLIArgument object at 0x7fdf171b09b0&gt;&#125;, OrderedDict([('path-prefix', &lt;awscli.arguments.CLIArgument object at 0x7fdf171ac780&gt;), ('marker', &lt;awscli.arguments.CLIArgument object at 0x7fdf171b09e8&gt;), ('max-items', &lt;awscli.customizations.paginate.PageArgument object at 0x7fdf171c58d0&gt;), ('cli-input-json', &lt;awscli.customizations.cliinputjson.CliInputJSONArgument object at 0x7fdf171b0a58&gt;), ('starting-token', &lt;awscli.customizations.paginate.PageArgument object at 0x7fdf171b0a20&gt;), ('page-size', &lt;awscli.customizations.paginate.PageArgument object at 0x7fdf171c5828&gt;), ('generate-cli-skeleton', &lt;awscli.customizations.generatecliskeleton.GenerateCliSkeletonArgument object at 0x7fdf171c5978&gt;)]))</span><br><span class="line">2019-08-12 12:36:18,328 - MainThread - botocore.hooks - DEBUG - Event load-cli-arg.iam.list-groups.path-prefix: calling handler &lt;awscli.paramfile.URIArgumentHandler object at 0x7fdf1725c978&gt;</span><br><span class="line">2019-08-12 12:36:18,328 - MainThread - botocore.hooks - DEBUG - Event load-cli-arg.iam.list-groups.marker: calling handler &lt;awscli.paramfile.URIArgumentHandler object at 0x7fdf1725c978&gt;</span><br><span class="line">2019-08-12 12:36:18,328 - MainThread - botocore.hooks - DEBUG - Event load-cli-arg.iam.list-groups.max-items: calling handler &lt;awscli.paramfile.URIArgumentHandler object at 0x7fdf1725c978&gt;</span><br><span class="line">2019-08-12 12:36:18,328 - MainThread - botocore.hooks - DEBUG - Event load-cli-arg.iam.list-groups.cli-input-json: calling handler &lt;awscli.paramfile.URIArgumentHandler object at 0x7fdf1725c978&gt;</span><br><span class="line">2019-08-12 12:36:18,328 - MainThread - botocore.hooks - DEBUG - Event load-cli-arg.iam.list-groups.starting-token: calling handler &lt;awscli.paramfile.URIArgumentHandler object at 0x7fdf1725c978&gt;</span><br><span class="line">2019-08-12 12:36:18,328 - MainThread - botocore.hooks - DEBUG - Event load-cli-arg.iam.list-groups.page-size: calling handler &lt;awscli.paramfile.URIArgumentHandler object at 0x7fdf1725c978&gt;</span><br><span class="line">2019-08-12 12:36:18,328 - MainThread - botocore.hooks - DEBUG - Event load-cli-arg.iam.list-groups.generate-cli-skeleton: calling handler &lt;awscli.paramfile.URIArgumentHandler object at 0x7fdf1725c978&gt;</span><br><span class="line">2019-08-12 12:36:18,329 - MainThread - botocore.hooks - DEBUG - Event calling-command.iam.list-groups: calling handler &lt;bound method CliInputJSONArgument.add_to_call_parameters of &lt;awscli.customizations.cliinputjson.CliInputJSONArgument object at 0x7fdf171b0a58&gt;&gt;</span><br><span class="line">2019-08-12 12:36:18,329 - MainThread - botocore.hooks - DEBUG - Event calling-command.iam.list-groups: calling handler &lt;bound method GenerateCliSkeletonArgument.generate_json_skeleton of &lt;awscli.customizations.generatecliskeleton.GenerateCliSkeletonArgument object at 0x7fdf171c5978&gt;&gt;</span><br><span class="line">2019-08-12 12:36:18,329 - MainThread - botocore.credentials - DEBUG - Looking for credentials via: assume-role</span><br><span class="line">2019-08-12 12:36:18,329 - MainThread - botocore.credentials - DEBUG - Looking for credentials via: assume-role-with-web-identity</span><br><span class="line">2019-08-12 12:36:18,329 - MainThread - botocore.credentials - DEBUG - Looking for credentials via: shared-credentials-file</span><br><span class="line">2019-08-12 12:36:18,329 - MainThread - botocore.credentials - INFO - Found credentials in shared credentials file: ~/.aws/credentials</span><br><span class="line">2019-08-12 12:36:18,330 - MainThread - botocore.loaders - DEBUG - Loading JSON file: /home/ec2-user/venv/lib/python3.7/site-packages/botocore/data/endpoints.json</span><br><span class="line">2019-08-12 12:36:18,334 - MainThread - botocore.hooks - DEBUG - Event choose-service-name: calling handler &lt;function handle_service_name_alias at 0x7fdf1898eb70&gt;</span><br><span class="line">2019-08-12 12:36:18,337 - MainThread - botocore.hooks - DEBUG - Event creating-client-class.iam: calling handler &lt;function add_generate_presigned_url at 0x7fdf18a028c8&gt;</span><br><span class="line">2019-08-12 12:36:18,337 - MainThread - botocore.regions - DEBUG - Using partition endpoint for iam, us-west-2: aws-global</span><br><span class="line">2019-08-12 12:36:18,337 - MainThread - botocore.args - DEBUG - The s3 config key is not a dictionary type, ignoring its value of: None</span><br><span class="line">2019-08-12 12:36:18,340 - MainThread - botocore.endpoint - DEBUG - Setting iam timeout as (60, 60)</span><br><span class="line">2019-08-12 12:36:18,341 - MainThread - botocore.loaders - DEBUG - Loading JSON file: /home/ec2-user/venv/lib/python3.7/site-packages/botocore/data/_retry.json</span><br><span class="line">2019-08-12 12:36:18,341 - MainThread - botocore.client - DEBUG - Registering retry handlers for service: iam</span><br><span class="line">2019-08-12 12:36:18,342 - MainThread - botocore.hooks - DEBUG - Event before-parameter-build.iam.ListGroups: calling handler &lt;function generate_idempotent_uuid at 0x7fdf189b10d0&gt;</span><br><span class="line">2019-08-12 12:36:18,342 - MainThread - botocore.hooks - DEBUG - Event before-call.iam.ListGroups: calling handler &lt;function inject_api_version_header_if_needed at 0x7fdf189b2a60&gt;</span><br><span class="line">2019-08-12 12:36:18,343 - MainThread - botocore.endpoint - DEBUG - Making request for OperationModel(name=ListGroups) with params: &#123;'url_path': '/', 'query_string': '', 'method': 'POST', 'headers': &#123;'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8', 'User-Agent': 'aws-cli/1.16.215 Python/3.7.3 Linux/4.14.133-113.105.amzn2.x86_64 botocore/1.12.205'&#125;, 'body': &#123;'Action': 'ListGroups', 'Version': '2010-05-08'&#125;, 'url': 'https://iam.amazonaws.com/', 'context': &#123;'client_region': 'aws-global', 'client_config': &lt;botocore.config.Config object at 0x7fdf16e9a4a8&gt;, 'has_streaming_input': False, 'auth_type': None&#125;&#125;</span><br><span class="line">2019-08-12 12:36:18,343 - MainThread - botocore.hooks - DEBUG - Event request-created.iam.ListGroups: calling handler &lt;bound method RequestSigner.handler of &lt;botocore.signers.RequestSigner object at 0x7fdf16e9a470&gt;&gt;</span><br><span class="line">2019-08-12 12:36:18,343 - MainThread - botocore.hooks - DEBUG - Event choose-signer.iam.ListGroups: calling handler &lt;function set_operation_specific_signer at 0x7fdf18996f28&gt;</span><br><span class="line">2019-08-12 12:36:18,343 - MainThread - botocore.auth - DEBUG - Calculating signature using v4 auth.</span><br><span class="line">2019-08-12 12:36:18,343 - MainThread - botocore.auth - DEBUG - CanonicalRequest:</span><br><span class="line">POST</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">content-type:application/x-www-form-urlencoded; charset=utf-8</span><br><span class="line">host:iam.amazonaws.com</span><br><span class="line">x-amz-date:20190812T193618Z</span><br><span class="line"></span><br><span class="line">content-type;host;x-amz-date</span><br><span class="line">5f776d91EXAMPLE9b8cb5eb5d6d4a787a33ae41c8cd6eEXAMPLEca69080e1e1f</span><br><span class="line">2019-08-12 12:36:18,344 - MainThread - botocore.auth - DEBUG - StringToSign:</span><br><span class="line">AWS4-HMAC-SHA256</span><br><span class="line">20190812T193618Z</span><br><span class="line">20190812/us-east-1/iam/aws4_request</span><br><span class="line">ab7e367eEXAMPLE2769f178ea509978cf8bfa054874b3EXAMPLE8d043fab6cc9</span><br><span class="line">2019-08-12 12:36:18,344 - MainThread - botocore.auth - DEBUG - Signature:</span><br><span class="line">d85a0EXAMPLEb40164f2f539cdc76d4f294fe822EXAMPLE18ad1ddf58a1a3ce7</span><br><span class="line">2019-08-12 12:36:18,344 - MainThread - botocore.endpoint - DEBUG - Sending http request: &lt;AWSPreparedRequest stream_output=False, method=POST, url=https://iam.amazonaws.com/, headers=&#123;'Content-Type': b'application/x-www-form-urlencoded; charset=utf-8', 'User-Agent': b'aws-cli/1.16.215 Python/3.7.3 Linux/4.14.133-113.105.amzn2.x86_64 botocore/1.12.205', 'X-Amz-Date': b'20190812T193618Z', 'Authorization': b'AWS4-HMAC-SHA256 Credential=AKIA01234567890EXAMPLE-east-1/iam/aws4_request, SignedHeaders=content-type;host;x-amz-date, Signature=d85a07692aceb401EXAMPLEa1b18ad1ddf58a1a3ce7EXAMPLE', 'Content-Length': '36'&#125;&gt;</span><br><span class="line">2019-08-12 12:36:18,344 - MainThread - urllib3.util.retry - DEBUG - Converted retries value: False -&gt; Retry(total=False, connect=None, read=None, redirect=0, status=None)</span><br><span class="line">2019-08-12 12:36:18,344 - MainThread - urllib3.connectionpool - DEBUG - Starting new HTTPS connection (1): iam.amazonaws.com:443</span><br><span class="line">2019-08-12 12:36:18,664 - MainThread - urllib3.connectionpool - DEBUG - https://iam.amazonaws.com:443 "POST / HTTP/1.1" 200 570</span><br><span class="line">2019-08-12 12:36:18,664 - MainThread - botocore.parsers - DEBUG - Response headers: &#123;'x-amzn-RequestId': '74c11606-bd38-11e9-9c82-559da0adb349', 'Content-Type': 'text/xml', 'Content-Length': '570', 'Date': 'Mon, 12 Aug 2019 19:36:18 GMT'&#125;</span><br><span class="line">2019-08-12 12:36:18,664 - MainThread - botocore.parsers - DEBUG - Response body:</span><br><span class="line">b'&lt;ListGroupsResponse xmlns="https://iam.amazonaws.com/doc/2010-05-08/"&gt;\n  &lt;ListGroupsResult&gt;\n    &lt;IsTruncated&gt;false&lt;/IsTruncated&gt;\n    &lt;Groups&gt;\n      &lt;member&gt;\n        &lt;Path&gt;/&lt;/Path&gt;\n        &lt;GroupName&gt;MyTestGroup&lt;/GroupName&gt;\n        &lt;Arn&gt;arn:aws:iam::123456789012:group/MyTestGroup&lt;/Arn&gt;\n        &lt;GroupId&gt;AGPA1234567890EXAMPLE&lt;/GroupId&gt;\n        &lt;CreateDate&gt;2019-08-12T19:34:04Z&lt;/CreateDate&gt;\n      &lt;/member&gt;\n    &lt;/Groups&gt;\n  &lt;/ListGroupsResult&gt;\n  &lt;ResponseMetadata&gt;\n    &lt;RequestId&gt;74c11606-bd38-11e9-9c82-559da0adb349&lt;/RequestId&gt;\n  &lt;/ResponseMetadata&gt;\n&lt;/ListGroupsResponse&gt;\n'</span><br><span class="line">2019-08-12 12:36:18,665 - MainThread - botocore.hooks - DEBUG - Event needs-retry.iam.ListGroups: calling handler &lt;botocore.retryhandler.RetryHandler object at 0x7fdf16e9a780&gt;</span><br><span class="line">2019-08-12 12:36:18,665 - MainThread - botocore.retryhandler - DEBUG - No retry needed.</span><br><span class="line">2019-08-12 12:36:18,665 - MainThread - botocore.hooks - DEBUG - Event after-call.iam.ListGroups: calling handler &lt;function json_decode_policies at 0x7fdf189b1d90&gt;</span><br><span class="line">&#123;</span><br><span class="line">    "Groups": [</span><br><span class="line">        &#123;</span><br><span class="line">            "Path": "/",</span><br><span class="line">            "GroupName": "MyTestGroup",</span><br><span class="line">            "GroupId": "AGPA123456789012EXAMPLE",</span><br><span class="line">            "Arn": "arn:aws:iam::123456789012:group/MyTestGroup",</span><br><span class="line">            "CreateDate": "2019-08-12T19:34:04Z"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><h3 id="运行-aws-时收到“找不到命令”错误"><a href="#运行-aws-时收到“找不到命令”错误" class="headerlink" title="运行 aws 时收到“找不到命令”错误"></a>运行 aws 时收到“找不到命令”错误</h3><p><strong>可能的原因：安装期间未更新操作系统“路径”</strong></p><p>此错误意味着操作系统找不到 AWS CLI 程序。安装可能不完整。</p><p>如果使用 pip 安装 AWS CLI，可能需要将包含 aws 程序的文件夹添加到操作系统的 PATH 环境变量，或更改其模式以使其可执行。</p><p>需要将 aws 可执行文件添加到操作系统的 PATH 环境变量中。按照相应过程中的步骤操作：</p><ul><li>Windows – <a href="https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/install-windows.html#awscli-install-windows-path" target="_blank" rel="noopener">将 AWS CLI 版本 1 可执行文件添加到命令行路径</a></li><li>macOS – <a href="https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/install-macos.html#awscli-install-osx-path" target="_blank" rel="noopener">将 AWS CLI 版本 1 可执行文件添加到 macOS 命令行路径</a></li><li>Linux – <a href="https://docs.aws.amazon.com/zh_cn/cli/latest/userguide/install-linux.html#install-linux-path" target="_blank" rel="noopener">将 AWS CLI 版本 1 可执行文件添加到命令行路径</a></li></ul><h3 id="“拒绝访问”错误"><a href="#“拒绝访问”错误" class="headerlink" title="“拒绝访问”错误"></a>“拒绝访问”错误</h3><p><strong>可能的原因：AWS CLI 程序文件没有“运行”权限</strong></p><p>在 Linux 或 macOS 上，确保 aws 程序具有调用用户的运行权限。通常，权限设置为 755。</p><p>要添加用户的运行权限，请运行以下命令，并将 ~/.local/bin/aws 替换为计算机上指向此程序的路径。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ chmod +x ~/.local/bin/aws</span><br></pre></td></tr></table></figure><h3 id="“凭证无效”错误"><a href="#“凭证无效”错误" class="headerlink" title="“凭证无效”错误"></a>“凭证无效”错误</h3><p><strong>可能的原因：AWS CLI 从意外位置读取了凭证</strong></p><p>AWS CLI 读取凭证的位置可能与预期不同。可以运行 aws configure list 以确认使用哪些凭证。</p><p>以下示例说明如何检查用于默认配置文件的凭证。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ aws configure list</span><br><span class="line">      Name                    Value             Type    Location</span><br><span class="line">      ----                    -----             ----    --------</span><br><span class="line">   profile                &lt;not set&gt;             None    None</span><br><span class="line">access_key     ****************XYVA shared-credentials-file</span><br><span class="line">secret_key     ****************ZAGY shared-credentials-file</span><br><span class="line">    region                us-west-2      config-file    ~/.aws/config</span><br></pre></td></tr></table></figure><p>以下示例说明如何检查命名配置文件的凭证。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ aws configure list --profile saanvi</span><br><span class="line">      Name                    Value             Type    Location</span><br><span class="line">      ----                    -----             ----    --------</span><br><span class="line">   profile                    saanvi           manual    --profile</span><br><span class="line">access_key         **************** shared-credentials-file</span><br><span class="line">secret_key         **************** shared-credentials-file</span><br><span class="line">    region                us-west-2      config-file    ~/.aws/config</span><br></pre></td></tr></table></figure><p><strong>可能的原因：计算机的时钟不同步</strong></p><p>如果使用有效的凭证，则时钟可能不同步导致了这个问题。在 Linux 或 macOS 上，运行 date 以检查时间。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ date</span><br></pre></td></tr></table></figure><p>如果系统时钟在几分钟内不正确，则使用 ntpd 进行同步。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service ntpd stop</span><br><span class="line">$ sudo ntpdate time.nist.gov</span><br><span class="line">$ sudo service ntpd start</span><br><span class="line">$ ntpstat</span><br></pre></td></tr></table></figure><p>在 Windows 上，使用控制面板中的日期和时间选项来配置系统时钟。</p><h3 id="“签名不匹配”错误。"><a href="#“签名不匹配”错误。" class="headerlink" title="“签名不匹配”错误。"></a>“签名不匹配”错误。</h3><p>当 AWS CLI 运行命令时，它会向 AWS 服务器发送加密请求以执行适当的 AWS 服务操作。凭证（访问密钥和私有密钥）参与了加密过程，使 AWS 能够对发出请求的人员进行身份验证。有多种因素可能会干扰此过程的正常执行，如下所示。</p><p><strong>可能的原因：时钟与 AWS 服务器不同步</strong></p><p>为了帮助防范重播攻击，在加密/解密过程中可能会使用当前时间。如果客户端和服务器的时间不一致超出允许的时间量，该过程可能会失败，并且请求会被拒绝。当在时钟与主机时钟不同步的虚拟机中运行命令时，也可能发生此错误。一个可能原因是，当虚拟机休眠时，唤醒后需要一些时间才能将时钟与主机重新同步。</p><p>在 Linux 或 macOS 上，运行 date 以检查时间。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ date</span><br></pre></td></tr></table></figure><p>如果系统时钟在几分钟内不正确，则使用 ntpd 进行同步。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service ntpd stop</span><br><span class="line">$ sudo ntpdate time.nist.gov</span><br><span class="line">$ sudo service ntpd start</span><br><span class="line">$ ntpstat</span><br></pre></td></tr></table></figure><p>在 Windows 上，使用控制面板中的日期和时间选项来配置系统时钟。</p><p><strong>可能的原因：操作系统错误地处理了包含某些特殊字符的 AWS 私有密钥</strong></p><p>如果 AWS 私有密钥包含某些特殊字符（例如 – 、+、/ 或 %），则某些操作系统变体会不正确地处理该字符串，并导致对该私有密钥字符串的解释不正确。huoz</p><p>如果使用其他工具或脚本（例如，在创建新实例期间在其上构建凭证文件的工具）处理访问密钥和私有密钥，则这些工具和脚本可能有自己对特殊字符的处理，这会使它们转换为 AWS 不再识别的内容。</p><p>简单的解决方案是重新生成私有密钥，以获得一个不包含特殊字符的私有密钥。</p><p><strong>可能的原因：配置文件包含额外内容,导致配置文件格式不正确</strong></p><p>重新生成配置文件或手动改正配置文件</p><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>以上完全基于<a href="https://docs.aws.amazon.com/" target="_blank" rel="noopener">AWS官方文档</a>，并结合自身理解创作</p><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> CLI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS CLI </tag>
            
            <tag> AWS CLI基础入门 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EFS-常见问题-4</title>
      <link href="2020/12/13/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/EFS/EFS-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98-4/"/>
      <url>2020/12/13/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/EFS/EFS-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98-4/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-EFS常见问题"><a href="#描述-EFS常见问题" class="headerlink" title="描述: EFS常见问题"></a>描述: EFS常见问题</h2><a id="more"></a><h3 id="无法创建-EFS-文件系统"><a href="#无法创建-EFS-文件系统" class="headerlink" title="无法创建 EFS 文件系统"></a>无法创建 EFS 文件系统</h3><p>创建 EFS 文件系统的请求失败,并显示以下消息:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User: arn:aws:iam::111122223333:user/username is not authorized to</span><br><span class="line">perform: elasticfilesystem:CreateFileSystem on the specified resource.</span><br></pre></td></tr></table></figure><p><strong>要采取的操作</strong>:<br>这通常是由IAM权限限制引起的,检查当前用户的权限,以及特定规则.<br>例如:</p><ul><li>用户是否有权限创建EFS</li><li>用户创建EFS是否有特定条件:必须加密?必须带某些tags?必须在特定region?</li></ul><h3 id="凭证进行身份验证时出错"><a href="#凭证进行身份验证时出错" class="headerlink" title="凭证进行身份验证时出错"></a>凭证进行身份验证时出错</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AuthFailure: An error occurred authenticating your credentials for XXXXXXXX</span><br></pre></td></tr></table></figure><p><strong>要采取的操作</strong>:</p><ul><li>查看用户的凭证是否正确</li><li>查看用户客户端时间是否准确</li></ul><h3 id="Amazon-EC2-实例挂起"><a href="#Amazon-EC2-实例挂起" class="headerlink" title="Amazon EC2 实例挂起"></a>Amazon EC2 实例挂起</h3><p>Amazon EC2 实例挂起的原因可能是，在未首先卸载文件系统的情况下删除了文件系统挂载目标。</p><p><strong>要采取的操作</strong><br>在删除文件系统挂载目标之前，请卸载文件系统。</p><h3 id="Disk-quota-exceeded"><a href="#Disk-quota-exceeded" class="headerlink" title="Disk quota exceeded"></a>Disk quota exceeded</h3><p>Amazon EFS 当前不支持用户磁盘配额。如果超出了以下任何限制，则可能会出现该错误：</p><p>一个实例同一时刻最多可以有 128 个活动用户账户打开文件。</p><p>一个实例同一时刻最多可打开 32,768 个文件。</p><p>实例上的每个唯一挂载可以在 256 个唯一文件/进程对中最多获取总共 8192 个锁。例如，单个进程可以在 256 个单独的文件上获取一个或多个锁，或者说 8 个进程中的每个进程均可以在 32 个文件上获取一个或多个锁。</p><p><strong>要采取的操作</strong>:</p><p>如果遇到该问题，可通过确定超出了上述哪个限制，然后进行更改以满足该限制，加以解决。</p><h3 id="I-O-error"><a href="#I-O-error" class="headerlink" title="I/O error"></a>I/O error</h3><p>遇到下列问题之一时会发生此错误：</p><ol><li><p>每个实例同一时刻最多有 128 个活动用户账户打开文件。</p><p> <strong>要采取的操作</strong></p><p> 如果遇到该问题，可以满足在实例上支持的打开文件数限制以解决该问题。为此，请减少在实例上同时打开 Amazon EFS 文件系统中的文件的活动用户数。</p></li><li><p>已删除加密的文件系统的 AWS KMS 密钥。</p><p> <strong>要采取的操作</strong>:</p><p> 如果遇到此问题，则表示不能再解密用该密钥加密的数据，这意味着该数据将无法恢复。</p></li></ol><h3 id="File-name-is-too-long"><a href="#File-name-is-too-long" class="headerlink" title="File name is too long"></a>File name is too long</h3><p>当文件名或其符号链接 (symbol link) 太长时，会出现该错误。文件名具有以下限制：</p><ul><li>名称的长度最多为 255 个字节。</li><li>符号链接的大小最多为 4080 个字节。</li></ul><p><strong>要采取的操作</strong>:</p><p>如果遇到该问题，可通过减小文件名或符号链接的长度以满足支持的限制，加以解决。</p><h3 id="Too-many-links"><a href="#Too-many-links" class="headerlink" title="Too many links"></a>Too many links</h3><p>当文件的硬链接太多时，会出现该错误。一个文件中最多可有 177 个硬链接。</p><p><strong>要采取的操作</strong>:</p><p>如果遇到该问题，可通过减少文件硬链接的数量以满足支持的限制，加以解决。</p><h3 id="File-too-large"><a href="#File-too-large" class="headerlink" title="File too large"></a>File too large</h3><p>当文件太大时，会出现该错误。单个文件的大小最多为 52,673,613,135,872 个字节 (47.9 TiB)。</p><p><strong>要采取的操作</strong>:</p><p>如果遇到该问题，可通过减小文件的大小以满足支持的限制，加以解决。</p><h3 id="无法更改所有权"><a href="#无法更改所有权" class="headerlink" title="无法更改所有权"></a>无法更改所有权</h3><p>当使用 Linux chown 命令时，无法更改文件/目录的所有权。</p><p>出现该错误的内核版本</p><p><em>2.6.32</em></p><p><strong>要采取的操作</strong>:<br>内核升级</p><h3 id="由于客户端错误，文件系统重复执行操作"><a href="#由于客户端错误，文件系统重复执行操作" class="headerlink" title="由于客户端错误，文件系统重复执行操作"></a>由于客户端错误，文件系统重复执行操作</h3><p>由于某个客户端错误，文件系统重复执行操作。</p><p><strong>要采取的操作</strong>:</p><p>将客户端软件更新为最新版本。</p><h3 id="客户端发生死锁"><a href="#客户端发生死锁" class="headerlink" title="客户端发生死锁"></a>客户端发生死锁</h3><p>客户端变为死锁状态。</p><p>出现该错误的内核版本</p><ul><li>CentOS -7,内核为 Linux 3.10.0-229.20.1.el7.x86_64</li><li>内核为 Linux 4.2.0-18-generic 的 Ubuntu 15.10</li></ul><p><strong>要采取的操作</strong>:</p><p>执行下列操作之一：</p><ul><li>升级为更新的内核版本。对于 CentOS-7,内核版本 Linux 3.10.0-327 或更高版本包含修复。</li><li>降级为较旧的内核版本。</li></ul><h3 id="列出大型目录中的文件需要很长时间"><a href="#列出大型目录中的文件需要很长时间" class="headerlink" title="列出大型目录中的文件需要很长时间"></a>列出大型目录中的文件需要很长时间</h3><p>如果在 NFS 客户端遍历目录以完成列出操作时，目录正在发生更改，则可能会出现这种情况。每当 NFS 客户端在这种遍历期间注意到目录内容发生更改时，它都会从头开始重新遍历。因此，对于包含经常更改的文件的大型目录，ls 命令可能需要很长时间才能完成。</p><p>出现该错误的内核版本</p><p>CentOS 和低于 2.6.32-696.el6 的 RHEL 内核版本</p><p><strong>要采取的操作</strong>:</p><p>要解决该问题，请升级到较新的内核版本。</p><h3 id="在-Windows-实例上挂载文件系统失败"><a href="#在-Windows-实例上挂载文件系统失败" class="headerlink" title="在 Windows 实例上挂载文件系统失败"></a>在 Windows 实例上挂载文件系统失败</h3><p>在 Microsoft Windows Amazon EC2 实例上挂载文件系统失败。</p><p><strong>要采取的操作</strong>:</p><p>不要将 Amazon EFS 与 Windows EC2 实例一起使用，不支持该配置。</p><h3 id="自动挂载失败，并且实例没有响应"><a href="#自动挂载失败，并且实例没有响应" class="headerlink" title="自动挂载失败，并且实例没有响应"></a>自动挂载失败，并且实例没有响应</h3><p>如果在实例上自动挂载文件系统，并且未声明 _netdev 选项，则可能会出现该问题。如果缺少 _netdev EC2 实例可能会停止响应。出现该结果是因为，需要在计算实例启动其网络后初始化网络文件系统。</p><p><strong>要采取的操作</strong>:</p><p>如果出现该问题，请与 AWS Support 联系。</p><h3 id="在-etc-fstab-中挂载多个-Amazon-EFS-文件系统失败"><a href="#在-etc-fstab-中挂载多个-Amazon-EFS-文件系统失败" class="headerlink" title="在 /etc/fstab 中挂载多个 Amazon EFS 文件系统失败"></a>在 /etc/fstab 中挂载多个 Amazon EFS 文件系统失败</h3><p>如果实例使用的 systemd 初始化系统在 /etc/fstab 中具有两个或更多 Amazon EFS 条目，有时可能会没有挂载其中的部分或全部条目。在这种情况下，dmesg 输出显示类似于以下内容的一行或多行。</p><p><code>NFS: nfs4_discover_server_trunking unhandled error -512. Exiting with error EIO</code></p><p><strong>要采取的操作</strong>:</p><p>在这种情况下，使用以下内容在 /etc/systemd/system/mount-nfs-sequentially.service 中创建新的 systemd 服务文件。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Workaround for mounting NFS file systems sequentially at boot time</span><br><span class="line">After=remote-fs.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">ExecStart=/bin/mount -avt nfs4</span><br><span class="line">RemainAfterExit=yes</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p>在执行该操作后，运行以下两个命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">sudo systemctl enable mount-nfs-sequentially.service</span><br></pre></td></tr></table></figure><p>然后，重新启动 Amazon EC2 实例。通常在一秒内将按需挂载文件系统</p><h3 id="挂载命令失败，并显示“wrong-fs-type”错误消息"><a href="#挂载命令失败，并显示“wrong-fs-type”错误消息" class="headerlink" title="挂载命令失败，并显示“wrong fs type”错误消息"></a>挂载命令失败，并显示“wrong fs type”错误消息</h3><p>挂载命令失败，并显示如下错误消息。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mount: wrong fs type, bad option, bad superblock on 10.1.25.30:/, </span><br><span class="line">missing codepage or helper program, or other error (for several filesystems </span><br><span class="line">(e.g. nfs, cifs) you might need a /sbin/mount.&lt;type&gt; helper program)</span><br><span class="line">In some cases useful info is found in syslog - try dmesg | tail or so.</span><br></pre></td></tr></table></figure><p><strong>要采取的操作</strong>:</p><p>如果收到该消息，请安装 nfs-utils（或 Ubuntu 上的 nfs-common）软件包</p><h3 id="挂载命令失败，并显示“incorrect-mount-option”错误消息"><a href="#挂载命令失败，并显示“incorrect-mount-option”错误消息" class="headerlink" title="挂载命令失败，并显示“incorrect mount option”错误消息"></a>挂载命令失败，并显示“incorrect mount option”错误消息</h3><p>挂载命令失败，并显示如下错误消息。</p><p><code>mount.nfs: an incorrect mount option was specified</code></p><p><strong>要采取的操作</strong>:</p><p>该错误消息很可能意味着 Linux 发行版不支持 4.0 和 4.1 版网络文件系统 (NFSv4)。要确认是否属于这种情况，可以运行以下命令。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> grep CONFIG_NFS_V4_1 /boot/config*</span><br></pre></td></tr></table></figure><p>如果上述命令返回 <code># CONFIG_NFS_V4_1 is not set</code>,则表明你的 Linux 发行版不支持 NFSv4.1。有关支持 Amazon Elastic Compute Cloud 的 Amazon EC2 (NFSv4.1,) 的 Amazon 系统映像 (AMI) 的列表,请参阅NFS 支持。</p><h3 id="在创建文件系统后文件系统挂载立即失败"><a href="#在创建文件系统后文件系统挂载立即失败" class="headerlink" title="在创建文件系统后文件系统挂载立即失败"></a>在创建文件系统后文件系统挂载立即失败</h3><p>在创建域名服务 (DNS) 记录的挂载目标后，可能最多需要 90 秒的时间才能在 AWS 区域中完全传播。</p><p><strong>要采取的操作</strong>:</p><p>如果以编程方式创建和挂载文件系统（例如，使用 AWS CloudFormation 模板），建议实施等待条件</p><h3 id="文件系统挂载挂起，然后失败，并显示超时错误"><a href="#文件系统挂载挂起，然后失败，并显示超时错误" class="headerlink" title="文件系统挂载挂起，然后失败，并显示超时错误"></a>文件系统挂载挂起，然后失败，并显示超时错误</h3><p>文件系统挂载命令挂起一两分钟，然后失败，并显示超时错误。下面的代码显示了一个示例。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mount -t nfs -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport mount-target-ip:/ mnt</span><br><span class="line"></span><br><span class="line">[2+ minute wait here]</span><br><span class="line">mount.nfs: Connection timed out</span><br></pre></td></tr></table></figure><p><strong>要采取的操作</strong>:</p><p>出现该错误的原因可能是，Amazon EC2 实例或挂载目标安全组的配置不正确。确保挂载目标安全组具有允许从 EC2 安全组进行 NFS 访问的2049入站规则。或者可能挂载的IP不正确</p><h3 id="Name-or-service-not-known"><a href="#Name-or-service-not-known" class="headerlink" title="Name or service not known"></a>Name or service not known</h3><p>使用 DNS 名称的文件系统挂载失败。下面的代码显示了一个示例。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mount -t nfs -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport file-system-id.efs.aws-region.amazonaws.com:/ mnt   </span><br><span class="line">mount.nfs: Failed to resolve server file-system-id.efs.aws-region.amazonaws.com: </span><br><span class="line">  Name or service not known.   </span><br><span class="line"></span><br><span class="line">$  </span><br><span class="line">``` </span><br><span class="line">**要采取的操作**:</span><br><span class="line"></span><br><span class="line">请检查 VPC 配置。如果使用自定义 VPC，请确保已启用 DNS 设置。</span><br><span class="line">* 确保 Amazon EC2 实例所在的同一可用区中有一个 Amazon EFS 挂载目标</span><br><span class="line">* 确保在与 Amazon EC2 实例相同的 VPC 中有一个挂载目标。否则，不能对位于其他 VPC 中的 EFS 挂载目标使用 DNS 名称解析</span><br><span class="line">* 在配置为使用由 Amazon 提供的 DNS 服务器的 Amazon VPC 内连接至您的 Amazon EC2 实例</span><br><span class="line">* 确保连接 Amazon EC2 实例的 Amazon VPC 已启用 DNS 主机名</span><br><span class="line"></span><br><span class="line">### nfs not responding</span><br><span class="line"></span><br><span class="line">Amazon EFS 文件系统挂载因传输控制协议 (TCP) 重新连接事件失败，返回错误&quot;nfs: server_name still not responding&quot;。</span><br><span class="line"></span><br><span class="line">**要采取的操作**:</span><br><span class="line"></span><br><span class="line">请使用 noresvport 挂载选项，以确保在重新建立网络连接时，NFS 客户端将使用新的 TCP 源端口。这样做有助于确保在网络恢复事件后具有不间断的可用性。</span><br><span class="line"></span><br><span class="line">### 挂载没有响应</span><br><span class="line">Amazon EFS 挂载看起来没有响应。例如，ls 等命令挂起。</span><br><span class="line"></span><br><span class="line">**要采取的操作**:</span><br><span class="line"></span><br><span class="line">如果另一个应用程序正在将大量数据写入文件系统，则可能会出现该错误。在该操作完成前，可能会阻止对正在被写入的文件的访问。一般来说，尝试访问正在被写入的文件的任何命令或应用程序均可能会显示为挂起状态。例如，ls 命令可能会在访问正在被写入的文件时挂起。出现该结果是因为，某些 Linux 发行版在 ls 命令中使用别名，以便检索文件属性以及列出目录内容。</span><br><span class="line"></span><br><span class="line">要解决此问题，请验证另一个应用程序是否正在将文件写入 Amazon EFS 挂载，并验证它是否处于 Uninterruptible sleepD 状态，如下面的示例所示：</span><br></pre></td></tr></table></figure><p>$ ps aux | grep large_io.py<br>root 33253 0.5 0.0 126652 5020 pts/3 D+ 18:22 0:00 python large_io.py /efs/large_file</p><p>```<br>在已验证确属这种情况之后，您可以通过等待其他写入操作完成或通过实施一种变通解决办法来解决问题。在 ls 示例中，您可以直接使用 /bin/ls 命令，而不是使用别名。这样做可以继续执行命令，而不会在写入的文件处挂起。通常，如果写入数据的应用程序可能会定期强制执行数据刷新（可能使用 fsync(2)），这样做可能有助于提高文件系统对其他应用程序的响应能力。但是，在应用程序写入数据时，这种改善可能会牺牲性能。</p><h3 id="bad-file-handle"><a href="#bad-file-handle" class="headerlink" title="bad file handle"></a>bad file handle</h3><p>针对新挂载的文件系统执行的操作返回 bad file handle 错误。</p><p>如果 Amazon EC2 实例连接到了一个文件系统和一个具有指定 IP 地址的挂载目标，然后该文件系统和挂载目标被删除，则可能会出现该错误。如果您创建新的文件系统和挂载目标，以连接到具有相同挂载目标 IP 地址的 Amazon EC2 实例，则可能会发生该问题。</p><p><strong>要采取的操作</strong>:</p><p>可以卸载文件系统，然后在 Amazon EC2 实例上重新挂载文件系统以解决该问题。</p><h3 id="卸载文件系统失败"><a href="#卸载文件系统失败" class="headerlink" title="卸载文件系统失败"></a>卸载文件系统失败</h3><p>如果文件系统繁忙，则无法将其卸载。</p><p><strong>要采取的操作</strong>:</p><p>可以通过以下方法解决该问题：</p><ul><li>等待所有读取和写入操作完成，然后再次尝试执行 umount 命令。</li><li>使用 umount 选项强制完成 -f 命令。</li></ul><h3 id="具有传输中的数据加密的挂载失败"><a href="#具有传输中的数据加密的挂载失败" class="headerlink" title="具有传输中的数据加密的挂载失败"></a>具有传输中的数据加密的挂载失败</h3><p>默认情况下，当您使用带有传输层安全性 (TLS) 的 Amazon EFS 挂载帮助程序时，它会强制执行主机名检查。某些系统不支持此功能,例如,当您使用 Red Hat Enterprise Linux 或 CentOS 时。 在这些情况下,使用 TLS 挂载 EFS 文件系统会失败。</p><p><strong>要采取的操作</strong>:</p><p>我们建议您升级客户端上的 stunnel 版本以支持主机名检查。<a href="https://docs.aws.amazon.com/zh_cn/efs/latest/ug/upgrading-stunnel.html" target="_blank" rel="noopener">升级stunnel</a></p><h3 id="具有传输中的数据加密的挂载中断"><a href="#具有传输中的数据加密的挂载中断" class="headerlink" title="具有传输中的数据加密的挂载中断"></a>具有传输中的数据加密的挂载中断</h3><p>在极少数情况下，客户端事件可能会导致到您的 Amazon EFS 文件系统的加密连接挂起或中断。</p><p><strong>要采取的操作</strong>:</p><p>如果到使用传输中的数据加密的 Amazon EFS 文件系统的连接中断，请执行以下步骤：</p><ul><li>确保正在客户端上运行 stunnel 服务。</li><li>确认正在客户端上运行监控程序应用程序 amazon-efs-mount-watchdog。您可以使用以下命令确定是否正在运行该应用程序：<br>  <code>ps aux | grep [a]mazon-efs-mount-watchdog</code></li><li>检查日志，可以查找在 /var/log/amazon/efs 中存储的日志。</li><li>（可选）可以启用 stunnel 日志以及检查这些日志中的信息。可以在 /etc/amazon/efs/efs-utils.conf 中更改日志配置以启用 stunnel 日志。但是，这样做需要卸载文件系统，然后使用挂载帮助程序重新挂载以使更改生效。</li></ul><h3 id="无法创建静态加密的文件系统"><a href="#无法创建静态加密的文件系统" class="headerlink" title="无法创建静态加密的文件系统"></a>无法创建静态加密的文件系统</h3><p>您已尝试创建新的静态加密的文件系统。不过，您会收到一条错误消息，指出 AWS KMS 不可用。</p><p><strong>要采取的操作</strong>:</p><p>在极少数情况下，AWS KMS 可能在您的 AWS 区域中暂时不可用，从而出现该错误。如果发生这种情况，请等到 AWS KMS 恢复完全可用，然后重试以创建文件系统。</p><h3 id="无法使用的加密文件系统"><a href="#无法使用的加密文件系统" class="headerlink" title="无法使用的加密文件系统"></a>无法使用的加密文件系统</h3><p>加密的文件系统持续返回 NFS 服务器错误。如果由于以下原因之一 EFS 无法从 AWS KMS 中检索主密钥，则可能会出现这些错误：</p><ul><li>禁用了密钥。</li><li>删除了密钥。</li><li>撤销了 Amazon EFS 使用密钥的权限。</li><li>AWS KMS 暂时不可用。</li></ul><p><strong>要采取的操作</strong>:</p><ul><li>确认已启用 AWS KMS 密钥。为此，您可以在控制台中查看这些密钥。</li><li>如果未启用密钥，请将其启用。</li><li>如果密钥处于待删除状态，该状态将禁用密钥。可以取消删除，然后重新启用密钥。</li><li>如果已启用密钥并且仍遇到问题，或者在重新启用密钥时遇到问题，请与 AWS Support 联系。</li></ul><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> 存储类 </category>
          
          <category> EFS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS EFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EC2-2-CLI</title>
      <link href="2020/12/12/AWS/EC2/EC2-2-CLI/"/>
      <url>2020/12/12/AWS/EC2/EC2-2-CLI/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-常用EC2-CLI"><a href="#描述-常用EC2-CLI" class="headerlink" title="描述: 常用EC2 CLI"></a>描述: 常用EC2 CLI</h2><a id="more"></a><h4 id="create-keypair"><a href="#create-keypair" class="headerlink" title="create keypair"></a>create keypair</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 create-key-pair --key-name MyKeyPair --query 'KeyMaterial' --output text &gt; MyKeyPair.pem</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> for Windows</span><br><span class="line">aws ec2 create-key-pair --key-name MyKeyPair --query 'KeyMaterial' --output text | out-file -encoding ascii -filepath MyKeyPair.pem</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> don't forget change the permission of the keypair file</span><br><span class="line">chmod 400 MyKeyPair.pem</span><br></pre></td></tr></table></figure><h4 id="启动新的EC2"><a href="#启动新的EC2" class="headerlink" title="启动新的EC2"></a>启动新的EC2</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 run-instances \</span><br><span class="line">--image-id $&#123;AMIID&#125; \</span><br><span class="line">--count 1 \</span><br><span class="line">--instance-type t2.micro \</span><br><span class="line">--associate-public-ip-address \</span><br><span class="line">--key-name $&#123;key-pair-name&#125; \</span><br><span class="line">--security-group-ids $&#123;group-ids&#125; \</span><br><span class="line">--subnet-id $&#123;subnetID&#125;</span><br></pre></td></tr></table></figure><h4 id="确认可用区ID"><a href="#确认可用区ID" class="headerlink" title="确认可用区ID"></a>确认可用区ID</h4><p><strong>不同账户相同AvailableZone的ZoneID是不同的.</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 该命令是在EC2机器上运行</span><br><span class="line">aws ec2 describe-availability-zones --zone-name `curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone`</span><br><span class="line">&#123;</span><br><span class="line">    "AvailabilityZones": [</span><br><span class="line">        &#123;</span><br><span class="line">            "State": "available", </span><br><span class="line">            "ZoneName": "us-east-2b", </span><br><span class="line">            "Messages": [], </span><br><span class="line">            "ZoneId": "use2-az2", </span><br><span class="line">            "RegionName": "us-east-2"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 通过instance id获取该instance zone name,然后再查找zone id</span><br><span class="line">ZoneName=$(aws ec2 describe-instances \</span><br><span class="line">    --instance-id i-057750d42936e468a \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --query "Reservations[0].Instances[0].AvailabilityZone" \</span><br><span class="line">    --output text)</span><br><span class="line">aws ec2 describe-availability-zones --zone-name $&#123;ZoneName&#125;</span><br></pre></td></tr></table></figure><p>可用区 ID 在 ZoneId 属性值 <code>use2-az2</code> </p><h4 id="EC2-tags"><a href="#EC2-tags" class="headerlink" title="EC2 tags"></a>EC2 tags</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 create-tags \</span><br><span class="line">--resources  EC2-instance-ID \</span><br><span class="line">--tags \</span><br><span class="line">    Key=Name,Value=Provide-instance-name \</span><br><span class="line">    Key=Env,Value=dev</span><br></pre></td></tr></table></figure><h4 id="停止EC2"><a href="#停止EC2" class="headerlink" title="停止EC2"></a>停止EC2</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 stop-instances \</span><br><span class="line">    --instance-ids $&#123;InstanceId&#125;</span><br></pre></td></tr></table></figure><h4 id="等待停止EC2"><a href="#等待停止EC2" class="headerlink" title="等待停止EC2"></a>等待停止EC2</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 wait instance-stopped \</span><br><span class="line">    --instance-ids $&#123;InstanceId&#125;</span><br></pre></td></tr></table></figure><h4 id="启动EC2"><a href="#启动EC2" class="headerlink" title="启动EC2"></a>启动EC2</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 start-instances \</span><br><span class="line">    --instance-ids $&#123;InstanceId&#125;</span><br></pre></td></tr></table></figure><h4 id="终止EC2"><a href="#终止EC2" class="headerlink" title="终止EC2"></a>终止EC2</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 terminate-instances \</span><br><span class="line">--instance-ids instance-id</span><br></pre></td></tr></table></figure><h4 id="获取具有指定标签的最新的snapshot-id"><a href="#获取具有指定标签的最新的snapshot-id" class="headerlink" title="获取具有指定标签的最新的snapshot id"></a>获取具有指定标签的最新的snapshot id</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function getLatestSnapshot()</span><br><span class="line">&#123;</span><br><span class="line">    SnapshotId=$(aws ec2 describe-snapshots \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --filters "Name=tag:Name,Values=$&#123;Name&#125;" \</span><br><span class="line">    --query 'reverse(sort_by(Snapshots,&amp;StartTime))[0].[SnapshotId]' \</span><br><span class="line">    --output text)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="describe-Instance"><a href="#describe-Instance" class="headerlink" title="describe Instance"></a>describe Instance</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> Get instance ID, OldVolumeId and AvailabilityZone</span><br><span class="line"></span><br><span class="line">function getInstanceINFO()</span><br><span class="line">&#123;</span><br><span class="line">    InstanceINFO=($(aws ec2 describe-instances \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --filters "Name=tag:Name,Values=$&#123;Name&#125;" \</span><br><span class="line">    --query 'Reservations[*].Instances[*].&#123;I0:InstanceId,I2:lockDeviceMappings[*].Ebs.VolumeId,I1:Placement.AvailabilityZone&#125;' \</span><br><span class="line">    --output text))</span><br><span class="line"></span><br><span class="line">    InstanceId=$&#123;InstanceINFO[0]&#125;</span><br><span class="line">    AvailabilityZone=$&#123;InstanceINFO[1]&#125;</span><br><span class="line">    OldVolumeId=$&#123;InstanceINFO[2]&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 以下命令列出使用以下任何 AMI 启动的实例：ami-x0123456、ami-y0123456 和 ami-z0123456。</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span> aws ec2 describe-instances --filters "Name=image-id,Values=ami-x0123456,ami-y0123456,ami-z0123456"</span><br></pre></td></tr></table></figure><h4 id="通过snapshot-id创建volume并获取volume-id"><a href="#通过snapshot-id创建volume并获取volume-id" class="headerlink" title="通过snapshot id创建volume并获取volume id"></a>通过snapshot id创建volume并获取volume id</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NewVolumeId=$(aws ec2 create-volume \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --snapshot-id $&#123;SnapshotId&#125; \</span><br><span class="line">    --availability-zone $&#123;AvailabilityZone&#125; \</span><br><span class="line">    --query 'VolumeId' \</span><br><span class="line">    --tag-specifications "ResourceType=volume,Tags=[ \</span><br><span class="line">        &#123;Key=Team,Value=$&#123;Team&#125;&#125;,&#123;Key=Department,Value=$&#123;Department&#125;&#125;, \</span><br><span class="line">        &#123;Key=Name,Value=$&#123;Name&#125;&#125;,&#123;Key=Environment,Value=$&#123;Environment&#125;&#125;]" \</span><br><span class="line">    --output text)</span><br><span class="line"></span><br><span class="line">echo "NewVolumeId: $&#123;NewVolumeId&#125;"</span><br></pre></td></tr></table></figure><h4 id="等待volume可用"><a href="#等待volume可用" class="headerlink" title="等待volume可用"></a>等待volume可用</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 wait volume-available \</span><br><span class="line">    --volume-ids $&#123;NewVolumeId&#125;</span><br></pre></td></tr></table></figure><h4 id="从EC2上卸载硬盘"><a href="#从EC2上卸载硬盘" class="headerlink" title="从EC2上卸载硬盘"></a>从EC2上卸载硬盘</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 detach-volume \</span><br><span class="line">    --instance-id $&#123;InstanceId&#125; \</span><br><span class="line">    --volume-id $&#123;OldVolumeId&#125;</span><br></pre></td></tr></table></figure><h4 id="挂载硬盘"><a href="#挂载硬盘" class="headerlink" title="挂载硬盘"></a>挂载硬盘</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 attach-volume \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --volume-id $&#123;NewVolumeId&#125; \</span><br><span class="line">    --instance-id $&#123;InstanceId&#125; \</span><br><span class="line">    --device /dev/sda1</span><br></pre></td></tr></table></figure><h4 id="挂载硬盘后等待硬盘处于使用"><a href="#挂载硬盘后等待硬盘处于使用" class="headerlink" title="挂载硬盘后等待硬盘处于使用"></a>挂载硬盘后等待硬盘处于使用</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 wait volume-in-use \</span><br><span class="line">    --profile $&#123;PROFILE&#125; \</span><br><span class="line">    --region $&#123;REGION&#125; \</span><br><span class="line">    --volume-ids $&#123;NewVolumeId&#125;</span><br></pre></td></tr></table></figure><h4 id="创建Security-Group"><a href="#创建Security-Group" class="headerlink" title="创建Security Group"></a>创建Security Group</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 create-security-group \</span><br><span class="line">--group-name efs-walkthrough1-ec2-sg \</span><br><span class="line">--description "Amazon EFS walkthrough 1, SG for EC2 instance" \</span><br><span class="line">--vpc-id vpc-id-in-us-west-2</span><br></pre></td></tr></table></figure><h4 id="添加入站规则-IP"><a href="#添加入站规则-IP" class="headerlink" title="添加入站规则-IP"></a>添加入站规则-IP</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 authorize-security-group-ingress \</span><br><span class="line">--group-id id of the security group created for EC2 instance \</span><br><span class="line">--protocol tcp \</span><br><span class="line">--port 22 \</span><br><span class="line">--cidr 0.0.0.0/0</span><br></pre></td></tr></table></figure><h4 id="添加入站规则-安全组"><a href="#添加入站规则-安全组" class="headerlink" title="添加入站规则-安全组"></a>添加入站规则-安全组</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 authorize-security-group-ingress \</span><br><span class="line">--group-id GROUPID \</span><br><span class="line">--protocol tcp \</span><br><span class="line">--port 2049 \</span><br><span class="line">--source-group GROUPID</span><br></pre></td></tr></table></figure><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> EC2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS EC2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EFS-Policy-3</title>
      <link href="2020/12/12/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/EFS/EFS-Policy-3/"/>
      <url>2020/12/12/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/EFS/EFS-Policy-3/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-EFS-Policy"><a href="#描述-EFS-Policy" class="headerlink" title="描述: EFS-Policy"></a>描述: EFS-Policy</h2><a id="more"></a><h4 id="示例-1-授予对所有人的读写访问权限-IAM-委托人"><a href="#示例-1-授予对所有人的读写访问权限-IAM-委托人" class="headerlink" title="示例 #1 授予对所有人的读写访问权限 IAM 委托人"></a>示例 #1 授予对所有人的读写访问权限 IAM 委托人</h4><p>仅向使用 TLS 连接到文件系统的 NFS 客户端授予访问权限</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Id"</span>: <span class="string">"ExamplePolicy01"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Sid"</span>: <span class="string">"ExampleSatement01"</span>,</span><br><span class="line">            <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="attr">"Principal"</span>: &#123;</span><br><span class="line">                <span class="attr">"AWS"</span>: <span class="string">"*"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"Action"</span>: [</span><br><span class="line">                <span class="string">"elasticfilesystem:ClientRootAccess"</span>,</span><br><span class="line">                <span class="string">"elasticfilesystem:ClientMount"</span>,</span><br><span class="line">                <span class="string">"elasticfilesystem:ClientWrite"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">                <span class="attr">"Bool"</span>: &#123;</span><br><span class="line">                    <span class="attr">"aws:SecureTransport"</span>: <span class="string">"true"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="示例-2-授予-只读访问权限-基于资源的策略"><a href="#示例-2-授予-只读访问权限-基于资源的策略" class="headerlink" title="示例 2 授予 只读访问权限(基于资源的策略)"></a>示例 2 授予 只读访问权限(基于资源的策略)</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Id"</span>: <span class="string">"read-only-example-policy02"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Sid"</span>: <span class="string">"efs-statement-example02"</span>,</span><br><span class="line">            <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="attr">"Principal"</span>: &#123;</span><br><span class="line">                <span class="attr">"AWS"</span>: <span class="string">"*"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"Action"</span>: [</span><br><span class="line">                <span class="string">"elasticfilesystem:ClientMount"</span></span><br><span class="line">            ]   </span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="示例-3-授予访问EFS接入点的权限-基于资源的策略"><a href="#示例-3-授予访问EFS接入点的权限-基于资源的策略" class="headerlink" title="示例 3 授予访问EFS接入点的权限(基于资源的策略)"></a>示例 3 授予访问EFS接入点的权限(基于资源的策略)</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Id"</span>: <span class="string">"access-point-example03"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Sid"</span>: <span class="string">"access-point-statement-example03"</span>,</span><br><span class="line">            <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="attr">"Principal"</span>: &#123;<span class="attr">"AWS"</span>: <span class="string">"arn:aws:iam::account_id:role/myapp"</span>&#125;,</span><br><span class="line">            <span class="attr">"Action"</span>: <span class="string">"elasticfilesystem:Client*"</span>,</span><br><span class="line">            <span class="attr">"Condition"</span>: &#123; </span><br><span class="line">                <span class="attr">"StringEquals"</span>: &#123;</span><br><span class="line">                    <span class="attr">"elasticfilesystem:AccessPointArn"</span>:<span class="string">"arn:aws::elasticfilesystem:region:account_id:access-point/access_point_id"</span> &#125; </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="使用IAM强制执行创建加密文件系统-基于身份的策略"><a href="#使用IAM强制执行创建加密文件系统-基于身份的策略" class="headerlink" title="使用IAM强制执行创建加密文件系统(基于身份的策略)"></a>使用IAM强制执行创建加密文件系统(基于身份的策略)</h4><p>当创建EFS必须启用加密</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Sid"</span>: <span class="string">"VisualEditor0"</span>,</span><br><span class="line">            <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="attr">"Action"</span>: <span class="string">"elasticfilesystem:CreateFileSystem"</span>,</span><br><span class="line">            <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">                <span class="attr">"Bool"</span>: &#123;</span><br><span class="line">                    <span class="attr">"elasticfilesystem:Encrypted"</span>: <span class="string">"true"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="仅允许用户创建加密的EFS的策略-基于身份的策略"><a href="#仅允许用户创建加密的EFS的策略-基于身份的策略" class="headerlink" title="仅允许用户创建加密的EFS的策略(基于身份的策略)"></a>仅允许用户创建加密的EFS的策略(基于身份的策略)</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Sid"</span> : <span class="string">"Stmt1EFSpermissions"</span>,  </span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: [</span><br><span class="line">        <span class="string">"elasticfilesystem:CreateFileSystem"</span>,</span><br><span class="line">        <span class="string">"elasticfilesystem:CreateMountTarget"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Resource"</span>: <span class="string">"arn:aws:elasticfilesystem:us-west-2:account-id:file-system/*"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">     <span class="attr">"Sid"</span> : <span class="string">"Stmt2EC2permissions"</span>,</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: [</span><br><span class="line">        <span class="string">"ec2:DescribeSubnets"</span>,</span><br><span class="line">        <span class="string">"ec2:CreateNetworkInterface"</span>,</span><br><span class="line">        <span class="string">"ec2:DescribeNetworkInterfaces"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="允许用户在现有文件系统上创建安装目标和标记"><a href="#允许用户在现有文件系统上创建安装目标和标记" class="headerlink" title="允许用户在现有文件系统上创建安装目标和标记"></a>允许用户在现有文件系统上创建安装目标和标记</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Sid"</span> : <span class="string">"Stmt1CreateMountTargetAndTag"</span>,</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: [</span><br><span class="line">        <span class="string">"elasticfilesystem:CreateMountTarget"</span>,</span><br><span class="line">        <span class="string">"elasticfilesystem:DescribeMountTargets"</span>,</span><br><span class="line">        <span class="string">"elasticfilesystem:CreateTags"</span>,</span><br><span class="line">        <span class="string">"elasticfilesystem:DescribeTags"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Resource"</span>: <span class="string">"arn:aws:elasticfilesystem:us-west-2:123456789012:file-system/file-system-ID"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Sid"</span> : <span class="string">"Stmt2AdditionalEC2PermissionsToCreateMountTarget"</span>,</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: [</span><br><span class="line">        <span class="string">"ec2:DescribeSubnets"</span>,</span><br><span class="line">        <span class="string">"ec2:CreateNetworkInterface"</span>,</span><br><span class="line">        <span class="string">"ec2:DescribeNetworkInterfaces"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="允许用户执行全部-Amazon-EFS-行动"><a href="#允许用户执行全部-Amazon-EFS-行动" class="headerlink" title="允许用户执行全部 Amazon EFS 行动"></a>允许用户执行全部 Amazon EFS 行动</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">     <span class="attr">"Sid"</span> : <span class="string">"Stmt1PermissionForAllEFSActions"</span>,</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: <span class="string">"elasticfilesystem:*"</span>,</span><br><span class="line">      <span class="attr">"Resource"</span>: <span class="string">"arn:aws:elasticfilesystem:us-west-2:123456789012:file-system/*"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">     <span class="attr">"Sid"</span> : <span class="string">"Stmt2RequiredEC2PermissionsForAllEFSActions"</span>,</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: [</span><br><span class="line">        <span class="string">"ec2:DescribeSubnets"</span>,</span><br><span class="line">        <span class="string">"ec2:CreateNetworkInterface"</span>,</span><br><span class="line">        <span class="string">"ec2:DescribeNetworkInterfaces"</span>,</span><br><span class="line">        <span class="string">"ec2:DeleteNetworkInterface"</span>,</span><br><span class="line">        <span class="string">"ec2:ModifyNetworkInterfaceAttribute"</span>,</span><br><span class="line">        <span class="string">"ec2:DescribeNetworkInterfaceAttribute"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="访问点的策略-基于EFS"><a href="#访问点的策略-基于EFS" class="headerlink" title="访问点的策略(基于EFS)"></a>访问点的策略(基于EFS)</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Id"</span>: <span class="string">"MyFileSystemPolicy"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Sid"</span>: <span class="string">"App1Access"</span>,</span><br><span class="line">            <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="attr">"Principal"</span>: &#123; <span class="attr">"AWS"</span>: <span class="string">"arn:aws:iam::111122223333:role/app1"</span> &#125;,</span><br><span class="line">            <span class="attr">"Action"</span>: [</span><br><span class="line">                <span class="string">"elasticfilesystem:ClientMount"</span>,</span><br><span class="line">                <span class="string">"elasticfilesystem:ClientWrite"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">                <span class="attr">"StringEquals"</span>: &#123;</span><br><span class="line">                    <span class="attr">"elasticfilesystem:AccessPointArn"</span> : <span class="string">"arn:aws:elasticfilesystem:us-east-1:222233334444:access-point/fsap-01234567"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Sid"</span>: <span class="string">"App2Access"</span>,</span><br><span class="line">            <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="attr">"Principal"</span>: &#123; <span class="attr">"AWS"</span>: <span class="string">"arn:aws:iam::111122223333:role/app2"</span> &#125;,</span><br><span class="line">            <span class="attr">"Action"</span>: [</span><br><span class="line">                <span class="string">"elasticfilesystem:ClientMount"</span>,</span><br><span class="line">                <span class="string">"elasticfilesystem:ClientWrite"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">                <span class="attr">"StringEquals"</span>: &#123;</span><br><span class="line">                    <span class="attr">"elasticfilesystem:AccessPointArn"</span> : <span class="string">"arn:aws:elasticfilesystem:us-east-1:222233334444:access-point/fsap-89abcdef"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="为-Amazon-EFS-创建-VPC-终端节点策略"><a href="#为-Amazon-EFS-创建-VPC-终端节点策略" class="headerlink" title="为 Amazon EFS 创建 VPC 终端节点策略"></a>为 Amazon EFS 创建 VPC 终端节点策略</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Action"</span>: <span class="string">"*"</span>,</span><br><span class="line">            <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="attr">"Resource"</span>: <span class="string">"*"</span>,</span><br><span class="line">            <span class="attr">"Principal"</span>: <span class="string">"*"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Action"</span>: <span class="string">"elasticfilesystem:CreateFileSystem"</span>,</span><br><span class="line">            <span class="attr">"Effect"</span>: <span class="string">"Deny"</span>,</span><br><span class="line">            <span class="attr">"Resource"</span>: <span class="string">"*"</span>,</span><br><span class="line">            <span class="attr">"Principal"</span>: <span class="string">"*"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> 存储类 </category>
          
          <category> EFS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS EFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EFS-CLI-2</title>
      <link href="2020/12/11/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/EFS/EFS-CLI-2/"/>
      <url>2020/12/11/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/EFS/EFS-CLI-2/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-EFS-相关CLI命令"><a href="#描述-EFS-相关CLI命令" class="headerlink" title="描述: EFS 相关CLI命令"></a>描述: EFS 相关CLI命令</h2><a id="more"></a><h4 id="创建文件系统"><a href="#创建文件系统" class="headerlink" title="创建文件系统"></a>创建文件系统</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">aws efs create-file-system \</span><br><span class="line">    --performance-mode generalPurpose \</span><br><span class="line">    --throughput-mode bursting \</span><br><span class="line">    --encrypted \</span><br><span class="line">    --tags Key=Name,Value=my-file-system</span><br></pre></td></tr></table></figure><h4 id="查看文件系统"><a href="#查看文件系统" class="headerlink" title="查看文件系统"></a>查看文件系统</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws efs describe-file-systems \</span><br><span class="line">    --file-system-id fs-c7a0456e</span><br></pre></td></tr></table></figure><p>在响应中,ValueInIA 显示 IA 存储中的最后一个计量大小。ValueInStandard 显示 Standard 存储中的最后一个计量大小。两者相加等于 Value 显示的整个文件系统的大小。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "FileSystems": [</span><br><span class="line">        &#123;</span><br><span class="line">            "OwnerId": "123456789012",</span><br><span class="line">            "CreationToken": "console-d7f56c5f-e433-41ca-8307-9d9c0example",</span><br><span class="line">            "FileSystemId": "fs-c7a0456e",</span><br><span class="line">            "FileSystemArn": "arn:aws:elasticfilesystem:us-west-2:123456789012:file-system/fs-48499b4d",</span><br><span class="line">            "CreationTime": 1595286880.0,</span><br><span class="line">            "LifeCycleState": "available",</span><br><span class="line">            "Name": "my-file-system",</span><br><span class="line">            "NumberOfMountTargets": 3,</span><br><span class="line">            "SizeInBytes": &#123;</span><br><span class="line">                "Value": 6144,</span><br><span class="line">                "Timestamp": 1600991437.0,</span><br><span class="line">                "ValueInIA": 0,</span><br><span class="line">                "ValueInStandard": 6144</span><br><span class="line">            &#125;,</span><br><span class="line">            "PerformanceMode": "generalPurpose",</span><br><span class="line">            "Encrypted": true,</span><br><span class="line">            "KmsKeyId": "arn:aws:kms:us-west-2:123456789012:key/a59b3472-e62c-42e4-adcf-30d92example",</span><br><span class="line">            "ThroughputMode": "bursting",</span><br><span class="line">            "Tags": [</span><br><span class="line">                &#123;</span><br><span class="line">                    "Key": "Name",</span><br><span class="line">                    "Value": "my-file-system"</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="删除文件系统"><a href="#删除文件系统" class="headerlink" title="删除文件系统"></a>删除文件系统</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws efs delete-file-system \</span><br><span class="line">--file-system-id ID-of-file-system-to-delete</span><br></pre></td></tr></table></figure><h4 id="创建挂载目标"><a href="#创建挂载目标" class="headerlink" title="创建挂载目标"></a>创建挂载目标</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aws efs create-mount-target \</span><br><span class="line">--file-system-id file-system-id \</span><br><span class="line">--subnet-id  subnet-id \</span><br><span class="line">--security-group SGID</span><br></pre></td></tr></table></figure><h4 id="获取挂载目标的描述"><a href="#获取挂载目标的描述" class="headerlink" title="获取挂载目标的描述"></a>获取挂载目标的描述</h4><p>当跨VPC挂载时可用区 ID需要与EC2 所在的可用区 ID相匹配方可挂载</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">aws efs describe-mount-targets --file-system-id file_system_id</span><br><span class="line">&#123;</span><br><span class="line">    "MountTargets": [</span><br><span class="line">        &#123;</span><br><span class="line">            "OwnerId": "111122223333",</span><br><span class="line">            "MountTargetId": "fsmt-11223344", </span><br><span class="line">  =====&gt;    "AvailabilityZoneId": "use2-az2",</span><br><span class="line">            "NetworkInterfaceId": "eni-048c09a306023eeec", </span><br><span class="line">            "AvailabilityZoneName": "us-east-2b", </span><br><span class="line">            "FileSystemId": "fs-01234567", </span><br><span class="line">            "LifeCycleState": "available", </span><br><span class="line">            "SubnetId": "subnet-06eb0da37ee82a64f", </span><br><span class="line">            "OwnerId": "958322738406", </span><br><span class="line">  =====&gt;    "IpAddress": "10.0.2.153"</span><br><span class="line">        &#125;, </span><br><span class="line">...</span><br><span class="line">        &#123;</span><br><span class="line">            "OwnerId": "111122223333",</span><br><span class="line">            "MountTargetId": "fsmt-667788aa", </span><br><span class="line">            "AvailabilityZoneId": "use2-az3", </span><br><span class="line">            "NetworkInterfaceId": "eni-0edb579d21ed39261", </span><br><span class="line">            "AvailabilityZoneName": "us-east-2c", </span><br><span class="line">            "FileSystemId": "fs-01234567", </span><br><span class="line">            "LifeCycleState": "available", </span><br><span class="line">            "SubnetId": "subnet-0ee85556822c441af", </span><br><span class="line">            "OwnerId": "958322738406", </span><br><span class="line">            "IpAddress": "10.0.3.107"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可用区 ID <code>use2-az2</code> 中的挂载目标的 IP 地址为 10.0.2.153。</p><h4 id="删除挂载目标"><a href="#删除挂载目标" class="headerlink" title="删除挂载目标"></a>删除挂载目标</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws efs delete-mount-target \</span><br><span class="line">--mount-target-id ID-of-mount-target-to-delete</span><br></pre></td></tr></table></figure><h4 id="创建访问点"><a href="#创建访问点" class="headerlink" title="创建访问点"></a>创建访问点</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">aws efs create-access-point --file-system-id fs-12345678 --posix-user Uid=0,Gid=0,SecondaryGids=1,2 --root-directory Path="/test",CreationInfo="&#123;OwnerUid=0,OwnerGid=0,Permissions=755&#125;"</span><br><span class="line">&#123;</span><br><span class="line">    "ClientToken": "4c27af46-c1f3-40e6-91ba-9fa58ee71234",</span><br><span class="line">    "Tags": [],</span><br><span class="line">    "AccessPointId": "fsap-1234567890abcdefe",</span><br><span class="line">    "AccessPointArn": "arn:aws:elasticfilesystem:us-east-1:1234567890ab:access-point/fsap-1234567890abcdefe",</span><br><span class="line">    "FileSystemId": "fs-12345678",</span><br><span class="line">    "PosixUser": &#123;</span><br><span class="line">        "Uid": 0,</span><br><span class="line">        "Gid": 0,</span><br><span class="line">        "SecondaryGids": [</span><br><span class="line">            1,</span><br><span class="line">            2</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    "RootDirectory": &#123;</span><br><span class="line">        "Path": "/test",</span><br><span class="line">        "CreationInfo": &#123;</span><br><span class="line">            "OwnerUid": 0,</span><br><span class="line">            "OwnerGid": 0,</span><br><span class="line">            "Permissions": "755"</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "OwnerId": "1234567890ab",</span><br><span class="line">    "LifeCycleState": "creating"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="删除访问点"><a href="#删除访问点" class="headerlink" title="删除访问点"></a>删除访问点</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws efs delete-access-point --access-point-id fsap-1234567890abcdefe</span><br></pre></td></tr></table></figure><h4 id="修改生命周期"><a href="#修改生命周期" class="headerlink" title="修改生命周期"></a>修改生命周期</h4><p><code>TransitionToIA</code> 可能的值 <code>AFTER_7_DAYS</code> <code>AFTER_14_DAYS</code> <code>AFTER_30_DAYS</code> <code>AFTER_60_DAYS</code> <code>AFTER_90_DAYS</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aws efs put-lifecycle-configuration \</span><br><span class="line">  --file-system-id File-System-ID \</span><br><span class="line">  --lifecycle-policies TransitionToIA=AFTER_60_DAYS</span><br></pre></td></tr></table></figure><h4 id="停止生命周期"><a href="#停止生命周期" class="headerlink" title="停止生命周期"></a>停止生命周期</h4><p>将 <code>--lifecycle-policies</code> 属性留空</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aws efs put-lifecycle-configuration \</span><br><span class="line">  --file-system-id File-System-ID \</span><br><span class="line">  --lifecycle-policies</span><br></pre></td></tr></table></figure><h4 id="打开自动备份"><a href="#打开自动备份" class="headerlink" title="打开自动备份"></a>打开自动备份</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws efs put-backup-policy --file-system-id fs-01234567 \</span><br><span class="line">--backup-policy Status="ENABLED"</span><br></pre></td></tr></table></figure><h4 id="关闭自动备份"><a href="#关闭自动备份" class="headerlink" title="关闭自动备份"></a>关闭自动备份</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws efs put-backup-policy --file-system-id fs-01234567 \</span><br><span class="line">--backup-policy Status="DISABLED"</span><br></pre></td></tr></table></figure><h4 id="创建文件系统标签"><a href="#创建文件系统标签" class="headerlink" title="创建文件系统标签"></a>创建文件系统标签</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">aws efs tag-resource \</span><br><span class="line">  --resource-id fs-c7a0456e \</span><br><span class="line">  --tags \</span><br><span class="line">      Key=Department,Value=dev \</span><br><span class="line">      Key=Environment,Value="int business"</span><br></pre></td></tr></table></figure><h4 id="访问点标签"><a href="#访问点标签" class="headerlink" title="访问点标签"></a>访问点标签</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">aws efs tag-resource \</span><br><span class="line">  --resource-id Access-Point-Id \</span><br><span class="line">  --tags \</span><br><span class="line">      Key=Department,Value=dev \</span><br><span class="line">      Key=AccessTeam,Value="Data_Lake"</span><br></pre></td></tr></table></figure><h4 id="检索与文件系统关联的所有标签"><a href="#检索与文件系统关联的所有标签" class="headerlink" title="检索与文件系统关联的所有标签"></a>检索与文件系统关联的所有标签</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws efs list-tags-for-resource \</span><br><span class="line">  --resource-id File-System-Id</span><br></pre></td></tr></table></figure><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> 存储类 </category>
          
          <category> EFS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS EFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EFS-概述-1</title>
      <link href="2020/12/11/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/EFS/EFS-%E6%A6%82%E8%BF%B0-1/"/>
      <url>2020/12/11/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/EFS/EFS-%E6%A6%82%E8%BF%B0-1/</url>
      
        <content type="html"><![CDATA[<h2 id="描述"><a href="#描述" class="headerlink" title="描述:"></a>描述:</h2><a id="more"></a><h3 id="EFS简介"><a href="#EFS简介" class="headerlink" title="EFS简介"></a>EFS简介</h3><p>Amazon Elastic File System (Amazon EFS) 可提供简单、可扩展、完全托管的弹性 NFS 文件系统，可在不中断应用程序的情况下按需扩展到 PB 级，随着添加或删除文件而自动扩展或缩减，无需预置和管理容量，可自适应增长。支持传输中加密和静态加密.支持网络文件系统版本 4（NFSv4.1 和 NFSv4.0）协议,多个 Amazon EC2 实例可以同时访问 Amazon EFS 文件系统，为在多个实例或服务器上运行的工作负载和应用程序提供通用数据源。</p><p>Amazon EFS 提供两种存储类别：Standard 和 Infrequent Access。EFS 生命周期管理是文件系统管理经济高效的文件存储。启用后，生命周期管理会将在一段设定时间内(7,14,30,60和90天)未访问的文件迁移到不常访问 (IA) 存储类别。费用降低10倍,读取是会按读取的文件大小收费.小于 128KB 的文件不符合生命周期管理条件，其将始终存储在标准类别中.</p><p>创建文件系统后，默认情况下，只有根用户 (UID 0) 具有读取、写入和执行权限。为了让其他用户也能修改文件系统，根用户必须明确授予他们访问权限。可以使用访问点自动创建非根用户可从中写入的目录.</p><h3 id="性能模式"><a href="#性能模式" class="headerlink" title="性能模式"></a>性能模式</h3><p>两种性能模式: </p><ul><li>默认通用性能模式,非常适合对延迟敏感的使用案例，如 Web 服务环境、内容管理系统、主目录和一般文件服务.</li><li>最大 I/O 模式下的文件系统可以扩展到更高级别的聚合吞吐量和每秒操作数，但代价是稍高的文件元数据操作延迟. 如大数据分析、媒体处理和基因组分析等高度并行化的应用程序和工作负载可以受益于这种模式.</li></ul><p><a href="https://docs.aws.amazon.com/zh_cn/efs/latest/ug/performance.html#throughput-modes" target="_blank" rel="noopener">如何确定性能模式选择</a></p><p>两种吞吐量模式:</p><ul><li>默认突增吞吐量模式，吞吐量随着文件系统的增长而扩展.</li><li>预置吞吐量模式，可以指定与存储的数据量无关的文件系统的吞吐量,贵一些.</li></ul><p><a href="https://docs.aws.amazon.com/zh_cn/efs/latest/ug/performance.html#throughput-modes" target="_blank" rel="noopener">如何确认吞吐量模式</a></p><p>EFS定价与存储类别和预置IO有关,与性能模式无关</p><h3 id="EFS与EBS"><a href="#EFS与EBS" class="headerlink" title="EFS与EBS"></a>EFS与EBS</h3><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>存储特性比较</td><td>Amazon EFS</td><td>Amazon EBS 预置 IOPS</td></tr><tr><td>可用性与持久性</td><td>数据冗余存储在多个可用区中。</td><td>数据冗余存储在一个可用区中</td></tr><tr><td>访问</td><td>多个可用区的多达数千个 Amazon EC2 实例可以同时连接到一个文件系统</td><td>一个可用区的一个 Amazon EC2 实例可以连接到一个文件系统</td></tr><tr><td>使用案例</td><td>大数据和分析、媒体处理工作流、内容管理、Web 服务和主目录</td><td>引导卷、事务型数据库和 NoSQL 数据库、数据仓库和 ETL</td></tr></tbody></table><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>性能比较</td><td>Amazon EFS</td></tr><tr><td>每次操作的延迟</td><td>低且一致的延迟</td></tr><tr><td>吞吐量规模</td><td>每秒 10+ GB</td></tr></tbody></table><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>简单价格比较</td><td>Amazon EFS</td></tr><tr><td>标准存储(GB/月)</td><td>0.3 USD</td></tr></tbody></table><p>Amazon EFS 文件系统的性能特征不依赖于使用 EBS 优化的实例</p><h3 id="定价"><a href="#定价" class="headerlink" title="定价"></a>定价</h3><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>标准存储（GB/月）</td><td>0.30 USD</td></tr><tr><td>不频繁访问存储类（GB/月）</td><td>0.025 USD</td></tr><tr><td>不频繁访问请求（根据传输的 GB 数）</td><td>0.01 USD</td></tr><tr><td>预置吞吐量（MB/s/月）</td><td>6.00 USD</td></tr><tr><td><a href="https://aws.amazon.com/cn/efs/pricing/" target="_blank" rel="noopener">EFS定价及示例</a></td><td></td></tr></tbody></table><h3 id="挂载EFS"><a href="#挂载EFS" class="headerlink" title="挂载EFS"></a>挂载EFS</h3><p>一次只能在一个 VPC 中基于 Amazon VPC 服务使用 Amazon EFS 文件系统。也就是说，在 VPC 中为文件系统创建挂载目标，并使用这些挂载目标提供对该文件系统的访问权限。想要切换至不同的VPC,需要先将所有VPC的挂载点删除,该操作不会影响EFS内的数据.</p><p>谁可以挂载:</p><ul><li>同一 VPC 中的 Amazon EC2 实例</li><li>VPC 中通过 VPC 对等连接的 EC2 实例,当跨VPC挂载时可用区 ID需要与EC2 所在的可用区 ID相匹配方可挂载</li><li>通过使用 AWS Direct Connect 的本地服务器</li><li>使用 Amazon VPC 通过 AWS 虚拟专用网络 (VPN) 的本地服务器</li><li><em>Amazon EFS 不支持从 Amazon EC2 Windows 实例挂载</em></li></ul><p>挂载EFS可以使用efs挂载和nfs挂载,efs挂载可以很简单地配置在传输过程中加密</p><h4 id="EFS挂载先决条件"><a href="#EFS挂载先决条件" class="headerlink" title="EFS挂载先决条件"></a>EFS挂载先决条件</h4><p>Amazon EFS client(amazon-efs-utils软件包)是 Amazon EFS 工具, <a href="https://github.com/aws/efs-utils" target="_blank" rel="noopener">GitHub地址</a>.</p><p>Ubuntu安装EFS客户端:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo apt update &amp;&amp; sudo apt-get -y install binutils</span><br><span class="line"><span class="meta">$</span> git clone https://github.com/aws/efs-utils</span><br><span class="line"><span class="meta">$</span> cd efs-utils &amp;&amp; ./build-deb.sh</span><br><span class="line"><span class="meta">$</span> sudo apt-get -y install ./build/amazon-efs-utils*deb</span><br></pre></td></tr></table></figure><h5 id="efs手动挂载"><a href="#efs手动挂载" class="headerlink" title="efs手动挂载"></a>efs手动挂载</h5><p>运行以下命令以挂载文件系统。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo mount -t efs fs-12345678:/ /mnt/efs</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">或者，如果要使用传输中的数据加密，可以使用以下命令挂载文件系统。</span><br><span class="line">```shell</span><br><span class="line"><span class="meta">$</span> sudo mount -t efs -o tls fs-12345678:/ /mnt/efs</span><br></pre></td></tr></table></figure><p>访问点挂载</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t efs -o tls,accesspoint=fsap-12345678 fs-12345678: /localmountpoint</span><br></pre></td></tr></table></figure><h5 id="efs自动挂载"><a href="#efs自动挂载" class="headerlink" title="efs自动挂载"></a>efs自动挂载</h5><p>正常自动挂载文件系统，请将以下行添加到 /etc/fstab 文件中。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file-system-id efs-mount-point efs _netdev,tls 0 0</span><br></pre></td></tr></table></figure><p>要使用 IAM 授权自动挂载到具有实例配置文件的 Amazon EC2 实例，请将以下行添加 /etc/fstab 文件中。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file-system-id:/ efs-mount-point efs _netdev,tls,iam 0 0</span><br></pre></td></tr></table></figure><p>要使用凭证文件通过 IAM 授权自动挂载到 Linux 实例，请将以下行添加到 /etc/fstab 文件中。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file-system-id:/ efs-mount-point efs _netdev,tls,iam,awsprofile=namedprofile 0 0</span><br></pre></td></tr></table></figure><p>要使用 EFS 访问点自动挂载文件系统，请将以下行添加到 /etc/fstab 文件中。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file-system-id efs-mount-point efs _netdev,tls,accesspoint=access-point-id 0 0</span><br></pre></td></tr></table></figure><p>通过将带 ‘fake’ 选项的 mount 命令与 ‘all’ 和 ‘verbose’ 选项结合使用来测试 fstab 条目。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo mount -fav</span><br><span class="line">home/ec2-user/efs      : successfully mounted</span><br></pre></td></tr></table></figure><p><a href="https://docs.aws.amazon.com/zh_cn/efs/latest/ug/mount-multiple-ec2-instances.html" target="_blank" rel="noopener">使用 AWS Systems Manager 将 EFS 挂载到多个 EC2 实例</a></p><p><a href="https://docs.aws.amazon.com/zh_cn/efs/latest/ug/manage-fs-access-vpc-peering.html#mount-fs-different-vpc" target="_blank" rel="noopener">从另一个账户或 VPC 挂载 EFS 文件系统</a></p><h4 id="nfs挂载"><a href="#nfs挂载" class="headerlink" title="nfs挂载"></a>nfs挂载</h4><p>为获得最佳性能以及避免出现各种已知的 NFS 客户端错误，建议使用最新的 Linux 内核。如果使用的是企业 Linux 发行版，建议使用以下版本：</p><ul><li>Amazon Linux 2</li><li>Amazon Linux 2015.09 或更高版本</li><li>RHEL 7.3 或更高版本</li><li>具有内核 2.6.32-696 或更高版本的 RHEL 6.9</li><li>所有 Ubuntu 16.04 版本</li><li>具有内核 3.13.0-83 或更高版本的 Ubuntu 14.04</li><li>SLES 12 Sp2 或更高版本</li><li>如果使用其他发行版或自定义内核，建议使用内核 4.3 或更高版本。</li></ul><p><a href="https://docs.aws.amazon.com/zh_cn/efs/latest/ug/mounting-fs-nfs-mount-settings.html" target="_blank" rel="noopener">NFS挂载建议</a></p><p>安装nfs客户端</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> Red Hat</span><br><span class="line">sudo yum -y update </span><br><span class="line">sudo yum -y install nfs-utils</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Ubuntu</span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt -y install nfs-common</span><br><span class="line"></span><br><span class="line">sudo service nfs start</span><br><span class="line">sudo service nfs status</span><br></pre></td></tr></table></figure><h5 id="nfs传输加密"><a href="#nfs传输加密" class="headerlink" title="nfs传输加密"></a>nfs传输加密</h5><p><a href="https://docs.aws.amazon.com/zh_cn/efs/latest/ug/encryption-in-transit.html#how-encrypt-transit" target="_blank" rel="noopener">https://docs.aws.amazon.com/zh_cn/efs/latest/ug/encryption-in-transit.html#how-encrypt-transit</a></p><h5 id="手动nfs挂载"><a href="#手动nfs挂载" class="headerlink" title="手动nfs挂载"></a>手动nfs挂载</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> IP挂载,IP可以在EFS控制台和CLI describe-mount-targets中找到</span><br><span class="line">sudo mount -t nfs -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport mount-target-IP:/   ~/efs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 文件系统DNS挂载</span><br><span class="line">sudo mount -t nfs -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport file-system-ID.efs.aws-region.amazonaws.com:/mike  /home/mike/mikeEFS</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 挂载目标DNS挂载,同一可用区中删除并新建挂载目标不会影响挂载目标的DNS</span><br><span class="line">sudo mount -t nfs -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport availability-zone.file-system-id.efs.aws-region.amazonaws.com</span><br><span class="line">:/mike  /home/mike/mikeEFS</span><br></pre></td></tr></table></figure><h5 id="自动nfs挂载"><a href="#自动nfs挂载" class="headerlink" title="自动nfs挂载"></a>自动nfs挂载</h5><p>将以下行添加到 /etc/fstab 文件中</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file-system-ID.efs.aws-region.amazonaws.com:/ /var/www/html/efs-mount-point   nfs4   defaults</span><br></pre></td></tr></table></figure><p>卸载</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount /mnt/efs</span><br></pre></td></tr></table></figure><h3 id="监控EFS"><a href="#监控EFS" class="headerlink" title="监控EFS"></a>监控EFS</h3><p><a href="https://docs.aws.amazon.com/zh_cn/efs/latest/ug/monitoring-cloudwatch.html#efs-metrics" target="_blank" rel="noopener">EFS metric</a><br><a href="https://docs.aws.amazon.com/zh_cn/efs/latest/ug/logging-using-cloudtrail.html" target="_blank" rel="noopener">CloudTrail</a></p><table><thead><tr><th>主要指标</th><th>如何确认</th></tr></thead><tbody><tr><td>吞吐量</td><td>监控 Sum 指标的每日 TotalIOBytes 统计数据以查看吞吐量</td></tr><tr><td>Amazon EC2 实例链接数数量</td><td>监控 Sum 指标的 ClientConnections 统计数据</td></tr><tr><td>突增积分余额</td><td>监控文件系统的 BurstCreditBalance 指标,如果 BurstCreditBalance 指标的值为零或稳步下降，则使用预置吞吐量</td></tr><tr><td>性能</td><td>监控 PercentIOLimit 百分比达到或接近 100%，应用程序应使用最大 I/O 性能模式</td></tr></tbody></table><p>从存储库安装 amazon-efs-utils 软件包时,可以通过取消 cloudwatch-log 部分中的 # enabled = true 行的注释来手动更新 /etc/amazon/efs/efs-utils.conf 配置文件,CloudWatch日志组: /aws/efs/utils 日志组</p><p>EFS的挂载日志在这<code>/var/log/amazon/efs</code>. </p><h3 id="数据保护"><a href="#数据保护" class="headerlink" title="数据保护"></a>数据保护</h3><p>AWS Backup 是一种统一备份服务，旨在简化备份的创建、迁移、恢复和删除，同时提供改进的报告和审核,它可以:</p><ul><li>配置并审核要备份的 AWS 资源</li><li>自动备份计划</li><li>设置保留策略</li><li>监控所有最近的备份和还原活动</li></ul><h4 id="增量备份"><a href="#增量备份" class="headerlink" title="增量备份:"></a>增量备份:</h4><p>在初始备份期间，将创建整个文件系统的副本。在该文件系统的后续备份期间，只复制已更改、已添加或已删除的文件和目录。</p><h4 id="一致性"><a href="#一致性" class="headerlink" title="一致性"></a>一致性</h4><p>如果在执行备份时对文件系统进行了修改，则可能会出现不一致，例如重复、偏差或排除的数据。这些修改包括写入、重命名、移动或删除操作。为确保一致的备份,备份过程中暂停修改文件系统的应用程序或进程。或者，将备份安排在不修改文件系统期间。</p><h4 id="存储类型"><a href="#存储类型" class="headerlink" title="存储类型"></a>存储类型</h4><p>AWS Backup 备份 EFS 文件系统中的所有数据,对于IA类型的备份,不会产生数据访问费用.还原恢复点时，会将所有文件还原到<em>标准存储类别</em></p><h4 id="并发备份"><a href="#并发备份" class="headerlink" title="并发备份"></a>并发备份</h4><p>AWS Backup 将备份限制为每个资源一个并发备份。因此，如果备份作业已在进行中，则计划备份或按需备份可能会失败。</p><h4 id="还原"><a href="#还原" class="headerlink" title="还原"></a>还原</h4><p>AWS Backup 可以将恢复点还原到新的 EFS 文件系统或源文件系统。可以执行完全还原，这会还原整个文件系统。或者可以使用部分还原来还原特定的文件和目录。还原特定文件或目录，必须指定与挂载点相关的相对路径。例如,如果文件系统挂载到 /user/home/myname/efs 并且文件路径为 user/home/myname/efs/file1,请输入 /file1。 <strong>路径区分大小写,不能包含特殊字符、通配符和正则表达式字符串</strong>。</p><p>执行完全还原或部分还原时，恢复点将还原到根目录下的还原目录 aws-backup-restore_<code>timestamp-of-restore</code>并保留原始文件目录结构.当得到想要的还原数据并另行保存后,记得删除这个还原目录.</p><p><strong>还有2种数据备份方式</strong> </p><ul><li><a href="https://aws.amazon.com/cn/solutions/implementations/efs-to-efs-backup-solution/#" target="_blank" rel="noopener">EFS to EFS</a></li><li><a href="https://docs.aws.amazon.com/zh_cn/efs/latest/ug/alternative-efs-backup.html" target="_blank" rel="noopener">AWS Data pipeline</a></li></ul><h3 id="演练"><a href="#演练" class="headerlink" title="演练"></a>演练</h3><ul><li><a href="https://docs.aws.amazon.com/zh_cn/efs/latest/ug/wt2-apache-web-server.html" target="_blank" rel="noopener">演练：设置 Apache Web 服务器并提供 Amazon EFS 文件服务</a></li><li><a href="https://docs.aws.amazon.com/zh_cn/efs/latest/ug/accessing-fs-nfs-permissions-per-user-subdirs.html" target="_blank" rel="noopener">演练：创建可写的每用户子目录以及配置在重启时自动重新挂载</a></li><li><a href="https://docs.aws.amazon.com/zh_cn/efs/latest/ug/efs-onpremises.html#wt5-step4-install-nfs" target="_blank" rel="noopener">演练：使用 AWS Direct Connect 和 VPN 在本地创建和挂载文件系统: 主要修改/etc/host</a></li><li><a href="https://docs.aws.amazon.com/zh_cn/efs/latest/ug/efs-enforce-encryption.html" target="_blank" rel="noopener">演示 强制加密 Amazon EFS 静态文件系统: 将CloudTrail的事件发送到CloudWatch Log然后filter并创建警报</a></li></ul><h3 id="访问点"><a href="#访问点" class="headerlink" title="访问点"></a>访问点</h3><p>如果用户从两个不同的 EC2 实例访问 Amazon EFS 文件系统，根据用户的 UID 在这些实例上是相同还是不同，会看到如下所示的不同行为：</p><ul><li>如果两个 EC2 实例上的用户 IDs 相同,则 Amazon EFS 会将其视为指明同一用户,而不考虑所用的 EC2 实例。从两个 EC2 实例访问文件系统的用户体验相同。</li><li>如果两个 EC2 实例上的用户 IDs 不相同,则 Amazon EFS 会将其视为不同的用户。从两个不同的 EC2 实例访问 Amazon EFS 文件系统的用户体验不相同。</li><li>如果不同 EC2 实例上的两个不同用户共享一个 ID，则 Amazon EFS 会将其视为同一个用户。</li></ul><p>Ubuntu user的默认用户ID和组ID都是1000</p><p><a href="https://docs.aws.amazon.com/zh_cn/efs/latest/ug/accessing-fs-nfs-permissions.html" target="_blank" rel="noopener">详细权限说明看这里</a></p><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> 存储类 </category>
          
          <category> EFS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS EFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell-grep</title>
      <link href="2020/12/07/Bash/shell-grep/"/>
      <url>2020/12/07/Bash/shell-grep/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-grep可以筛选特定字符串"><a href="#描述-grep可以筛选特定字符串" class="headerlink" title="描述: grep可以筛选特定字符串"></a>描述: grep可以筛选特定字符串</h2><a id="more"></a><p>查看指定时间的日志条目</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -n '2019-10-24 00:01:11' *.log</span><br></pre></td></tr></table></figure><p>通过正则表达式查找匹配的行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> grep –e "正则表达式" 文件名</span><br></pre></td></tr></table></figure><p>反向查找</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> grep –v "被查找的字符串" 文件名</span><br></pre></td></tr></table></figure><p>递归查找当前目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> grep -rn "string" ./</span><br></pre></td></tr></table></figure><p>显示查找字符以及前后两行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> grep -C2 "string" ./file</span><br></pre></td></tr></table></figure><p>找到符合条件的整列并修改</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if grep -xq "system.secret-key: '!!changeme!!'" $SENTRY_CONFIG_YML ; then</span><br><span class="line">  echo ""</span><br><span class="line">  echo "Generating secret key..."</span><br><span class="line">  SECRET_KEY=$(export LC_ALL=C; head /dev/urandom | tr -dc "a-z0-9@#%^&amp;*(-_=+)" | head -c 50 | sed -e 's/[\/&amp;]/\\&amp;/g')</span><br><span class="line">  sed -i -e 's/^system.secret-key:.*$/system.secret-key: '"'$SECRET_KEY'"'/' $SENTRY_CONFIG_YML</span><br><span class="line">  echo "Secret key written to $SENTRY_CONFIG_YML"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> shell命令 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell-scp</title>
      <link href="2020/12/07/Bash/shell-scp/"/>
      <url>2020/12/07/Bash/shell-scp/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-SCP命令"><a href="#描述-SCP命令" class="headerlink" title="描述: SCP命令"></a>描述: SCP命令</h2><a id="more"></a><p>scp [参数] [原路径] [目标路径]</p><p>Case 1: 将本地文件发送到远端</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp local_file remote_username@remote_ip:remote_file</span><br><span class="line">scp -i key.pem local_file remote_username@remote_ip:remote_file</span><br></pre></td></tr></table></figure><p>Case 2: 将本地文件夹发送到远端, 递归模式 <code>-r</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp -r local_folder remote_username@remote_ip:remote_folder</span><br><span class="line">scp -i key.pem -r local_folder remote_username@remote_ip:remote_folder</span><br></pre></td></tr></table></figure><p>Case 3: 啰嗦模式 <code>-v</code>,检查错误的好方法</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -v ~/123.txt username@remote_ip:/home/ubuntu/456.txt</span><br></pre></td></tr></table></figure><p>Case 4: 多个文件之间用空格隔开</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp 123.txt 456.txt username@remote_ip:/home/ubuntu/directory/</span><br></pre></td></tr></table></figure><p>Case 5: 两个远程主机之间复制文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp user1@remotehost1:/some/remote/dir/foobar.txt user2@remotehost2:/some/remote/dir/</span><br></pre></td></tr></table></figure><p>Case 6: 压缩复制文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -vrC ~/Downloads root@192.168.1.3:/root/Downloads</span><br></pre></td></tr></table></figure><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> shell命令 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell-if判断</title>
      <link href="2020/12/07/Bash/shell-if%E5%88%A4%E6%96%AD/"/>
      <url>2020/12/07/Bash/shell-if%E5%88%A4%E6%96%AD/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-if判断"><a href="#描述-if判断" class="headerlink" title="描述: if判断"></a>描述: if判断</h2><a id="more"></a><h3 id="文件目录判定"><a href="#文件目录判定" class="headerlink" title="文件目录判定"></a>文件目录判定</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-e filename  如果 filename存在，则为真  [ -e /var/log/syslog ]</span><br><span class="line">-d filename  如果 filename为目录，则为真  [ -d /tmp/mydir ]</span><br><span class="line">-f filename  如果 filename为常规文件，则为真  [ -f /usr/bin/grep ]</span><br><span class="line">-L filename  如果 filename为符号链接，则为真  [ -L /usr/bin/grep ]</span><br><span class="line">-r filename  如果 filename可读，则为真  [ -r /var/log/syslog ]</span><br><span class="line">-w filename  如果 filename可写，则为真  [ -w /var/mytmp.txt ]</span><br><span class="line">-x filename  如果 filename可执行，则为真  [ -L /usr/bin/grep ]</span><br><span class="line">filename1-nt filename2  如果 filename1比 filename2新，则为真  [ /tmp/install/etc/services -nt /etc/services ]</span><br><span class="line">filename1-ot filename2  如果 filename1比 filename2旧，则为真  [ /boot/bzImage -ot arch/i386/boot/bzImage ]</span><br></pre></td></tr></table></figure><h3 id="字符串比较运算符"><a href="#字符串比较运算符" class="headerlink" title="字符串比较运算符"></a>字符串比较运算符</h3><p>（请注意引号的使用，这是防止空格扰乱代码的好方法）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-z string  如果 string长度为零，则为真  [ -z &quot;$myvar&quot; ]</span><br><span class="line">-n string  如果 string长度非零，则为真  [ -n &quot;$myvar&quot; ]</span><br><span class="line">string1 = string2  如果 string1与 string2相同，则为真  [[ &quot;$myvar&quot; = &quot;one two three&quot; ]]</span><br><span class="line">string1 != string2  如果 string1与 string2不同，则为真  [[ &quot;$myvar&quot; != &quot;one two three&quot; ]]</span><br><span class="line">string1 =~ string2  如果 string2是 string1的一部分，则为真  [[ &quot;$myvar&quot; =~ &quot;one two three&quot; ]]</span><br><span class="line">string1 = string2  如果 string2是 string1的一部分，则为真  [[ &quot;$myvar&quot; = &quot;*one two three*&quot; ]]</span><br></pre></td></tr></table></figure><h3 id="算术比较运算符"><a href="#算术比较运算符" class="headerlink" title="算术比较运算符"></a>算术比较运算符</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">num1-eq num2  等于 [ 3 -eq $mynum ]</span><br><span class="line">num1-ne num2  不等于 [ 3 -ne $mynum ]</span><br><span class="line">num1-lt num2  小于 [ 3 -lt $mynum ]</span><br><span class="line">num1-le num2  小于或等于 [ 3 -le $mynum ]</span><br><span class="line">num1-gt num2  大于 [ 3 -gt $mynum ]</span><br><span class="line">num1-ge num2  大于或等于 [ 3 -ge $mynum ]</span><br></pre></td></tr></table></figure><p>1：判断目录<code>$dir</code>是否存在，若不存在，则新建一个</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if [ ! -d "$dir"]; then</span><br><span class="line">　　mkdir "$dir"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>2：判断普通文件<code>$file</code>是否存，若不存在，则新建一个</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if [ ! -f "$file" ]; then</span><br><span class="line">　　touch "$file"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>3：判断<code>$sh</code>是否存在并且是否具有可执行权限</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if [ ! -x "$sh"]; then</span><br><span class="line">    chmod +x "$sh"</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>4：是判断变量<code>$var</code>是否有值</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if [ ! -n "$var" ]; then</span><br><span class="line">　　echo "$var is empty"</span><br><span class="line">　　exit 0</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> shell命令 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell远程执行命令</title>
      <link href="2020/12/07/Bash/shell%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/"/>
      <url>2020/12/07/Bash/shell%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-shell远程执行命令"><a href="#描述-shell远程执行命令" class="headerlink" title="描述: shell远程执行命令"></a>描述: shell远程执行命令</h2><a id="more"></a><p>经常需要远程到其他节点上执行一些shell命令</p><h3 id="对于简单的命令"><a href="#对于简单的命令" class="headerlink" title="对于简单的命令"></a>对于简单的命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i key.pem -o StrictHostKeyChecking=no user@remoteNode "cd /home ; ls"</span><br></pre></td></tr></table></figure><h3 id="需要屏幕的命令"><a href="#需要屏幕的命令" class="headerlink" title="需要屏幕的命令"></a>需要屏幕的命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 例如top</span><br><span class="line">ssh -i key.pem -o StrictHostKeyChecking=no -t user@remoteNode "top"</span><br></pre></td></tr></table></figure><h3 id="对于脚本的方式"><a href="#对于脚本的方式" class="headerlink" title="对于脚本的方式"></a>对于脚本的方式</h3><h4 id="执行本地脚本"><a href="#执行本地脚本" class="headerlink" title="执行本地脚本"></a>执行本地脚本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i key.pem -o StrictHostKeyChecking=no -t user@remoteNode &lt; test.sh</span><br></pre></td></tr></table></figure><h4 id="执行远程脚本"><a href="#执行远程脚本" class="headerlink" title="执行远程脚本"></a>执行远程脚本</h4><p>远程脚本需要绝对路径</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i key.pem -o StrictHostKeyChecking=no -t user@remoteNode "/home/"</span><br></pre></td></tr></table></figure><h3 id="脚本传递参数"><a href="#脚本传递参数" class="headerlink" title="脚本传递参数"></a>脚本传递参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i key.pem -o StrictHostKeyChecking=no -t user@remoteNode "bash -s" &lt; test.sh helloworld</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line">ssh user@remoteNode &gt; /dev/null 2&gt;&amp;1 &lt;&lt; EOF</span><br><span class="line">cd /home</span><br><span class="line">touch abcdefg.txt</span><br><span class="line">exit</span><br><span class="line">EOF</span><br><span class="line">echo done!</span><br></pre></td></tr></table></figure><p>远程执行的内容在“&lt;&lt; EOF ” 至“ EOF ”之间，在远程机器上的操作就位于其中，注意的点：</p><ul><li>重定向目的在于不显示远程的输出了</li><li>在结束前，加exit退出远程节点</li></ul><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>将<code>$HOME/src/</code>目录下面的所有文件，复制到远程主机的<code>$HOME/src/</code>目录。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> cd &amp;&amp; tar czv src | ssh user@host 'tar xz'</span><br></pre></td></tr></table></figure><p>将远程主机<code>$HOME/src/</code>目录下面的所有文件，复制到用户的当前目录。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ssh user@host 'tar cz src' | tar xzv</span><br></pre></td></tr></table></figure><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell脚本执行时间</title>
      <link href="2020/12/07/Bash/shell%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C%E6%97%B6%E9%97%B4/"/>
      <url>2020/12/07/Bash/shell%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C%E6%97%B6%E9%97%B4/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-shell脚本的执行时间"><a href="#描述-shell脚本的执行时间" class="headerlink" title="描述: shell脚本的执行时间"></a>描述: shell脚本的执行时间</h2><a id="more"></a><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">START_TIME=`date '+%F %T'`</span><br><span class="line"><span class="meta">#</span> code......</span><br><span class="line">DONE_TIME=`date '+%F %T'`</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Consuming Time Calculate</span><br><span class="line">TOTAL_TIME=$((`date -d "$DONE_TIME" +%s`-`date -d "$START_TIME" +%s`))</span><br><span class="line"></span><br><span class="line">function Time_convert()&#123;</span><br><span class="line">  Seconds=$(($1%60))</span><br><span class="line">  Mins=$(( $1/60 ))</span><br><span class="line">  echo "$2 : $Mins min(s) $Seconds s"</span><br><span class="line">&#125;</span><br><span class="line">echo ""</span><br><span class="line">Time_convert $TOTAL_TIME "Prepare Time "</span><br><span class="line">echo ""</span><br></pre></td></tr></table></figure><p>另外一种</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">START_TIME=$(date +%s)</span><br><span class="line"><span class="meta">#</span> code......</span><br><span class="line">DONE_TIME=$(date +%s)</span><br><span class="line"><span class="meta">#</span> Consuming Time Calculate</span><br><span class="line">TOTAL_TIME=$(($DONE_TIME-$START_TIME))</span><br><span class="line"></span><br><span class="line">function Time_convert()&#123;</span><br><span class="line">    Seconds=$(($1%60))</span><br><span class="line">    Mins=$(( $1/60 ))</span><br><span class="line">    write_log "$2 : $Mins min(s) $Seconds s"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Time_convert $TOTAL_TIME "Deployment Time "</span><br></pre></td></tr></table></figure><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell-for循环</title>
      <link href="2020/12/07/Bash/shell-for%E5%BE%AA%E7%8E%AF/"/>
      <url>2020/12/07/Bash/shell-for%E5%BE%AA%E7%8E%AF/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-for循环的常见用法"><a href="#描述-for循环的常见用法" class="headerlink" title="描述: for循环的常见用法"></a>描述: for循环的常见用法</h2><a id="more"></a><h3 id="列表循环"><a href="#列表循环" class="headerlink" title="列表循环"></a>列表循环</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">envs=(test int dev stage prod)</span><br><span class="line">for env in $&#123;envs[@]&#125;; do </span><br><span class="line">    echo "$env"</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="参数循环"><a href="#参数循环" class="headerlink" title="参数循环"></a>参数循环</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for a in $@</span><br><span class="line">do</span><br><span class="line">    echo $a</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="数字循环"><a href="#数字循环" class="headerlink" title="数字循环"></a>数字循环</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for((i=1;i&lt;=10;i++));do </span><br><span class="line">    echo $(expr $i \* 3 + 1);</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="数字循环-1"><a href="#数字循环-1" class="headerlink" title="数字循环"></a>数字循环</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for i in $(seq 1 10)</span><br><span class="line">do </span><br><span class="line">    echo $(expr $i \* 3 + 1);</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="当前目录文件循环"><a href="#当前目录文件循环" class="headerlink" title="当前目录文件循环"></a>当前目录文件循环</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for i in `ls`;do </span><br><span class="line">    echo $i is file name\!;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="字符循环"><a href="#字符循环" class="headerlink" title="字符循环"></a>字符循环</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">services=&quot;a b c d&quot;</span><br><span class="line">for service in $&#123;services&#125;; do</span><br><span class="line">    echo &quot;$service is cool&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="普通循环"><a href="#普通循环" class="headerlink" title="普通循环"></a>普通循环</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for i in f1 f2 f3;do</span><br><span class="line">    echo $i is appoint;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> shell命令 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>疑难杂症-Markdown补全</title>
      <link href="2020/12/07/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87-Markdown%E8%A1%A5%E5%85%A8/"/>
      <url>2020/12/07/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87-Markdown%E8%A1%A5%E5%85%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-在VSCode中开启Markdown补全以及添加自定义格式"><a href="#描述-在VSCode中开启Markdown补全以及添加自定义格式" class="headerlink" title="描述: 在VSCode中开启Markdown补全以及添加自定义格式"></a>描述: 在VSCode中开启Markdown补全以及添加自定义格式</h2><a id="more"></a><ol><li><p>编辑setting.json配置文件</p><p> 工作区添加<code>.vscode/settings.json</code>文件<br> <img src="1.png" alt></p><p> 以我的git路径为例</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim ~/git/.vscode/settings.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;[markdown]&quot;: &#123;</span><br><span class="line">        &quot;editor.quickSuggestions&quot;: true, //开启提示</span><br><span class="line">        &quot;editor.snippetSuggestions&quot;: &quot;top&quot;, //提示优先</span><br><span class="line">        &quot;editor.tabCompletion&quot;: &quot;on&quot;, //tab补全</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>编辑Markdown.json配置文件</p><p> VSCode 首选项-&gt;用户代码片段-&gt;MarkDown</p><p> 将以下内容加入到markdown.json中并保存.</p> <figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="code">    "new article": &#123;</span></span><br><span class="line"><span class="code">        "prefix": "new", //触发词</span></span><br><span class="line"><span class="code">        "body": [ //内容</span></span><br><span class="line"><span class="code">            "---",</span></span><br><span class="line"><span class="code">            "title: $1",</span></span><br><span class="line"><span class="code">            "categories:",</span></span><br><span class="line"><span class="code">            "  - $2",</span></span><br><span class="line"><span class="code">            "tags:",</span></span><br><span class="line"><span class="code">            "  - $3",</span></span><br><span class="line"><span class="code">            "date: $CURRENT_YEAR-$CURRENT_MONTH-$CURRENT_DATE $CURRENT_HOUR:$CURRENT_MINUTE:$CURRENT_SECOND",</span></span><br><span class="line"><span class="code">            "---",</span></span><br><span class="line"><span class="code">            "",</span></span><br><span class="line"><span class="code">            "## 描述: ",</span></span><br><span class="line"><span class="code">            "&lt;!--more--&gt;",</span></span><br><span class="line"><span class="code">            "",</span></span><br><span class="line"><span class="code">            "[全文有任何错误或疏漏，烦请不吝指正](https://github.com/HKCM/HKCM.github.io/issues)",</span></span><br><span class="line"><span class="code">            "",</span></span><br><span class="line"><span class="code">            "本文采用知识共享 署名-相同方式共享 3.0协议",</span></span><br><span class="line"><span class="code">            "",</span></span><br><span class="line"><span class="code">            "署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权"</span></span><br><span class="line"><span class="code">        ],</span></span><br><span class="line"><span class="code">        "description": "create new article structure"</span></span><br><span class="line"><span class="code">    &#125;,</span></span><br><span class="line"><span class="code">    "shell code": &#123;</span></span><br><span class="line"><span class="code">        "prefix": "shell", //触发词</span></span><br><span class="line"><span class="code">        "body": [ //内容</span></span><br><span class="line"><span class="code">            "```shell",</span></span><br><span class="line"><span class="code">            "$ $1",</span></span><br><span class="line"><span class="code">            "```"</span></span><br><span class="line"><span class="code">        ],</span></span><br><span class="line"><span class="code">        "description": "shell code area"</span></span><br><span class="line"><span class="code">    &#125;,</span></span><br><span class="line"><span class="code">    "table": &#123;</span></span><br><span class="line"><span class="code">        "prefix": "table", //触发词</span></span><br><span class="line"><span class="code">        "body": [ //内容</span></span><br><span class="line"><span class="code">            "| | | |",</span></span><br><span class="line"><span class="code">            "|-|-|-|",</span></span><br><span class="line"><span class="code">            "|$1 | | |",</span></span><br><span class="line"><span class="code">            "| | | |"</span></span><br><span class="line"><span class="code">        ],</span></span><br><span class="line"><span class="code">        "description": "a table"</span></span><br><span class="line"><span class="code">    &#125;,</span></span><br><span class="line"><span class="code">    "insertDate": &#123; //插入时间</span></span><br><span class="line"><span class="code">        "prefix": "date",</span></span><br><span class="line"><span class="code">        "body": "$CURRENT_YEAR-$CURRENT_MONTH-$CURRENT_DATE $CURRENT_HOUR:$CURRENT_MINUTE:$CURRENT_SECOND"</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>目前个人markdown.json的配置</p><details><summary><strong>markdown.json</strong></summary><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    "new article": &#123;//新建文章框架</span><br><span class="line">        "prefix": "new", //触发词</span><br><span class="line">        "body": [ //内容</span><br><span class="line">            "---",</span><br><span class="line">            "title: $1",</span><br><span class="line">            "categories:",</span><br><span class="line">            "  - $2",</span><br><span class="line">            "tags:",</span><br><span class="line">            "  - $3",</span><br><span class="line">            "date: $CURRENT_YEAR-$CURRENT_MONTH-$CURRENT_DATE $CURRENT_HOUR:$CURRENT_MINUTE:$CURRENT_SECOND",</span><br><span class="line">            "---",</span><br><span class="line">            "",</span><br><span class="line">            "## 描述: $4",</span><br><span class="line">            "&lt;!--more--&gt;",</span><br><span class="line">            "",</span><br><span class="line">            "### 结语",</span><br><span class="line">            "",</span><br><span class="line">            "[全文有任何错误或疏漏，烦请不吝指正](https://github.com/HKCM/HKCM.github.io/issues)",</span><br><span class="line">            "",</span><br><span class="line">            "本文采用知识共享 署名-相同方式共享 3.0协议",</span><br><span class="line">            "",</span><br><span class="line">            <span class="string">"署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权"</span></span><br><span class="line">        ],</span><br><span class="line">        "description": "create new article structure"</span><br><span class="line">    &#125;,</span><br><span class="line">    "shell code": &#123;</span><br><span class="line">        "prefix": "shell", //触发词</span><br><span class="line">        "body": [ //内容</span><br><span class="line">            "```shell",</span><br><span class="line">            "$1",</span><br><span class="line">            <span class="string">"```"</span></span><br><span class="line">        ],</span><br><span class="line">        "description": "shell code area"</span><br><span class="line">    &#125;,</span><br><span class="line">    "table": &#123;</span><br><span class="line">        "prefix": "table", //触发词</span><br><span class="line">        "body": [ //内容</span><br><span class="line">            "| | | |",</span><br><span class="line">            "|-|-|-|",</span><br><span class="line">            "|$1 | | |",</span><br><span class="line">            <span class="string">"| | | |"</span></span><br><span class="line">        ],</span><br><span class="line">        "description": "a table"</span><br><span class="line">    &#125;,</span><br><span class="line">    "insertDate": &#123; //插入时间</span><br><span class="line">        "prefix": "date",</span><br><span class="line">        "body": "$CURRENT_YEAR-$CURRENT_MONTH-$CURRENT_DATE $CURRENT_HOUR:$CURRENT_MINUTE:$CURRENT_SECOND"</span><br><span class="line">    &#125;,</span><br><span class="line">    "detail": &#123; //收缩功能</span><br><span class="line">        "prefix": "detail",</span><br><span class="line">        "body": [</span><br><span class="line">            "&lt;details&gt;",</span><br><span class="line">            "&lt;summary&gt;&lt;strong&gt;$1&lt;/strong&gt;&lt;/summary&gt;",</span><br><span class="line">            "$2",</span><br><span class="line">            <span class="string">"&lt;/details&gt;"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details></li></ol><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> 疑难杂症 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 疑难杂症 </tag>
            
            <tag> VSCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>疑难杂症-AWS Not Authorized to Use Launch Template</title>
      <link href="2020/11/27/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87-AWS-Not-Authorized-to-Use-Launch-Template/"/>
      <url>2020/11/27/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87-AWS-Not-Authorized-to-Use-Launch-Template/</url>
      
        <content type="html"><![CDATA[<p>描述: 当使用AutoScaling时遇到报错,You are not authorized to use launch template</p><a id="more"></a><h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><p>这个报错代表,当前ASG无法通过launch template启动EC2.这个问题甚至会出现延期,可能你成功创建了ASG和Launch Template,在真正需要启动EC2时才报错.</p><p>对于这个问题只能提供解决思路.</p><p>导致问题的原因大致有三个:</p><ol><li>运行命令的用户缺少权限(可能性低)</li></ol><p>运行命令的用户需要具有最低相应权限,但是通常情况如果能通过AWS console界面创建EC2,则说明权限没有问题</p><p>以下是最低权限要求:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;Action&quot;: [</span><br><span class="line">    &quot;ec2:runInstances&quot;,</span><br><span class="line">    &quot;ec2:DescribeLaunchTemplates&quot;,</span><br><span class="line">    &quot;ec2:DescribeLaunchTemplateVersions&quot;,</span><br><span class="line">    &quot;ec2:DescribeVpcs&quot;,</span><br><span class="line">    &quot;ec2:DescribeSubnets&quot;,</span><br><span class="line">    &quot;ec2:DescribeAvailabilityZones&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;Resource&quot;: [</span><br><span class="line">    &quot;arn:aws:ec2:ap-southeast-1:xxxxxxxxxxxx:launch-template/lt-05xxxxxxxxxxxxxa5&quot;,</span><br><span class="line">    &quot;arn:aws:ec2:ap-southeast-1:xxxxxxxxxxxx:subnet/subnet-0axxxxxxxxxxxxxad&quot;,</span><br><span class="line">    &quot;arn:aws:ec2:ap-southeast-1:xxxxxxxxxxxx:security-group/sg-0axxxxxxxxxxxxx78&quot;,</span><br><span class="line">    &quot;arn:aws:ec2:ap-southeast-1:xxxxxxxxxxxx:instance/*&quot;,</span><br><span class="line">    &quot;arn:aws:ec2:ap-southeast-1:xxxxxxxxxxxx:network-interface/*&quot;,</span><br><span class="line">    &quot;arn:aws:ec2:ap-southeast-1:xxxxxxxxxxxx:volume/*&quot;,</span><br><span class="line">    &quot;arn:aws:ec2:ap-southeast-1::image/&quot;,</span><br><span class="line">    &quot;arn:aws:ec2:ap-southeast-1::snapshot/&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;Effect&quot;: &quot;Allow&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果用户具有相应权限但是无法启动,下一条.</p><ol start="2"><li>Template错误(常见原因)</li></ol><p>正如我之前所说,这个报错是在正在启动EC2时才报错的.所以当你创建ASG和Launch Template时,只要没有语法错误都能创建成功.但是其中的值是否真实有效则需要启动时才能确认.</p><p>所以很有可能是Template的值出错. 常见于多账户,多可用区使用,账户B或可用区B没有你指定的AMI 或者 Key.</p><ul><li>AMIID不存在或值错误</li><li>Keypair不存在或值错误</li><li>SecurityGroup不存在或值错误</li><li>……</li></ul><ol start="3"><li>AWS账户和AWS organize限制导致(常见原因)</li></ol><p>这是最多且最复杂的原因.我只能列出一些常见的,具体的需要自己探究</p><ul><li>AWS账户或组织设置限定EC2类型和Template不一致</li><li>AWS账户或组织设置限定资源只能在指定区域创建</li><li>AWS账户或组织设置限定资源必须附带标签</li><li>AWS账户或组织设置限定不能有公共IP</li><li>AWS账户或组织设置限定资源必须加密</li><li>……</li></ul><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> 疑难杂症 </category>
          
          <category> AWS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 疑难杂症 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>疑难杂症-修改MAC默认截图地址和截图格式</title>
      <link href="2020/11/27/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87-%E4%BF%AE%E6%94%B9MAC%E9%BB%98%E8%AE%A4%E6%88%AA%E5%9B%BE%E5%9C%B0%E5%9D%80/"/>
      <url>2020/11/27/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87-%E4%BF%AE%E6%94%B9MAC%E9%BB%98%E8%AE%A4%E6%88%AA%E5%9B%BE%E5%9C%B0%E5%9D%80/</url>
      
        <content type="html"><![CDATA[<p>描述: 修改MAC默认截图地址</p><a id="more"></a><ol><li><p>创建截图存放位置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/Desktop/Snapshot</span><br></pre></td></tr></table></figure></li><li><p>修改存储位置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defaults write com.apple.screencapture location ~/Desktop/Snapshot</span><br></pre></td></tr></table></figure></li><li><p>修改截图格式(可选)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># png gif pdf jpg</span><br><span class="line">defaults write com.apple.screencapture type jpg</span><br></pre></td></tr></table></figure></li><li><p>重启UI</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">killall SystemUIServer</span><br></pre></td></tr></table></figure></li></ol><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> 疑难杂症 </category>
          
          <category> MAC </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 疑难杂症 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>疑难杂症-VSCode字体等宽</title>
      <link href="2020/11/27/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87-VSCode%E5%AD%97%E4%BD%93%E7%AD%89%E5%AE%BD/"/>
      <url>2020/11/27/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87-VSCode%E5%AD%97%E4%BD%93%E7%AD%89%E5%AE%BD/</url>
      
        <content type="html"><![CDATA[<p>描述: 用VSCode写markdown时,原生字体在中英文字体下不等宽,导致写table时强迫症很难受</p><a id="more"></a><p>解决方案:</p><ol><li>下载字体</li></ol><p><a href="https://github.com/be5invis/Sarasa-Gothic/releases" target="_blank" rel="noopener">https://github.com/be5invis/Sarasa-Gothic/releases</a></p><p>分为ttc和ttf:</p><p>下载<code>ttc</code>格式则安装<code>ttcsarasa-regular.ttc</code></p><p>下载<code>ttf</code>格式则安装<code>sarasa-mono-sc-regular.ttf</code></p><ol start="2"><li>VSCode设置</li></ol><p>因为我只希望markdown使用该字体,所以在当前工作区添加<code>.vscode/settings.json</code>文件<br><img src="1.png" alt></p><p>以我的git路径为例</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim ~/git/.vscode/settings.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;[markdown]&quot;: &#123;</span><br><span class="line">        &quot;editor.fontFamily&quot;: &quot;Sarasa Mono SC&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>重启或重载VSCode</li></ol><p><code>Command + shift + P</code> 查找 <code>Reload Window</code></p><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> 疑难杂症 </category>
          
          <category> VSCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 疑难杂症 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bash基础入门（13）实用代码</title>
      <link href="2020/11/26/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%8813%EF%BC%89%E5%AE%9E%E7%94%A8%E4%BB%A3%E7%A0%81/"/>
      <url>2020/11/26/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%8813%EF%BC%89%E5%AE%9E%E7%94%A8%E4%BB%A3%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<p>描述: 实用代码</p><a id="more"></a><h3 id="shell-执行命令失败则中断执行"><a href="#shell-执行命令失败则中断执行" class="headerlink" title="shell 执行命令失败则中断执行"></a>shell 执行命令失败则中断执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Command || ! echo &apos;Something Wrong&apos; || exit 1</span><br><span class="line"></span><br><span class="line"># or</span><br><span class="line"></span><br><span class="line">Command</span><br><span class="line">if [[ $? -ne 0 ]]; then</span><br><span class="line">    echo &apos;Something Wrong&apos;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h3 id="在脚本中写入系统日志"><a href="#在脚本中写入系统日志" class="headerlink" title="在脚本中写入系统日志"></a>在脚本中写入系统日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger –t ScriptName "Hello World"</span><br></pre></td></tr></table></figure><h3 id="在脚本中输出并记录日志"><a href="#在脚本中输出并记录日志" class="headerlink" title="在脚本中输出并记录日志"></a>在脚本中输出并记录日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo "somethong wrong" | tee -a /var/log/script_log</span><br></pre></td></tr></table></figure><h3 id="在脚本中写日志函数"><a href="#在脚本中写日志函数" class="headerlink" title="在脚本中写日志函数"></a>在脚本中写日志函数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">LOG_FILE='/var/log/script_'$(date +"%Y-%m-%d_%H-%M-%S")'.log'</span><br><span class="line"></span><br><span class="line">function write_log()</span><br><span class="line">&#123;</span><br><span class="line">  now_time='['$(date +"%Y-%m-%d %H:%M:%S")']'</span><br><span class="line">  echo $&#123;now_time&#125; $1 | tee -a $&#123;log_file&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">write_log "everything is ok"</span><br></pre></td></tr></table></figure><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> Bash基础入门 </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>英语入门1-音标</title>
      <link href="2020/11/24/%E8%8B%B1%E8%AF%AD/%E8%8B%B1%E8%AF%AD%E5%85%A5%E9%97%A81-%E9%9F%B3%E6%A0%87/"/>
      <url>2020/11/24/%E8%8B%B1%E8%AF%AD/%E8%8B%B1%E8%AF%AD%E5%85%A5%E9%97%A81-%E9%9F%B3%E6%A0%87/</url>
      
        <content type="html"><![CDATA[<p>描述: 英语入门1-音标</p><a id="more"></a><table><thead><tr><th>音标</th><th>常见发音法字母</th><th>单词1</th><th>单词2</th><th>单词3</th><th>单词4</th><th>单词5</th></tr></thead><tbody><tr><td>/ɪ/ 短元音</td><td>i,y,e</td><td>sit /sɪt/ vi. 坐</td><td>fish /fɪʃ/ n. 鱼</td><td>economy /ɪ’kɒnəmɪ/ n. 经济</td><td></td><td></td></tr><tr><td>/iː/ 长元音</td><td>ee,ea,ie,ei</td><td>bee /biː/ n. 蜜蜂</td><td>steam /stiːm/ n. 蒸汽</td><td>belief /bɪ’liːf/ n. 相信</td><td>receive /rɪ’siːv/ vt. 收到</td><td></td></tr><tr><td>/ʊ/ 短元音</td><td>oo,oul,u</td><td>book /bʊk/ n. 书籍</td><td>bush /bʊʃ/ n.矮树丛</td><td>would /wʊd/ aux. 将</td><td></td><td></td></tr><tr><td>/u:/ 长元音</td><td>o,u,oo,ew,ui,oe,ou</td><td>lose /luːz/ vi. 失败</td><td>rude /ruːd/ adj. 粗鲁的</td><td>school /skuːl/ n. 学校</td><td>threw /θruː/ v. 抛</td><td>juice /dʒuːs/ n.(水果)汁</td></tr><tr><td>/ʌ/ 短元音</td><td>ou,om ,on,ov,u</td><td>touch /tʌtʃ/ vt. 接触</td><td>some /sʌm/ pron. 一些</td><td>sun /sʌn/ n. 太阳</td><td>love /lʌv/ vi. 爱</td><td>hurry /‘hʌrɪ/ n. 匆忙</td></tr><tr><td>/ɑː/ 长元音</td><td>ar,au,al(f,m)</td><td>mark /mɑːk/ n. 标志</td><td>laugh /lɑːf/ n. 笑</td><td>half /hɑːf/ n. 一半</td><td></td><td></td></tr><tr><td>/ɒ/ 短元音</td><td>o,a(在w,wh后)</td><td>dog /dɒg/ n. 狗    box /bɒks/ n. 箱</td><td>what /wɒt/ pron. 什么</td><td></td><td></td><td></td></tr><tr><td>/ɔː/ 长元音</td><td>al,au,aw,or,oar,oor,ore,ar(在w后)</td><td>walk /wɔːk/ n. 步行</td><td>law /lɔː/ n. 法律</td><td>border /‘bɔːdə/ n. 边境</td><td>store /stɔː/ n. 商店</td><td>war /wɔː/ n. 战争</td></tr><tr><td>/ə/ 短元音</td><td>a,e,o,u,or,er</td><td>sofa /‘səʊfə/ n. 沙发</td><td>president /‘prezɪdənt/ n. 校长</td><td>today /tə’deɪ/ n. 今天</td><td>support /sə’pɔːt/ vt. 支持</td><td>visitor /‘vɪzɪtə/ n. 访问者</td></tr><tr><td>/ɜː/ 长元音</td><td>er,ir,ur,ear,or(在w后)</td><td>serve /sɜːv/ vi. 服务</td><td>bird /bɜːd/ n. 鸟</td><td>nurse /nɜːs/ n. 护士</td><td>earth /ɜːθ/ n. 地球</td><td>work /wɜːk/ n. 工作</td></tr><tr><td>/e/ 短元音</td><td>e,ea</td><td>egg /eg/ n. 蛋</td><td>bed /bed/ n. 床</td><td>check /tʃek/ vi. 核实</td><td>health /helθ/ n. 健康</td><td></td></tr><tr><td>/æ/ 短元音</td><td>a</td><td>family /ˈfæməlɪ/ n. 家庭</td><td>rabbit /‘ræbɪt/ n. 兔子</td><td>happy /‘hæpɪ/ adj. 幸福的</td><td></td><td></td></tr><tr><td>/ɪə/ 双元音</td><td>ear,ere,ea,eer</td><td>near /nɪə/ adj. 近的</td><td>here /hɪə/ adv. 在这里</td><td>area /‘eərɪə/ n. 区域</td><td>deer /dɪə/ n. 鹿</td><td></td></tr><tr><td>/ʊə/ 双元音</td><td>our,oor,ure</td><td>tour /tʊə/ n. 旅游</td><td>poor /pʊə/ adj. 贫穷的</td><td>ensure /enˈʃʊə/ vt. 保证</td><td></td><td></td></tr><tr><td>/aɪ/ 双元音</td><td>i,y    write /raɪt/ vi. 写</td><td>fight /faɪt/ vi. 打架</td><td>why /waɪ/ adv. 为什么</td><td></td><td></td><td></td></tr><tr><td>/ɔɪ/ 双元音</td><td>oy,oi    boy /bɔɪ/ n. 男孩</td><td>noise /nɔɪz/ n. 噪音</td><td>choice /tʃɔɪs/ n. 选择</td><td></td><td></td><td></td></tr><tr><td>/əʊ/ 双元音</td><td>o,oa,oe,ow</td><td>smoke /sməʊk/ n. 烟</td><td>boat /bəʊt/ n. 小船</td><td>toe /təʊ/ n. 脚趾</td><td>know /nəʊ/ vt. 知道</td><td></td></tr><tr><td>/eə/ 双元音</td><td>are,air,ear,ere</td><td>share /ʃeə/ vt. 分享</td><td>air /eə/ n. 空气</td><td>bear /beə/ n. 熊</td><td>where /weə/ pron. 哪里</td><td></td></tr><tr><td>/aʊ/ 双元音</td><td>ou,ow</td><td>mouse /maʊs/ n. 鼠标</td><td>cloud /klaʊd/ n. 云</td><td>town /taʊn/ n. 城镇</td><td></td><td></td></tr><tr><td>/eɪ/ 双元音</td><td>a,ai,ay,ei</td><td>shake /ʃeɪk/ vt. 动摇</td><td>wait /weɪt/ vt. 等候</td><td>pay /peɪ/ vt. 支付</td><td>weight /weɪt/ n. 重量</td><td></td></tr><tr><td>/p/</td><td>p,pp</td><td>cup /kʌp/ n. 杯子</td><td>open /‘əʊpn/ v.打开</td><td>supper /‘sʌpə/ n. 晚餐</td><td></td><td></td></tr><tr><td>/b/</td><td>b,bb</td><td>bread /bred/ n. 面包</td><td>club /klʌb/ n. 俱乐部</td><td>cabbage /ˈkæbɪdʒ/ n. 卷心菜</td><td></td><td></td></tr><tr><td>/t/</td><td>t,tt</td><td>talk /tɔːk/ vt. 讲</td><td>better /‘betə/ adv. 更好的</td><td>night /naɪt/ n. 夜晚</td><td></td><td></td></tr><tr><td>/d/</td><td>d,dd</td><td>duck /dʌk/ n. 鸭子</td><td>murder /‘mɜːdə/ vt. 谋杀</td><td>middle /‘mɪd(ə)l/ adj. 中间的</td><td></td><td></td></tr><tr><td>/k/</td><td>c,k,ch,ck</td><td>card /kɑːd/ n. 卡片    ache /eɪk/ n. 疼痛</td><td>archive /‘ɑrkaɪv/ n. 档案馆</td><td>kick /kɪk/ vt. 踢</td><td></td><td></td></tr><tr><td>/g/</td><td>g,gg,gu,gh</td><td>gate /geɪt/ n. 大门</td><td>luggage /‘lʌgɪdʒ/ n. 行李</td><td>catalogue /‘kæt(ə)lɒg/ n. 目录</td><td>ghost /gəʊst/ n. 鬼</td><td></td></tr><tr><td>/f/</td><td>f,ff,ph,gh</td><td>five /faɪv/ n. 五</td><td>offer /‘ɒfə/ n. 提议</td><td>alpha /‘ælfə/ n.开端</td><td>laugh /lɑːf/ n. 笑</td><td></td></tr><tr><td>/v/</td><td>v</td><td>very /‘verɪ/ adv. 非常</td><td>leave /liːv/ vt. 离开</td><td>heavy /‘hevɪ/ adj. 沉重的</td><td></td><td></td></tr><tr><td>/s/</td><td>s,ss,c,sc</td><td>sea /siː/ n. 海</td><td>lesson /‘les(ə)n/ n. 教训</td><td>ice /aɪs/ n. 冰</td><td>science /‘saɪəns/ n. 科学</td><td></td></tr><tr><td>/z/</td><td>z,ze,zz,s,se</td><td>zoom /zuːm/ n.变焦摄影</td><td>doze /dəʊz/ n. 瞌睡</td><td>puzzle /‘pʌz(ə)l/ vi. 迷惑</td><td>is /ɪz/ v. 是</td><td>rise /raɪz/ vi. 上升</td></tr><tr><td>/ʃ/</td><td>sh,s(在u前),ss,ci,ti,si</td><td>ship /ʃɪp/ n. 船</td><td>sugar /‘ʃʊgə/ n. 糖</td><td>pressure /‘preʃə/ n. 压力</td><td>social /‘səʊʃ(ə)l/ adj. 社会的</td><td>station /‘steɪʃ(ə)n/ n. 车站</td></tr><tr><td>/ʒ/</td><td>si,su,ge</td><td>vision /‘vɪʒ(ə)n/ n. 视力</td><td>pleasure /‘pleʒə/ n. 快乐</td><td>massage /‘mæsɑːʒ/ n. 按摩</td><td></td><td></td></tr><tr><td>/θ/</td><td>th</td><td>think /θɪŋk/ vt. 想</td><td>cloth /klɒθ/ n. 布</td><td>health /helθ/ n. 健康</td><td></td><td></td></tr><tr><td>/ð/</td><td>th</td><td>they /ðeɪ/ pron. 他们</td><td>other /‘ʌðə/ adj. 其他的</td><td>breathe /briːð/ vi. 呼吸</td><td></td><td></td></tr><tr><td>/h/</td><td>h</td><td>hair /heə/ n.头发</td><td>hate /heɪt/ vt.憎恨</td><td>high /haɪ/ adj.高的</td><td></td><td></td></tr><tr><td>/r/</td><td>r,rr,wr</td><td>read /ri:d/ vt. 阅读</td><td>arrive /ə’raɪv/ vi. 到达</td><td>wrinkle /‘rɪŋkl/ n. 皱纹</td><td></td><td></td></tr><tr><td>/tʃ/</td><td>ch,tch,tua,ture</td><td>chair /tʃeə/ n. 椅子</td><td>catch /kætʃ/ n. 捕捉</td><td>natural /ˈnætʃrəl/ adj. 自然的</td><td>future /‘fjuːtʃə/ n. 未来</td><td></td></tr><tr><td>/dʒ/</td><td>g,dge,j,du</td><td>page /peɪdʒ/ n. 页</td><td>bridge /brɪdʒ/ n. 桥</td><td>July /dʒʊˈlaɪ/ n. 七月</td><td>procedure /prə’siːdʒə/ n. 程序</td><td></td></tr><tr><td>/tr/</td><td>tr</td><td>tree /triː/ n. 树</td><td>trade /treɪd/ n. 贸易</td><td>metric /‘metrɪk/ adj. 公制的</td><td></td><td></td></tr><tr><td>/dr/</td><td>dr</td><td>drink /drɪŋk/ vt. 喝</td><td>dress /dres/ n. 连衣裙</td><td>dream /driːm/ n. 梦想</td><td></td><td></td></tr><tr><td>/ts/</td><td>ts</td><td>pets /pets/ n. (复数)宠物</td><td>cats /kæts/ n. (复数)猫</td><td>gifts /gɪfts/ n. (复数)礼物</td><td></td><td></td></tr><tr><td>/dz/</td><td>ds</td><td>heads /hedz/ n. 头(复数)</td><td>roads /rəʊdz/ n.道路(复数)</td><td>friends /frendz/ n. 朋友(复数)</td><td></td><td></td></tr><tr><td>/m/</td><td>m,mm,mb</td><td>mail /meɪl/ n. 邮件</td><td>grammar /‘græmə/ n. 语法</td><td>climb /klaɪm/ vi. 爬</td><td></td><td></td></tr><tr><td>/n/</td><td>n,nn,gn</td><td>no /nəʊ/ adv. 不</td><td>sunny /‘sʌnɪ/ adj. 阳光的</td><td>foreign /‘fɒrɪn/ adj. 外国的</td><td></td><td></td></tr><tr><td>/ŋ/</td><td>n,ng,nk</td><td>long /lɒŋ/ adj. 长的</td><td>spring /sprɪŋ/ n. 春天</td><td>bank /bæŋk/ n. 银行</td><td></td><td></td></tr><tr><td>/l/</td><td>l,ll</td><td>line /laɪn/ n. 路线</td><td>all /ɔːl/ adj. 全部的</td><td>wheel /wiːl/ n. 车轮</td><td></td><td></td></tr><tr><td>/j/</td><td>y,i</td><td>youth /juːθ/ n. 青年</td><td>unit /‘juːnɪt/ n. 单位</td><td>yolk /jəʊk/ n. 蛋黄</td><td></td><td></td></tr><tr><td>/w/</td><td>w,wh,qu</td><td>white /waɪt/ n. 白色</td><td>what /wɒt/ pron. 什么</td><td>queen /kwiːn/ n. 女王</td><td></td><td></td></tr></tbody></table><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> 英语 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 英语 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AWS-S3-访问点AccessPoint</title>
      <link href="2020/11/22/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/S3/AWS-S3-%E8%AE%BF%E9%97%AE%E7%82%B9AccessPoint/"/>
      <url>2020/11/22/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/S3/AWS-S3-%E8%AE%BF%E9%97%AE%E7%82%B9AccessPoint/</url>
      
        <content type="html"><![CDATA[<p>描述: 访问点的意义和使用</p><a id="more"></a><!-- TOC --><ul><li><a href="#什么是访问点accesspoint">什么是访问点AccessPoint</a></li><li><a href="#访问点限制和局限性">访问点限制和局限性</a></li><li><a href="#access-point-cli">Access Point CLI</a></li><li><a href="#访问点条件键">访问点条件键</a></li><li><a href="#策略示例">策略示例</a><ul><li><a href="#只能从访问点访问">只能从访问点访问</a></li><li><a href="#访问点策略授予">访问点策略授予</a></li><li><a href="#带标签条件的访问点策略">带标签条件的访问点策略</a></li><li><a href="#允许查看存储桶列示内容的访问点策略">允许查看存储桶列示内容的访问点策略</a></li><li><a href="#服务控制策略">服务控制策略</a></li><li><a href="#将-s3-操作限制为-vpc-网络起源的存储桶策略">将 S3 操作限制为 VPC 网络起源的存储桶策略</a></li><li><a href="#cli">CLI</a></li></ul></li></ul><!-- /TOC --><h3 id="什么是访问点AccessPoint"><a href="#什么是访问点AccessPoint" class="headerlink" title="什么是访问点AccessPoint"></a>什么是访问点AccessPoint</h3><p>了解一个东西最方便的就是看它的使用场景.那么访问点的使用场景是什么呢?以下以存储桶策略为例,不谈IAM.</p><p>想象一下,公司有一个桶,桶里面有IT,财务,开发和HR各自的文件夹(其实S3并没有文件夹概念,这里是为了方便理解),目前存储桶策略只允许各自部门访问各自的文件夹.<br>随着公司壮大,多了一个部门,这个部门要求要访问IT和开发的文件夹,怎么办呢?那只有修改存储桶策略.有后来又多了一个部门,要求访问HR和财务的文件夹…<br>随着部门的扩展,存储桶策略会越来越复杂且难以追踪和管理,存储桶策略的修改还很有可能会影响到其他部门.  </p><p>所以访问点应运而生,当有新的部门需要访问,可以通过创建访问点和访问点策略以达到访问需求,新的访问点策略不会影响现有的访问点<br><img src="1.png" alt></p><p>所以访问点是简化了 S3 中共享数据集的大规模数据访问管理问题.</p><h3 id="访问点限制和局限性"><a href="#访问点限制和局限性" class="headerlink" title="访问点限制和局限性"></a>访问点限制和局限性</h3><ol><li>访问点策略的大小限制为 20 KB</li><li>只能为自己拥有的存储桶创建访问点</li><li>每个访问点只与一个存储桶相关联</li><li>使用 REST API 向访问点发出请求时，必须使用 AWS Signature Version 4</li><li>每个区域每个 AWS 账户最多可以创建 1,000 个访问点。可以增加配额</li><li>创建访问点之后不可更改访问点的阻止公有访问设置</li><li>访问点不支持跨区域复制</li></ol><h3 id="Access-Point-CLI"><a href="#Access-Point-CLI" class="headerlink" title="Access Point CLI"></a>Access Point CLI</h3><p>创建一个访问点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws s3control create-access-point --name example-ap --account-id 123456789012 --bucket example-bucket</span><br></pre></td></tr></table></figure><p>创建仅限 VPC 访问的访问点并验证</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ aws s3control create-access-point --name example-vpc-ap --account-id 123456789012 --bucket example-bucket --vpc-configuration VpcId=vpc-1a2b3c</span><br><span class="line">$ aws s3control get-access-point --name example-vpc-ap --account-id 123456789012</span><br></pre></td></tr></table></figure><p>创建具有非默认阻止公有访问设置的访问点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ aws s3control create-access-point --name example-ap --account-id 123456789012 --bucket example-bucket \</span><br><span class="line">  --public-access-block-configuration BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=true,RestrictPublicBuckets=true</span><br></pre></td></tr></table></figure><p>要将访问点与 VPC 搭配使用，必须修改 VPC 终端节点的访问策略。VPC 终端节点允许流量从 VPC 流向 Amazon S3。它们具有访问控制策略，用于控制如何允许 VPC 内的资源与 S3 交互。仅当 VPC 终端节点策略同时对访问点和底层存储桶授予访问权限时，从 VPC 通过访问点到 S3 的请求才会成功。</p><p>配置 VPC 终端节点策略,需要同时具有bucket和access point的资源</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br><span class="line">    &quot;Statement&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Principal&quot;: &quot;*&quot;,</span><br><span class="line">        &quot;Action&quot;: [</span><br><span class="line">            &quot;s3:GetObject&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;Effect&quot;: &quot;Allow&quot;,</span><br><span class="line">        &quot;Resource&quot;: [</span><br><span class="line">            &quot;arn:aws:s3:::awsexamplebucket1/*&quot;,</span><br><span class="line">            &quot;arn:aws:s3:us-west-2:123456789012:accesspoint/example-vpc-ap/object/*&quot;</span><br><span class="line">        ]</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="访问点条件键"><a href="#访问点条件键" class="headerlink" title="访问点条件键"></a>访问点条件键</h3><p>匹配访问点 ARN 的字符串</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;Condition&quot; : &#123;</span><br><span class="line">    &quot;StringLike&quot;: &#123;</span><br><span class="line">        &quot;s3:DataAccessPointArn&quot;: &quot;arn:aws:s3:us-west-2:123456789012:accesspoint/*&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>匹配访问点拥有者的账户 ID</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;Condition&quot; : &#123;</span><br><span class="line">    &quot;StringEquals&quot;: &#123;</span><br><span class="line">        &quot;s3:DataAccessPointAccount&quot;: &quot;123456789012&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>匹配网络起源（Internet 或 VPC）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;Condition&quot; : &#123;</span><br><span class="line">    &quot;StringEquals&quot;: &#123;</span><br><span class="line">        &quot;s3:AccessPointNetworkOrigin&quot;: &quot;VPC&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="策略示例"><a href="#策略示例" class="headerlink" title="策略示例"></a>策略示例</h3><h4 id="只能从访问点访问"><a href="#只能从访问点访问" class="headerlink" title="只能从访问点访问"></a>只能从访问点访问</h4><p>如果希望存储桶只通过访问点访问,可以设置如下<code>存储桶策略</code></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">        <span class="attr">"Principal"</span> : &#123; <span class="attr">"AWS"</span>: <span class="string">"*"</span> &#125;,</span><br><span class="line">        "Action" : "*", #很危险</span><br><span class="line">        "Resource" : [ "Bucket ARN", "Bucket ARN/*"],</span><br><span class="line">        "Condition": &#123;</span><br><span class="line">            "StringEquals" : &#123; "s3:DataAccessPointAccount" : "Bucket owner's account ID" &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="访问点策略授予"><a href="#访问点策略授予" class="headerlink" title="访问点策略授予"></a>访问点策略授予</h4><p>以下访问点策略通过账户 123456789012 中的访问点 my-access-point 向账户 123456789012 中的 IAM 用户 Alice 授予对具有前缀 <code>Alice/</code> 的 <code>GET</code> 和 <code>PUT</code> 对象的权限。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>:<span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">        <span class="attr">"Principal"</span>: &#123;</span><br><span class="line">            <span class="attr">"AWS"</span>: <span class="string">"arn:aws:iam::123456789012:user/Alice"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"Action"</span>: [<span class="string">"s3:GetObject"</span>, <span class="string">"s3:PutObject"</span>],</span><br><span class="line">        <span class="attr">"Resource"</span>: <span class="string">"arn:aws:s3:us-west-2:123456789012:accesspoint/my-access-point/object/Alice/*"</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="带标签条件的访问点策略"><a href="#带标签条件的访问点策略" class="headerlink" title="带标签条件的访问点策略"></a>带标签条件的访问点策略</h4><p>以下访问点策略通过账户 123456789012 中的访问点 my-access-point 向账户 123456789012 中的 IAM 用户 Bob 授予对 <code>GET</code> 对象的权限，这些权限仅能访问标签为data 值为 finance的资源。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;Version&quot;:&quot;2012-10-17&quot;,</span><br><span class="line">    &quot;Statement&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Effect&quot;:&quot;Allow&quot;,</span><br><span class="line">        &quot;Principal&quot; : &#123;</span><br><span class="line">            &quot;AWS&quot;: &quot;arn:aws:iam::123456789012:user/Bob&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Action&quot;:&quot;s3:GetObject&quot;,</span><br><span class="line">        &quot;Resource&quot; : &quot;arn:aws:s3:us-west-2:123456789012:accesspoint/my-access-point/object/*&quot;,</span><br><span class="line">        &quot;Condition&quot; : &#123;</span><br><span class="line">            &quot;StringEquals&quot;: &#123;</span><br><span class="line">                &quot;s3:ExistingObjectTag/data&quot;: &quot;finance&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="允许查看存储桶列示内容的访问点策略"><a href="#允许查看存储桶列示内容的访问点策略" class="headerlink" title="允许查看存储桶列示内容的访问点策略"></a>允许查看存储桶列示内容的访问点策略</h4><p>以下访问点策略通过账户 123456789012 中的访问点 my-access-point 授予账户 123456789012 中的 IAM 用户 Charles 查看底层存储桶中包含的对象的权限。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;Version&quot;:&quot;2012-10-17&quot;,</span><br><span class="line">    &quot;Statement&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Effect&quot;: &quot;Allow&quot;,</span><br><span class="line">        &quot;Principal&quot;: &#123;</span><br><span class="line">            &quot;AWS&quot;: &quot;arn:aws:iam::123456789012:user/Charles&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Action&quot;: &quot;s3:ListBucket&quot;,</span><br><span class="line">        &quot;Resource&quot;: &quot;arn:aws:s3:us-west-2:123456789012:accesspoint/my-access-point&quot;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="服务控制策略"><a href="#服务控制策略" class="headerlink" title="服务控制策略"></a>服务控制策略</h4><p><strong>以下服务控制策略要求使用 VPC 网络起源创建所有新访问点。实施此策略时，组织中的用户无法创建可从 Internet 访问的新访问点。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br><span class="line">    &quot;Statement&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Effect&quot;: &quot;Deny&quot;,</span><br><span class="line">        &quot;Action&quot;: &quot;s3:CreateAccessPoint&quot;,</span><br><span class="line">        &quot;Resource&quot;: &quot;*&quot;,</span><br><span class="line">        &quot;Condition&quot;: &#123;</span><br><span class="line">            &quot;StringNotEquals&quot;: &#123;</span><br><span class="line">                &quot;s3:AccessPointNetworkOrigin&quot;: &quot;VPC&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="将-S3-操作限制为-VPC-网络起源的存储桶策略"><a href="#将-S3-操作限制为-VPC-网络起源的存储桶策略" class="headerlink" title="将 S3 操作限制为 VPC 网络起源的存储桶策略"></a>将 S3 操作限制为 VPC 网络起源的存储桶策略</h4><p>以下存储桶策略限制为只能通过具有 VPC 网络起源的访问点来访问存储桶 examplebucket 的所有 S3 对象操作。</p><p><strong>重要</strong></p><p>在使用类似此示例的语句之前，请确保您不需要使用访问点不支持的功能，例如跨区域复制。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br><span class="line">    &quot;Statement&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Effect&quot;: &quot;Deny&quot;,</span><br><span class="line">            &quot;Principal&quot;: &quot;*&quot;,</span><br><span class="line">            &quot;Action&quot;: [</span><br><span class="line">                &quot;s3:AbortMultipartUpload&quot;,</span><br><span class="line">                &quot;s3:BypassGovernanceRetention&quot;,</span><br><span class="line">                &quot;s3:DeleteObject&quot;,</span><br><span class="line">                &quot;s3:DeleteObjectTagging&quot;,</span><br><span class="line">                &quot;s3:DeleteObjectVersion&quot;,</span><br><span class="line">                &quot;s3:DeleteObjectVersionTagging&quot;,</span><br><span class="line">                &quot;s3:GetObject&quot;,</span><br><span class="line">                &quot;s3:GetObjectAcl&quot;,</span><br><span class="line">                &quot;s3:GetObjectLegalHold&quot;,</span><br><span class="line">                &quot;s3:GetObjectRetention&quot;,</span><br><span class="line">                &quot;s3:GetObjectTagging&quot;,</span><br><span class="line">                &quot;s3:GetObjectVersion&quot;,</span><br><span class="line">                &quot;s3:GetObjectVersionAcl&quot;,</span><br><span class="line">                &quot;s3:GetObjectVersionTagging&quot;,</span><br><span class="line">                &quot;s3:ListMultipartUploadParts&quot;,</span><br><span class="line">                &quot;s3:PutObject&quot;,</span><br><span class="line">                &quot;s3:PutObjectAcl&quot;,</span><br><span class="line">                &quot;s3:PutObjectLegalHold&quot;,</span><br><span class="line">                &quot;s3:PutObjectRetention&quot;,</span><br><span class="line">                &quot;s3:PutObjectTagging&quot;,</span><br><span class="line">                &quot;s3:PutObjectVersionAcl&quot;,</span><br><span class="line">                &quot;s3:PutObjectVersionTagging&quot;,</span><br><span class="line">                &quot;s3:RestoreObject&quot;</span><br><span class="line">            ],</span><br><span class="line">            &quot;Resource&quot;: &quot;arn:aws:s3:::examplebucket/*&quot;,</span><br><span class="line">            &quot;Condition&quot;: &#123;</span><br><span class="line">                &quot;StringNotEquals&quot;: &#123;</span><br><span class="line">                    &quot;s3:AccessPointNetworkOrigin&quot;: &quot;VPC&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="CLI"><a href="#CLI" class="headerlink" title="CLI"></a>CLI</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ aws s3api get-object --key Alice/my-image.jpg --bucket arn:aws:s3:us-west-2:123456789012:accesspoint/my-access-point download.jpg</span><br><span class="line">$ aws s3api put-object --bucket arn:aws:s3:us-west-2:123456789012:accesspoint/my-access-point --key Alice/test.log --body test.log</span><br><span class="line">$ aws s3api delete-object --bucket arn:aws:s3:us-west-2:123456789012:accesspoint/my-access-point --key Alice/my-image.jpg</span><br><span class="line">$ aws s3api list-objects-v2 --bucket arn:aws:s3:us-east-1:123456789012:accesspoint/my-access-point</span><br></pre></td></tr></table></figure><p>以上完全基于<a href="https://docs.aws.amazon.com/" target="_blank" rel="noopener">AWS官方文档</a>，并结合自身理解创作</p><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> 存储类 </category>
          
          <category> S3 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS S3 </tag>
            
            <tag> S3基础入门 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bash基础入门（12）示例</title>
      <link href="2020/11/20/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%8812%EF%BC%89%E7%A4%BA%E4%BE%8B/"/>
      <url>2020/11/20/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%8812%EF%BC%89%E7%A4%BA%E4%BE%8B/</url>
      
        <content type="html"><![CDATA[<p>描述: 基于AWS EC2的Bash脚本示例</p><a id="more"></a><p>本文基于AWS EC2的CLI命令,实现EC2 instance type的转化.代码源于<a href="https://docs.amazonaws.cn/cli/latest/userguide/cli-services-ec2-instance-type-script.html" target="_blank" rel="noopener">https://docs.amazonaws.cn/cli/latest/userguide/cli-services-ec2-instance-type-script.html</a></p><p>主要是学习Bash shell脚本的格式和规范.例如,函数声明使用,提示信息,测试以及说明文档</p><h3 id="change-ec2-instance-type-sh"><a href="#change-ec2-instance-type-sh" class="headerlink" title="change_ec2_instance_type.sh"></a>change_ec2_instance_type.sh</h3><p>该主脚本文件包含执行以下任务的 change_ec2_instance_type() 函数：</p><ul><li>验证指定的 EC2 实例是否存在。</li><li>除非选择了 -f，否则函数会在停止实例之前向用户发出警告。</li><li>更改实例类型</li><li>如果您设置了 -r，请重启实例并确认实例正在运行</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>##############################################################################</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span> function change_ec2_instance_type</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span> This function changes the instance type of the specified Amazon EC2 instance.</span><br><span class="line"><span class="meta">#</span> </span><br><span class="line"><span class="meta">#</span> Parameters:</span><br><span class="line"><span class="meta">#</span>   -i   [string, mandatory] The instance ID of the instance whose type you</span><br><span class="line"><span class="meta">#</span>                            want to change.</span><br><span class="line"><span class="meta">#</span>   -t   [string, mandatory] The instance type to switch the instance to.</span><br><span class="line"><span class="meta">#</span>   -f   [switch, optional]  If set, the function doesn't pause and ask before</span><br><span class="line"><span class="meta">#</span>                            stopping the instance.</span><br><span class="line"><span class="meta">#</span>   -r   [switch, optional]  If set, the function restarts the instance after</span><br><span class="line"><span class="meta">#</span>                            changing the type.</span><br><span class="line"><span class="meta">#</span>   -h   [switch, optional]  Displays this help.</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span> Example:</span><br><span class="line"><span class="meta">#</span>      The following example converts the specified instance to type "t2.micro"</span><br><span class="line"><span class="meta">#</span>      without pausing to ask permission. It automatically restarts the</span><br><span class="line"><span class="meta">#</span>      instance after changing the type.</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span>      change-instance-type -i i-123456789012 -f -r</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span> Returns:</span><br><span class="line"><span class="meta">#</span>      0 if successful</span><br><span class="line"><span class="meta">#</span>      1 if it fails</span><br><span class="line"><span class="meta">#</span>##############################################################################</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Import the general_purpose functions.</span><br><span class="line">source awsdocs_general.sh </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>##############################################################################</span><br><span class="line"><span class="meta">#</span> function instance-exists</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span> This function checks to see if the specified instance already exists. If it</span><br><span class="line"><span class="meta">#</span> does, it sets two global parameters to return the running state and the </span><br><span class="line"><span class="meta">#</span> instance type.</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span> Input parameters:</span><br><span class="line"><span class="meta">#</span>       $1 - The id of the instance to check</span><br><span class="line"><span class="meta">#</span> </span><br><span class="line"><span class="meta">#</span> Returns:</span><br><span class="line"><span class="meta">#</span>       0 if the instance already exists</span><br><span class="line"><span class="meta">#</span>       1 if the instance doesn't exist</span><br><span class="line"><span class="meta">#</span>     AND: </span><br><span class="line"><span class="meta">#</span>       Sets two global variables:</span><br><span class="line"><span class="meta">#</span>            EXISTING_STATE - Contains the running/stopped state of the instance.</span><br><span class="line"><span class="meta">#</span>            EXISTING_TYPE  - Contains the current type of the instance.</span><br><span class="line"><span class="meta">#</span>##############################################################################</span><br><span class="line">function get_instance_info &#123;</span><br><span class="line"></span><br><span class="line">    # Declare local variables.</span><br><span class="line">    local INSTANCE_ID RESPONSE</span><br><span class="line">    </span><br><span class="line">    # This function accepts a single parameter.</span><br><span class="line">    INSTANCE_ID=$1</span><br><span class="line"></span><br><span class="line">    # The following --filters parameter causes server-side filtering to limit</span><br><span class="line">    # results to only the records that match the specified ID. The --query </span><br><span class="line">    # parameter causes CLI client-side filtering to include only the values of</span><br><span class="line">    # the InstanceType and State.Code fields. </span><br><span class="line">    </span><br><span class="line">    RESPONSE=$(aws ec2 describe-instances \</span><br><span class="line">                   --query 'Reservations[*].Instances[*].[State.Name, InstanceType]' \</span><br><span class="line">                   --filters Name=instance-id,Values="$INSTANCE_ID" \</span><br><span class="line">                   --output text \</span><br><span class="line">               )</span><br><span class="line"></span><br><span class="line">    if [[ $? -ne 0 ]] || [[ -z "$RESPONSE" ]]; then</span><br><span class="line">        # There was no response, so no such instance.</span><br><span class="line">        return 1        # 1 in Bash script means error/false</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # If we got a response, the instance exists.</span><br><span class="line">    # Retrieve the values of interest and set them as global variables.</span><br><span class="line">    EXISTING_STATE=$(echo "$RESPONSE" | cut -f 1 )        </span><br><span class="line">    EXISTING_TYPE=$(echo "$RESPONSE" | cut -f 2 )</span><br><span class="line"></span><br><span class="line">    return 0        # 0 in Bash script means no error/true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>#####################################</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span>  See header at top of this file</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span>#####################################</span><br><span class="line"></span><br><span class="line">function change_ec2_instance_type &#123;</span><br><span class="line"></span><br><span class="line">    function usage() (</span><br><span class="line">        echo ""</span><br><span class="line">        echo "This function changes the instance type of the specified instance."</span><br><span class="line">        echo "Parameter:"</span><br><span class="line">        echo "  -i  Specify the instance ID whose type you want to modify."</span><br><span class="line">        echo "  -t  Specify the instance type to convert the instance to."</span><br><span class="line">        echo "  -d  If the instance was originally running, this option prevents"</span><br><span class="line">        echo "      automatically restarting the instance."</span><br><span class="line">        echo "  -f  If the instance was originally running, this option prevents"</span><br><span class="line">        echo "      the script from asking permission before stopping the instance."</span><br><span class="line">        echo ""</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    local FORCE RESTART REQUESTED_TYPE INSTANCE_ID VERBOSE OPTION RESPONSE ANSWER </span><br><span class="line">    local OPTIND OPTARG # Required to use getopts command in a function.</span><br><span class="line">    </span><br><span class="line">    # Set default values.</span><br><span class="line">    FORCE=false</span><br><span class="line">    RESTART=false</span><br><span class="line">    REQUESTED_TYPE=""</span><br><span class="line">    INSTANCE_ID=""</span><br><span class="line">    VERBOSE=false</span><br><span class="line"></span><br><span class="line">    # Retrieve the calling parameters.</span><br><span class="line">    while getopts "i:t:frvh" OPTION; do</span><br><span class="line">        case "$&#123;OPTION&#125;"</span><br><span class="line">        in</span><br><span class="line">            i)  INSTANCE_ID="$&#123;OPTARG&#125;";;</span><br><span class="line">            t)  REQUESTED_TYPE="$&#123;OPTARG&#125;";;</span><br><span class="line">            f)  FORCE=true;;</span><br><span class="line">            r)  RESTART=true;;</span><br><span class="line">            v)  VERBOSE=true;;</span><br><span class="line">            h)  usage; return 0;;</span><br><span class="line">            \?) echo "Invalid parameter"; usage; return 1;; </span><br><span class="line">        esac</span><br><span class="line">    done</span><br><span class="line"></span><br><span class="line">    if [[ -z "$INSTANCE_ID" ]]; then</span><br><span class="line">        errecho "ERROR: You must provide an instance ID with the -i parameter."</span><br><span class="line">        usage</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if [[ -z "$REQUESTED_TYPE" ]]; then</span><br><span class="line">        errecho "ERROR: You must provide an instance type with the -t parameter."</span><br><span class="line">        usage</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    iecho "Parameters:\n"</span><br><span class="line">    iecho "    Instance ID:   $INSTANCE_ID"</span><br><span class="line">    iecho "    Requests type: $REQUESTED_TYPE"</span><br><span class="line">    iecho "    Force stop:    $FORCE"</span><br><span class="line">    iecho "    Restart:       $RESTART"</span><br><span class="line">    iecho "    Verbose:       $VERBOSE"</span><br><span class="line">    iecho ""</span><br><span class="line">    </span><br><span class="line">    # Check that the specified instance exists.</span><br><span class="line">    iecho -n "Confirming that instance $INSTANCE_ID exists..."</span><br><span class="line">    get_instance_info "$INSTANCE_ID"</span><br><span class="line">    # If the instance doesn't exist, the function returns an error code &lt;&gt; 0.</span><br><span class="line">    if [[ $&#123;?&#125; -ne 0 ]]; then</span><br><span class="line">        errecho "ERROR: I can't find the instance \"$INSTANCE_ID\" in the current AWS account."</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line">    # Function get_instance_info has returned two global values:</span><br><span class="line">    #   $EXISTING_TYPE  -- The instance type of the specified instance</span><br><span class="line">    #   $EXISTING_STATE -- Whether the specified instance is running</span><br><span class="line"></span><br><span class="line">    iecho "confirmed $INSTANCE_ID exists."</span><br><span class="line">    iecho "      Current type: $EXISTING_TYPE"</span><br><span class="line">    iecho "      Current state code: $EXISTING_STATE"</span><br><span class="line"></span><br><span class="line">    # Are we trying to change the instance to the same type?</span><br><span class="line">    if [[ "$EXISTING_TYPE" == "$REQUESTED_TYPE" ]]; then</span><br><span class="line">        errecho "ERROR: Can't change instance type to the same type: $REQUESTED_TYPE."</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # Check if the instance is currently running.</span><br><span class="line">    # 16="running"</span><br><span class="line">    if [[ "$EXISTING_STATE" == "running" ]]; then</span><br><span class="line">        # If it is, we need to stop it.</span><br><span class="line">        # Do we have permission to stop it? </span><br><span class="line">        # If -f (FORCE) was set, we do.</span><br><span class="line">        # If not, we need to ask the user.</span><br><span class="line">        if [[ $FORCE == false ]]; then</span><br><span class="line">            while true; do</span><br><span class="line">                echo ""</span><br><span class="line">                echo "The instance $INSTANCE_ID is currently running. It must be stopped to change the type."</span><br><span class="line">                read -r -p "ARE YOU SURE YOU WANT TO STOP THE INSTANCE? (Y or N) " ANSWER</span><br><span class="line">                case $ANSWER in</span><br><span class="line">                    [yY]* )</span><br><span class="line">                        break;;</span><br><span class="line">                    [nN]* )</span><br><span class="line">                        echo "Aborting."</span><br><span class="line">                        exit;;</span><br><span class="line">                    * ) </span><br><span class="line">                        echo "Please answer Y or N."</span><br><span class="line">                        ;;</span><br><span class="line">                esac</span><br><span class="line">            done</span><br><span class="line">        else</span><br><span class="line">            iecho "Forcing stop of instance without prompt because of -f."</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        # stop the instance</span><br><span class="line">        iecho -n "Attempting to stop instance $INSTANCE_ID..."</span><br><span class="line">        RESPONSE=$( aws ec2 stop-instances \</span><br><span class="line">                        --instance-ids "$INSTANCE_ID" )</span><br><span class="line"></span><br><span class="line">        if [[ $&#123;?&#125; -ne 0 ]]; then</span><br><span class="line">            echo "ERROR - AWS reports that it's unable to stop instance $INSTANCE_ID.\n$RESPONSE"</span><br><span class="line">            return 1</span><br><span class="line">        fi</span><br><span class="line">        iecho "request accepted."</span><br><span class="line">    else</span><br><span class="line">        iecho "Instance is not in running state, so not requesting a stop."</span><br><span class="line">    fi;</span><br><span class="line"></span><br><span class="line">    # Wait until stopped.</span><br><span class="line">    iecho "Waiting for $INSTANCE_ID to report 'stopped' state..."</span><br><span class="line">    aws ec2 wait instance-stopped \</span><br><span class="line">        --instance-ids "$INSTANCE_ID"</span><br><span class="line">    if [[ $&#123;?&#125; -ne 0 ]]; then</span><br><span class="line">        echo "\nERROR - AWS reports that Wait command failed.\n$RESPONSE"</span><br><span class="line">        return 1</span><br><span class="line">    fi </span><br><span class="line">    iecho "stopped.\n"</span><br><span class="line"></span><br><span class="line">    # Change the type - command produces no output.</span><br><span class="line">    iecho "Attempting to change type from $EXISTING_TYPE to $REQUESTED_TYPE..."</span><br><span class="line">    RESPONSE=$(aws ec2 modify-instance-attribute \</span><br><span class="line">                   --instance-id "$INSTANCE_ID" \</span><br><span class="line">                   --instance-type "&#123;\"Value\":\"$REQUESTED_TYPE\"&#125;"</span><br><span class="line">              )</span><br><span class="line">    if [[ $&#123;?&#125; -ne 0 ]]; then</span><br><span class="line">        errecho "ERROR - AWS reports that it's unable to change the instance type for instance $INSTANCE_ID from $EXISTING_TYPE to $REQUESTED_TYPE.\n$RESPONSE"</span><br><span class="line">        return 1</span><br><span class="line">    fi</span><br><span class="line">    iecho "changed.\n"</span><br><span class="line"></span><br><span class="line">    # Restart if asked</span><br><span class="line">    if [[ "$RESTART" == "true" ]]; then</span><br><span class="line"></span><br><span class="line">        iecho "Requesting to restart instance $INSTANCE_ID..."</span><br><span class="line">        RESPONSE=$(aws ec2 start-instances \</span><br><span class="line">                        --instance-ids "$INSTANCE_ID" \</span><br><span class="line">                   )</span><br><span class="line">        if [[ $&#123;?&#125; -ne 0 ]]; then</span><br><span class="line">            errecho "ERROR - AWS reports that it's unable to restart instance $INSTANCE_ID.\n$RESPONSE"</span><br><span class="line">            return 1</span><br><span class="line">        fi</span><br><span class="line">        iecho "started.\n"</span><br><span class="line">        iecho "Waiting for instance $INSTANCE_ID to report 'running' state..."</span><br><span class="line">        RESPONSE=$(aws ec2 wait instance-running \</span><br><span class="line">                       --instance-ids "$INSTANCE_ID" )</span><br><span class="line">        if [[ $&#123;?&#125; -ne 0 ]]; then</span><br><span class="line">            errecho "ERROR - AWS reports that Wait command failed.\n$RESPONSE"</span><br><span class="line">            return 1</span><br><span class="line">        fi </span><br><span class="line">        </span><br><span class="line">        iecho "running.\n"</span><br><span class="line">        </span><br><span class="line">    else</span><br><span class="line">        iecho "Restart was not requested with -r.\n"</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="test-change-ec2-instance-type-sh"><a href="#test-change-ec2-instance-type-sh" class="headerlink" title="test_change_ec2_instance_type.sh"></a>test_change_ec2_instance_type.sh</h3><p>脚本文件 change_ec2_instance_type_test.sh 会测试 change_ec2_instance_type 函数的各种代码路径。如果测试脚本中的所有步骤都正确完成，测试脚本将会删除它创建的所有资源。</p><p>您可以使用以下参数运行该测试脚本：</p><ul><li>-v -（开关）每个测试在运行时都会显示通过/失败状态。默认情况下，测试以静默方式运行，输出仅包含最终的总体通过/失败状态。</li><li>-i -（开关）脚本会在每个测试后暂停，以便您能查看每个步骤的中间结果。让您能够使用 Amazon EC2 控制台检查实例的当前状态。您在系统提示符处按 Enter 后，脚本才会继续执行下一步。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bash</span><br><span class="line"></span><br><span class="line">###############################################################################</span><br><span class="line"># Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.</span><br><span class="line"># This file is licensed under the Apache License, Version 2.0 (the &quot;License&quot;).</span><br><span class="line">#</span><br><span class="line"># You may not use this file except in compliance with the License. A copy of</span><br><span class="line"># the License is located at http://aws.amazon.com/apache2.0/.</span><br><span class="line">#</span><br><span class="line"># This file is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span><br><span class="line"># CONDITIONS OF ANY KIND, either express or implied. See the License for the</span><br><span class="line"># specific language governing permissions and limitations under the License.</span><br><span class="line">###############################################################################</span><br><span class="line"></span><br><span class="line">source ./awsdocs_general.sh</span><br><span class="line">source ./change_ec2_instance_type.sh</span><br><span class="line"></span><br><span class="line">function usage &#123;</span><br><span class="line">    echo &quot;This script tests the change_ec2_instance_type function by calling the&quot;</span><br><span class="line">    echo &quot;function in a variety of ways and checking the output. It converts the&quot;</span><br><span class="line">    echo &quot;instance between types t2.nano and t2.micro.&quot;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">    echo &quot;Parameters:&quot;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">    echo &quot;  -v  Verbose. Shows diagnostic messages about the tests as they run.&quot;</span><br><span class="line">    echo &quot;  -i  Interactive. Pauses the script between steps so you can browse&quot;</span><br><span class="line">    echo &quot;      the results in the AWS Management Console as they occur.&quot;</span><br><span class="line">    echo &quot;&quot;</span><br><span class="line">    echo &quot;IMPORTANT: Running this test script creates an Amazon EC2 instance in&quot;</span><br><span class="line">    echo &quot;   your Amazon account that can incur charges. It is your responsibility&quot;</span><br><span class="line">    echo &quot;   to ensure that no resources are left in your account after the script&quot;</span><br><span class="line">    echo &quot;   completes. If an error occurs during the operation of the script,this&quot;</span><br><span class="line">    echo &quot;   instance can remain. Check for the instance and delete it manually to&quot;</span><br><span class="line">    echo &quot;   avoid charges.&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Set default values.</span><br><span class="line">INTERACTIVE=false</span><br><span class="line"></span><br><span class="line"># Retrieve the calling parameters.</span><br><span class="line">while getopts &quot;ivh&quot; OPTION; do</span><br><span class="line">    case &quot;$&#123;OPTION&#125;&quot;</span><br><span class="line">    in</span><br><span class="line">        i)</span><br><span class="line">            INTERACTIVE=true</span><br><span class="line">            VERBOSE=true</span><br><span class="line">            ;;</span><br><span class="line">        v)</span><br><span class="line">            VERBOSE=true</span><br><span class="line">            ;;</span><br><span class="line">        h)</span><br><span class="line">            usage</span><br><span class="line">            return 0</span><br><span class="line">            ;;</span><br><span class="line">        \?)</span><br><span class="line">            echo &quot;Invalid parameter.&quot;</span><br><span class="line">            usage</span><br><span class="line">            return 1</span><br><span class="line">            ;;</span><br><span class="line">    esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">if [ &quot;$VERBOSE&quot; == &quot;true&quot; ]; then iecho &quot;Tests running in verbose mode.&quot;; fi</span><br><span class="line">if [ &quot;$INTERACTIVE&quot; == &quot;true&quot; ]; then iecho &quot;Tests running in interactive mode.&quot;; fi</span><br><span class="line"></span><br><span class="line">iecho &quot;&quot;</span><br><span class="line">iecho &quot;***************SETUP STEPS******************&quot;</span><br><span class="line">    # First, get the AMI ID for the one running the latest Amazon Linix 2.</span><br><span class="line">    iecho -n &quot;Retrieving the AMI ID for the latest Amazon Linux 2 AMI...&quot;</span><br><span class="line">    AMI_ID=$(aws ec2 describe-images \</span><br><span class="line">                --owners &apos;amazon&apos; \</span><br><span class="line">                --filters &apos;Name=name,Values=amzn2-ami-hvm-2.0.????????-x86_64-gp2&apos; &apos;Name=state,Values=available&apos; \</span><br><span class="line">                --query &apos;sort_by(Images, &amp;CreationDate)[-1].[ImageId]&apos; \</span><br><span class="line">                --output &apos;text&apos;)</span><br><span class="line">    if [ $&#123;?&#125; -ne 0 ]; then</span><br><span class="line">        echo &quot;ERROR: Unable to retrieve latest Amazon Linux 2 AMI ID: $AMI_ID&quot;</span><br><span class="line">        echo &quot;Tests canceled.&quot;</span><br><span class="line">        return 1</span><br><span class="line">    else</span><br><span class="line">        iecho &quot;retrieved $AMI_ID.&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # Now launch the instance as a t2.micro and capture its instance ID.</span><br><span class="line">    # All other instance settings are left to default.</span><br><span class="line">    iecho -n &quot;Requesting new Amazon EC2 instance of type t2.micro...&quot;</span><br><span class="line">    EC2_INSTANCE_ID=$(aws ec2 run-instances \</span><br><span class="line">                        --image-id &quot;$AMI_ID&quot; \</span><br><span class="line">                        --instance-type t2.micro \</span><br><span class="line">                        --query &apos;Instances[0].InstanceId&apos; \</span><br><span class="line">                        --output text)</span><br><span class="line">    if [ $&#123;?&#125; -ne 0 ]; then</span><br><span class="line">        echo &quot;ERROR: Unable to launch EC2 instance: $EC2_INSTANCE_ID&quot;</span><br><span class="line">        echo &quot;Tests canceled.&quot;</span><br><span class="line">        return 1</span><br><span class="line">    else</span><br><span class="line">        iecho &quot;launched. ID:$EC2_INSTANCE_ID&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    iecho -n &quot;Waiting for instance $EC2_INSTANCE_ID to exist...&quot;</span><br><span class="line">    aws ec2 wait instance-exists \</span><br><span class="line">        --instance-id &quot;$EC2_INSTANCE_ID&quot;</span><br><span class="line">    iecho &quot;confirmed.&quot;</span><br><span class="line"></span><br><span class="line">iecho &quot;***************END OF SETUP*****************&quot;</span><br><span class="line">iecho &quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">run_test &quot;1. Missing mandatory -i parameter&quot; \</span><br><span class="line">         &quot;change_ec2_instance_type&quot; \</span><br><span class="line">         1 \</span><br><span class="line">         &quot;ERROR: You must provide an instance id.&quot;</span><br><span class="line"></span><br><span class="line">run_test &quot;2. Missing mandatory -t parameter&quot; \</span><br><span class="line">         &quot;change_ec2_instance_type -i abc&quot; \</span><br><span class="line">         1 \</span><br><span class="line">         &quot;ERROR: You must provide an instance type.&quot;</span><br><span class="line"></span><br><span class="line">run_test &quot;3. Using an instance ID that doesn&apos;t exist&quot; \</span><br><span class="line">         &quot;change_ec2_instance_type -i abc -t t2.micro&quot; \</span><br><span class="line">         1 \</span><br><span class="line">         &quot;ERROR: I can&apos;t find the instance.&quot;</span><br><span class="line"></span><br><span class="line"># Test changing to the same type. We can do this while the instance is starting up.</span><br><span class="line">run_test &quot;4. Trying to change to same type&quot; \</span><br><span class="line">         &quot;change_ec2_instance_type -v -i $EC2_INSTANCE_ID -t t2.micro&quot; \</span><br><span class="line">         1 \</span><br><span class="line">         &quot;ERROR: Can&apos;t change instance type to the same type.&quot;</span><br><span class="line"></span><br><span class="line">iecho -n &quot;Waiting for instance $EC2_INSTANCE_ID to reach running state...&quot;</span><br><span class="line">RESPONSE=$(aws ec2 wait instance-running --instance-id &quot;$EC2_INSTANCE_ID&quot;)</span><br><span class="line">if [[ $&#123;?&#125; -ne 0 ]]; then</span><br><span class="line">    errecho &quot;\nERROR: AWS reports that the Wait command failed.\n$RESPONSE&quot;</span><br><span class="line">    return 1</span><br><span class="line">fi </span><br><span class="line">iecho &quot;running.&quot;</span><br><span class="line"></span><br><span class="line"># Test changing to t2.micro without -r : should still be in stopped state.</span><br><span class="line">run_test &quot;5. Changing to type t2.nano without restart&quot; \</span><br><span class="line">         &quot;change_ec2_instance_type -f -i $EC2_INSTANCE_ID -t t2.nano&quot; \</span><br><span class="line">         0</span><br><span class="line"></span><br><span class="line">         # Validate result was &quot;t2.nano&quot; and that it&apos;s in &quot;stopped&quot; state.</span><br><span class="line">         get_instance_info &quot;$EC2_INSTANCE_ID&quot;</span><br><span class="line">         if [ &quot;$EXISTING_TYPE&quot; != &quot;t2.nano&quot; ]; then</span><br><span class="line">             test_failed &quot;Unable to validate change. Should be t2.nano. Found $EXISTING_TYPE.&quot;</span><br><span class="line">         fi</span><br><span class="line">         if [ &quot;$EXISTING_STATE&quot; != &quot;stopped&quot; ]; then</span><br><span class="line">             test_failed &quot;Unable to validate state. Should be stopped. Found $EXISTING_STATE.&quot;</span><br><span class="line">         fi</span><br><span class="line"></span><br><span class="line"># Test changing back to t2.micro with -r. Should now be in running state</span><br><span class="line">run_test &quot;6. Changing to type t2.micro with restart&quot; \</span><br><span class="line">         &quot;change_ec2_instance_type -f -r -i $EC2_INSTANCE_ID -t t2.micro&quot; \</span><br><span class="line">         0</span><br><span class="line"></span><br><span class="line">         # Validate result was &quot;t2.micro&quot; and that it&apos;s in &quot;running&quot; state.</span><br><span class="line">         get_instance_info &quot;$EC2_INSTANCE_ID&quot;</span><br><span class="line">         if [ &quot;$EXISTING_TYPE&quot; != &quot;t2.micro&quot; ]; then</span><br><span class="line">             test_failed &quot;Unable to validate change. Should be t2.micro. Found $EXISTING_TYPE.&quot;</span><br><span class="line">         fi</span><br><span class="line">         if [ &quot;$EXISTING_STATE&quot; != &quot;running&quot; ]; then</span><br><span class="line">             test_failed &quot;Unable to validate state. Should be running. Found $EXISTING_STATE.&quot;</span><br><span class="line">         fi</span><br><span class="line"></span><br><span class="line">iecho &quot;&quot;</span><br><span class="line">iecho &quot;*************TEAR DOWN STEPS****************&quot;</span><br><span class="line">    iecho -n &quot;Requesting termination of instance $EC2_INSTANCE_ID...&quot;</span><br><span class="line">    # Delete and terminate the instance.</span><br><span class="line">    RESPONSE=$(aws ec2 terminate-instances \</span><br><span class="line">                        --instance-ids &quot;$EC2_INSTANCE_ID&quot;</span><br><span class="line">              )</span><br><span class="line">    if [ $&#123;?&#125; -ne 0 ]; then</span><br><span class="line">        errecho &quot;**** ERROR ****&quot;</span><br><span class="line">        errecho &quot;AWS reported a failure to terminate EC2 instance: $EC2_INSTANCE_ID&quot;</span><br><span class="line">        errecho &quot;You must terminate the instance using the AWS Management Console&quot;</span><br><span class="line">        errecho &quot;or CLI commands. Failure to terminate the instance can result in&quot;</span><br><span class="line">        errecho &quot;charges to your AWS account.\n&quot;</span><br><span class="line">    else</span><br><span class="line">        iecho &quot;request accepted.&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    iecho -n &quot;Waiting for instance $EC2_INSTANCE_ID to terminate...&quot;</span><br><span class="line">    aws ec2 wait instance-terminated \</span><br><span class="line">        --instance-id &quot;$EC2_INSTANCE_ID&quot;</span><br><span class="line">    iecho &quot;confirmed.&quot;</span><br><span class="line">    if [[ $&#123;?&#125; -ne 0 ]]; then</span><br><span class="line">        errecho &quot;ERROR - AWS reports that Wait command failed.&quot;</span><br><span class="line">        errecho &quot;You must ensure that the instance terminated successfully yourself using the&quot;</span><br><span class="line">        errecho &quot;AWS Management Console or CLI commands. Failure to terminate the instance can&quot; </span><br><span class="line">        errecho &quot;result in charges to your AWS account.\n&quot;</span><br><span class="line">        return 1</span><br><span class="line">    fi </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">iecho &quot;************END OF TEAR DOWN****************&quot;</span><br><span class="line">iecho &quot;&quot;</span><br><span class="line"></span><br><span class="line">echo &quot;Tests completed successfully.&quot;</span><br></pre></td></tr></table></figure><h3 id="awsdocs-general-sh"><a href="#awsdocs-general-sh" class="headerlink" title="awsdocs_general.sh"></a>awsdocs_general.sh</h3><p>脚本文件 awsdocs_general.sh 中包含了在 AWS CLI 的高级示例中使用的通用函数。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bash</span><br><span class="line">###############################################################################</span><br><span class="line"># Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.</span><br><span class="line"># This file is licensed under the Apache License, Version 2.0 (the &quot;License&quot;).</span><br><span class="line">#</span><br><span class="line"># You may not use this file except in compliance with the License. A copy of</span><br><span class="line"># the License is located at http://aws.amazon.com/apache2.0/.</span><br><span class="line">#</span><br><span class="line"># This file is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span><br><span class="line"># CONDITIONS OF ANY KIND, either express or implied. See the License for the</span><br><span class="line"># specific language governing permissions and limitations under the License.</span><br><span class="line">###############################################################################</span><br><span class="line">#</span><br><span class="line"># This script contains general-purpose functions that are used throughout </span><br><span class="line"># the AWS Command Line Interface (AWS CLI) code examples that are maintained</span><br><span class="line"># in the repo at https://github.com/awsdocs/aws-doc-sdk-examples.</span><br><span class="line">#</span><br><span class="line"># They are intended to abstract functionality that is required for the tests</span><br><span class="line"># to work without cluttering up the code. The intent is to ensure that the </span><br><span class="line"># purpose of the code is clear.</span><br><span class="line"></span><br><span class="line"># Set global defaults:</span><br><span class="line">VERBOSE=false</span><br><span class="line"></span><br><span class="line">###############################################################################</span><br><span class="line"># function run_test</span><br><span class="line">#</span><br><span class="line"># This function is used to perform a command and compare its output to both</span><br><span class="line"># the expected error code and the expected output string. If there isn&apos;t a </span><br><span class="line"># match, then the function invokes the test_failed function.</span><br><span class="line">###############################################################################</span><br><span class="line">function run_test &#123;</span><br><span class="line">    local DESCRIPTION COMMAND EXPECTED_ERR_CODE EXPECTED_OUTPUT RESPONSE</span><br><span class="line">    </span><br><span class="line">    DESCRIPTION=&quot;$1&quot;</span><br><span class="line">    COMMAND=&quot;$2&quot;</span><br><span class="line">    EXPECTED_ERR_CODE=&quot;$3&quot;</span><br><span class="line">    if [[ -z &quot;$4&quot; ]]; then EXPECTED_OUTPUT=&quot;$4&quot;; else EXPECTED_OUTPUT=&quot;&quot;; fi</span><br><span class="line">    </span><br><span class="line">    iecho -n &quot;Running test: $DESCRIPTION...&quot;</span><br><span class="line">    RESPONSE=&quot;$($COMMAND)&quot;</span><br><span class="line">    ERR=&quot;$&#123;?&#125;&quot;</span><br><span class="line"></span><br><span class="line">    # Check to see if we got the expected error code.</span><br><span class="line">    if [[ &quot;$EXPECTED_ERR_CODE&quot; -ne &quot;$ERR&quot; ]]; then</span><br><span class="line">        test_failed &quot;The test \&quot;$DESCRIPTION\&quot; returned an unexpected error code: $ERR&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # Now check the error message, if we provided other than &quot;&quot;.</span><br><span class="line">    if [[ -n &quot;$EXPECTED_OUTPUT&quot; ]]; then</span><br><span class="line">        MATCH=$(echo &quot;$RESPONSE&quot; | grep &quot;$EXPECTED_OUTPUT&quot;)</span><br><span class="line">        # If there was no match (it&apos;s an empty string), then fail.</span><br><span class="line">        if [[ -z &quot;$MATCH&quot; ]]; then</span><br><span class="line">            test_failed &quot;The test \&quot;$DESCRIPTION\&quot; returned an unexpected output: $RESPONSE&quot;</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">    </span><br><span class="line">    iecho &quot;OK&quot;</span><br><span class="line">    ipause</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###############################################################################</span><br><span class="line"># function test_failed</span><br><span class="line">#</span><br><span class="line"># This function is used to terminate a failed test and to warn the customer</span><br><span class="line"># about possible undeleted resources that could incur costs to their account.</span><br><span class="line">###############################################################################</span><br><span class="line"></span><br><span class="line">function test_failed &#123;</span><br><span class="line">    </span><br><span class="line">    errecho &quot;&quot;</span><br><span class="line">    errecho &quot;===TEST FAILED===&quot;</span><br><span class="line">    errecho &quot;$@&quot;</span><br><span class="line">    errecho &quot;&quot;</span><br><span class="line">    errecho &quot;    One or more of the tests failed to complete successfully. This means that&quot;</span><br><span class="line">    errecho &quot;    any tests after the one that failed didn&apos;t run and might have left resources&quot;</span><br><span class="line">    errecho &quot;    still active in your account.&quot;</span><br><span class="line">    errecho &quot;&quot;</span><br><span class="line">    errecho &quot;IMPORTANT:&quot;</span><br><span class="line">    errecho &quot;    Resources created by this script can incur charges to your AWS account. If the&quot;</span><br><span class="line">    errecho &quot;    script didn&apos;t complete successfully, then you must review and manually delete&quot;</span><br><span class="line">    errecho &quot;    any resources created by this script that were not automatically removed.&quot;</span><br><span class="line">    errecho &quot;&quot;</span><br><span class="line">    exit 1 </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">###############################################################################</span><br><span class="line"># function errecho</span><br><span class="line">#</span><br><span class="line"># This function outputs everything sent to it to STDERR (standard error output).</span><br><span class="line">###############################################################################</span><br><span class="line">function errecho &#123;</span><br><span class="line">    printf &quot;%s\n&quot; &quot;$*&quot; 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###############################################################################</span><br><span class="line"># function iecho</span><br><span class="line">#</span><br><span class="line"># This function enables the script to display the specified text only if </span><br><span class="line"># the global variable $VERBOSE is set to true.</span><br><span class="line">###############################################################################</span><br><span class="line">function iecho &#123;</span><br><span class="line">    if [[ $VERBOSE == true ]]; then</span><br><span class="line">        echo &quot;$@&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">###############################################################################</span><br><span class="line"># function ipause</span><br><span class="line">#</span><br><span class="line"># This function enables the script to pause after each command if interactive</span><br><span class="line"># mode is set (by including -i on the script invocation command).</span><br><span class="line">###############################################################################</span><br><span class="line">function ipause &#123;</span><br><span class="line">    if [[ $INTERACTIVE == true ]]; then</span><br><span class="line">        read -r -p &quot;Press ENTER to continue...&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Initialize the shell&apos;s RANDOM variable.</span><br><span class="line">RANDOM=$$</span><br><span class="line">###############################################################################</span><br><span class="line"># function generate_random_name</span><br><span class="line">#</span><br><span class="line"># This function generates a random file name with using the specified root,</span><br><span class="line"># followed by 4 groups that each have 4 digits.</span><br><span class="line"># The default root name is &quot;test&quot;.</span><br><span class="line">###############################################################################</span><br><span class="line">function generate_random_name &#123;</span><br><span class="line"></span><br><span class="line">    ROOTNAME=&quot;test&quot;</span><br><span class="line">    if [[ -n $1 ]]; then</span><br><span class="line">        ROOTNAME=$1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # Initialize the FILENAME variable</span><br><span class="line">    FILENAME=&quot;$ROOTNAME&quot;</span><br><span class="line">    # Configure random number generator to issue numbers between 1000 and 9999, </span><br><span class="line">    # inclusive.</span><br><span class="line">    DIFF=$((9999-1000+1))</span><br><span class="line"></span><br><span class="line">    for _ in &#123;1..4&#125;</span><br><span class="line">    do</span><br><span class="line">        rnd=$(($((RANDOM%DIFF))+X))</span><br><span class="line">        # Make sure that the number is 4 digits long.</span><br><span class="line">        while [ &quot;$&#123;#rnd&#125;&quot; -lt 4 ]; do rnd=&quot;0$rnd&quot;; done</span><br><span class="line">        FILENAME+=&quot;-$rnd&quot;</span><br><span class="line">    done</span><br><span class="line">    echo $FILENAME</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上完全基于<a href="https://docs.aws.amazon.com/" target="_blank" rel="noopener">AWS官方文档</a>，并结合自身理解创作</p><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> Bash基础入门 </tag>
            
            <tag> shell技巧 </tag>
            
            <tag> AWS CLI </tag>
            
            <tag> AWS EC2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AWS CLI(4)示例</title>
      <link href="2020/11/19/AWS/CLI/AWS-CLI-4-%E7%A4%BA%E4%BE%8B/"/>
      <url>2020/11/19/AWS/CLI/AWS-CLI-4-%E7%A4%BA%E4%BE%8B/</url>
      
        <content type="html"><![CDATA[<p>描述: 将 Amazon 服务 与 AWS CLI 结合使用</p><a id="more"></a><p>演示一些常见命令</p><h3 id="DynamoDB"><a href="#DynamoDB" class="headerlink" title="DynamoDB"></a>DynamoDB</h3><h4 id="创建table"><a href="#创建table" class="headerlink" title="创建table"></a>创建table</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ aws dynamodb create-table \</span><br><span class="line">    --table-name MusicCollection \</span><br><span class="line">    --attribute-definitions AttributeName=Artist,AttributeType=S AttributeName=SongTitle,AttributeType=S \</span><br><span class="line">    --key-schema AttributeName=Artist,KeyType=HASH AttributeName=SongTitle,KeyType=RANGE \</span><br><span class="line">    --provisioned-throughput ReadCapacityUnits=1,WriteCapacityUnits=1</span><br></pre></td></tr></table></figure><h4 id="插入项目"><a href="#插入项目" class="headerlink" title="插入项目"></a>插入项目</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ aws dynamodb put-item \</span><br><span class="line">    --table-name MusicCollection \</span><br><span class="line">    --item &apos;&#123;</span><br><span class="line">        &quot;Artist&quot;: &#123;&quot;S&quot;: &quot;No One You Know&quot;&#125;,</span><br><span class="line">        &quot;SongTitle&quot;: &#123;&quot;S&quot;: &quot;Call Me Today&quot;&#125; ,</span><br><span class="line">        &quot;AlbumTitle&quot;: &#123;&quot;S&quot;: &quot;Somewhat Famous&quot;&#125; </span><br><span class="line">      &#125;&apos; \</span><br><span class="line">    --return-consumed-capacity TOTAL</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ConsumedCapacity&quot;: &#123;</span><br><span class="line">        &quot;CapacityUnits&quot;: 1.0,</span><br><span class="line">        &quot;TableName&quot;: &quot;MusicCollection&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ aws dynamodb put-item \</span><br><span class="line">    --table-name MusicCollection \</span><br><span class="line">    --item &apos;&#123; </span><br><span class="line">        &quot;Artist&quot;: &#123;&quot;S&quot;: &quot;Acme Band&quot;&#125;, </span><br><span class="line">        &quot;SongTitle&quot;: &#123;&quot;S&quot;: &quot;Happy Day&quot;&#125; , </span><br><span class="line">        &quot;AlbumTitle&quot;: &#123;&quot;S&quot;: &quot;Songs About Life&quot;&#125; </span><br><span class="line">      &#125;&apos; \</span><br><span class="line">    --return-consumed-capacity TOTAL</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;ConsumedCapacity&quot;: &#123;</span><br><span class="line">        &quot;CapacityUnits&quot;: 1.0,</span><br><span class="line">        &quot;TableName&quot;: &quot;MusicCollection&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="使用json文件"><a href="#使用json文件" class="headerlink" title="使用json文件"></a>使用json文件</h4><p>json文件<code>expression-attributes.json</code>的内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;:v1&quot;: &#123;&quot;S&quot;: &quot;No One You Know&quot;&#125;,</span><br><span class="line">  &quot;:v2&quot;: &#123;&quot;S&quot;: &quot;Call Me Today&quot;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ aws dynamodb query --table-name MusicCollection \</span><br><span class="line">    --key-condition-expression &quot;Artist = :v1 AND SongTitle = :v2&quot; \</span><br><span class="line">    --expression-attribute-values file://expression-attributes.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Count&quot;: 1,</span><br><span class="line">    &quot;Items&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;AlbumTitle&quot;: &#123;</span><br><span class="line">                &quot;S&quot;: &quot;Somewhat Famous&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;SongTitle&quot;: &#123;</span><br><span class="line">                &quot;S&quot;: &quot;Call Me Today&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Artist&quot;: &#123;</span><br><span class="line">                &quot;S&quot;: &quot;No One You Know&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ScannedCount&quot;: 1,</span><br><span class="line">    &quot;ConsumedCapacity&quot;: null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="EC2"><a href="#EC2" class="headerlink" title="EC2"></a>EC2</h3><h4 id="创建keypair"><a href="#创建keypair" class="headerlink" title="创建keypair"></a>创建keypair</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 create-key-pair --key-name MyKeyPair --query &apos;KeyMaterial&apos; --output text &gt; MyKeyPair.pem</span><br></pre></td></tr></table></figure><h4 id="创建安全组"><a href="#创建安全组" class="headerlink" title="创建安全组"></a>创建安全组</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 create-security-group --group-name my-sg --description &quot;My security group&quot; --vpc-id vpc-1a2b3c4d</span><br><span class="line">&#123;</span><br><span class="line">    &quot;GroupId&quot;: &quot;sg-903004f8&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="添加入站规则"><a href="#添加入站规则" class="headerlink" title="添加入站规则"></a>添加入站规则</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 authorize-security-group-ingress --group-id sg-903004f8 --protocol tcp --port 22 --cidr 203.0.113.0/24</span><br></pre></td></tr></table></figure><h4 id="创建EC2"><a href="#创建EC2" class="headerlink" title="创建EC2"></a>创建EC2</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 run-instances --image-id ami-xxxxxxxx --count 1 --instance-type t2.micro --key-name MyKeyPair --security-group-ids sg-903004f8 --subnet-id subnet-6e7f829e</span><br></pre></td></tr></table></figure><h4 id="列出EC2"><a href="#列出EC2" class="headerlink" title="列出EC2"></a>列出EC2</h4><p>列出类型为t2.micro的实例</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 describe-instances --filters &quot;Name=instance-type,Values=t2.micro&quot; --query &quot;Reservations[].Instances[].InstanceId&quot;</span><br></pre></td></tr></table></figure><h3 id="IAM"><a href="#IAM" class="headerlink" title="IAM"></a>IAM</h3><h4 id="创建用户组"><a href="#创建用户组" class="headerlink" title="创建用户组"></a>创建用户组</h4><p>使用 <code>create-group</code> 命令创建组</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ aws iam create-group --group-name MyIamGroup</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Group&quot;: &#123;</span><br><span class="line">        &quot;GroupName&quot;: &quot;MyIamGroup&quot;,</span><br><span class="line">        &quot;CreateDate&quot;: &quot;2018-12-14T03:03:52.834Z&quot;,</span><br><span class="line">        &quot;GroupId&quot;: &quot;AGPAJNUJ2W4IJVEXAMPLE&quot;,</span><br><span class="line">        &quot;Arn&quot;: &quot;arn:aws-cn:iam::123456789012:group/MyIamGroup&quot;,</span><br><span class="line">        &quot;Path&quot;: &quot;/&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h4><p>使用 <code>create-user</code> 命令创建用户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ aws iam create-user --user-name MyUser</span><br><span class="line">&#123;</span><br><span class="line">    &quot;User&quot;: &#123;</span><br><span class="line">        &quot;UserName&quot;: &quot;MyUser&quot;,</span><br><span class="line">        &quot;Path&quot;: &quot;/&quot;,</span><br><span class="line">        &quot;CreateDate&quot;: &quot;2018-12-14T03:13:02.581Z&quot;,</span><br><span class="line">        &quot;UserId&quot;: &quot;AIDAJY2PE5XUZ4EXAMPLE&quot;,</span><br><span class="line">        &quot;Arn&quot;: &quot;arn:aws-cn:iam::123456789012:user/MyUser&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="将用户添加到组中"><a href="#将用户添加到组中" class="headerlink" title="将用户添加到组中"></a>将用户添加到组中</h4><p>使用 <code>add-user-to-group</code> 命令将用户添加到组中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws iam add-user-to-group --user-name MyUser --group-name MyIamGroup</span><br></pre></td></tr></table></figure><h4 id="将-IAM-托管策略附加到-IAM-用户"><a href="#将-IAM-托管策略附加到-IAM-用户" class="headerlink" title="将 IAM 托管策略附加到 IAM 用户"></a>将 IAM 托管策略附加到 IAM 用户</h4><ol><li><p>确定要附加的策略的 Amazon 资源名称 (ARN)。以下命令使用 <code>list-policies</code> 查找具有名称 <code>PowerUserAccess</code> 的策略的 ARN。然后，它会将该 ARN 存储在环境变量中。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ export POLICYARN=$(aws iam list-policies --query &apos;Policies[?PolicyName==`PowerUserAccess`].&#123;ARN:Arn&#125;&apos; --output text)       ~</span><br><span class="line">$ echo $POLICYARN</span><br><span class="line">arn:aws-cn:iam::aws:policy/PowerUserAccess</span><br></pre></td></tr></table></figure></li><li><p>要附加策略，请使用 <code>attach-user-policy</code> 命令，并引用存放策略 ARN 的环境变量。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws iam attach-user-policy --user-name MyUser --policy-arn $POLICYARN</span><br></pre></td></tr></table></figure></li><li><p>通过运行 <code>list-attached-user-policies</code> 命令验证策略已附加到此用户。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ aws iam list-attached-user-policies --user-name MyUser</span><br><span class="line">&#123;</span><br><span class="line">    &quot;AttachedPolicies&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;PolicyName&quot;: &quot;PowerUserAccess&quot;,</span><br><span class="line">            &quot;PolicyArn&quot;: &quot;arn:aws-cn:iam::aws:policy/PowerUserAccess&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h4 id="为-IAM-用户设置初始密码"><a href="#为-IAM-用户设置初始密码" class="headerlink" title="为 IAM 用户设置初始密码"></a>为 IAM 用户设置初始密码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ aws iam create-login-profile --user-name MyUser --password My!User1Login8P@ssword --password-reset-required</span><br><span class="line">&#123;</span><br><span class="line">    &quot;LoginProfile&quot;: &#123;</span><br><span class="line">        &quot;UserName&quot;: &quot;MyUser&quot;,</span><br><span class="line">        &quot;CreateDate&quot;: &quot;2018-12-14T17:27:18Z&quot;,</span><br><span class="line">        &quot;PasswordResetRequired&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="更改-IAM-用户的密码"><a href="#更改-IAM-用户的密码" class="headerlink" title="更改 IAM 用户的密码"></a>更改 IAM 用户的密码</h4><p>可以使用 <code>update-login-profile</code> 命令更改 IAM 用户的密码。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws iam update-login-profile --user-name MyUser --password My!User1ADifferentP@ssword</span><br></pre></td></tr></table></figure><h4 id="创建访问密钥"><a href="#创建访问密钥" class="headerlink" title="创建访问密钥"></a>创建访问密钥</h4><p>使用 <code>create-access-key</code> 命令为 IAM 用户创建访问密钥。访问密钥是一组安全凭证，由访问密钥 ID 和私有密钥组成。</p><p>IAM 用户一次只能创建两个访问密钥。如果您尝试创建第三组，则命令返回 <code>LimitExceeded</code> 错误。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ aws iam create-access-key --user-name MyUser</span><br><span class="line">&#123;</span><br><span class="line">    &quot;AccessKey&quot;: &#123;</span><br><span class="line">        &quot;UserName&quot;: &quot;MyUser&quot;,</span><br><span class="line">        &quot;AccessKeyId&quot;: &quot;AKIAIOSFODNN7EXAMPLE&quot;,</span><br><span class="line">        &quot;Status&quot;: &quot;Active&quot;,</span><br><span class="line">        &quot;SecretAccessKey&quot;: &quot;wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY&quot;,</span><br><span class="line">        &quot;CreateDate&quot;: &quot;2018-12-14T17:34:16Z&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="删除访问密钥"><a href="#删除访问密钥" class="headerlink" title="删除访问密钥"></a>删除访问密钥</h4><p>使用 <code>delete-access-key</code> 命令为 IAM 用户删除访问密钥。使用访问密钥 ID 指定要删除的访问密钥。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws iam delete-access-key --user-name MyUser --access-key-id AKIAIOSFODNN7EXAMPLE</span><br></pre></td></tr></table></figure><h3 id="S3"><a href="#S3" class="headerlink" title="S3"></a>S3</h3><h4 id="创建桶"><a href="#创建桶" class="headerlink" title="创建桶"></a>创建桶</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws s3 mb s3://bucket-name</span><br></pre></td></tr></table></figure><h4 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ aws s3 cp filename.txt s3://bucket-name</span><br><span class="line">$ aws s3 cp s3://bucket-name/filename.txt ./</span><br><span class="line"></span><br><span class="line"># 使用 cat 文本编辑器，将文本“hello world”流式传输到 s3://bucket-name/filename.txt 文件</span><br><span class="line">$ cat &quot;hello world&quot; | aws s3 cp - s3://bucket-name/filename.txt</span><br><span class="line"></span><br><span class="line"># 将 s3://bucket-name/filename.txt 文件流式传输到 stdout，并将内容输出到控制台</span><br><span class="line">$ aws s3 cp s3://bucket-name/filename.txt -</span><br><span class="line">hello world</span><br><span class="line"></span><br><span class="line"># 将 s3://bucket-name/pre 的内容流式传输到 stdout，使用 bzip2 命令压缩文件，并将名为 key.bz2 的新压缩文件上传到 s3://bucket-name</span><br><span class="line">$ aws s3 cp s3://bucket-name/pre - | bzip2 --best | aws s3 cp - s3://bucket-name/key.bz2</span><br></pre></td></tr></table></figure><h4 id="移动"><a href="#移动" class="headerlink" title="移动"></a>移动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 将对象从 s3://bucket-name/example 移动到 s3://my-bucket/</span><br><span class="line">$ aws s3 mv s3://bucket-name/example s3://my-bucket/</span><br><span class="line"></span><br><span class="line"># 将本地文件从当前工作目录移动到 Amazon S3 存储桶</span><br><span class="line">$ aws s3 mv filename.txt s3://bucket-name</span><br><span class="line"></span><br><span class="line"># 将文件从 Amazon S3 存储桶移动到当前工作目录，其中 ./ 指定当前的工作目录。</span><br><span class="line">$ aws s3 mv s3://bucket-name/filename.txt ./</span><br></pre></td></tr></table></figure><h4 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h4><p>s3 sync 命令同步一个存储桶与一个目录中的内容，或者同步两个存储桶中的内容。通常，s3 sync 在源和目标之间复制缺失或过时的文件或对象。不过，您还可以提供 –delete 选项来从目标中删除源中不存在的文件或对象。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$ aws s3 sync . s3://my-bucket/path</span><br><span class="line">upload: MySubdirectory\MyFile3.txt to s3://my-bucket/path/MySubdirectory/MyFile3.txt</span><br><span class="line">upload: MyFile2.txt to s3://my-bucket/path/MyFile2.txt</span><br><span class="line">upload: MyFile1.txt to s3://my-bucket/path/MyFile1.txt</span><br><span class="line"></span><br><span class="line"># Delete local file</span><br><span class="line">$ rm ./MyFile1.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Sync with deletion - object is deleted from bucket</span><br><span class="line">$ aws s3 sync . s3://my-bucket/path --delete</span><br><span class="line">delete: s3://my-bucket/path/MyFile1.txt</span><br><span class="line"></span><br><span class="line"># Delete object from bucket</span><br><span class="line">$ aws s3 rm s3://my-bucket/path/MySubdirectory/MyFile3.txt</span><br><span class="line">delete: s3://my-bucket/path/MySubdirectory/MyFile3.txt</span><br><span class="line"></span><br><span class="line"># Sync with deletion - local file is deleted</span><br><span class="line">$ aws s3 sync s3://my-bucket/path . --delete</span><br><span class="line">delete: MySubdirectory\MyFile3.txt</span><br><span class="line"></span><br><span class="line"># Sync with Infrequent Access storage class</span><br><span class="line">$ aws s3 sync . s3://my-bucket/path --storage-class STANDARD_IA</span><br></pre></td></tr></table></figure><h3 id="删除桶以及桶内所有有内容"><a href="#删除桶以及桶内所有有内容" class="headerlink" title="删除桶以及桶内所有有内容"></a>删除桶以及桶内所有有内容</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws s3 rb s3://bucket-name --force</span><br></pre></td></tr></table></figure><h3 id="删除桶中对象"><a href="#删除桶中对象" class="headerlink" title="删除桶中对象"></a>删除桶中对象</h3><p>从 s3://bucket-name/example 中删除所有对象</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws s3 rm s3://bucket-name/example</span><br></pre></td></tr></table></figure><p>以上完全基于<a href="https://docs.aws.amazon.com/" target="_blank" rel="noopener">AWS官方文档</a>，并结合自身理解创作</p><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> CLI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS CLI </tag>
            
            <tag> AWS CLI基础入门 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AWS CLI(3)query示例</title>
      <link href="2020/11/19/AWS/CLI/AWS-CLI-3-query%E7%A4%BA%E4%BE%8B/"/>
      <url>2020/11/19/AWS/CLI/AWS-CLI-3-query%E7%A4%BA%E4%BE%8B/</url>
      
        <content type="html"><![CDATA[<p>描述: AWS CLI(3)query示例</p><a id="more"></a><p>以下通过官方示例进行<code>query</code>参数选项的演示。</p><p>描述了连接到单独 Amazon EC2 实例的两个 Amazon Elastic Block Store (Amazon EBS) 卷</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 describe-volumes</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Volumes&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;AvailabilityZone&quot;: &quot;us-west-2a&quot;,</span><br><span class="line">            &quot;Attachments&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;AttachTime&quot;: &quot;2013-09-17T00:55:03.000Z&quot;,</span><br><span class="line">                    &quot;InstanceId&quot;: &quot;i-a071c394&quot;,</span><br><span class="line">                    &quot;VolumeId&quot;: &quot;vol-e11a5288&quot;,</span><br><span class="line">                    &quot;State&quot;: &quot;attached&quot;,</span><br><span class="line">                    &quot;DeleteOnTermination&quot;: true,</span><br><span class="line">                    &quot;Device&quot;: &quot;/dev/sda1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;VolumeType&quot;: &quot;standard&quot;,</span><br><span class="line">            &quot;VolumeId&quot;: &quot;vol-e11a5288&quot;,</span><br><span class="line">            &quot;State&quot;: &quot;in-use&quot;,</span><br><span class="line">            &quot;SnapshotId&quot;: &quot;snap-f23ec1c8&quot;,</span><br><span class="line">            &quot;CreateTime&quot;: &quot;2013-09-17T00:55:03.000Z&quot;,</span><br><span class="line">            &quot;Size&quot;: 30</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;AvailabilityZone&quot;: &quot;us-west-2a&quot;,</span><br><span class="line">            &quot;Attachments&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;AttachTime&quot;: &quot;2013-09-18T20:26:16.000Z&quot;,</span><br><span class="line">                    &quot;InstanceId&quot;: &quot;i-4b41a37c&quot;,</span><br><span class="line">                    &quot;VolumeId&quot;: &quot;vol-2e410a47&quot;,</span><br><span class="line">                    &quot;State&quot;: &quot;attached&quot;,</span><br><span class="line">                    &quot;DeleteOnTermination&quot;: true,</span><br><span class="line">                    &quot;Device&quot;: &quot;/dev/sda1&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;VolumeType&quot;: &quot;standard&quot;,</span><br><span class="line">            &quot;VolumeId&quot;: &quot;vol-2e410a47&quot;,</span><br><span class="line">            &quot;State&quot;: &quot;in-use&quot;,</span><br><span class="line">            &quot;SnapshotId&quot;: &quot;snap-708e8348&quot;,</span><br><span class="line">            &quot;CreateTime&quot;: &quot;2013-09-18T20:26:15.000Z&quot;,</span><br><span class="line">            &quot;Size&quot;: 8</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以选择使用以下命令从 Volumes 列表中仅显示第一个卷</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 describe-volumes --query &apos;Volumes[0]&apos;</span><br><span class="line">&#123;</span><br><span class="line">    &quot;AvailabilityZone&quot;: &quot;us-west-2a&quot;,</span><br><span class="line">    &quot;Attachments&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;AttachTime&quot;: &quot;2013-09-17T00:55:03.000Z&quot;,</span><br><span class="line">            &quot;InstanceId&quot;: &quot;i-a071c394&quot;,</span><br><span class="line">            &quot;VolumeId&quot;: &quot;vol-e11a5288&quot;,</span><br><span class="line">            &quot;State&quot;: &quot;attached&quot;,</span><br><span class="line">            &quot;DeleteOnTermination&quot;: true,</span><br><span class="line">            &quot;Device&quot;: &quot;/dev/sda1&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;VolumeType&quot;: &quot;standard&quot;,</span><br><span class="line">    &quot;VolumeId&quot;: &quot;vol-e11a5288&quot;,</span><br><span class="line">    &quot;State&quot;: &quot;in-use&quot;,</span><br><span class="line">    &quot;SnapshotId&quot;: &quot;snap-f23ec1c8&quot;,</span><br><span class="line">    &quot;CreateTime&quot;: &quot;2013-09-17T00:55:03.000Z&quot;,</span><br><span class="line">    &quot;Size&quot;: 30</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>还可以使用通配符表示法 [*]循环访问列表中的所有卷，同时筛选出每个卷中的三个元素：<code>VolumeId</code>、<code>AvailabilityZone</code> 和 <code>Size</code>。词典表示法要求为每个 JSON 键提供一个别名，如：<code>{Alias1:JSONKey1,Alias2:JSONKey2}</code>。词典本身是无序的，因此，此种结构中的键/别名的顺序可能不一致。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 describe-volumes --query &apos;Volumes[*].&#123;ID:VolumeId,AZ:AvailabilityZone,Size:Size&#125;&apos;</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;AZ&quot;: &quot;us-west-2a&quot;,</span><br><span class="line">        &quot;ID&quot;: &quot;vol-e11a5288&quot;,</span><br><span class="line">        &quot;Size&quot;: 30</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;AZ&quot;: &quot;us-west-2a&quot;,</span><br><span class="line">        &quot;ID&quot;: &quot;vol-2e410a47&quot;,</span><br><span class="line">        &quot;Size&quot;: 8</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>还可以将键链接起来（如 <code>key1.key2[0].key3</code>）来筛选深度嵌套在结构中的元素。以下示例利用 <code>Attachments[0].InstanceId</code> 键演示此功能，别名指定为简单的 InstanceId。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 describe-volumes --query &apos;Volumes[*].&#123;ID:VolumeId,InstanceId:Attachments[0].InstanceId,AZ:AvailabilityZone,Size:Size&#125;&apos;</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;InstanceId&quot;: &quot;i-a071c394&quot;,</span><br><span class="line">        &quot;AZ&quot;: &quot;us-west-2a&quot;,</span><br><span class="line">        &quot;ID&quot;: &quot;vol-e11a5288&quot;,</span><br><span class="line">        &quot;Size&quot;: 30</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;InstanceId&quot;: &quot;i-4b41a37c&quot;,</span><br><span class="line">        &quot;AZ&quot;: &quot;us-west-2a&quot;,</span><br><span class="line">        &quot;ID&quot;: &quot;vol-2e410a47&quot;,</span><br><span class="line">        &quot;Size&quot;: 8</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="筛选结果"><a href="#筛选结果" class="headerlink" title="筛选结果"></a>筛选结果</h3><p>要按特定字段的值筛选结果，请使用 JMESPath “?” 运算符。以下示例查询仅输出 us-west-2a 可用区中的卷。并且在指定诸如以上 JMESPath 查询表达式中的 “us-west-2” 这样的文字值时，必须将该值放在反引号 (<code></code>) 中，以便使它能够正确读取。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 describe-volumes \</span><br><span class="line">    --query &apos;Volumes[?AvailabilityZone==`us-west-2a`]&apos;</span><br></pre></td></tr></table></figure><h3 id="大于某值"><a href="#大于某值" class="headerlink" title="大于某值"></a>大于某值</h3><p>以下示例列出了 Amazon EC2 卷。该服务在 us-west-2a 可用区中生成所有附加的卷的列表。–query 参数进一步将输出限制为只有 Size 值大于 50 的卷，并且仅显示具有用户定义名称的指定字段。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 describe-volumes \</span><br><span class="line">    --filters &quot;Name=availability-zone,Values=us-west-2a&quot; &quot;Name=status,Values=attached&quot; \</span><br><span class="line">    --query &apos;Volumes[?Size &gt; `50`].&#123;Id:VolumeId,Size:Size,Type:VolumeType&#125;&apos;</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Id&quot;: &quot;vol-0be9bb0bf12345678&quot;,</span><br><span class="line">        &quot;Size&quot;: 80,</span><br><span class="line">        &quot;Type&quot;: &quot;gp2&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>以下示例显示如何列出在指定日期之后创建的所有快照，从而在输出中仅包括几个可用字段。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 describe-snapshots --owner self \</span><br><span class="line">    --output json \</span><br><span class="line">    --query &apos;Snapshots[?StartTime&gt;=`2018-02-07`].&#123;Id:SnapshotId,VId:VolumeId,Size:VolumeSize&#125;&apos; \</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;id&quot;: &quot;snap-0effb42b7a1b2c3d4&quot;,</span><br><span class="line">        &quot;vid&quot;: &quot;vol-0be9bb0bf12345678&quot;,</span><br><span class="line">        &quot;Size&quot;: 8</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><p>使用 –query 参数按 CreationDate 使用<code>sort_by</code>对输出进行排序,使用<code>[-1]</code>从而仅选择最新的。最终，它显示这一个映像的 ImageId。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 describe-images \</span><br><span class="line">    --owners amazon \</span><br><span class="line">    --filters &quot;Name=name,Values=amzn*gp2&quot; &quot;Name=virtualization-type,Values=hvm&quot; &quot;Name=root-device-type,Values=ebs&quot; \</span><br><span class="line">    --query &quot;sort_by(Images, &amp;CreationDate)[-1].ImageId&quot; \</span><br><span class="line">    --output text</span><br><span class="line">ami-00ced3122871a4921</span><br></pre></td></tr></table></figure><p>以下示例列出了创建的五个最新 Amazon 系统映像 (AMI)，使用<code>reverse</code>从最新到最旧排序。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> aws ec2 describe-images \</span><br><span class="line">    --owners self \</span><br><span class="line">    --query 'reverse(sort_by(Images,&amp;CreationDate))[:5].&#123;id:ImageId,date:CreationDate&#125;'</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        "id": "ami-0a1b2c3d4e5f60001",</span><br><span class="line">        "date": "2018-11-28T17:16:38.000Z"</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        "id": "ami-0a1b2c3d4e5f60002",</span><br><span class="line">        "date": "2018-09-15T13:51:22.000Z"</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        "id": "ami-0a1b2c3d4e5f60003",</span><br><span class="line">        "date": "2018-08-19T10:22:45.000Z"</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        "id": "ami-0a1b2c3d4e5f60004",</span><br><span class="line">        "date": "2018-05-03T12:04:02.000Z"</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        "id": "ami-0a1b2c3d4e5f60005",</span><br><span class="line">        "date": "2017-12-13T17:16:38.000Z"</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>以下示例列出了最新的具有特殊名字的Instance，使用<code>reverse</code>从最新到最旧排序。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aws ec2 describe-instances \</span><br><span class="line">    --filters "Name=tag:Name,Values=new-stack" \</span><br><span class="line">    --query "reverse(sort_by(Reservations[0].Instances,&amp;LaunchTime))[0].&#123;I0:InstanceId,I1:PublicIpAddress,I2:LaunchTime&#125;"</span><br></pre></td></tr></table></figure><h3 id="计数"><a href="#计数" class="headerlink" title="计数"></a>计数</h3><p>计算输出中的项目数量。以下示例通过使用 <code>length</code> 计算列表中的数量，以显示超过 1000 IOPS 的可用卷数。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> aws ec2 describe-volumes \</span><br><span class="line">    --filters "Name=status,Values=available" \</span><br><span class="line">    --query 'length(Volumes[?Iops &gt; `1000`])'</span><br><span class="line">3</span><br></pre></td></tr></table></figure><p>以上完全基于<a href="https://docs.aws.amazon.com/" target="_blank" rel="noopener">AWS官方文档</a>，并结合自身理解创作</p><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> CLI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS CLI </tag>
            
            <tag> AWS CLI基础入门 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AWS CLI(2)使用</title>
      <link href="2020/11/18/AWS/CLI/AWS-CLI-2-%E4%BD%BF%E7%94%A8/"/>
      <url>2020/11/18/AWS/CLI/AWS-CLI-2-%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>描述: AWS CLI的使用过程中的常见操作</p><a id="more"></a><h3 id="获取帮助"><a href="#获取帮助" class="headerlink" title="获取帮助"></a>获取帮助</h3><p>首先当然是获取帮助啦，获取帮助用<code>help</code>命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ aws help</span><br><span class="line">$ aws ec2 help</span><br><span class="line">$ aws ec2 describe-instances help</span><br></pre></td></tr></table></figure><h3 id="wait命令"><a href="#wait命令" class="headerlink" title="wait命令"></a>wait命令</h3><p><code>wait</code> 命令是一个特殊的命令，很多service都有<code>wait</code>这个子命令，<code>wait</code>之后还要接一个子命令。它也是一个承上启下的命令，尤其是在编写AWS脚本很常用。举个例子，在使用创建EC2的CLI命令后，希望在EC2的<code>status</code>处于<code>ok</code>状态之后告诉你EC2已经正常运行起来了（EC2有很多状态，启动状态initial，运行状态running，停止状态stopping）</p><p><code>wait</code> 命令是在command命令之后</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 wait instance-status-ok --instance-ids i-1234567890abcdef0</span><br></pre></td></tr></table></figure><p>并不是说有服务都有<code>wait</code>子命令,通常有状态变化或者需要一段时间才能完成的服务才有<code>wait</code>子命令，例如EC2和CloudFormation。</p><p><code>wait</code> 每15秒轮询一次，直到达到成功状态为止。40次失败检查后，将以255的返回码退出。</p><h3 id="CLI参数"><a href="#CLI参数" class="headerlink" title="CLI参数"></a>CLI参数</h3><p>CLI参数类型不多，但是也不算简单</p><ol><li><p>字符串<br>最简单的参数，<code>--instance-id</code>后面的参数就是字符串</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 describe-instance --instance-id i-1234567890abcdef0</span><br></pre></td></tr></table></figure><p>如果字符串参数包含空格，则字符串必须用引号引起来</p></li><li><p>时间戳参数</p><p>时间戳参数适用于类似<code>--start-time</code> 或 <code>--end-time</code>的参数选项，或者叫<code>date</code>参数.<br>可接受格式包括</p><ul><li><code>YYYY-MM-DDThh:mm:ss.sssTZD (UTC)</code>，例如，2014-10-01T20:30:00.000Z</li><li><code>YYYY-MM-DDThh:mm:ss.sssTZD（带偏移量</code>，例如，2014-10-01T12:30:00.000-08:00</li><li><code>YYYY-MM-DD</code>，例如，2014-10-01</li><li>以秒为单位的 Unix 时间，如 <code>1412195400</code>。表示自 1970 年 1 月 1 日午夜 (UTC) 以来经历的秒数。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 describe-spot-price-history --start-time 2014-10-13T19:00:00Z</span><br></pre></td></tr></table></figure></li></ul></li><li><p>列表参数<br>以空格分隔的一个或多个字符串。如果任何字符串项目包含空格，则必须用引号括起该项目</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 describe-spot-price-history --instance-types m1.xlarge m1.medium</span><br></pre></td></tr></table></figure></li><li><p>整数参数<br>同样很好理解</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 describe-spot-price-history --max-items 5</span><br></pre></td></tr></table></figure></li><li><p>二进制参数<br>简单来说二进制参数就是一个非文本和数字类型的参数，例如，图片，音频和视频</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws s3api put-object --bucket my-bucket --key testimage.png --body /tmp/image.png</span><br></pre></td></tr></table></figure></li><li><p>映射参数<br>映射参数通常比较复杂，像这样</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ aws dynamodb get-item --table-name my-table --key &apos;&#123;&quot;id&quot;: &#123;&quot;N&quot;:&quot;1&quot;&#125;&#125;&apos;</span><br><span class="line"></span><br><span class="line">$ aws ec2 run-instances \</span><br><span class="line">    --image-id ami-12345678 \</span><br><span class="line">    --block-device-mappings &apos;[&#123;&quot;DeviceName&quot;:&quot;/dev/sdb&quot;,&quot;Ebs&quot;:&#123;&quot;VolumeSize&quot;:20,&quot;DeleteOnTermination&quot;:false,&quot;VolumeType&quot;:&quot;standard&quot;&#125;&#125;]&apos;</span><br></pre></td></tr></table></figure></li><li><p>文件参数<br>使用文件参数加载参数值有时候会很有用，例如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws sqs create-queue --queue-name my-queue --attributes file://attributes.json</span><br></pre></td></tr></table></figure><p><code>attributes.json</code>文件内容为，在文件中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;RedrivePolicy&quot;: &quot;&#123;\&quot;deadLetterTargetArn\&quot;:\&quot;arn:aws-cn:sqs:us-west-2:0123456789012:deadletter\&quot;, \&quot;maxReceiveCount\&quot;:\&quot;5\&quot;&#125;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>文件参数还包括远程文件和二进制文件，具体看这：<a href="https://docs.amazonaws.cn/cli/latest/userguide/cli-usage-parameters-file.html" target="_blank" rel="noopener">https://docs.amazonaws.cn/cli/latest/userguide/cli-usage-parameters-file.html</a></p></li></ol><h3 id="控制命令输出"><a href="#控制命令输出" class="headerlink" title="控制命令输出"></a>控制命令输出</h3><p>前面说了CLI大致有四种输出<code>json</code>，<code>yaml</code>，<code>text</code>和<code>table</code>，并且可以通过配置文件<code>~/.aws/config</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[default]</span><br><span class="line">output=text</span><br></pre></td></tr></table></figure><p>环境变量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ export AWS_DEFAULT_OUTPUT=&quot;table&quot;</span><br></pre></td></tr></table></figure><p>以及CLI<code>--output</code>选项进行配置，其中CLI的优先级最高</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws swf list-domains --registration-status REGISTERED --output json</span><br></pre></td></tr></table></figure><p>使用<code>json</code>输出时，可以考虑使用 <code>jq</code>进行高级筛选，这是一个命令行 <code>JSON</code> 处理器。可以通过 <a href="http://mikefarah.github.io/jq/" target="_blank" rel="noopener">http://mikefarah.github.io/jq/</a> 下载它并查找文档。</p><p>使用<code>yaml</code>输出时，可以考虑使用 <code>yq</code>进行高级筛选，这是一个命令行 <code>YAML</code> 处理器。可以通过 <a href="http://mikefarah.github.io/yq/" target="_blank" rel="noopener">http://mikefarah.github.io/yq/</a> 下载它并查找文档。</p><p>使用<code>text</code>输出时，强烈建议使用<code>--query</code>，脚本中本人最常用的输出格式，因为不用额外安装 <code>jq</code> 或 <code>yq</code></p><p>使用<code>table</code>输出时，也是和<code>--query</code>结合使用，最便于认为阅读，不适合脚本中使用</p><h3 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h3><p>AWS CLI 使用的凭证存储在纯文本文件中，并且<code>不加密</code>。</p><ul><li>$HOME/.aws/credentials 文件存储访问 AWS 资源所需的长期凭证。这包括访问密钥 ID 和秘密访问密钥。</li><li>短期凭证（例如承担的角色或用于 AWS Single Sign-On 服务的角色的凭证）也分别存储在 $HOME/.aws/cli/cache 和 $HOME/.aws/sso/cache 文件夹中。</li></ul><p>强烈建议您在 $HOME/.aws 文件夹及其子文件夹和文件上配置文件系统权限，仅限授权用户访问。<br>尽可能使用具有临时凭证的角色，以减少凭证泄露时造成损坏的机会。仅使用长期凭证来请求和刷新短期角色凭证。</p><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><ol><li><p>系统时间与实际时间不匹配导致验证不通过,需要调整系统时间</p></li><li><p>~/.aws/credential 文件中格式不正确或者包含错误的字符串.需要生成格式正确的<code>credential</code>文件</p></li></ol><p>以上完全基于<a href="https://docs.aws.amazon.com/" target="_blank" rel="noopener">AWS官方文档</a>，并结合自身理解创作</p><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> CLI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS CLI </tag>
            
            <tag> AWS CLI基础入门 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AWS CLI(1)安装和配置</title>
      <link href="2020/11/16/AWS/CLI/AWS-CLI-1-%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE/"/>
      <url>2020/11/16/AWS/CLI/AWS-CLI-1-%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>描述: AWS CLI安装和配置</p><a id="more"></a><p>到文章发布AWS CLI有两个版本，V1和V2. V2中添加很多修改，具体看这里:<br> <a href="https://docs.amazonaws.cn/cli/latest/userguide/cliv2-migration.html" target="_blank" rel="noopener">https://docs.amazonaws.cn/cli/latest/userguide/cliv2-migration.html</a></p><p><strong>默认情况下，AWS CLI 版本 2 会对所有输出使用分页程序,在Linux 和 macOS 上是 <code>less</code> 程序</strong></p><p>如果不想使用分页程序或者换成其他分页程序，可以配置 <code>AWS_PAGER</code> 环境变量或者在<code>~/.aws/config</code>文件中添加<code>cli_pager</code>。设置为空则表示不使用分页。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ export AWS_PAGER=&quot;&quot;</span><br><span class="line"></span><br><span class="line">$ aws configure set cli_pager &apos;&apos;</span><br><span class="line"></span><br><span class="line">$ cat ~/.aws/config</span><br><span class="line">[default]</span><br><span class="line">cli_pager=</span><br></pre></td></tr></table></figure><p>所以下面我们直接安装V2版本，推荐用官方的方式安装，由于 AWS 不维护第三方存储库，因此不能保证它们包含最新版本的 AWS CLI。</p><h2 id="CLI-安装更新和删除"><a href="#CLI-安装更新和删除" class="headerlink" title="CLI 安装更新和删除"></a>CLI 安装更新和删除</h2><h3 id="Linux安装"><a href="#Linux安装" class="headerlink" title="Linux安装"></a>Linux安装</h3><figure class="highlight plain"><figcaption><span>X86</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 下载最新版本</span><br><span class="line">$ curl &quot;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip&quot; -o &quot;awscliv2.zip&quot;</span><br><span class="line"></span><br><span class="line"># 下载指定版本，例如版本 2.0.30</span><br><span class="line"># $ curl &quot;https://awscli.amazonaws.com/awscli-exe-linux-x86_64-2.0.30.zip&quot; -o &quot;awscliv2.zip&quot;</span><br><span class="line"></span><br><span class="line"># 解压</span><br><span class="line">$ unzip awscliv2.zip</span><br><span class="line"></span><br><span class="line"># 安装至指定路径</span><br><span class="line"># -i – 此选项指定要将所有文件复制到的目录，程序实际所在路径，默认值为 /usr/local/aws-cli</span><br><span class="line"># -b – 此选项指定安装目录中的主 aws 程序通过符号链接指向指定路径中的 aws 文件，默认值为 /usr/local/bin，所以无需再将安装目录添加到用户的 $PATH 变量中</span><br><span class="line">$ sudo ./aws/install -i /usr/local/aws-cli -b /usr/local/bin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 验证安装</span><br><span class="line">$ aws --version</span><br><span class="line">aws-cli/2.0.47 Python/3.7.4 Linux/4.14.133-113.105.amzn2.x86_64 botocore/2.0.0</span><br></pre></td></tr></table></figure><p>版本列表: <a href="https://github.com/aws/aws-cli/blob/v2/CHANGELOG.rst" target="_blank" rel="noopener">https://github.com/aws/aws-cli/blob/v2/CHANGELOG.rst</a></p><h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><p>更新其实就是用新文件覆盖旧文件,和安装基本一致</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 下载最新版本</span><br><span class="line">$ curl &quot;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip&quot; -o &quot;awscliv2.zip&quot;</span><br><span class="line"></span><br><span class="line"># 解压</span><br><span class="line">$ unzip awscliv2.zip</span><br><span class="line"></span><br><span class="line"># 使用 which 命令查找符号链接</span><br><span class="line">$ which aws</span><br><span class="line">/usr/local/bin/aws</span><br><span class="line"></span><br><span class="line"># 使用 ls 命令查找符号链接指向的目录</span><br><span class="line">$ ls -l /usr/local/bin/aws</span><br><span class="line">lrwxrwxrwx 1 ec2-user ec2-user 49 Oct 22 09:49 /usr/local/bin/aws -&gt; /usr/local/aws-cli/v2/current/bin/aws</span><br><span class="line"></span><br><span class="line"># 使用带有 --update 参数的 install 命令。</span><br><span class="line"># --bin-dir - which命令返回的目录</span><br><span class="line"># --install-dir - ls显示的链接的实际路径</span><br><span class="line">$ sudo ./aws/install --bin-dir /usr/local/bin --install-dir /usr/local/aws-cli --update</span><br></pre></td></tr></table></figure><h3 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h3><p>卸载其实就是删除相关文件和链接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 首先使用 which 命令查找符号链接</span><br><span class="line">$ which aws</span><br><span class="line">/usr/local/bin/aws</span><br><span class="line"></span><br><span class="line"># 使用 ls 命令查找符号链接指向的目录</span><br><span class="line">$ ls -l /usr/local/bin/aws</span><br><span class="line">lrwxrwxrwx 1 ec2-user ec2-user 49 Oct 22 09:49 /usr/local/bin/aws -&gt; /usr/local/aws-cli/v2/current/bin/aws</span><br><span class="line"></span><br><span class="line"># 最后删除链接和目录</span><br><span class="line">$ sudo rm /usr/local/bin/aws</span><br><span class="line">$ sudo rm /usr/local/bin/aws_completer</span><br><span class="line">$ sudo rm -rf /usr/local/aws-cli</span><br></pre></td></tr></table></figure><p>其他系统安装方式可以参考官方文档，官方文档： <a href="https://docs.amazonaws.cn/cli/latest/userguide/install-cliv2-linux.html" target="_blank" rel="noopener">https://docs.amazonaws.cn/cli/latest/userguide/install-cliv2-linux.html</a></p><h2 id="配置CLI"><a href="#配置CLI" class="headerlink" title="配置CLI"></a>配置CLI</h2><h3 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h3><ol><li><p>默认配置命令 <code>aws configure</code> </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 创建默认名称为default的配置文件</span><br><span class="line">$ aws configure</span><br><span class="line">AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE</span><br><span class="line">AWS Secret Access Key [None]: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br><span class="line">Default region name [None]: us-west-2</span><br><span class="line">Default output format [None]: json</span><br><span class="line"></span><br><span class="line"># 创建名为 produser的配置文件</span><br><span class="line">$ aws configure --profile produser</span><br></pre></td></tr></table></figure><ul><li>AWS Access Key ID：源于IAM创建的访问密钥</li><li>AWS Secret Access Key：源于IAM创建的访问密钥</li><li>Region：运行CLI命令时，命令发送的区域，取决于服务部署在哪个Region</li><li>Output：输出格式</li></ul><p>CLI 为使用 <code>aws configure</code> 配置的默认配置文件生成的文件看起来类似于以下内容。</p><p><code>~/.aws/credentials</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[default]</span><br><span class="line">aws_access_key_id=AKIAIOSFODNN7EXAMPLE</span><br><span class="line">aws_secret_access_key=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</span><br></pre></td></tr></table></figure><p><code>~/.aws/config</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[default]</span><br><span class="line">region=us-east-1</span><br><span class="line">output=json</span><br></pre></td></tr></table></figure></li><li><p>使用<code>configure</code>的 <code>set</code>, <code>get</code> 和 <code>list</code>, <code>list-profiles</code> 子命令:<br>进行单独配置，对于<code>assume role</code>操作很有用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 使用set配置</span><br><span class="line">$ aws configure set aws_access_key_id AKIAIOSFODNN7EXAMPLE --profile example</span><br><span class="line">$ aws configure set aws_secret_access_key wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY --profile example</span><br><span class="line">$ aws configure set region us-east-1 --profile example</span><br><span class="line">$ aws configure set aws_access_key_id AKIAIOSFODNN7EXAMPLE --profile example</span><br><span class="line"></span><br><span class="line"># 使用get获取</span><br><span class="line">$ aws configure get aws_access_key_id --profile example</span><br><span class="line">AKIAIOSFODNN7EXAMPLE</span><br><span class="line"></span><br><span class="line"># 使用lit获取</span><br><span class="line">$ aws configure get aws_access_key_id --profile example</span><br><span class="line">      Name                    Value             Type    Location</span><br><span class="line">      ----                    -----             ----    --------</span><br><span class="line">  profile                  example           manual    --profile</span><br><span class="line">access_key     ****************MPLE shared-credentials-file    </span><br><span class="line">secret_key     ****************EKEY shared-credentials-file    </span><br><span class="line">    region                us-east-1      config-file    ~/.aws/config</span><br><span class="line"></span><br><span class="line"># 查看当前的profile</span><br><span class="line">$ aws configure list-profiles</span><br><span class="line">default</span><br><span class="line">example</span><br></pre></td></tr></table></figure><p><code>assume role</code>举例</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">KST=($(aws sts assume-role \</span><br><span class="line">--role-arn &quot;arn:aws:iam::$&#123;AWSAccount&#125;:role/$&#123;RoleName&#125;&quot; \</span><br><span class="line">--role-session-name &quot;role-session&quot; \</span><br><span class="line">--query &apos;Credentials.[AccessKeyId,SecretAccessKey,SessionToken]&apos; \</span><br><span class="line">--profile &apos;bot-aws-profile&apos; \</span><br><span class="line">--output text))</span><br><span class="line"></span><br><span class="line">echo &quot;Setting AWS configs:&quot;</span><br><span class="line">aws configure set aws_access_key_id &quot;$&#123;KST[0]&#125;&quot; --profile role-profile</span><br><span class="line">aws configure set aws_secret_access_key &quot;$&#123;KST[1]&#125;&quot; --profile role-profile</span><br><span class="line">aws configure set aws_session_token &quot;$&#123;KST[2]&#125;&quot; --profile role-profile</span><br><span class="line">aws configure set region &quot;$&#123;REGION&#125;&quot; --profile role-profile</span><br></pre></td></tr></table></figure></li><li><p><code>import</code></p><p>这是最方便的方式，当需要配置本机CLI时，大概率你手里已经有了credentials.csv文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws configure import –-csv file://./credentials.csv</span><br></pre></td></tr></table></figure></li></ol><h3 id="配置设置"><a href="#配置设置" class="headerlink" title="配置设置"></a>配置设置</h3><p>config文件支持大量的字段,下面介绍一些常用的：</p><ul><li>cli_pager<br>分页功能，仅适用于 AWS CLI 版本 2，可以被 AWS_PAGER 环境变量覆盖</li><li>duration_seconds<br>指定角色会话的最大持续时间（以秒为单位），默认为3600秒</li><li>max_attempts<br>指定 AWS CLI 重试处理程序使用的最大重试次数值，其中初始调用计入您提供的 max_attempts 值。可以使用 AWS_MAX_ATTEMPTS 环境变量覆盖此值。</li><li>output<br>CLI命令的输出格式<ul><li>json – 输出采用 JSON 字符串的格式。</li><li>yaml – 输出采用 YAML 字符串的格式。（仅在 AWS CLI 版本 2 中可用。）</li><li>yaml-stream – 输出被流式处理并采用 YAML 字符串的格式。流式处理支持更快地处理大型数据类型。（仅在 AWS CLI 版本 2 中可用。）</li><li>text – 输出采用多个制表符分隔字符串值行的格式。这对于将输出传递到文本处理器（如 grep、sed 或 awk）很有用。</li><li>table – 输出采用表格形式，使用字符 +|- 以形成单元格边框。它通常以“人性化”格式呈现信息，这种格式比其他格式更容易阅读，但从编程方面来讲不是那么有用。</li></ul></li><li>region<br>对于使用该配置文件请求的命令，指定要将请求发送到的 AWS 区域</li><li>role_arn<br>指定要用于运行 AWS CLI 命令的 IAM 角色的 Amazon 资源名称 (ARN)。此外，还必须指定以下参数之一以标识有权代入此角色的凭证：<ul><li>source_profile</li><li>credential_source</li></ul></li><li>source_profile<br>指定包含长期凭证的命名配置文件，AWS CLI 可使用这些凭证代入通过 role_arn 参数指定的角色。不能在同一配置文件中同时指定 source_profile 和 credential_source。</li><li>credential_source<br>在 Amazon EC2 实例或 EC2 容器中使用，指定 AWS CLI 在何处可以找到要用于代入通过 role_arn 参数指定的角色的凭证。不能在同一配置文件中同时指定 source_profile 和 credential_source。<br>此参数具有三个值：<ul><li>Environment – 指定 AWS CLI 从环境变量检索源凭证。</li><li>Ec2InstanceMetadata – 指定 AWS CLI 将使用附加到 EC2 实例配置文件的 IAM 角色以获取源凭证。</li><li>EcsContainer – 指定 AWS CLI 将附加到 ECS 容器的 IAM 角色用作源凭证。</li></ul></li><li>retry_mode<br>重试操作，有三种类型传统重试模式（legacy），标准重试模式（standard）和自适应重试模式（adaptive）<br>传统模式：AWS CLI 版本 1 使用的默认模式，重试4次，总共可发出 5 次调用尝试。<br>标准模式：AWS CLI 版本 2 使用的默认模式，最大重试次数的默认值为 2，总共可发出 3 次调用尝试。多了一些报错代码。<br>自适应模式：自适应模式是一种试验模式，AWSCLI会自己根据情况改变重试次数</li><li>max_attempts<br>最大重试次数</li></ul><h3 id="config中的s3设置"><a href="#config中的s3设置" class="headerlink" title="config中的s3设置"></a>config中的s3设置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[profile development]</span><br><span class="line">s3 =</span><br><span class="line">  max_concurrent_requests = 20</span><br><span class="line">  max_queue_size = 10000</span><br><span class="line">  multipart_threshold = 64MB</span><br><span class="line">  multipart_chunksize = 16MB</span><br><span class="line">  max_bandwidth = 50MB/s</span><br><span class="line">  use_accelerate_endpoint = true</span><br><span class="line">  addressing_style = path</span><br></pre></td></tr></table></figure><p>具体信息：<a href="https://docs.amazonaws.cn/cli/latest/userguide/cli-configure-files.html#cli-configure-files-where" target="_blank" rel="noopener">https://docs.amazonaws.cn/cli/latest/userguide/cli-configure-files.html#cli-configure-files-where</a></p><h3 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h3><p>AWS CLI 凭证和配置设置的优先顺序如下：</p><ol><li>命令行选项 – 覆盖任何其他位置的设置。可以在命令行上指定 –region、–output 和 –profile 作为参数。</li><li>环境变量 – 您可以在系统的环境变量中存储值。 环境变量参考：<a href="https://docs.amazonaws.cn/cli/latest/userguide/cli-configure-envvars.html" target="_blank" rel="noopener">https://docs.amazonaws.cn/cli/latest/userguide/cli-configure-envvars.html</a></li><li>CLI 凭证文件 – credentials 文件。credentials 文件位于 ~/.aws/credentials（在 Linux 或 macOS 上）或 C:\Users\USERNAME.aws\credentials（在 Windows 上）。该文件可以包含 default 配置文件和任何命名配置文件的<code>凭证详细信息</code>。</li><li>CLI 配置文件 – config 文件。config 文件位于 ~/.aws/config（在 Linux 或 macOS 上）或 C:\Users\USERNAME.aws\config（在 Windows 上）。该文件包含默认配置文件和任何命名配置文件的<code>配置设置</code>。</li><li>容器凭证 – ECS的IAM role</li><li>实例配置文件凭证 – EC2的IAM role</li></ol><h2 id="CLI常用命令行选项"><a href="#CLI常用命令行选项" class="headerlink" title="CLI常用命令行选项"></a>CLI常用命令行选项</h2><ol><li><p><strong>–profile</strong></p><p>最常用的选项没有之一，当你具有多个配置文件时，用于让AWS命令运行在不同配置下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws --profile dev servicename commandname options</span><br></pre></td></tr></table></figure></li><li><p><strong>–region</strong><br>一般般，当你的资源在同一个AWS账号下但是不在同一个region时，在不同region之间控制资源需要用到。</p></li><li><p><strong>–output &lt;json|yaml|text|table&gt;</strong><br>比较常用，尤其是编程时与<code>--query</code>结合</p></li><li><p><strong>–query <string></string></strong><br>比较常用，尤其是编程时与<code>--output</code>结合</p></li><li><p><strong>–debug</strong><br>不算常用，但是在CLI出现意料之外的情况时很有用。通常可以将错误输出到错误日志。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ aws servicename commandname options --debug 2&gt; debug.txt</span><br></pre></td></tr></table></figure></li><li><p><strong>–generate-cli-skeleton</strong><br>不常用，至少我自己没用过。它可以帮你生成CLI命令的模版,模版中包括该命令的所有参数，你可以修改这个模版，删除你不需要的参数，然后填上你需要的参数。<br>最后运行CLI命令时使用<code>--cli-input-yaml</code>选项，就可以自动将你的参数带入命令中。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ aws ec2 run-instances --generate-cli-skeleton yaml-input &gt; ec2runinst.yaml</span><br><span class="line">$ vim ec2runinst.yaml</span><br><span class="line">DryRun: true</span><br><span class="line">ImageId: &apos;ami-dfc39aef&apos;</span><br><span class="line">KeyName: &apos;mykey&apos;</span><br><span class="line">SecurityGroups:</span><br><span class="line">- &apos;my-sg&apos;</span><br><span class="line">InstanceType: &apos;t2.micro&apos;</span><br><span class="line">Monitoring: </span><br><span class="line">  Enabled: true</span><br><span class="line">$ aws ec2 run-instances --cli-input-yaml file://ec2runinst.yaml</span><br></pre></td></tr></table></figure></li></ol><h2 id="返场："><a href="#返场：" class="headerlink" title="返场："></a>返场：</h2><ol><li><p>设置AWS自动补全</p><p>通常AWS安装后会有自动补全功能如果没有，首先找到AWS的命令补全程序的位置(通常和<code>aws</code>在同一目录下)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ which aws_completer</span><br><span class="line">/usr/local/bin/aws_completer</span><br></pre></td></tr></table></figure><p><code>/usr/local/bin</code>已经在我的$PATH,如果路径不在<code>$PATH</code>需要在<code>~/.bash_profile</code>文件末尾中添加这一行，并应用生效<code>source ~/.bash_profile</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=/other/path/folder:$PATH</span><br></pre></td></tr></table></figure><p>最后<code>bash</code>使用内置命令 <code>complete</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ complete -C &apos;/usr/local/aws/bin/aws_completer&apos; aws</span><br></pre></td></tr></table></figure><p><a href="https://docs.amazonaws.cn/cli/latest/userguide/cli-configure-completion.html" target="_blank" rel="noopener">https://docs.amazonaws.cn/cli/latest/userguide/cli-configure-completion.html</a></p></li></ol><p>以上完全基于<a href="https://docs.aws.amazon.com/" target="_blank" rel="noopener">AWS官方文档</a>，并结合自身理解创作</p><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> CLI </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS CLI </tag>
            
            <tag> AWS CLI基础入门 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AWS S3-CLI</title>
      <link href="2020/11/14/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/S3/AWS-S3-3-CLI/"/>
      <url>2020/11/14/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/S3/AWS-S3-3-CLI/</url>
      
        <content type="html"><![CDATA[<p>描述: AWS S3 常用CLI</p><a id="more"></a><!-- TOC --><ul><li><a href="#s3高级命令">S3高级命令</a></li><li><a href="#存储桶cli">存储桶CLI</a><ul><li><a href="#查找规范用户id">查找规范用户ID</a></li><li><a href="#删除存储桶">删除存储桶</a></li><li><a href="#清空存储桶">清空存储桶</a></li><li><a href="#获取存储桶状态">获取存储桶状态</a></li><li><a href="#启用和停止transfer-acceleration">启用和停止Transfer Acceleration</a></li><li><a href="#将存储桶内的对象批量加密">将存储桶内的对象批量加密</a></li><li><a href="#上传生命周期配置">上传生命周期配置</a><ul><li><a href="#该操作针对当前版本所以对象总共存在10年一年标准存储九年glacier存储"><strong>该操作针对当前版本所以对象总共存在10年,一年标准存储,九年Glacier存储</strong></a></li><li><a href="#带有版本控制的生命周期配置">带有版本控制的生命周期配置</a></li><li><a href="#带前缀及标签的生命周期配置">带前缀及标签的生命周期配置</a></li></ul></li><li><a href="#获取存储桶生命周期配置">获取存储桶生命周期配置</a></li><li><a href="#删除存储桶生命周期配置">删除存储桶生命周期配置</a></li></ul></li><li><a href="#对象cli">对象CLI</a><ul><li><a href="#上传对象">上传对象</a></li><li><a href="#修改对象acl">修改对象ACL</a></li><li><a href="#分段上传">分段上传</a></li><li><a href="#列出存储桶中未完成的分段上传">列出存储桶中未完成的分段上传</a></li><li><a href="#删除未完成的分段上传">删除未完成的分段上传</a></li><li><a href="#列出对象">列出对象</a></li><li><a href="#复制对象">复制对象</a></li><li><a href="#下载对象">下载对象</a></li><li><a href="#删除对象">删除对象</a></li><li><a href="#生成预签名对象">生成预签名对象</a></li><li><a href="#删除对象-1">删除对象</a></li></ul></li><li><a href="#访问点cli">访问点CLI</a><ul><li><a href="#创建访问点">创建访问点</a></li><li><a href="#查看访问点">查看访问点</a></li><li><a href="#通过访问点获取对象">通过访问点获取对象</a></li><li><a href="#通过访问点上传对象">通过访问点上传对象</a></li><li><a href="#通过访问点删除对象">通过访问点删除对象</a></li><li><a href="#通过访问点列出对象">通过访问点列出对象</a></li><li><a href="#通过访问点向对象添加标签集">通过访问点向对象添加标签集</a></li><li><a href="#使用-acl-通过访问点授予访问权限">使用 ACL 通过访问点授予访问权限</a></li></ul></li></ul><!-- /TOC --><h3 id="S3高级命令"><a href="#S3高级命令" class="headerlink" title="S3高级命令"></a>S3高级命令</h3><ul><li><a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3/cp.html" target="_blank" rel="noopener"><code>cp</code></a> </li><li><a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3/ls.html" target="_blank" rel="noopener"><code>ls</code></a></li><li><a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3/mb.html" target="_blank" rel="noopener"><code>mb</code></a></li><li><a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3/mv.html" target="_blank" rel="noopener"><code>mv</code></a></li><li><a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3/presign.html" target="_blank" rel="noopener"><code>presign</code></a></li><li><a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3/rb.html" target="_blank" rel="noopener"><code>rb</code></a></li><li><a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3/rm.html" target="_blank" rel="noopener"><code>rm</code></a></li><li><a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3/sync.html" target="_blank" rel="noopener"><code>sync</code></a></li><li><a href="https://awscli.amazonaws.com/v2/documentation/api/latest/reference/s3/website.html" target="_blank" rel="noopener"><code>website</code></a></li></ul><h3 id="存储桶CLI"><a href="#存储桶CLI" class="headerlink" title="存储桶CLI"></a>存储桶CLI</h3><h4 id="查找规范用户ID"><a href="#查找规范用户ID" class="headerlink" title="查找规范用户ID"></a>查找规范用户ID</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api list-buckets --query Owner.ID --output text</span><br></pre></td></tr></table></figure><p><a href="https://docs.aws.amazon.com/zh_cn/general/latest/gr/acct-identifiers.html#FindingCanonicalId" target="_blank" rel="noopener">AWS账户标识符</a></p><h4 id="删除存储桶"><a href="#删除存储桶" class="headerlink" title="删除存储桶"></a>删除存储桶</h4><p>如果存储桶未启用版本控制，则可将 rb(删除存储桶) AWS CLI 命令与 <code>--force</code> 参数结合使用来删除非空存储桶。此命令将先删除所有对象，然后再删除存储桶。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3 rb s3://bucket-name --force</span><br></pre></td></tr></table></figure><h4 id="清空存储桶"><a href="#清空存储桶" class="headerlink" title="清空存储桶"></a>清空存储桶</h4><p>如果存储桶未启用版本控制，可以将 rm(删除) AWS CLI 命令与 <code>--recursive</code> 参数结合使用来清空存储桶 (或删除部分带特定键名前缀的对象)。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 以下 rm 命令将删除带键名前缀 doc 的对象，例如，doc/doc1 和 doc/doc2。</span><br><span class="line"><span class="meta">$</span> aws s3 rm s3://bucket-name/doc --recursive</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 使用以下命令删除所有对象，而无需指定前缀。</span><br><span class="line"><span class="meta">$</span> aws s3 rm s3://bucket-name --recursive</span><br></pre></td></tr></table></figure><h4 id="获取存储桶状态"><a href="#获取存储桶状态" class="headerlink" title="获取存储桶状态"></a>获取存储桶状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api get-bucket-policy --bucket DOC-EXAMPLE-BUCKET1 --expected-bucket-owner 111122223333</span><br></pre></td></tr></table></figure><h4 id="启用和停止Transfer-Acceleration"><a href="#启用和停止Transfer-Acceleration" class="headerlink" title="启用和停止Transfer Acceleration"></a>启用和停止Transfer Acceleration</h4><p>下示例设置 <code>Status=Enabled</code> 以对存储桶启用 Transfer Acceleration。可使用 <code>Status=Suspended</code> 暂停 Transfer Acceleration</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api put-bucket-accelerate-configuration --bucket bucketname --accelerate-configuration Status=Enabled</span><br></pre></td></tr></table></figure><h4 id="将存储桶内的对象批量加密"><a href="#将存储桶内的对象批量加密" class="headerlink" title="将存储桶内的对象批量加密"></a>将存储桶内的对象批量加密</h4><p>批量加密要注意的问题:</p><ol><li>LastModified时间戳会改变</li><li>如果在PUT或COPY事件上启用leS3事件通知，在复制现有对象以对其进行加密时会触发S3事件通知</li><li>访问控制列表（ACL）重置为S3存储桶默认值。如果使用对象ACL，则必须在复制操作中添加它们</li><li>元数据和标签,CLI_V2支持元数据和标签的复制,V1不支持</li><li>存储类默认为“标准”。</li><li>在启用了版本控制的存储桶中，此过程将创建加密对象的新版本，但不会修改现有的未加密对象版本</li><li>如果使用了对象锁定，则保留期限将重置为存储桶默认值。</li><li>S3 ETag可能会更改。<ul><li>分段上传对象：如果与原始分段上传相比，副本使用不同的分段大小，则ETag会更改。</li><li>如果复制时与原对象不同的加密密钥对对象进行加密，则该对象将不会具有与之前相同的ETag <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3 cp s3://mybucket/ s3://mybucket/ --recursive --sse aws:kms --sse-kms-key-id arn:aws:kms:us-east-1:123456789012:alias/mykey</span><br></pre></td></tr></table></figure></li></ul></li></ol><h4 id="上传生命周期配置"><a href="#上传生命周期配置" class="headerlink" title="上传生命周期配置"></a>上传生命周期配置</h4><p>本地需要一个lifecycle.json 文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aws s3api put-bucket-lifecycle-configuration  \</span><br><span class="line">--bucket bucketname  \</span><br><span class="line">--lifecycle-configuration file://lifecycle.json</span><br></pre></td></tr></table></figure><p><a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/lifecycle-configuration-examples.html" target="_blank" rel="noopener">生命周期示例</a></p><details><summary>  <strong>示例 1：指定筛选条件</strong></summary>在此生命周期配置规则中，筛选条件指定了一个键前缀 (documents/)。因此，此规则应用于带键名前缀 documents/ 的对象，例如 documents/doc1.txt 和 documents/doc2.txt。<p>此规则指定两个引导 Amazon S3 完成以下任务的操作：</p><ul><li>在对象创建 365 天（一年）后将其转换为 S3 Glacier 存储类别。</li><li>在对象创建 3650 天（10 年）后将其删除（Expiration 操作）。</li></ul><h5 id="该操作针对当前版本所以对象总共存在10年-一年标准存储-九年Glacier存储"><a href="#该操作针对当前版本所以对象总共存在10年-一年标准存储-九年Glacier存储" class="headerlink" title="该操作针对当前版本所以对象总共存在10年,一年标准存储,九年Glacier存储"></a><strong>该操作针对当前版本所以对象总共存在10年,一年标准存储,九年Glacier存储</strong></h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Rules"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Filter"</span>: &#123;</span><br><span class="line">                <span class="attr">"Prefix"</span>: <span class="string">"documents/"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"Status"</span>: <span class="string">"Enabled"</span>,</span><br><span class="line">            <span class="attr">"Transitions"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"Days"</span>: <span class="number">365</span>,</span><br><span class="line">                    <span class="attr">"StorageClass"</span>: <span class="string">"GLACIER"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"Expiration"</span>: &#123;</span><br><span class="line">                <span class="attr">"Days"</span>: <span class="number">3650</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"ID"</span>: <span class="string">"ExampleRule"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="带有版本控制的生命周期配置"><a href="#带有版本控制的生命周期配置" class="headerlink" title="带有版本控制的生命周期配置"></a>带有版本控制的生命周期配置</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Rules"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"ID"</span>: <span class="string">"ExampleRule"</span>,</span><br><span class="line">            <span class="attr">"Filter"</span>: &#123;</span><br><span class="line">                <span class="attr">"Prefix"</span>: <span class="string">"documents/"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"Status"</span>: <span class="string">"Enabled"</span>,</span><br><span class="line">            <span class="attr">"Transition"</span>: &#123;</span><br><span class="line">                <span class="attr">"Days"</span>: <span class="number">30</span>,</span><br><span class="line">                <span class="attr">"StorageClass"</span>: <span class="string">"STANDARD_IA"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"NoncurrentVersionTransitions"</span>: &#123;</span><br><span class="line">              <span class="attr">"NoncurrentDays"</span>: <span class="number">90</span>,</span><br><span class="line">              <span class="attr">"StorageClass"</span>: <span class="string">"GLACIER"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"NoncurrentVersionExpiration"</span>: &#123;</span><br><span class="line">                <span class="attr">"NoncurrentDays"</span>: <span class="number">3650</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="带前缀及标签的生命周期配置"><a href="#带前缀及标签的生命周期配置" class="headerlink" title="带前缀及标签的生命周期配置"></a>带前缀及标签的生命周期配置</h5><p>在以下配置中，该规则指定了一个 Expiration 操作，以下示例代码将生命周期规则应用于带 tax/ 键前缀且包含具有特定两个键和值的对象。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Rules"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="attr">"Filter"</span>: &#123;</span><br><span class="line">              <span class="attr">"And"</span>: &#123;</span><br><span class="line">                  <span class="attr">"Prefix"</span>: <span class="string">"tax/"</span>,</span><br><span class="line">                  <span class="attr">"Tags"</span>: [</span><br><span class="line">                      &#123;</span><br><span class="line">                          <span class="attr">"Value"</span>: <span class="string">"mytagvalue1"</span>, </span><br><span class="line">                          <span class="attr">"Key"</span>: <span class="string">"mytagkey1"</span></span><br><span class="line">                      &#125;, </span><br><span class="line">                      &#123;</span><br><span class="line">                          <span class="attr">"Value"</span>: <span class="string">"mytagvalue2"</span>, </span><br><span class="line">                          <span class="attr">"Key"</span>: <span class="string">"mytagkey2"</span></span><br><span class="line">                      &#125;</span><br><span class="line">                  ]</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"Status"</span>: <span class="string">"Enabled"</span>,</span><br><span class="line">          <span class="attr">"Expiration"</span>: &#123;</span><br><span class="line">                  <span class="attr">"Days"</span>: <span class="number">1</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"ID"</span>: <span class="string">"ExampleRule"</span></span><br><span class="line">      &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在以下配置中，该规则指定了一个 Transition 操作，该操作指示 Amazon S3 在对象创建 0 天后将其转换为 S3 Glacier 存储类别，在这种情况下，对象都有资格在创建后的 UTC 时间午夜存档到 Amazon S3 Glacier</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Rules"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Filter"</span>: &#123;</span><br><span class="line">                <span class="attr">"Prefix"</span>: <span class="string">""</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"Status"</span>: <span class="string">"Enabled"</span>,</span><br><span class="line">            <span class="attr">"Transitions"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"Days"</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">"StorageClass"</span>: <span class="string">"GLACIER"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"ID"</span>: <span class="string">"ExampleRule"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><details><summary><strong>示例2: 多个规则</strong></summary><p>希望不同的对象有不同的生命周期操作，则可以指定多个规则。以下生命周期配置有两个规则：</p><ul><li>规则 1 应用于带键名前缀 classA/ 的对象。它指示 Amazon S3 在对象创建一年后将其转换为 S3 Glacier 存储类别，并在对象创建 10 年后使它们过期。</li><li>规则 2 应用于带键名前缀 classB/ 的对象。它指示 Amazon S3 在对象创建 90 天后将其转换为 S3 标准-IA 存储类，并在对象创建 1 年后将其删除。</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Rules"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="attr">"Filter"</span>: &#123;</span><br><span class="line">              <span class="attr">"Prefix"</span>: <span class="string">"ClassA/"</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"Status"</span>: <span class="string">"Enabled"</span>,</span><br><span class="line">          <span class="attr">"Transitions"</span>: &#123;</span><br><span class="line">              <span class="attr">"Days"</span>: <span class="number">365</span>,</span><br><span class="line">              <span class="attr">"StorageClass"</span>: <span class="string">"GLACIER"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"Expiration"</span>: &#123;</span><br><span class="line">              <span class="attr">"Days"</span>: <span class="number">3650</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"ID"</span>: <span class="string">"ClassADocRule"</span></span><br><span class="line">      &#125;,&#123;</span><br><span class="line">          <span class="attr">"Filter"</span>: &#123;</span><br><span class="line">              <span class="attr">"Prefix"</span>: <span class="string">"ClassB/"</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"Status"</span>: <span class="string">"Enabled"</span>,</span><br><span class="line">          <span class="attr">"Transitions"</span>: &#123;</span><br><span class="line">              <span class="attr">"Days"</span>: <span class="number">90</span>,</span><br><span class="line">              <span class="attr">"StorageClass"</span>: <span class="string">"STANDARD_IA"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"Expiration"</span>: &#123;</span><br><span class="line">              <span class="attr">"Days"</span>: <span class="number">365</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">"ID"</span>: <span class="string">"ClassBDocRule"</span></span><br><span class="line">      &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><details><summary><strong>JSON格式语法</strong></summary><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Rules"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Expiration"</span>: &#123;</span><br><span class="line">        <span class="attr">"Date"</span>: timestamp,</span><br><span class="line">        <span class="attr">"Days"</span>: integer,</span><br><span class="line">        <span class="attr">"ExpiredObjectDeleteMarker"</span>: <span class="literal">true</span>|<span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"ID"</span>: <span class="string">"string"</span>,</span><br><span class="line">      <span class="attr">"Prefix"</span>: <span class="string">"string"</span>,</span><br><span class="line">      <span class="attr">"Filter"</span>: &#123;</span><br><span class="line">        <span class="attr">"Prefix"</span>: <span class="string">"string"</span>,</span><br><span class="line">        <span class="attr">"Tag"</span>: &#123;</span><br><span class="line">          <span class="attr">"Key"</span>: <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"Value"</span>: <span class="string">"string"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"And"</span>: &#123;</span><br><span class="line">          <span class="attr">"Prefix"</span>: <span class="string">"string"</span>,</span><br><span class="line">          <span class="attr">"Tags"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="attr">"Key"</span>: <span class="string">"string"</span>,</span><br><span class="line">              <span class="attr">"Value"</span>: <span class="string">"string"</span></span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"Status"</span>: <span class="string">"Enabled"</span>|<span class="string">"Disabled"</span>,</span><br><span class="line">      <span class="attr">"Transitions"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"Date"</span>: timestamp,</span><br><span class="line">          <span class="attr">"Days"</span>: integer,</span><br><span class="line">          <span class="attr">"StorageClass"</span>: <span class="string">"GLACIER"</span>|<span class="string">"STANDARD_IA"</span>|<span class="string">"ONEZONE_IA"</span>|<span class="string">"INTELLIGENT_TIERING"</span>|<span class="string">"DEEP_ARCHIVE"</span></span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"NoncurrentVersionTransitions"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"NoncurrentDays"</span>: integer,</span><br><span class="line">          <span class="attr">"StorageClass"</span>: <span class="string">"GLACIER"</span>|<span class="string">"STANDARD_IA"</span>|<span class="string">"ONEZONE_IA"</span>|<span class="string">"INTELLIGENT_TIERING"</span>|<span class="string">"DEEP_ARCHIVE"</span></span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"NoncurrentVersionExpiration"</span>: &#123;</span><br><span class="line">        <span class="attr">"NoncurrentDays"</span>: integer</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"AbortIncompleteMultipartUpload"</span>: &#123;</span><br><span class="line">        <span class="attr">"DaysAfterInitiation"</span>: integer</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><h4 id="获取存储桶生命周期配置"><a href="#获取存储桶生命周期配置" class="headerlink" title="获取存储桶生命周期配置"></a>获取存储桶生命周期配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws s3api get-bucket-lifecycle-configuration  \</span><br><span class="line">--bucket bucketname</span><br></pre></td></tr></table></figure><h4 id="删除存储桶生命周期配置"><a href="#删除存储桶生命周期配置" class="headerlink" title="删除存储桶生命周期配置"></a>删除存储桶生命周期配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws s3api delete-bucket-lifecycle \</span><br><span class="line">--bucket bucketname</span><br></pre></td></tr></table></figure><h3 id="对象CLI"><a href="#对象CLI" class="headerlink" title="对象CLI"></a>对象CLI</h3><h4 id="上传对象"><a href="#上传对象" class="headerlink" title="上传对象"></a>上传对象</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">aws s3api put-object --bucket $&#123;mybucket&#125; --body ./local_file --key hello.html --acl public-read</span><br><span class="line">&#123;</span><br><span class="line">    "ETag": "\"e8f8ca569bda9ae941cc68013262abcd\"",</span><br><span class="line">    "VersionId": "D.HahJrVUGdK4D.RZ0Jn5lDbNRKeABCD"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">aws s3api put-object --body ./h1.html --key static/allowed/h.html --bucket karl-test-us --content-type text/plain --acl public-read</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 使用桶所有者条件以确保 DOC-EXAMPLE-BUCKET1 归 AWS 账户 111122223333.</span><br><span class="line">aws s3api put-object \</span><br><span class="line">  --bucket DOC-EXAMPLE-BUCKET1 --key exampleobject --body example_file.txt \</span><br><span class="line">  --expected-bucket-owner 111122223333</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 上传对象带标签</span><br><span class="line"></span><br><span class="line">aws s3api put-object --bucket mybucket --key tax/delete3 --body ./h1.html \</span><br><span class="line">--tagging "mytagkey1=mytagvalue1&amp;mytagkey2=mytagvalue2"</span><br></pre></td></tr></table></figure><h4 id="修改对象ACL"><a href="#修改对象ACL" class="headerlink" title="修改对象ACL"></a>修改对象ACL</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api put-object-acl --bucket DOC-EXAMPLE-BUCKET1 --key HappyFace.jpg --grant-full-control id="AccountA-CanonicalUserID" --profile AccountBadmin</span><br></pre></td></tr></table></figure><h4 id="分段上传"><a href="#分段上传" class="headerlink" title="分段上传"></a>分段上传</h4><p>AWS S3高级命令<code>s3 cp</code>、<code>s3 sync</code>以及<code>s3 mv</code>等都会自动执行分段操作 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 分段上传可配置S3相关命令</span><br><span class="line">aws configure set default.s3.max_concurrent_requests 60</span><br><span class="line">aws configure set default.s3.multipart_threshold 5GB</span><br><span class="line">aws configure set default.s3.multipart_chunksize 5GB</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> S3默认配置</span><br><span class="line">aws configure set default.s3.max_concurrent_requests 10</span><br><span class="line">aws configure set default.s3.multipart_threshold 8MB</span><br><span class="line">aws configure set default.s3.multipart_chunksize 8MB</span><br></pre></td></tr></table></figure><p>以下是分段上传的示例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 创建50M的文件</span><br><span class="line">dd if=/dev/zero of=test.file bs=1048576 count=50</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 获取md5值,以便在上传后执行完整性检查时作为参考</span><br><span class="line">md5 test.file</span><br><span class="line">MD5 (test.file) = 25e317773f308e446cc84c503a6d1f85</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 使用split分割为25M大小</span><br><span class="line">split -b 26214400 test.file test.file_</span><br><span class="line">test.file_aa test.file_ab </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 创建分段上传</span><br><span class="line">aws s3api create-multipart-upload --bucket mybucket --key test.file</span><br><span class="line">&#123;</span><br><span class="line">    "Bucket": "mybucket",</span><br><span class="line">    "Key": "test.file",</span><br><span class="line">    "UploadId": "B9e10l2zv9hb.jxutvVffxfnvLwhj_uAT9Qka2h8FlnttkDeZ09_ZLMV.2HHbvt54hxMmx.RkEC83c2zUFFvKXZaI.NcIwMr9gu7kih.ujS4dh3VQTim7QKbHHDZlbVxsv0pAAyb.rB8vzG2YQvAqHtGzlTr3HV2JiLCPYXg_Sc-"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 第一部分上传,后面重复操作,记得修改part-number和body参数, ETag需要保留,后面要用</span><br><span class="line">aws s3api upload-part --bucket mybucket --key test.file --part-number 1 --body test.file_aa --upload-id B9e10l2zv9hb.jxutvVffxfnvLwhj_uAT9Qka2h8FlnttkDeZ09_ZLMV.2HHbvt54hxMmx.RkEC83c2zUFFvKXZaI.NcIwMr9gu7kih.ujS4dh3VQTim7QKbHHDZlbVxsv0pAAyb.rB8vzG2YQvAqHtGzlTr3HV2JiLCPYXg_Sc-</span><br><span class="line">&#123;</span><br><span class="line">    "ETag": "\"bed3c0a4a1407f584989b4009e9ce33f\""</span><br><span class="line">&#125;</span><br><span class="line">aws s3api upload-part --bucket mybucket --key test.file --part-number 2 --body test.file_ab --upload-id B9e10l2zv9hb.jxutvVffxfnvLwhj_uAT9Qka2h8FlnttkDeZ09_ZLMV.2HHbvt54hxMmx.RkEC83c2zUFFvKXZaI.NcIwMr9gu7kih.ujS4dh3VQTim7QKbHHDZlbVxsv0pAAyb.rB8vzG2YQvAqHtGzlTr3HV2JiLCPYXg_Sc-</span><br><span class="line">&#123;</span><br><span class="line">    "ETag": "\"bed3c0a4a1407f584989b4009e9ce33f\""</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> list-parts</span><br><span class="line">aws s3api list-parts --bucket mybucket --key test.file --upload-id B9e10l2zv9hb.jxutvVffxfnvLwhj_uAT9Qka2h8FlnttkDeZ09_ZLMV.2HHbvt54hxMmx.RkEC83c2zUFFvKXZaI.NcIwMr9gu7kih.ujS4dh3VQTim7QKbHHDZlbVxsv0pAAyb.rB8vzG2YQvAqHtGzlTr3HV2JiLCPYXg_Sc-</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 用ETag编成ETag Json文件,可以从list-parts命令中获取,类似这个</span><br><span class="line">&#123;</span><br><span class="line">    "Parts": [</span><br><span class="line">        &#123;</span><br><span class="line">            "PartNumber": 1,</span><br><span class="line">            "ETag": "\"bed3c0a4a1407f584989b4009e9ce33f\""</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            "PartNumber": 2,</span><br><span class="line">            "ETag": "\"bed3c0a4a1407f584989b4009e9ce33f\""</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 完成分段</span><br><span class="line">aws s3api complete-multipart-upload --multipart-upload file://ETag.json --bucket mybucket --key test.file --upload-id B9e10l2zv9hb.jxutvVffxfnvLwhj_uAT9Qka2h8FlnttkDeZ09_ZLMV.2HHbvt54hxMmx.RkEC83c2zUFFvKXZaI.NcIwMr9gu7kih.ujS4dh3VQTim7QKbHHDZlbVxsv0pAAyb.rB8vzG2YQvAqHtGzlTr3HV2JiLCPYXg_Sc-</span><br></pre></td></tr></table></figure><h4 id="列出存储桶中未完成的分段上传"><a href="#列出存储桶中未完成的分段上传" class="headerlink" title="列出存储桶中未完成的分段上传"></a>列出存储桶中未完成的分段上传</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api list-multipart-uploads --bucket DOC-EXAMPLE-BUCKET</span><br></pre></td></tr></table></figure><h4 id="删除未完成的分段上传"><a href="#删除未完成的分段上传" class="headerlink" title="删除未完成的分段上传"></a>删除未完成的分段上传</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api abort-multipart-upload --bucket DOC-EXAMPLE-BUCKET --key large_test_file --upload-id examplevQpHp7eHc_J5s9U.kzM3GAHeOJh1P8wVTmRqEVojwiwu3wPX6fWYzADNtOHklJI6W6Q9NJUYgjePKCVpbl_rDP6mGIr2AQJNKB</span><br></pre></td></tr></table></figure><h4 id="列出对象"><a href="#列出对象" class="headerlink" title="列出对象"></a>列出对象</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 只列出目录</span><br><span class="line">aws s3 --profile int-xmn --region us-east-1 ls s3://karl-test-us/North\ America/USA/</span><br><span class="line">                           PRE A/</span><br><span class="line">                           PRE B/</span><br><span class="line">                           PRE C/</span><br><span class="line"></span><br><span class="line">aws s3api --profile int-xmn --region us-east-1 list-objects-v2 --bucket karl-test-us --prefix 'North America/USA/' --delimiter /</span><br><span class="line">&#123;</span><br><span class="line">    "CommonPrefixes": [</span><br><span class="line">        &#123;</span><br><span class="line">            "Prefix": "North America/USA/A/"</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            "Prefix": "North America/USA/B/"</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            "Prefix": "North America/USA/C/"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 列出对象</span><br><span class="line">aws s3 --profile int-xmn --region us-east-1 ls s3://karl-test-us/North\ America/USA/ --recursive</span><br><span class="line">2020-12-20 19:50:24          0 North America/USA/A/A/1.txt</span><br><span class="line">2020-12-20 19:50:24          0 North America/USA/B/A/1.txt</span><br><span class="line">2020-12-20 19:50:24          0 North America/USA/C/A/1.txt</span><br><span class="line"></span><br><span class="line">aws s3api --profile int-xmn --region us-east-1 list-objects-v2 --bucket karl-test-us --prefix 'North America/USA/'</span><br><span class="line">&#123;</span><br><span class="line">    "Contents": [</span><br><span class="line">        &#123;</span><br><span class="line">            "Key": "North America/USA/A/A/1.txt",</span><br><span class="line">            "LastModified": "2020-12-20T11:50:24+00:00",</span><br><span class="line">            "ETag": "\"d41d8cd98f00b204e9800998ecf8427e\"",</span><br><span class="line">            "Size": 0,</span><br><span class="line">            "StorageClass": "STANDARD"</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            "Key": "North America/USA/B/A/1.txt",</span><br><span class="line">            "LastModified": "2020-12-20T11:50:24+00:00",</span><br><span class="line">            "ETag": "\"d41d8cd98f00b204e9800998ecf8427e\"",</span><br><span class="line">            "Size": 0,</span><br><span class="line">            "StorageClass": "STANDARD"</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            "Key": "North America/USA/C/A/1.txt",</span><br><span class="line">            "LastModified": "2020-12-20T11:50:24+00:00",</span><br><span class="line">            "ETag": "\"d41d8cd98f00b204e9800998ecf8427e\"",</span><br><span class="line">            "Size": 0,</span><br><span class="line">            "StorageClass": "STANDARD"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="复制对象"><a href="#复制对象" class="headerlink" title="复制对象"></a>复制对象</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">aws s3 cp ./local_directory s3://mybucket --recursive</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 将来自S3桶DOC-EXAMPLE-BUCKET1的对象object1复制至S3桶DOC-EXAMPLE-BUCKET2。它使用bucketowner条件来确保bucket由预期帐户根据下表拥有。</span><br><span class="line">aws s3api copy-object --copy-source DOC-EXAMPLE-BUCKET1/object1 \</span><br><span class="line">  --bucket DOC-EXAMPLE-BUCKET2 --key object1copy \</span><br><span class="line">  --expected-source-bucket-owner 111122223333 --expected-bucket-owner 444455556666</span><br></pre></td></tr></table></figure><h4 id="下载对象"><a href="#下载对象" class="headerlink" title="下载对象"></a>下载对象</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">aws s3api get-object --bucket $&#123;mybucket&#125; --key hello.html hello.html </span><br><span class="line">&#123;</span><br><span class="line">    "AcceptRanges": "bytes",</span><br><span class="line">    "LastModified": "2020-12-17T10:20:22+00:00",</span><br><span class="line">    "ContentLength": 15,</span><br><span class="line">    "ETag": "\"4643d69d5ca0b263531be4a3f3a76699\"",</span><br><span class="line">    "VersionId": "HlOmQ6Yw_HvbKAjiaykj6vqsDOhQnAuA",</span><br><span class="line">    "ContentType": "text/plain",</span><br><span class="line">    "Metadata": &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 下载带有DeleteMarker标记的对象,即启用版本控制后被删除的对象</span><br><span class="line">aws s3api get-object --bucket mybucket --key hello.html hello.html</span><br><span class="line">An error occurred (NoSuchKey) when calling the GetObject operation: The specified key does not exist.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 下载带版本的对象</span><br><span class="line">aws s3api get-object --bucket $&#123;mybucket&#125; --key hello.html hello.html --version-id HlOmQ6Yw_HvbKAjiaykj6vqsDOhQABCD</span><br></pre></td></tr></table></figure><h4 id="删除对象"><a href="#删除对象" class="headerlink" title="删除对象"></a>删除对象</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">aws s3 rm s3://mybucket/test2.txt</span><br><span class="line"></span><br><span class="line">aws s3 rm s3://mybucket --recursive</span><br><span class="line"></span><br><span class="line">aws s3 --profile int-xmn --region us-east-1 rm s3://karl-test-us/North\ America --recursive --exclude *.jpg</span><br><span class="line">aws s3 --profile int-xmn --region us-east-1 rm s3://karl-test-us/North\ America --recursive --exclude prefix/*</span><br><span class="line">aws s3 --profile int-xmn --region us-east-1 rm s3://karl-test-us/North\ America --recursive --exclude *tag*</span><br></pre></td></tr></table></figure><h4 id="生成预签名对象"><a href="#生成预签名对象" class="headerlink" title="生成预签名对象"></a>生成预签名对象</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 创建预签名地址时要注意与bucket region相同,profile中任何region都能成功创建URL但只有与bucket相匹配的才能访问</span><br><span class="line"><span class="meta">#</span> 预签名有时间限制</span><br><span class="line"><span class="meta">#</span>   用户创建:36小时 </span><br><span class="line"><span class="meta">#</span>   instance profile: 6小时</span><br><span class="line"><span class="meta">#</span>   IAM 用户并且使用 V4版本签名最长可达7天</span><br><span class="line"><span class="meta">#</span>   临时Token: Token有效期结束时,预签名URL就到期</span><br><span class="line">aws s3 presign s3://awsexamplebucket/test2.txt --expires-in 86400</span><br></pre></td></tr></table></figure><h4 id="删除对象-1"><a href="#删除对象-1" class="headerlink" title="删除对象"></a>删除对象</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">aws s3api delete-object --bucket $&#123;mybucket&#125; --key h.html</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 带有版本控制的桶删除时不会真的删除对象,只是打一个DeleteMarker标记,获取对象时会返回404, 3hMMqVy.dX0p1HGzoH6_o7cqSkP.wjOH 版本只是一个空对象</span><br><span class="line">aws s3api delete-object --bucket $&#123;mybucket&#125; --key h.html</span><br><span class="line">&#123;</span><br><span class="line">    "DeleteMarker": true,</span><br><span class="line">    "VersionId": "3hMMqVy.dX0p1HGzoH6_o7cqSkP.wjOH"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 删除DeleteMarker标记,让对象回到上一个版本,3hMMqVy.dX0p1HGzoH6_o7cqSkP.wjOH 版本消失</span><br><span class="line">aws s3api delete-object --bucket $&#123;mybucket&#125; --key h.html --version-id 3hMMqVy.dX0p1HGzoH6_o7cqSkP.wjOH</span><br><span class="line">&#123;</span><br><span class="line">    "DeleteMarker": true,</span><br><span class="line">    "VersionId": "3hMMqVy.dX0p1HGzoH6_o7cqSkP.wjOH"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="访问点CLI"><a href="#访问点CLI" class="headerlink" title="访问点CLI"></a>访问点CLI</h3><h4 id="创建访问点"><a href="#创建访问点" class="headerlink" title="创建访问点"></a>创建访问点</h4><p>创建访问点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">aws s3control create-access-point --name example-ap --account-id 123456789012 --bucket example-bucket</span><br><span class="line"></span><br><span class="line">aws s3control create-access-point --name example-ap --account-id 123456789012 --bucket example-bucket --public-access-block-configuration BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=true,RestrictPublicBuckets=true</span><br></pre></td></tr></table></figure><p>创建具有VPC限制的访问点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3control create-access-point --name example-vpc-ap --account-id 123456789012 --bucket example-bucket --vpc-configuration VpcId=vpc-1a2b3c</span><br></pre></td></tr></table></figure><h4 id="查看访问点"><a href="#查看访问点" class="headerlink" title="查看访问点"></a>查看访问点</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">aws s3control get-access-point --name example-vpc-ap --account-id 123456789012</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    "Name": "example-vpc-ap",</span><br><span class="line">    "Bucket": "example-bucket",</span><br><span class="line">    "NetworkOrigin": "VPC",</span><br><span class="line">    "VpcConfiguration": &#123;</span><br><span class="line">        "VpcId": "vpc-1a2b3c"</span><br><span class="line">    &#125;,</span><br><span class="line">    "PublicAccessBlockConfiguration": &#123;</span><br><span class="line">        "BlockPublicAcls": true,</span><br><span class="line">        "IgnorePublicAcls": true,</span><br><span class="line">        "BlockPublicPolicy": true,</span><br><span class="line">        "RestrictPublicBuckets": true</span><br><span class="line">    &#125;,</span><br><span class="line">    "CreationDate": "2019-11-27T00:00:00Z"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="通过访问点获取对象"><a href="#通过访问点获取对象" class="headerlink" title="通过访问点获取对象"></a>通过访问点获取对象</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api get-object --key my-image.jpg --bucket arn:aws:s3:us-west-2:123456789012:accesspoint/prod download.jpg</span><br></pre></td></tr></table></figure><h4 id="通过访问点上传对象"><a href="#通过访问点上传对象" class="headerlink" title="通过访问点上传对象"></a>通过访问点上传对象</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api put-object --bucket arn:aws:s3:us-west-2:123456789012:accesspoint/prod --key my-image.jpg --body my-image.jpg</span><br></pre></td></tr></table></figure><h4 id="通过访问点删除对象"><a href="#通过访问点删除对象" class="headerlink" title="通过访问点删除对象"></a>通过访问点删除对象</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api delete-object --bucket arn:aws:s3:us-west-2:123456789012:accesspoint/prod --key my-image.jpg</span><br></pre></td></tr></table></figure><h4 id="通过访问点列出对象"><a href="#通过访问点列出对象" class="headerlink" title="通过访问点列出对象"></a>通过访问点列出对象</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api list-objects-v2 --bucket arn:aws:s3:us-west-2:123456789012:accesspoint/prod</span><br></pre></td></tr></table></figure><h4 id="通过访问点向对象添加标签集"><a href="#通过访问点向对象添加标签集" class="headerlink" title="通过访问点向对象添加标签集"></a>通过访问点向对象添加标签集</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api put-object-tagging --bucket arn:aws:s3:us-west-2:123456789012:accesspoint/prod --key my-image.jpg --tagging TagSet=[&#123;Key="finance",Value="true"&#125;]</span><br></pre></td></tr></table></figure><h4 id="使用-ACL-通过访问点授予访问权限"><a href="#使用-ACL-通过访问点授予访问权限" class="headerlink" title="使用 ACL 通过访问点授予访问权限"></a>使用 ACL 通过访问点授予访问权限</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api put-object-acl --bucket arn:aws:s3:us-west-2:123456789012:accesspoint/prod --key my-image.jpg --acl private</span><br></pre></td></tr></table></figure><p>以上完全基于<a href="https://docs.aws.amazon.com/" target="_blank" rel="noopener">AWS官方文档</a>，并结合自身理解创作</p><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> 存储类 </category>
          
          <category> S3 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS S3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AWS-S3-4-Policy策略</title>
      <link href="2020/11/14/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/S3/AWS-S3-4-Policy%E7%AD%96%E7%95%A5/"/>
      <url>2020/11/14/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/S3/AWS-S3-4-Policy%E7%AD%96%E7%95%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="描述-S3-策略示例-S3存储桶策略可以基于各种条件进行访问限定"><a href="#描述-S3-策略示例-S3存储桶策略可以基于各种条件进行访问限定" class="headerlink" title="描述: S3 策略示例,S3存储桶策略可以基于各种条件进行访问限定"></a>描述: S3 策略示例,S3存储桶策略可以基于各种条件进行访问限定</h2><a id="more"></a><p><strong>注意: 所有<code>Effect</code>为<code>Deny</code>的<code>Action</code>字段不要用<code>s3:*</code>,否则会出现严重的问题，除非你知道怎么解决。</strong></p><!-- TOC --><ul><li><a href="#描述-s3-策略示例s3存储桶策略可以基于各种条件进行访问限定">描述: S3 策略示例,S3存储桶策略可以基于各种条件进行访问限定</a><ul><li><a href="#iam-policy">IAM Policy</a><ul><li><a href="#允许-iam-用户访问某个存储桶">允许 IAM 用户访问某个存储桶</a></li><li><a href="#允许每个-iam-用户访问存储桶中的文件夹">允许每个 IAM 用户访问存储桶中的文件夹</a></li></ul></li><li><a href="#bucket-policy">Bucket Policy</a><ul><li><a href="#存储桶拥有者授予跨账户存储桶权限">存储桶拥有者授予跨账户存储桶权限</a></li><li><a href="#以下存储桶策略使对象可公开访问">以下存储桶策略使对象可公开访问。</a></li><li><a href="#基于ip限制">基于IP限制</a></li><li><a href="#限制对特定-http-引用站点的访问">限制对特定 HTTP 引用站点的访问</a></li><li><a href="#特定用户或角色仅允许访问指定bucket">特定用户或角色仅允许访问指定bucket</a></li><li><a href="#特定用户或角色仅允许访问指定bucket的特定文件夹前缀">特定用户或角色仅允许访问指定bucket的特定文件夹（前缀）</a></li><li><a href="#特定bucket仅允许特定角色访问">特定Bucket仅允许特定角色访问</a></li><li><a href="#特定bucket仅允许特定iam用户访问">特定Bucket仅允许特定IAM用户访问</a></li><li><a href="#仅允许从vpc-endpoint访问">仅允许从VPC endpoint访问</a></li><li><a href="#向-oaiorigin-access-identity--授予读写访问权限">向 OAI(Origin Access Identity ) 授予读写访问权限</a></li><li><a href="#vpc-endpoint与access-point结合">VPC endpoint与Access Point结合</a></li><li><a href="#检查仅允许从特定-ip-地址上传的条件类似条件如下">检查仅允许从特定 IP 地址上传的条件，类似条件如下：</a></li><li><a href="#检查仅允许在对象为特定存储类时上传的条件类似条件如下">检查仅允许在对象为特定存储类时上传的条件，类似条件如下：</a></li><li><a href="#检查仅允许在对象分配有特定访问控制列表-acl-时进行上传的条件类似条件如下">检查仅允许在对象分配有特定访问控制列表 (ACL) 时进行上传的条件，类似条件如下：</a></li><li><a href="#检查要求上传授予存储桶拥有者典型用户-id对象完全控制权的条件类似条件如下">检查要求上传授予存储桶拥有者（典型用户 ID）对象完全控制权的条件，类似条件如下：</a></li><li><a href="#检查仅允许在特定-aws-key-management-system-aws-kms-密钥加密对象时进行上传的条件类似条件如下">检查仅允许在特定 AWS Key Management System (AWS KMS) 密钥加密对象时进行上传的条件，类似条件如下：</a></li><li><a href="#检查仅允许在对象使用特定类型服务器端加密时进行上传的条件类似条件如下">检查仅允许在对象使用特定类型服务器端加密时进行上传的条件，类似条件如下：</a></li><li><a href="#将最长保留期限设置为-10-天">将最长保留期限设置为 10 天。</a></li></ul></li><li><a href="#访问点相关策略">访问点相关策略</a><ul><li><a href="#将访问控制委派给访问点的存储桶策略">将访问控制委派给访问点的存储桶策略</a></li><li><a href="#访问点策略授予">访问点策略授予</a></li><li><a href="#允许用户仅读取具有特定标签的对象">允许用户仅读取具有特定标签的对象</a></li><li><a href="#允许用户添加指定的对象标签">允许用户添加指定的对象标签</a></li><li><a href="#存储桶中对象所有权">存储桶中对象所有权</a></li><li><a href="#允许用户添加包含特定标签键和值的对象标签">允许用户添加包含特定标签键和值的对象标签</a></li><li><a href="#允许查看存储桶列示内容的访问点策略">允许查看存储桶列示内容的访问点策略</a></li></ul></li><li><a href="#结语">结语</a></li></ul></li></ul><!-- /TOC --><h3 id="IAM-Policy"><a href="#IAM-Policy" class="headerlink" title="IAM Policy"></a>IAM Policy</h3><p>IAM Policy是附加到用户，用户组或是角色的策略</p><h4 id="允许-IAM-用户访问某个存储桶"><a href="#允许-IAM-用户访问某个存储桶" class="headerlink" title="允许 IAM 用户访问某个存储桶"></a>允许 IAM 用户访问某个存储桶</h4><p>在本示例中，授予 AWS 账户中的 IAM 用户访问其中一个存储桶 awsexamplebucket1 的权限，以便该用户能够添加、更新和删除对象。</p><p><strong>注意：这个示例策略是加给用户或角色的，而不是加到bucket policy</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"Version"</span>:<span class="string">"2012-10-17"</span>,</span><br><span class="line">   <span class="attr">"Statement"</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"Effect"</span>:<span class="string">"Allow"</span>,</span><br><span class="line">         <span class="attr">"Action"</span>: <span class="string">"s3:ListAllMyBuckets"</span>,</span><br><span class="line">         <span class="attr">"Resource"</span>:<span class="string">"arn:aws:s3:::*"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"Effect"</span>:<span class="string">"Allow"</span>,</span><br><span class="line">         <span class="attr">"Action"</span>:[<span class="string">"s3:ListBucket"</span>,<span class="string">"s3:GetBucketLocation"</span>],</span><br><span class="line">         <span class="attr">"Resource"</span>:<span class="string">"arn:aws:s3:::awsexamplebucket1"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"Effect"</span>:<span class="string">"Allow"</span>,</span><br><span class="line">         <span class="attr">"Action"</span>:[</span><br><span class="line">            <span class="string">"s3:PutObject"</span>,</span><br><span class="line">            <span class="string">"s3:PutObjectAcl"</span>,</span><br><span class="line">            <span class="string">"s3:GetObject"</span>,</span><br><span class="line">            <span class="string">"s3:GetObjectAcl"</span>,</span><br><span class="line">            <span class="string">"s3:DeleteObject"</span></span><br><span class="line">         ],</span><br><span class="line">         <span class="attr">"Resource"</span>:<span class="string">"arn:aws:s3:::awsexamplebucket1/*"</span></span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="允许每个-IAM-用户访问存储桶中的文件夹"><a href="#允许每个-IAM-用户访问存储桶中的文件夹" class="headerlink" title="允许每个 IAM 用户访问存储桶中的文件夹"></a>允许每个 IAM 用户访问存储桶中的文件夹</h4><p>两个 IAM 用户（Alice 和 Bob）可以访问 examplebucket 存储桶，以便他们可以添加、更新和删除对象。但是，想要限制每个用户对存储桶中单个文件夹的访问权限。可以使用与用户名称匹配的名称创建文件夹。</p><ol><li><p>对用户单独创建策略</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Version"</span>:<span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"Effect"</span>:<span class="string">"Allow"</span>,</span><br><span class="line">        <span class="attr">"Action"</span>:[</span><br><span class="line">            <span class="string">"s3:PutObject"</span>,</span><br><span class="line">            <span class="string">"s3:GetObject"</span>,</span><br><span class="line">            <span class="string">"s3:GetObjectVersion"</span>,</span><br><span class="line">            <span class="string">"s3:DeleteObject"</span>,</span><br><span class="line">            <span class="string">"s3:DeleteObjectVersion"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"Resource"</span>:<span class="string">"arn:aws:s3:::awsexamplebucket1/Alice/*"</span></span><br><span class="line">      &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同样，对Bob也创建一个</p></li><li><p>使用策略变量的策略并将该策略附加到一个组，而不是将策略附加到单个用户。然后将 Alice 和 Bob 添加到该组中。</p><p>策略变量 ${aws:username} 将替换为请求者的用户名称。例如，如果 Alice 发送了一个请求以放置对象，只有当 Alice 将对象上传到 examplebucket/Alice 文件夹后，才允许该操作。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Version"</span>:<span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"Effect"</span>:<span class="string">"Allow"</span>,</span><br><span class="line">        <span class="attr">"Action"</span>:[</span><br><span class="line">            <span class="string">"s3:PutObject"</span>,</span><br><span class="line">            <span class="string">"s3:GetObject"</span>,</span><br><span class="line">            <span class="string">"s3:GetObjectVersion"</span>,</span><br><span class="line">            <span class="string">"s3:DeleteObject"</span>,</span><br><span class="line">            <span class="string">"s3:DeleteObjectVersion"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"Resource"</span>:<span class="string">"arn:aws:s3:::awsexamplebucket1/$&#123;aws:username&#125;/*"</span></span><br><span class="line">      &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="Bucket-Policy"><a href="#Bucket-Policy" class="headerlink" title="Bucket Policy"></a>Bucket Policy</h3><p>对于Bucket的策略，</p><ol><li>在Bucket是<code>Public</code>的情况下只允许<code>XXX</code>访问，则<code>Effect</code>字段应设置为<code>Deny</code>然后在<code>Condition</code>字段添加<code>Not</code>条件。</li><li>在Bucket是<code>NotPublic</code>的情况下允许<code>XXX</code>访问，则<code>Effect</code>字段应设置为<code>Allow</code>然后设定在<code>Condition</code>字段添加<code>Not</code>条件</li></ol><h4 id="存储桶拥有者授予跨账户存储桶权限"><a href="#存储桶拥有者授予跨账户存储桶权限" class="headerlink" title="存储桶拥有者授予跨账户存储桶权限"></a>存储桶拥有者授予跨账户存储桶权限</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">   <span class="attr">"Statement"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"Sid"</span>: <span class="string">"Example permissions"</span>,</span><br><span class="line">         <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">         <span class="attr">"Principal"</span>: &#123;</span><br><span class="line">            <span class="attr">"AWS"</span>: <span class="string">"arn:aws:iam::AccountB-ID:root"</span></span><br><span class="line">         &#125;,</span><br><span class="line">         <span class="attr">"Action"</span>: [</span><br><span class="line">            <span class="string">"s3:GetBucketLocation"</span>,</span><br><span class="line">            <span class="string">"s3:ListBucket"</span></span><br><span class="line">         ],</span><br><span class="line">         <span class="attr">"Resource"</span>: [</span><br><span class="line">            <span class="string">"arn:aws:s3:::awsexamplebucket1"</span></span><br><span class="line">         ]</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="以下存储桶策略使对象可公开访问。"><a href="#以下存储桶策略使对象可公开访问。" class="headerlink" title="以下存储桶策略使对象可公开访问。"></a>以下存储桶策略使对象可公开访问。</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>:<span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Sid"</span>:<span class="string">"GrantAnonymousReadPermissions"</span>,</span><br><span class="line">            <span class="attr">"Effect"</span>:<span class="string">"Allow"</span>,</span><br><span class="line">            <span class="attr">"Principal"</span>: <span class="string">"*"</span>,</span><br><span class="line">            <span class="attr">"Action"</span>:[<span class="string">"s3:GetObject"</span>],</span><br><span class="line">            <span class="attr">"Resource"</span>:[<span class="string">"arn:aws:s3:::awsexamplebucket1/*"</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="基于IP限制"><a href="#基于IP限制" class="headerlink" title="基于IP限制"></a>基于IP限制</h4><p>除特定外部 IP 地址外，阻止所有的流量 - 只允许特定IP访问</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Sid"</span>: <span class="string">"IPAllow"</span>,</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Deny"</span>,</span><br><span class="line">      <span class="attr">"Principal"</span>: <span class="string">"*"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: <span class="string">"s3:Get*"</span>,</span><br><span class="line">      <span class="attr">"Resource"</span>: <span class="string">"arn:aws:s3:::examplebucket/*"</span>,</span><br><span class="line">      <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">         <span class="attr">"NotIpAddress"</span>: &#123;</span><br><span class="line">            <span class="attr">"aws:SourceIp"</span>: [</span><br><span class="line">                <span class="string">"54.240.143.0/24"</span>,</span><br><span class="line">                <span class="string">"2001:DB8:1234:5678::/64"</span></span><br><span class="line">              ]</span><br><span class="line">         &#125;</span><br><span class="line">      &#125; </span><br><span class="line">    &#125; </span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>阻止特定外部 IP 地址的流量 - - 不允许特定IP访问</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Id"</span>:<span class="string">"PolicyId2"</span>,</span><br><span class="line">  <span class="attr">"Version"</span>:<span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>:[</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Sid"</span>:<span class="string">"AllowIPmix"</span>,</span><br><span class="line">      <span class="attr">"Effect"</span>:<span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Principal"</span>:<span class="string">"*"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>:<span class="string">"s3:*"</span>,</span><br><span class="line">      <span class="attr">"Resource"</span>:<span class="string">"arn:aws:s3:::awsexamplebucket1/*"</span>,</span><br><span class="line">      <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">        <span class="attr">"NotIpAddress"</span>: &#123;</span><br><span class="line">          <span class="attr">"aws:SourceIp"</span>: [</span><br><span class="line">          <span class="string">"54.240.143.128/30"</span>,</span><br><span class="line">          <span class="string">"2001:DB8:1234:5678:ABCD::/80"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>允许特定IP访问，阻止特定IP访问</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Id"</span>:<span class="string">"PolicyId2"</span>,</span><br><span class="line">  <span class="attr">"Version"</span>:<span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>:[</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Sid"</span>:<span class="string">"AllowIPmix"</span>,</span><br><span class="line">      <span class="attr">"Effect"</span>:<span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Principal"</span>:<span class="string">"*"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>:<span class="string">"s3:*"</span>,</span><br><span class="line">      <span class="attr">"Resource"</span>:<span class="string">"arn:aws:s3:::awsexamplebucket1/*"</span>,</span><br><span class="line">      <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">        <span class="attr">"IpAddress"</span>: &#123;</span><br><span class="line">          <span class="attr">"aws:SourceIp"</span>: [</span><br><span class="line">            <span class="string">"54.240.143.0/24"</span>,</span><br><span class="line">          <span class="string">"2001:DB8:1234:5678::/64"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"NotIpAddress"</span>: &#123;</span><br><span class="line">          <span class="attr">"aws:SourceIp"</span>: [</span><br><span class="line">            <span class="string">"54.240.143.128/30"</span>,</span><br><span class="line">            <span class="string">"2001:DB8:1234:5678:ABCD::/80"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="限制对特定-HTTP-引用站点的访问"><a href="#限制对特定-HTTP-引用站点的访问" class="headerlink" title="限制对特定 HTTP 引用站点的访问"></a>限制对特定 HTTP 引用站点的访问</h4><p>假设你拥有一个网站，其域名为 <a href="http://www.example.com" target="_blank" rel="noopener">www.example.com</a> 或 example.com，并且带有指向存储在 Amazon S3 存储桶 awsexamplebucket1 中的照片和视频的链接。默认情况下，所有 Amazon S3 资源都是私有的，因此只有创建资源的 AWS 账户才能访问它们。要允许从网站对这些对象进行读取访问，您可以添加一个存储桶策略允许 s3:GetObject 权限，并附带使用 aws:Referer 键的条件，即获取请求必须来自特定的网页。以下策略指定带有 StringLike 条件键的 aws:Referer 条件。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;Version&quot;:&quot;2012-10-17&quot;,</span><br><span class="line">  &quot;Id&quot;:&quot;http referer policy example&quot;,</span><br><span class="line">  &quot;Statement&quot;:[</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;Sid&quot;:&quot;Allow get requests originating from www.example.com and example.com.&quot;,</span><br><span class="line">      &quot;Effect&quot;:&quot;Allow&quot;,</span><br><span class="line">      &quot;Principal&quot;:&quot;*&quot;,</span><br><span class="line">      &quot;Action&quot;:[</span><br><span class="line">        &quot;s3:GetObject&quot;,</span><br><span class="line">        &quot;s3:GetObjectVersion&quot;</span><br><span class="line">      ],</span><br><span class="line">      &quot;Resource&quot;:&quot;arn:aws:s3:::`awsexamplebucket1`/*&quot;,</span><br><span class="line">      &quot;Condition&quot;:&#123;</span><br><span class="line">        &quot;StringLike&quot;:&#123;</span><br><span class="line">          &quot;aws:Referer&quot;:[</span><br><span class="line">            &quot;http://www.example.com/*&quot;,</span><br><span class="line">            &quot;http://example.com/*&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>确保您使用的浏览器在请求中包含 HTTP referer 标头。</p><h4 id="特定用户或角色仅允许访问指定bucket"><a href="#特定用户或角色仅允许访问指定bucket" class="headerlink" title="特定用户或角色仅允许访问指定bucket"></a>特定用户或角色仅允许访问指定bucket</h4><p>我想授予用户的 Amazon Simple Storage Service (Amazon S3) 控制台访问某个存储桶的权限。但是，我不希望用户能够查看其他账户中的存储桶。如何限制用户的控制台访问权限，使之只能访问某个存储桶？</p><p>要做到这个除了bucket policy之外，还需要一个额外的操作：</p><ul><li>删除用户或角色的<code>s3:ListAllMyBuckets</code>的权限</li></ul><p>以下示例策略用于访问存储桶。该策略允许用户仅对 <code>AWSDOC-EXAMPLE-BUCKET</code> 执行 <code>s3:ListBucket</code>、<code>s3:PutObject</code> 和 <code>s3:GetObject</code> 操作：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"Version"</span>:<span class="string">"2012-10-17"</span>,</span><br><span class="line">   <span class="attr">"Statement"</span>:[</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"Effect"</span>:<span class="string">"Allow"</span>,</span><br><span class="line">         <span class="attr">"Action"</span>:[</span><br><span class="line">            <span class="string">"s3:ListBucket"</span></span><br><span class="line">         ],</span><br><span class="line">         <span class="attr">"Resource"</span>:<span class="string">"arn:aws:s3:::AWSDOC-EXAMPLE-BUCKET"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"Effect"</span>:<span class="string">"Allow"</span>,</span><br><span class="line">         <span class="attr">"Action"</span>:[</span><br><span class="line">            <span class="string">"s3:PutObject"</span>,</span><br><span class="line">            <span class="string">"s3:GetObject"</span></span><br><span class="line">         ],</span><br><span class="line">         <span class="attr">"Resource"</span>:<span class="string">"arn:aws:s3:::AWSDOC-EXAMPLE-BUCKET/*"</span></span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>更改这些权限后，用户在访问主 Amazon S3 控制台时会收到“访问被拒绝”错误。用户必须使用指向存储桶或文件夹的直接控制台链接访问存储桶。指向存储桶的直接控制台链接与以下类似：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://s3.console.aws.amazon.com/s3/buckets/AWSDOC-EXAMPLE-BUCKET/</span><br></pre></td></tr></table></figure><h4 id="特定用户或角色仅允许访问指定bucket的特定文件夹（前缀）"><a href="#特定用户或角色仅允许访问指定bucket的特定文件夹（前缀）" class="headerlink" title="特定用户或角色仅允许访问指定bucket的特定文件夹（前缀）"></a>特定用户或角色仅允许访问指定bucket的特定文件夹（前缀）</h4><p>我想授予用户的 Amazon Simple Storage Service (Amazon S3) 控制台访问某个特定存储桶文件夹（前缀）的权限。但是，我不希望用户能够查看其他账户中的存储桶或其他存储桶中的文件夹。如何限制用户的控制台访问权限，使之只能访问某个存储桶的文件夹？</p><p>要做到这个除了bucket policy之外，还需要一个额外的操作：</p><ul><li>删除用户或角色的<code>s3:ListAllMyBuckets</code>的权限</li></ul><p>以下示例策略用于访问文件夹。例如，以下策略允许用户对 <code>AWSDOC-EXAMPLE-BUCKET</code>中的 <code>folder2</code> 执行 <code>s3:ListBucket</code>、<code>s3:PutObject</code> 和 <code>s3:GetObject</code> 操作：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Sid"</span>: <span class="string">"AllowUsersToAccessFolder2Only"</span>,</span><br><span class="line">            <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="attr">"Action"</span>: [</span><br><span class="line">                <span class="string">"s3:GetObject*"</span>,</span><br><span class="line">                <span class="string">"s3:PutObject*"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"Resource"</span>: [</span><br><span class="line">                <span class="string">"arn:aws:s3:::AWSDOC-EXAMPLE-BUCKET/folder1/folder2/*"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="attr">"Action"</span>: [</span><br><span class="line">                <span class="string">"s3:ListBucket*"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"Resource"</span>: [</span><br><span class="line">                <span class="string">"arn:aws:s3:::AWSDOC-EXAMPLE-BUCKET"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">                <span class="attr">"StringLike"</span>: &#123;</span><br><span class="line">                    <span class="attr">"s3:prefix"</span>: [</span><br><span class="line">                        <span class="string">"folder1/folder2/*"</span></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>更改这些权限后，用户在访问主 Amazon S3 控制台时会收到“访问被拒绝”错误。用户必须使用指向存储桶或文件夹的直接控制台链接访问存储桶。指向存储桶的直接控制台链接与以下类似：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://s3.console.aws.amazon.com/s3/buckets/AWSDOC-EXAMPLE-BUCKET/folder1/folder2/</span><br></pre></td></tr></table></figure><h4 id="特定Bucket仅允许特定角色访问"><a href="#特定Bucket仅允许特定角色访问" class="headerlink" title="特定Bucket仅允许特定角色访问"></a>特定Bucket仅允许特定角色访问</h4><p>有一个存放着公司绝密的文件的bucket，只允许特定角色和根用户访问，不能以IAM用户身份访问，即使拥有管理员权限也无法访问</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Deny"</span>,</span><br><span class="line">      # 警告 这个示例很危险不要轻易尝试，除非你知道自己在做什么</span><br><span class="line">      "Principal": "*",</span><br><span class="line">      "Action": "s3:Get*",</span><br><span class="line">      "Resource": [</span><br><span class="line">        "arn:aws:s3:::MyExampleBucket",</span><br><span class="line">        <span class="string">"arn:aws:s3:::MyExampleBucket/*"</span></span><br><span class="line">      ],</span><br><span class="line">      "Condition": &#123;</span><br><span class="line">        "StringNotLike": &#123;</span><br><span class="line">          "aws:userId": [</span><br><span class="line">            "AROAEXAMPLEID:*",</span><br><span class="line">            <span class="string">"111111111111"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>AROAEXAMPLEID</code>: 通过AWS CLI的<code>iam get-role</code>获取的<code>RoleId</code>，代表role</li><li><code>111111111111</code>: AWS AccountId，代表根用户</li></ul><p>可以和下方的特定用户配合使用</p><h4 id="特定Bucket仅允许特定IAM用户访问"><a href="#特定Bucket仅允许特定IAM用户访问" class="headerlink" title="特定Bucket仅允许特定IAM用户访问"></a>特定Bucket仅允许特定IAM用户访问</h4><p>有一个存放着公司绝密的文件的bucket，只允许特定的用户（例如CEO）和根用户访问，即使拥有管理员权限也无法访问</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Deny"</span>,</span><br><span class="line">      # 警告 这个示例很危险不要轻易尝试，除非你知道自己在做什么</span><br><span class="line">      "Principal": "*",</span><br><span class="line">      "Action": "s3:Get*",</span><br><span class="line">      "Resource": [</span><br><span class="line">        "arn:aws:s3:::MyExampleBucket",</span><br><span class="line">        <span class="string">"arn:aws:s3:::MyExampleBucket/*"</span></span><br><span class="line">      ],</span><br><span class="line">      "Condition": &#123;</span><br><span class="line">        "StringNotLike": &#123;</span><br><span class="line">          "aws:userId": [</span><br><span class="line">            "AIDAEXAMPLEID",</span><br><span class="line">            <span class="string">"111111111111"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>AIDAEXAMPLEID</code>: 通过AWS CLI的<code>iam get-user</code>获取的<code>UserId</code>，代表user</li><li><code>111111111111</code>: AWS AccountId，代表根用户</li></ul><p>可以和上方的特定角色配合使用</p><h4 id="仅允许从VPC-endpoint访问"><a href="#仅允许从VPC-endpoint访问" class="headerlink" title="仅允许从VPC endpoint访问"></a>仅允许从VPC endpoint访问</h4><p>允许VPC内的机器能够直接访问S3</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Id"</span>: <span class="string">"VPCe and SourceIP"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>: [&#123;</span><br><span class="line">    <span class="attr">"Sid"</span>: <span class="string">"VPCe and SourceIP"</span>,</span><br><span class="line">    <span class="attr">"Effect"</span>: <span class="string">"Deny"</span>,</span><br><span class="line">    <span class="attr">"Principal"</span>: <span class="string">"*"</span>,</span><br><span class="line">    <span class="attr">"Action"</span>: <span class="string">"s3:Get*"</span>,</span><br><span class="line">    <span class="attr">"Resource"</span>: [</span><br><span class="line">      <span class="string">"arn:aws:s3:::awsexamplebucket"</span>,</span><br><span class="line">      <span class="string">"arn:aws:s3:::awsexamplebucket/*"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">      <span class="attr">"StringNotEquals"</span>: &#123;</span><br><span class="line">        <span class="attr">"aws:sourceVpce"</span>: [</span><br><span class="line">          <span class="string">"vpce-1111111"</span>,</span><br><span class="line">          <span class="string">"vpce-2222222"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"StringNotLike"</span>: &#123;</span><br><span class="line">        <span class="attr">"aws:userId"</span>: [</span><br><span class="line">          <span class="string">"AROAEXAMPLEID:*"</span>,</span><br><span class="line">          <span class="string">"AIDAEXAMPLEID"</span>,</span><br><span class="line">          <span class="string">"111111111111"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>AROAEXAMPLEID</code>: 通过AWS CLI的<code>iam get-role</code>获取的<code>RoleId</code>，代表role</li><li><code>AIDAEXAMPLEID</code>: 通过AWS CLI的<code>iam get-user</code>获取的<code>UserId</code>，代表user</li><li><code>111111111111</code>: AWS AccountId，代表根用户</li></ul><h4 id="向-OAI-Origin-Access-Identity-授予读写访问权限"><a href="#向-OAI-Origin-Access-Identity-授予读写访问权限" class="headerlink" title="向 OAI(Origin Access Identity ) 授予读写访问权限"></a>向 OAI(Origin Access Identity ) 授予读写访问权限</h4><p>这是配合CloudFront使用的策略，允许通过CloudFront访问，不能直接访问Bucket</p><p>下面的示例允许 OAI 读取和写入指定存储桶（s3:GetObject 和 s3:PutObject）中的对象。这样允许查看器将文件通过 CloudFront 上传到 Amazon S3 存储桶。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Id"</span>: <span class="string">"PolicyForCloudFrontPrivateContent"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="attr">"Principal"</span>: &#123;</span><br><span class="line">                <span class="attr">"AWS"</span>: <span class="string">"arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity EH1HDMB1FH2TC"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"Action"</span>: [</span><br><span class="line">                <span class="string">"s3:GetObject"</span>,</span><br><span class="line">                <span class="string">"s3:PutObject"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"Resource"</span>: <span class="string">"arn:aws:s3:::aws-example-bucket/*"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="VPC-endpoint与Access-Point结合"><a href="#VPC-endpoint与Access-Point结合" class="headerlink" title="VPC endpoint与Access Point结合"></a>VPC endpoint与Access Point结合</h4><p>当Bucket越来越多，每次新增bucket都需要修改endpoint，使用该策略限制从S3请求必须通过Access Point。这是VPC endpoint策略。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>: <span class="string">"2008-10-17"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Sid"</span>: <span class="string">"AllowUseOfS3"</span>,</span><br><span class="line">            <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">            <span class="attr">"Principal"</span>: <span class="string">"*"</span>,</span><br><span class="line">            <span class="attr">"Action"</span>: <span class="string">"s3:*"</span>,</span><br><span class="line">            <span class="attr">"Resource"</span>: <span class="string">"*"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Sid"</span>: <span class="string">"OnlyIfAccessedViaAccessPoints"</span>,</span><br><span class="line">            <span class="attr">"Effect"</span>: <span class="string">"Deny"</span>,</span><br><span class="line">            <span class="attr">"Principal"</span>: <span class="string">"*"</span>,</span><br><span class="line">            <span class="attr">"Action"</span>: <span class="string">"s3:*"</span>,</span><br><span class="line">            <span class="attr">"Resource"</span>: <span class="string">"*"</span>,</span><br><span class="line">            <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">                <span class="attr">"ArnNotLikeIfExists"</span>: &#123;</span><br><span class="line">                    <span class="attr">"s3:DataAccessPointArn"</span>: <span class="string">"arn:aws:s3:us-east-1:&lt;Account ID&gt;:accesspoint/*"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="检查仅允许从特定-IP-地址上传的条件，类似条件如下："><a href="#检查仅允许从特定-IP-地址上传的条件，类似条件如下：" class="headerlink" title="检查仅允许从特定 IP 地址上传的条件，类似条件如下："></a>检查仅允许从特定 IP 地址上传的条件，类似条件如下：</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"Condition": &#123;</span><br><span class="line">  "IpAddress": &#123;</span><br><span class="line">    "aws:SourceIp": "54.240.143.0/24"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果存储桶策略具有此条件，IAM 用户必须从允许的 IP 地址访问存储桶。</p><h4 id="检查仅允许在对象为特定存储类时上传的条件，类似条件如下："><a href="#检查仅允许在对象为特定存储类时上传的条件，类似条件如下：" class="headerlink" title="检查仅允许在对象为特定存储类时上传的条件，类似条件如下："></a>检查仅允许在对象为特定存储类时上传的条件，类似条件如下：</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">"Condition": &#123;</span><br><span class="line">  "StringEquals": &#123;</span><br><span class="line">    "s3:x-amz-storage-class": [</span><br><span class="line">      <span class="string">"STANDARD_IA"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果策略具有此条件，用户必须使用允许的存储类上传对象。例如，上一个条件语句需要 STANDARD_IA 存储类，因此用户必须使用类似于以下内容的 AWS 命令行界面 (AWS CLI) 命令上传对象：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api put-object --bucket my_bucket --key examplefile.jpg --body c:\examplefile.jpg --storage-class STANDARD_IA</span><br></pre></td></tr></table></figure><h4 id="检查仅允许在对象分配有特定访问控制列表-ACL-时进行上传的条件，类似条件如下："><a href="#检查仅允许在对象分配有特定访问控制列表-ACL-时进行上传的条件，类似条件如下：" class="headerlink" title="检查仅允许在对象分配有特定访问控制列表 (ACL) 时进行上传的条件，类似条件如下："></a>检查仅允许在对象分配有特定访问控制列表 (ACL) 时进行上传的条件，类似条件如下：</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"Condition": &#123;</span><br><span class="line">  "StringEquals": &#123;</span><br><span class="line">      "s3:x-amz-acl":["public-read"]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果策略具有此条件，则用户必须用允许的 ACL 上传对象。例如，由于上一个条件需要 public-read ACL，用户必须使用类似于以下内容的命令上传对象：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api put-object --bucket my_bucket --key examplefile.jpg --body c:\examplefile.jpg --acl public-read</span><br></pre></td></tr></table></figure><h4 id="检查要求上传授予存储桶拥有者（典型用户-ID）对象完全控制权的条件，类似条件如下："><a href="#检查要求上传授予存储桶拥有者（典型用户-ID）对象完全控制权的条件，类似条件如下：" class="headerlink" title="检查要求上传授予存储桶拥有者（典型用户 ID）对象完全控制权的条件，类似条件如下："></a>检查要求上传授予存储桶拥有者（典型用户 ID）对象完全控制权的条件，类似条件如下：</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"Condition": &#123;</span><br><span class="line">  "StringEquals": &#123;</span><br><span class="line">    "s3:x-amz-grant-full-control": "id=AccountA-CanonicalUserID"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果策略具有此条件，则用户必须使用类似于以下内容的命令上传对象：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 获取AccountA-CanonicalUserID</span><br><span class="line">aws s3api list-buckets --query Owner.ID --output text</span><br><span class="line">example95f90f6fae9c770602ce44f64f76aee3386099178440a6e162952abcd</span><br><span class="line"></span><br><span class="line">aws s3api put-object --bucket my_bucket --key examplefile.jpg --body c:\examplefile.jpg --acl bucket-owner-full-control</span><br></pre></td></tr></table></figure><h4 id="检查仅允许在特定-AWS-Key-Management-System-AWS-KMS-密钥加密对象时进行上传的条件，类似条件如下："><a href="#检查仅允许在特定-AWS-Key-Management-System-AWS-KMS-密钥加密对象时进行上传的条件，类似条件如下：" class="headerlink" title="检查仅允许在特定 AWS Key Management System (AWS KMS) 密钥加密对象时进行上传的条件，类似条件如下："></a>检查仅允许在特定 AWS Key Management System (AWS KMS) 密钥加密对象时进行上传的条件，类似条件如下：</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"Condition": &#123;</span><br><span class="line">  "StringEquals": &#123;</span><br><span class="line">    "s3:x-amz-server-side-encryption-aws-kms-key-id": "arn:aws:kms:us-east-1:111122223333:key/*"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果策略具有此条件，则用户必须使用类似于以下内容的命令上传对象：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api put-object --bucket my_bucket --key examplefile.jpg --body c:\examplefile.jpg --ssekms-key-id arn:aws:kms:us-east-1:111122223333:key/*</span><br></pre></td></tr></table></figure><h4 id="检查仅允许在对象使用特定类型服务器端加密时进行上传的条件，类似条件如下："><a href="#检查仅允许在对象使用特定类型服务器端加密时进行上传的条件，类似条件如下：" class="headerlink" title="检查仅允许在对象使用特定类型服务器端加密时进行上传的条件，类似条件如下："></a>检查仅允许在对象使用特定类型服务器端加密时进行上传的条件，类似条件如下：</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"Condition": &#123;</span><br><span class="line">  "StringEquals": &#123;</span><br><span class="line">    "s3:x-amz-server-side-encryption": "AES256"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果策略具有此条件，用户必须使用类似于以下内容的命令上传对象：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api put-object --bucket my_bucket --key examplefile.jpg --body c:\examplefile.jpg --server-side-encryption &quot;AES256&quot;</span><br></pre></td></tr></table></figure><h4 id="将最长保留期限设置为-10-天。"><a href="#将最长保留期限设置为-10-天。" class="headerlink" title="将最长保留期限设置为 10 天。"></a>将最长保留期限设置为 10 天。</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Id"</span>: <span class="string">"&lt;SetRetentionLimits"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"Sid"</span>: <span class="string">"&lt;SetRetentionPeriod"</span>,</span><br><span class="line">            <span class="attr">"Effect"</span>: <span class="string">"Deny"</span>,</span><br><span class="line">            <span class="attr">"Principal"</span>: <span class="string">"*"</span>,</span><br><span class="line">            <span class="attr">"Action"</span>: [</span><br><span class="line">                <span class="string">"s3:PutObjectRetention"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"Resource"</span>: <span class="string">"arn:aws:s3:::&lt;awsexamplebucket1&gt;/*"</span>,</span><br><span class="line">            <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">                <span class="attr">"NumericGreaterThan"</span>: &#123;</span><br><span class="line">                    <span class="attr">"s3:object-lock-remaining-retention-days"</span>: <span class="string">"10"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="访问点相关策略"><a href="#访问点相关策略" class="headerlink" title="访问点相关策略"></a>访问点相关策略</h3><h4 id="将访问控制委派给访问点的存储桶策略"><a href="#将访问控制委派给访问点的存储桶策略" class="headerlink" title="将访问控制委派给访问点的存储桶策略"></a>将访问控制委派给访问点的存储桶策略</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">        <span class="attr">"Principal"</span> : &#123; <span class="attr">"AWS"</span>: <span class="string">"*"</span> &#125;,</span><br><span class="line">        <span class="attr">"Action"</span> : <span class="string">"*"</span>,</span><br><span class="line">        <span class="attr">"Resource"</span> : [ <span class="string">"Bucket ARN"</span>, <span class="string">"Bucket ARN/*"</span>],</span><br><span class="line">        <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">            <span class="attr">"StringEquals"</span> : &#123; <span class="attr">"s3:DataAccessPointAccount"</span> : <span class="string">"Bucket owner's account ID"</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="访问点策略授予"><a href="#访问点策略授予" class="headerlink" title="访问点策略授予"></a>访问点策略授予</h4><p>以下访问点策略通过账户 123456789012 中的访问点 my-access-point 向账户 123456789012 中的 IAM 用户 Alice 授予对具有前缀 Alice/ 的 GET 和 PUT 对象的权限。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>:<span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">        <span class="attr">"Principal"</span>: &#123;</span><br><span class="line">            <span class="attr">"AWS"</span>: <span class="string">"arn:aws:iam::123456789012:user/Alice"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"Action"</span>: [<span class="string">"s3:GetObject"</span>, <span class="string">"s3:PutObject"</span>],</span><br><span class="line">        <span class="attr">"Resource"</span>: <span class="string">"arn:aws:s3:us-west-2:123456789012:accesspoint/my-access-point/object/Alice/*"</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>注意</strong></p><p>要使访问点策略有效地向 Alice 授予访问权限，底层存储桶也必须对 Alice 允许相同的访问权限。可以将存储桶的访问控制委派到访问点，如<a href="#将访问控制委派给访问点的存储桶策略">将访问控制委派给访问点的存储桶策略</a>中所述。或者，您也可以将以下策略添加到底层存储桶中，以便向 Alice 授予必要的权限。请注意，访问点策略和存储桶策略的 Resource 条目不同。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">        <span class="attr">"Principal"</span>: &#123;</span><br><span class="line">            <span class="attr">"AWS"</span>: <span class="string">"arn:aws:iam::123456789012:user/Alice"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"Action"</span>: [<span class="string">"s3:GetObject"</span>, <span class="string">"s3:PutObject"</span>],</span><br><span class="line">        <span class="attr">"Resource"</span>: <span class="string">"arn:aws:s3:::awsexamplebucket1/Alice/*"</span></span><br><span class="line">    &#125;]    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="允许用户仅读取具有特定标签的对象"><a href="#允许用户仅读取具有特定标签的对象" class="headerlink" title="允许用户仅读取具有特定标签的对象"></a>允许用户仅读取具有特定标签的对象</h4><p>以下访问点策略通过账户 123456789012 中的访问点 my-access-point 向账户 123456789012 中的 IAM 用户 Bob 授予对 GET 对象的权限，这些权限具有值设为 finance 的标签键 data。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>:<span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"Effect"</span>:<span class="string">"Allow"</span>,</span><br><span class="line">        <span class="attr">"Principal"</span> : &#123;</span><br><span class="line">            <span class="attr">"AWS"</span>: <span class="string">"arn:aws:iam::123456789012:user/Bob"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"Action"</span>:<span class="string">"s3:GetObject"</span>,</span><br><span class="line">        <span class="attr">"Resource"</span> : <span class="string">"arn:aws:s3:us-west-2:123456789012:accesspoint/my-access-point/object/*"</span>,</span><br><span class="line">        <span class="attr">"Condition"</span> : &#123;</span><br><span class="line">            <span class="attr">"StringEquals"</span>: &#123;</span><br><span class="line">                <span class="attr">"s3:ExistingObjectTag/data"</span>: <span class="string">"finance"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="允许用户添加指定的对象标签"><a href="#允许用户添加指定的对象标签" class="headerlink" title="允许用户添加指定的对象标签"></a>允许用户添加指定的对象标签</h4><p>以下权限策略将向用户授予执行 s3:PutObjectTagging 操作的权限，这使用户可以将标签添加到现有对象。条件限制了用户可使用的标签键。条件使用 s3:RequestObjectTagKeys 条件键指定一组标签键。<code>用户可以在 PutObjectTagging 中发送空标签集，这是策略允许的 (请求中的空标签集将删除对象上的任何现有标签)</code></p><p>ForAllValues: 测试请求集的每个成员的值是否为条件键集的子集。如果请求中的<code>每个键值</code>均与策略中的至少一个值匹配，则条件返回 true。如果请求中没有键或者键值解析为空数据集（如空字符串），则也会返回 true,因为空集也是它的子集</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: [</span><br><span class="line">        <span class="string">"s3:PutObjectTagging"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Resource"</span>: [</span><br><span class="line">        <span class="string">"arn:aws:s3:::awsexamplebucket1/*"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Principal"</span>:&#123;</span><br><span class="line">        <span class="attr">"CanonicalUser"</span>:[</span><br><span class="line">            <span class="string">"64-digit-alphanumeric-value"</span></span><br><span class="line">         ]</span><br><span class="line">       &#125;,</span><br><span class="line">      <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">        <span class="attr">"ForAllValues:StringLike"</span>: &#123;</span><br><span class="line">          <span class="attr">"s3:RequestObjectTagKeys"</span>: [</span><br><span class="line">            <span class="string">"Owner"</span>,</span><br><span class="line">            <span class="string">"CreationDate"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以下权限策略将向用户授予执行 s3:PutObjectTagging 操作的权限，这使用户可以将标签添加到现有对象。条件限制了用户可使用的标签键。条件使用 s3:RequestObjectTagKeys 条件键指定一组标签键。<code>用户不可以在 PutObjectTagging 中发送空标签集</code></p><p>ForAnyValue: 测试请求值集的至少一个成员与条件键值集的至少一个成员匹配。如果请求中的任何一个键值与策略中的任何一个条件值匹配，则条件返回 true。对于没有匹配的键或空数据集，条件返回 false。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: [</span><br><span class="line">        <span class="string">"s3:PutObjectTagging"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Resource"</span>: [</span><br><span class="line">        <span class="string">"arn:aws:s3:::awsexamplebucket1/*"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Principal"</span>:&#123;</span><br><span class="line">        <span class="attr">"AWS"</span>:[</span><br><span class="line">            <span class="string">"arn:aws:iam::account-number-without-hyphens:user/username"</span></span><br><span class="line">         ]</span><br><span class="line">       &#125;,</span><br><span class="line">      <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">        <span class="attr">"ForAllValues:StringLike"</span>: &#123;</span><br><span class="line">          <span class="attr">"s3:RequestObjectTagKeys"</span>: [</span><br><span class="line">            <span class="string">"Owner"</span>,</span><br><span class="line">            <span class="string">"CreationDate"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"ForAnyValue:StringLike"</span>: &#123;</span><br><span class="line">          <span class="attr">"s3:RequestObjectTagKeys"</span>: [</span><br><span class="line">            <span class="string">"Owner"</span>,</span><br><span class="line">            <span class="string">"CreationDate"</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="存储桶中对象所有权"><a href="#存储桶中对象所有权" class="headerlink" title="存储桶中对象所有权"></a>存储桶中对象所有权</h4><p>存储桶策略指定只有当对象的 ACL 设置为 bucket-owner-full-control 时，账户 111122223333 才能将对象上传到 awsdoc-example-bucket。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">   <span class="attr">"Statement"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"Sid"</span>: <span class="string">"Only allow writes to my bucket with bucket owner full control"</span>,</span><br><span class="line">         <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">         <span class="attr">"Principal"</span>: &#123;</span><br><span class="line">            <span class="attr">"AWS"</span>: [</span><br><span class="line">               <span class="string">"arn:aws:iam::111122223333:user/ExampleUser"</span></span><br><span class="line">            ]</span><br><span class="line">         &#125;,</span><br><span class="line">         <span class="attr">"Action"</span>: [</span><br><span class="line">            <span class="string">"s3:PutObject"</span></span><br><span class="line">         ],</span><br><span class="line">         <span class="attr">"Resource"</span>: <span class="string">"arn:aws:s3:::awsdoc-example-bucket/*"</span>,</span><br><span class="line">         <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">            <span class="attr">"StringEquals"</span>: &#123;</span><br><span class="line">               <span class="attr">"s3:x-amz-acl"</span>: <span class="string">"bucket-owner-full-control"</span></span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="允许用户添加包含特定标签键和值的对象标签"><a href="#允许用户添加包含特定标签键和值的对象标签" class="headerlink" title="允许用户添加包含特定标签键和值的对象标签"></a>允许用户添加包含特定标签键和值的对象标签</h4><p>以下用户策略将向用户授予执行 s3:PutObjectTagging 操作的权限，这使用户可以在现有对象上添加标签。条件要求用户包含值设置为 Project 的特定标签 (X)。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: [</span><br><span class="line">        <span class="string">"s3:PutObjectTagging"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Resource"</span>: [</span><br><span class="line">        <span class="string">"arn:aws:s3:::awsexamplebucket1/*"</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"Principal"</span>:&#123;</span><br><span class="line">        <span class="attr">"AWS"</span>:[</span><br><span class="line">            <span class="string">"arn:aws:iam::account-number-without-hyphens:user/username"</span></span><br><span class="line">         ]</span><br><span class="line">       &#125;,</span><br><span class="line">      <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">        <span class="attr">"StringEquals"</span>: &#123;</span><br><span class="line">          <span class="attr">"s3:RequestObjectTag/Project"</span>: <span class="string">"X"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="允许查看存储桶列示内容的访问点策略"><a href="#允许查看存储桶列示内容的访问点策略" class="headerlink" title="允许查看存储桶列示内容的访问点策略"></a>允许查看存储桶列示内容的访问点策略</h4><p>以下访问点策略通过账户 123456789012 中的访问点 my-access-point 授予账户 123456789012 中的 IAM 用户 Charles 查看底层存储桶中包含的对象的权限。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>:<span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">        <span class="attr">"Principal"</span>: &#123;</span><br><span class="line">            <span class="attr">"AWS"</span>: <span class="string">"arn:aws:iam::123456789012:user/Charles"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"Action"</span>: <span class="string">"s3:ListBucket"</span>,</span><br><span class="line">        <span class="attr">"Resource"</span>: <span class="string">"arn:aws:s3:us-west-2:123456789012:accesspoint/my-access-point"</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>以上完全基于<a href="https://docs.aws.amazon.com/" target="_blank" rel="noopener">AWS官方文档</a> 和 <a href="https://amazonaws-china.com/cn/premiumsupport/knowledge-center/" target="_blank" rel="noopener">知识中心</a>，并结合自身理解创作</p><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> 存储类 </category>
          
          <category> S3 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS S3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AWS S3的服务等级协议(SLA)</title>
      <link href="2020/11/13/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/S3/AWS-S3%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AD%89%E7%BA%A7%E5%8D%8F%E8%AE%AE-SLA/"/>
      <url>2020/11/13/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/S3/AWS-S3%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AD%89%E7%BA%A7%E5%8D%8F%E8%AE%AE-SLA/</url>
      
        <content type="html"><![CDATA[<p>描述: AWS S3 服务等级协议(SLA)</p><a id="more"></a><p>首先给出官方原版文件：</p><p><a href="https://amazonaws-china.com/s3/sla/?nc1=h_ls" target="_blank" rel="noopener">AWS S3 服务等级协议</a><br><a href="https://d1.awsstatic-china.com/legal/amazons3service/Amazon-S3-Service-Level-Agreement-Chinese.pdf" target="_blank" rel="noopener">AWS S3 服务等级协议中文版</a></p><p>简单解释一下</p><p>当AWS的S3服务的每月正常运行时间低于某个值时，你可以申请AWS的S3服务积分，S3服务积分可以抵扣AWS的<strong>S3</strong>账单相当于S3优惠卷。<br>正常运行时间比|服务积分|大致的达成条件<br>-|-|-<br>99.9%-99%|10%|30天内平均每1000个请求至少失败一个或累计44分钟无法正常工作<br>99%-95%|25%|30天内平均每100个请求至少失败一个或累计7个半小时无法正常工作<br>&lt;95%|100%|30天内平均每20个请求至少失败一个或累计36个小时无法正常工作</p><p>之所以是大致达成条件是因为AWS的条件限制以5分钟内的平均失败率为准</p><p>举个例子：</p><p>假设，某月（30天）AWS S3持续故障一小时，并且公司A在这一小时内受到影响，导致完全无法使用S3，月内其余时间S3正常运行。</p><ul><li>情况1：</li></ul><p>这一小时内，公司A每5分钟访问S3一或多次，并且都得到error消息。<br>计算：<br>在这一个小时内，一共有12次100%的错误率<br>60 ➗ 5 = 12<br>整体错误率 = 平均每5分钟的错误率 = 每个5分钟错误率之和 / 30天内5分钟的数量<br>（12 * 100% + 0%【其余时间没有错误】）➗ （30 ✖️ 24 ✖️ 60 ➗ 5）= 0.139%<br>正常运行时间比<br>100% - 0.139% = 99.861%  </p><p><strong>结论：可以申请服务积分</strong></p><ul><li>情况2：</li></ul><p>这一小时内，公司A已知S3故障只有第一个5分钟内访问过S3一或多次，并且得到error消息。其余55分钟没有访问。<br>如果5分钟内没有任何请求，则该间隔错误率为0.</p><p>计算：<br>在这一个小时内，只有第一个5分钟是100%的错误率，其余时间没有访问所以错误率为0.<br>5 ➗ 5 = 1<br>整体错误率 = 平均每5分钟的错误率 = 每个5分钟错误率之和 / 30天内5分钟的数量<br>（1 * 100% + 0%【其余时间没有错误】）➗ （30 ✖️ 24 ✖️ 60 ➗ 5）= 0.0116%<br>正常运行时间比<br>100% - 0.0116% = 99.9884%  </p><p><strong>结论：无法申请服务积分</strong></p><p>以上只是申请理赔的必要条件，简单来说申请服务积分还需要</p><ol><li>必须在故障发生的第二个账单周期结束前通过AWS support center提交申请<br>一般理解为事故发生的两个月内，例如1月15日发生的故障必须在3月之前提交申请</li><li>申请的主题必须包含”SLA Credit Request”字样</li><li>带上发生故障AWS的region，发生的时间日期和发生次数</li><li>发生错误的日志<br>日志内的敏感信息以*号代替</li></ol><p>S3的免责条款大致内容</p><ol><li>不可抗力和网络接入<br>不可抗力很好理解，个人理解”网络接入”可能是指防火墙之类的</li><li>用户或第三方自愿作为或不作为<br>作为是指做了禁止的事，不作为指有义务做但是没做的事，例如需要升级CLI才能访问S3但是用户不升级导致无法访问</li><li>用户或第三方设备软件或其他技术导致</li><li>AWS协议中止或终止用户使用S3的权利导致<br>类似删号和封号</li></ol><p>以上完全基于<a href="https://docs.aws.amazon.com/" target="_blank" rel="noopener">AWS官方文档</a>，并结合自身理解创作</p><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> S3 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS S3 </tag>
            
            <tag> S3关键 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AWS-S3-2-功能</title>
      <link href="2020/11/13/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/S3/AWS-S3-2-%E5%8A%9F%E8%83%BD/"/>
      <url>2020/11/13/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/S3/AWS-S3-2-%E5%8A%9F%E8%83%BD/</url>
      
        <content type="html"><![CDATA[<p>描述: AWS S3的功能</p><a id="more"></a><!-- TOC --><ul><li><a href="#s3访问地址类型">S3访问地址类型</a></li><li><a href="#存储桶加密">存储桶加密</a><ul><li><a href="#存储桶加密分为3种">存储桶加密分为3种</a></li><li><a href="#加密总结">加密总结</a></li></ul></li><li><a href="#cors跨源资源共享">cors（跨源资源共享）</a></li><li><a href="#事件通知">事件通知</a></li><li><a href="#outposts">Outposts</a></li><li><a href="#生命周期">生命周期</a><ul><li><a href="#转换行为">转换行为</a></li><li><a href="#过期行为">过期行为:</a></li><li><a href="#针对过往对象版本的转换和过期行为">针对过往对象版本的转换和过期行为</a></li><li><a href="#注意事项">注意事项</a></li><li><a href="#生命周期日志">生命周期日志</a></li><li><a href="#生命周期示例httpsdocsawsamazoncomzh_cnamazons3latestdevlifecycle-configuration-exampleshtml"><a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/lifecycle-configuration-examples.html" target="_blank" rel="noopener">生命周期示例</a></a></li></ul></li><li><a href="#位置">位置</a></li><li><a href="#日志记录">日志记录</a></li><li><a href="#对象锁定">对象锁定</a></li><li><a href="#对象标签">对象标签</a></li><li><a href="#策略-和-acl访问控制列表">策略 和 ACL（访问控制列表）</a></li><li><a href="#分段上传">分段上传</a></li><li><a href="#复制">复制</a></li><li><a href="#requestpayment">requestPayment</a></li><li><a href="#访问点">访问点</a></li><li><a href="#传输加速transfer-acceleration">传输加速Transfer Acceleration</a><ul><li><a href="#cli示例">CLI示例</a></li></ul></li><li><a href="#版本控制">版本控制</a><ul><li><a href="#mfa-删除">MFA 删除</a></li></ul></li><li><a href="#网站">网站</a></li><li><a href="#账单和使用率报告">账单和使用率报告</a></li><li><a href="#结语">结语</a></li></ul><!-- /TOC --><h3 id="S3访问地址类型"><a href="#S3访问地址类型" class="headerlink" title="S3访问地址类型"></a>S3访问地址类型</h3><p>S3支持<code>虚拟托管类型访问</code>和<code>路径类型访问</code>, 虚拟托管访问是最新的访问方式.</p><p>Amazon S3 虚拟托管样式 URL 遵循如下所示格式:<br><code>https://bucket-name.s3.Region.amazonaws.com/key name</code></p><p>Amazon S3 路径样式 URL 遵循如下所示格式:<br><code>https://s3.Region.amazonaws.com/bucket-name/key name</code></p><p>S3 访问点仅支持虚拟主机式寻址:<br><code>https://AccessPointName-AccountId.s3-accesspoint.region.amazonaws.com.</code></p><p>路径样式原本与2020年9月23日废除但被延迟了.</p><h3 id="存储桶加密"><a href="#存储桶加密" class="headerlink" title="存储桶加密"></a>存储桶加密</h3><p>在为存储桶启用默认加密后，将会应用以下加密行为：</p><ul><li>在启用默认加密之前，存储桶中已存在的对象的加密没有变化。</li><li>在启用默认加密后上传对象时：<ul><li>如果您的 PUT 请求标头不包含加密信息，则 Amazon S3 将使用存储桶的默认加密设置来加密对象。</li><li>如果您的 PUT 请求标头包含加密信息，则 Amazon S3 将使用 PUT 请求中的加密信息加密对象，然后再将对象存储在 Amazon S3 中。</li></ul></li><li>如果您将 SSE-KMS 选项用于默认加密配置，则您将受到 AWS KMS 的 RPS (每秒请求数) 限制</li></ul><h4 id="存储桶加密分为3种"><a href="#存储桶加密分为3种" class="headerlink" title="存储桶加密分为3种"></a>存储桶加密分为3种</h4><ol><li>SSE-S3</li></ol><p>使用SSE-S3加密时，每个对象均使用唯一密钥加密。作为额外的保护，它将使用定期轮换的主密钥对密钥本身进行加密。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">aws s3api put-object \</span><br><span class="line">  --bucket text-content \</span><br><span class="line">  --key dir-1/my_images.tar.bz2 \</span><br><span class="line">  --body my_images.tar.bz2 \</span><br><span class="line">  --server-side-encryption AES256</span><br></pre></td></tr></table></figure><details><summary><strong>SSE-S3 Bucket Policy</strong></summary><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">  <span class="attr">"Id"</span>: <span class="string">"PutObjectPolicy"</span>,</span><br><span class="line">  <span class="attr">"Statement"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Sid"</span>: <span class="string">"DenyIncorrectEncryptionHeader"</span>,</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Deny"</span>,</span><br><span class="line">      <span class="attr">"Principal"</span>: <span class="string">"*"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: <span class="string">"s3:PutObject"</span>,</span><br><span class="line">      <span class="attr">"Resource"</span>: <span class="string">"arn:aws:s3:::awsexamplebucket1/*"</span>,</span><br><span class="line">      <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">        <span class="attr">"StringNotEquals"</span>: &#123;</span><br><span class="line">          <span class="attr">"s3:x-amz-server-side-encryption"</span>: <span class="string">"AES256"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"Sid"</span>: <span class="string">"DenyUnencryptedObjectUploads"</span>,</span><br><span class="line">      <span class="attr">"Effect"</span>: <span class="string">"Deny"</span>,</span><br><span class="line">      <span class="attr">"Principal"</span>: <span class="string">"*"</span>,</span><br><span class="line">      <span class="attr">"Action"</span>: <span class="string">"s3:PutObject"</span>,</span><br><span class="line">      <span class="attr">"Resource"</span>: <span class="string">"arn:aws:s3:::awsexamplebucket1/*"</span>,</span><br><span class="line">      <span class="attr">"Condition"</span>: &#123;</span><br><span class="line">        <span class="attr">"Null"</span>: &#123;</span><br><span class="line">          <span class="attr">"s3:x-amz-server-side-encryption"</span>: <span class="string">"true"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></details><ol start="2"><li>SSE-KMS</li></ol><p>SSE-KMS 与 SSE-S3 类似，使用该服务具有一些额外的好处，但也要额外收取费用。使用 CMK 需要单独的权限，该密钥可进一步防止未经授权地访问 Amazon S3 中的对象。意味着使用SSE-KMS加密的对象即使公开,如果访问者没有密钥的解密权限也依然无法访问该对象.SSE-KMS 还可以提供审核跟踪，显示 CMK 的使用时间和使用者。此外，还可以创建和管理客户托管 CMK，或者使用您、服务和区域独有的 AWS 托管 CMK。手动定期转换密钥也不要删除和禁用旧的密钥.</p><p><strong>重要: 删除和禁用KMS密钥后,曾被密钥加密的对象将不可读取</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 未指定kms-key-id,则使用默认的aws/s3 key</span><br><span class="line">aws s3api put-object \</span><br><span class="line">  --bucket text-content \</span><br><span class="line">  --key my_images.tar.bz2 \</span><br><span class="line">  --body my_images.tar.bz2 \</span><br><span class="line">  --server-side-encryption aws:kms</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 使用kms key arn</span><br><span class="line">aws s3api put-object \</span><br><span class="line">  --bucket text-content \</span><br><span class="line">  --key my_images.tar.bz2 \</span><br><span class="line">  --body my_images.tar.bz2 \</span><br><span class="line">  --server-side-encryption aws:kms \</span><br><span class="line">  --ssekms-key-id arn:aws:kms:us-east-1:123456789012:key/1234abcd-1234-abcd-1234-12345678abcd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 使用kms key 别名</span><br><span class="line">aws s3api put-object \</span><br><span class="line">  --bucket text-content \</span><br><span class="line">  --key my_images.tar.bz2 \</span><br><span class="line">  --body my_images.tar.bz2 \</span><br><span class="line">  --server-side-encryption aws:kms \</span><br><span class="line">  --ssekms-key-id arn:aws:kms:us-east-1:123456789012:alias/mykey</span><br></pre></td></tr></table></figure><ol start="3"><li>SSE-C</li></ol><p>使用具有客户提供密钥的服务器端加密 (SSE-C) 时，自己管理加密密钥，而 Amazon S3 管理加密（在它对磁盘进行写入时）和解密（在您访问您的对象时）.AWS不会保管用户密钥,用户要自己保存密钥,并自己控制对象和密钥之间的关系.</p><p><strong>重要:密钥丢失则数据丢失</strong></p><p>以下示例使用 Linux 命令行工具生成一个二进制 256 位 AES 密钥，然后将该密钥提供给 Amazon S3 以对上载的文件服务器端进行加密。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> dd if=/dev/urandom bs=1 count=32 &gt; sse.key</span><br><span class="line">32+0 records in</span><br><span class="line">32+0 records out</span><br><span class="line">32 bytes (32 B) copied, 0.000164441 s, 195 kB/s</span><br><span class="line"><span class="meta">#</span> 上传数据时需要带上用户自定义密钥</span><br><span class="line"><span class="meta">$</span> aws s3api put-object --bucket my-bucket --key mysse.html --body test.txt --sse-customer-key fileb://sse.key --sse-customer-algorithm AES256</span><br><span class="line">&#123;</span><br><span class="line">    "SSECustomerKeyMD5": "iVg8oWa8sy714+FjtesrJg==",</span><br><span class="line">    "SSECustomerAlgorithm": "AES256",</span><br><span class="line">    "ETag": "\"a6118e84b76cf98bf04bbe14b6045c6c\""</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 取回数据时也需要带上加密时所使用的密钥</span><br><span class="line"><span class="meta">$</span> aws s3api get-object --bucket my-bucket --sse-customer-key fileb://sse.key --sse-customer-algorithm AES256 --key mysse.html mysse.html</span><br></pre></td></tr></table></figure><h4 id="加密总结"><a href="#加密总结" class="headerlink" title="加密总结"></a>加密总结</h4><p>在第二和第三种加密方式下,对于对象的操作都需要相应地权限.</p><p>还有一种客户端加密方式.</p><p>要通过单个请求加密现有 Amazon S3 对象，可以使用 Amazon S3 批处理操作。您为 S3 批量操作提供要操作的对象的列表，批量操作调用相应的 API 来执行指定的操作。可以使用复制操作复制现有的未加密对象，并将新的加密对象写入同一存储桶。单个批量操作作业可对数十亿个包含 EB 级数据的对象执行指定操作。</p><p><em>使用 SSE-KMS 进行默认存储桶加密的 Amazon S3 存储桶不能用作 Amazon S3 服务器访问日志记录 的目标存储桶。对于服务器访问日志目标存储桶，仅支持 SSE-S3 默认加密。</em></p><p><a href="https://aws.amazon.com/cn/premiumsupport/knowledge-center/s3-object-encrpytion-keys/" target="_blank" rel="noopener">我该使用 AWS KMS 管理的密钥还是自定义 AWS KMS 密钥来加密 Amazon S3 中的对象</a></p><h3 id="cors（跨源资源共享）"><a href="#cors（跨源资源共享）" class="headerlink" title="cors（跨源资源共享）"></a>cors（跨源资源共享）</h3><p>可以配置存储桶以便允许跨源请求。<a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/cors.html" target="_blank" rel="noopener">https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/cors.html</a></p><p><a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/cors-troubleshooting.html" target="_blank" rel="noopener">问题排查</a></p><h3 id="事件通知"><a href="#事件通知" class="headerlink" title="事件通知"></a>事件通知</h3><p>您可以使存储桶向您发送特定存储桶事件的通知。</p><p>有关更多信息，请参阅 配置 Amazon S3 事件通知。</p><h3 id="Outposts"><a href="#Outposts" class="headerlink" title="Outposts"></a>Outposts</h3><p>AWS提供设备安装在客户的场所(借给你用),为期三年.提供更低的延迟和本地数据处理需求.可以像使用AWS一样使用这些资源. 主要是贵,无预付三年$194,652,有预付三年$169,444.(跟选择的计算容量有关).还不包含存储…</p><h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p>要管理对象以使其在整个生命周期内经济高效地存储，可以配置其 Amazon S3 生命周期。其本质是节约费用.S3 生命周期配置是一组规则，用于定义 Amazon S3 对一组对象应用的操作。小于 128 KB 的对象不会进行存储类型转换(因为没有经济效益).生命周期不支持启用了MFA删除的桶.有两种类型的操作：</p><ul><li><strong>转换操作</strong> — 定义一段时间后将对象自动转换为另一个存储类。</li><li><strong>过期操作</strong> — 定义对象的过期时间。Amazon S3 将代表你删除过期的对象。</li></ul><p>用例：</p><ul><li>定期将日志上传到一个存储桶，应用程序可能需要使用这些日志一个星期或一个月。之后，可能永远都不需要这些日志。</li><li>在限定的时间段内可能需要经常访问某些文档。自此之后，这些文档很少被访问。有时，可能不需要对这些文档进行实时访问，但是公司可能要求将它们存档一段特定的时间。之后，可以删除这些文档</li><li>可以主要为了存档目的而将一些类型的数据上传到 Amazon S3。例如，您可以存档数字媒体、财务和健康记录、原始基因组序列数据、长期数据库备份，以及为遵从法规而必须保留的数据</li></ul><h4 id="转换行为"><a href="#转换行为" class="headerlink" title="转换行为"></a>转换行为</h4><p>一切转换行为都是对当前版本操作.转换行为可以理解为从高费用向低费用转换,不可逆.例如，可以选择在对象创建 30 天后将其转换为 S3 标准-IA 存储类，或在对象创建 1 年后将其存档到 S3 Glacier 存储类。<br>可以进行以下转换：</p><ul><li>从 S3 标准 存储类转换为任何其他存储类。</li><li>任何存储类转换为 S3 Glacier 或 S3 Glacier Deep Archive 存储类。</li><li>从 S3 标准-IA 存储类转换为 S3 智能分层 或 S3 单区-IA 存储类。</li><li>从 S3 智能分层 存储类转换为 S3 单区-IA 存储类。</li><li>从 S3 Glacier 存储类转换为 S3 Glacier Deep Archive 存储类。</li></ul><h4 id="过期行为"><a href="#过期行为" class="headerlink" title="过期行为:"></a>过期行为:</h4><p>一切过期行为都是对当前版本操作.过期操作如果删除了没到存储类最低存储对象的收费期的对象,则按照存储类的最低日期收费,例如IA类最低存储30天,但是在10天就删除了,也按照30天时间收费.Glacier最低90天,Deep Archive最低180天.</p><ul><li><strong>不受版本控制的存储桶</strong>: 过期操作将永久删除未启用版本控制的存储桶中的对象</li><li><strong>已启用版本控制的存储桶</strong>: 正常情况Amazon将新建一个具有唯一的版本ID的删除标记的对象.如果当前对象版本是唯一一个且具有删除标记的对象版本,AWS会删除这个标记版本,因为该对象实际已经不存在了.如果该对象具有多个版本且当前版本具有删除标记,则AWS不做任何操作.</li><li><strong>已暂停版本控制的存储桶</strong>: 正常情况Amazon将新建一个具有null版本ID的删除标记的对象.删除标记会在版本层次结构中将替换版本ID为null的对象版本，从而实际上删除版本标记为null的对象。其他行为与已启用版本控制的存储桶一致</li></ul><h4 id="针对过往对象版本的转换和过期行为"><a href="#针对过往对象版本的转换和过期行为" class="headerlink" title="针对过往对象版本的转换和过期行为"></a>针对过往对象版本的转换和过期行为</h4><p>转换和过期行为都是在从对象变为非当前时开始的.例如，可以配置一个到期规则，以便在对象变为非当前版本五天后删除非当前版本。例如，假设在 2014 年 1 月 1 日上午 10:30 UTC，您创建了名为 photo.gif 的对象 (版本 ID 111111)。在 2014 年 2 月 1 日上午 11:30 UTC，您意外删除了 photo.gif (版本 ID 111111)，这将导致使用新版本 ID (如版本 ID 4857693) 创建一个删除标记。您现在有五天时间可以在永久删除之前，恢复原始版本的 photo.gif (版本 ID 111111)。在 2014 年 1 月 8 日 00:00 UTC，有关过期的生命周期规则执行并永久删除 photo.gif（版本 ID 111111）（在它成为非当前版本五天之后）。</p><p><a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/intro-lifecycle-rules.html#intro-lifecycle-rules-actions" target="_blank" rel="noopener">生命周期与版本控制具体行为</a></p><h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><p>Amazon S3 按以下方式计算时间：将在规则中指定的天数与对象创建时间相加，然后将得出的时间舍入至下一日的午夜 UTC。例如，如果对象的创建时间是 2014 年 1 月 15 日上午 10:30 UTC，并且您在转换规则中指定了 3 天，则对象的转换日期将计算为 2014 年 1 月 19 日 00:00 UTC。</p><p>版本控制示例: Amazon S3 按以下方式计算时间,将规则中指定的天数与创建对象新后继者版本的时间相加，然后将得出的时间舍入至下一日的午夜 UTC。例如，在您的存储桶中，假设某个对象的当前版本的创建时间是 2014 年 1 月 1 日上午 10:30 UTC。如果替换当前版本的对象新版本的创建时间是 2014 年 1 月 15 日上午 10:30 UTC，并且您在转换规则中指定了 3 天，则对象的转换日期计算为 2014 年 1 月 19 日 00:00 UTC。</p><p>如果为S3 生命周期操作指定一个过去的日期，所有合格对象会立即符合该生命周期操作的条件,包括新上传的对象.</p><p>生命周期配置可以同时存在多个:</p><ul><li>对相同对象的操作且两个过期策略重叠，将采用较短的过期策略，以便数据存储不会超过预期时间。例如一个策略在30天转化为STANDARD_IA,一个在90天转化为ARCHIVE</li><li>对相同对象的操作且两个但策略不同. 例如策略一,30天后转化存储类型;策略二30天后删除对象.策略二生效</li><li>对象筛选存在包含关系,符合第一个规则.例如策略一对象为全体对象10天后类型转换;策略二以log/为前缀的对象365天后类型转化.策略一生效.</li><li>对象标签冲突.策略一带有tag1/value1标签的对象10天后过期;策略二带有tag2/value2标签的对象100天后转换存储,有对象同时具备2个标签,策略一生效</li></ul><h4 id="生命周期日志"><a href="#生命周期日志" class="headerlink" title="生命周期日志"></a>生命周期日志</h4><p>CloudTrail 捕获向外部 Amazon S3 终端节点发起的 API 请求，而S3 生命周期操作是使用内部 Amazon S3 终端节点执行的。可以在一个 S3 存储桶中启用 Amazon S3 服务器访问日志，以捕获S3 生命周期相关操作，例如，对象转换到另一个存储类，以及对象失效导致永久删除或逻辑删除。<a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/lifecycle-and-other-bucket-config.html#lifecycle-general-considerations-mfa-enabled-bucket" target="_blank" rel="noopener">More Detail</a></p><h4 id="生命周期示例"><a href="#生命周期示例" class="headerlink" title="生命周期示例"></a><a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/lifecycle-configuration-examples.html" target="_blank" rel="noopener">生命周期示例</a></h4><p>示例 1：指定筛选条件<br>示例 2：禁用生命周期规则<br>示例 3：在对象的生命周期内逐步将存储类降级<br>示例 4：指定多个规则<br>示例 5：重叠的筛选条件、冲突的生命周期操作以及 Amazon S3 的功能<br>示例 6：为启用了版本控制的存储桶指定生命周期规则<br>示例 7：移除过期对象删除标记<br>示例 8：用于中止分段上传的生命周期配置</p><h3 id="位置"><a href="#位置" class="headerlink" title="位置"></a>位置</h3><p>创建存储桶时，请指定需要 Amazon S3 在其中创建存储桶的 AWS 区域。Amazon S3 将此信息存储在位置子资源中并提供 API 用于检索此信息。</p><h3 id="日志记录"><a href="#日志记录" class="headerlink" title="日志记录"></a>日志记录</h3><p>日志记录使您可以跟踪针对存储桶的访问请求。每个访问日志记录都提供有关单个访问请求的详细信息，如请求者、存储桶名称、请求时间、请求操作、响应状态和错误代码 (如果有)。访问日志信息可能在安全和访问审核方面十分有用。它还可以帮助您了解您的客户群并了解您的 Amazon S3 账单。 </p><p>有关更多信息，请参阅 Amazon S3 服务器访问日志记录。</p><h3 id="对象锁定"><a href="#对象锁定" class="headerlink" title="对象锁定"></a>对象锁定</h3><p>可以​使用对象锁定在固定的时间段内或无限期地阻止删除或覆盖对象.要使用 S3 对象锁定，必须在创建存储桶时启用(目前不支持在创建存储桶之后启用对象锁定)。还可以选择配置将应用于存储桶中放置的新对象的默认保留模式和保留期限。</p><p>对象锁定是基于版本控制的,所以具有版本控制功能,它加强了对于删除的保护功能.</p><ul><li>只能为新存储桶启用 对象锁定。如果要为现有存储桶开启 对象锁定，请联系 AWS Support。</li><li>如果创建存储桶时启用了 对象锁定，Amazon S3 将自动为该存储桶启用版本控制。</li><li>如果在创建存储桶时启用了对象锁定，将无法为该存储桶禁用对象锁定或暂停版本控制。</li></ul><p>相关权限:<br>s3:GetObjectRetention<br>s3:PutObjectLegalHold<br>s3:GetObjectLegalHold<br>s3:GetBucketObjectLockConfiguration<br>s3:BypassGovernanceRetention</p><p>对象锁定仅适用于受版本控制的存储桶，保留期限和依法保留则适用于单个对象版本。当锁定某一对象版本时，Amazon S3 会将锁定信息存储在该对象版本的元数据中。对对象实施保留期限或依法保留仅保护在请求中指定的版本。它不阻止创建该对象的新版本。如果将一个与现有的受保护对象键名相同的对象放在存储桶中，Amazon S3 将创建该对象的新版本、将其存储在请求的存储桶中，并将该请求报告为已成功完成。现有受保护版本的对象将根据其保留配置保持锁定状态。</p><p>对象版本可以同时具有保留期限和依法保留、具有其中任何一个或不具有任何一个。</p><p>依法保留是一个持续状态直到明确取消,没有保留期限.</p><p>S3 对象锁定中的保留期限提供两种保留模式：</p><ul><li>监管模式<br>监管模式允许具有 s3:BypassGovernanceRetention 权限的用户删除，但必须在需要覆盖监管模式的任何请求中显式包含 x-amz-bypass-governance-retention.S3 控制台默认添加bypass-governance-retention: true.</li><li>合规性模式<br>在合规性 模式中，任何用户都不能覆盖或删除受保护的对象版本，包括 AWS 账户中的根用户。在合规性模式下锁定对象后，其保留模式便无法更改，其保留期限也不能缩短。合规性模式确保在保留期限内无法覆盖或删除对象版本。</li></ul><h3 id="对象标签"><a href="#对象标签" class="headerlink" title="对象标签"></a>对象标签</h3><p>可以将 10 个标签与对象关联.键和值区分大小写.标签采用了最终一致性模型。还可以使用标签进行对象分类,就像对象键名前缀分类存储。但是，基于前缀的分类是一维的。参考以下对象键名：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">photos/photo1.jpg</span><br><span class="line">photos/photo2.jpg</span><br><span class="line">project/project1/document.pdf</span><br><span class="line">project/project2/document2.pdf</span><br></pre></td></tr></table></figure><p>这些键名具有前缀 photos/、project/project1/ 和 project/project2/。这些前缀支持一维分类。即，一个前缀下的一切都属于一个类别。例如，前缀 project/project1 可确定与项目project1相关的所有文档。</p><p>除了数据分类之外，标签还提供了下列好处：</p><ul><li>对象标签支持权限的精细访问控制。例如，可以向一个 IAM 用户授予仅读取带有特定标签的对象的权限。</li><li>对象标签支持精细的对象生命周期管理，在其中，除了在生命周期规则中指定键名前缀之外，还可以指定基于标签的筛选条件。</li><li>使用 Amazon S3 分析时，可以配置筛选条件，以便按对象标签、键名前缀或前缀和标签的组合对对象进行分组以进行分析。</li><li>还可以自定义 Amazon CloudWatch 指标以按特定标签筛选条件显示信息。</li></ul><p>例如可以对对象添加Department, Environment, Project 和 CostCenter等标签.</p><h3 id="策略-和-ACL（访问控制列表）"><a href="#策略-和-ACL（访问控制列表）" class="headerlink" title="策略 和 ACL（访问控制列表）"></a>策略 和 ACL（访问控制列表）</h3><p>所有资源（如存储桶和对象）在默认情况下均为私有。Amazon S3 支持存储桶策略和访问控制列表 (ACL) 选项，供您用于授予和管理存储桶级权限。Amazon S3 将权限信息存储在策略 和 acl 子资源中。</p><p>有关更多信息，请参阅 Amazon S3 中的 Identity and Access Management。</p><h3 id="分段上传"><a href="#分段上传" class="headerlink" title="分段上传"></a>分段上传</h3><p>分段上传允许上传单个对象作为一组分段。每个分段都是对象数据的连续部分。可以独立上传以及按任意顺序上传这些对象分段。如果任意分段传输失败，可以重新传输该分段且不会影响其他分段。当对象的所有段都上传后，Amazon S3 将这些段汇编起来，然后创建对象。一般而言，如果您的对象大小达到了 100 MB，您应该考虑使用分段上传，而不是在单个操作中上传对象。</p><p>最佳实践是使用 aws s3 命令（例如 aws s3 cp）进行上传和下载，因为这些 aws s3 命令会根据文件大小自动执行分段上传和下载。相比之下，只有在 aws s3 命令不支持特定上传需求（例如，当分段上传涉及多个服务器时，手动停止分段上传并稍后恢复）或者 aws s3 命令不支持所需的请求参数时，才应使用 aws s3api 命令（例如 aws s3api create-multipart-upload）</p><p>使用分段上传可提供以下优势：</p><ul><li>提高吞吐量 – 可以并行上传分段以提高吞吐量。</li><li>从任何网络问题中快速恢复 - 较小的分段大小可以将由于网络错误而需重启失败的上传所产生的影响降至最低。</li><li>暂停和恢复对象上传 – 可以在一段时间内逐步上传对象分段。启动分段上传后，不存在过期期限；必须显式地完成或停止分段上传。</li><li>知道对象的最终大小前开始上传 – 可以在创建对象时将其上传。</li></ul><h3 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h3><p>复制是在相同或跨不同 AWS 区域中的存储桶自动、异步地复制对象。有关更多信息，请参阅复制。</p><h3 id="requestPayment"><a href="#requestPayment" class="headerlink" title="requestPayment"></a>requestPayment</h3><p>默认情况下，S3的存储费用和数据流量费用都由S3的拥有者支付.但是当想共享数据，又不希望产生与访问数据等其他操作相关联的费用时，可以将存储桶配置为申请方付款。例如，当使大型数据集 (如邮政编码目录、参考数据、地理空间信息、网盘存储或网络爬取数据) 等,可以使用申请方付款.简单来说请求方支付数据传输和请求方面的费用；存储桶拥有者支付数据存储方面的费用。</p><p>配置为申请方付款存储桶后，请求方必须在其请求中包含 x-amz-request-payer (在 POST、GET 和 HEAD 请求的标头中，或在 REST 请求中作为参数)，以显示他们明确知道请求和数据下载将产生费用。requestPayment是存储桶级别的,不能对特定对象使用.</p><p>但是以下行为依然会向S3拥有者收费,虽然他们的请求失败了:</p><ul><li>申请方未在标头中 (GET、HEAD 或 POST) 包含参数 x-amz-request-payer，或未在请求中将其作为参数 (REST) (HTTP 代码 403)。</li><li>请求身份验证失败 (HTTP 代码 403)。</li><li>请求是匿名的 (HTTP 代码 403)。</li><li>请求是 SOAP 请求。</li></ul><p>有关更多信息，请参阅 申请方付款存储桶。</p><h3 id="访问点"><a href="#访问点" class="headerlink" title="访问点"></a>访问点</h3><p>Amazon S3 访问点简化了 S3 中共享数据集的大规模数据访问管理。访问点是附加到存储桶的命名网络终端节点，您可以使用这些存储桶执行 S3 对象操作（如 GetObject 和 PutObject）。每个访问点都具有不同的权限和网络控制，S3 将它们应用于通过该访问点发出的任何请求。每个访问点强制实施自定义访问点策略，该策略与附加到底层存储桶的存储桶策略结合使用。可以将任何访问点配置为仅接受来自 Virtual Private Cloud (VPC) 的请求，以限制专用网络的 Amazon S3 数据访问。还可以为每个访问点配置自定义阻止公有访问设置。使用访问点来执行对象操作。不能使用访问点执行其他 Amazon S3 操作，例如修改或删除存储桶。</p><p>对于通过访问点发出的任何请求，Amazon S3 会评估该访问点、底层存储桶和存储桶拥有者账户的阻止公有访问设置。如果这些设置中的任何一个指示应阻止请求，则 Amazon S3 会拒绝请求。</p><p>向存储桶添加 S3 访问点不会更改存储桶在通过现有存储桶名称或 ARN 访问时的行为。针对存储桶的所有现有操作将继续像以前一样运行。访问点策略中的限制仅适用于通过该访问点发出的请求。</p><p><a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/using-access-points.html#access-points-service-api-support" target="_blank" rel="noopener">访问点与 S3 操作和 AWS 服务的兼容性</a></p><p><a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/access-points-restrictions-limitations.html" target="_blank" rel="noopener">访问点的限制</a></p><h3 id="传输加速Transfer-Acceleration"><a href="#传输加速Transfer-Acceleration" class="headerlink" title="传输加速Transfer Acceleration"></a>传输加速Transfer Acceleration</h3><p>Transfer Acceleration 可在客户端与 S3 存储桶之间实现快速、轻松、安全的远距离文件传输。Transfer Acceleration 利用 Amazon CloudFront 的全球分布式边缘站点。启用后有最大0.08 USD/GB的双向流量收费.</p><p>什么时候启用加速:</p><ul><li>位于全球各地的客户需要上传到集中式存储桶</li><li>定期跨大洲传输数 GB 至数 TB 数据</li><li>在上传到 Amazon S3 时无法充分利用 Internet 上的所有可用带宽</li></ul><p><a href="https://s3-accelerate-speedtest.s3-accelerate.amazonaws.com/en/accelerate-speed-comparsion.html" target="_blank" rel="noopener">加速效果比较</a></p><p>借助传输加速终端节点执行所有 Amazon S3 操作，但以下操作除外：<code>GET 服务（列出存储桶）</code>、<code>PUT 存储桶（创建存储桶）</code>和 <code>DELETE 存储桶</code>。此外，Amazon S3 Transfer Acceleration不支持使用 <code>PUT Object - Copy</code> 进行跨区域复制。</p><p>启用加速后,加速终端节点将随即可用,但最多 20 分钟后才可实现性能提升.使用加速终端节点才能有性能提升.加速终端节点名称类似:</p><ul><li>bucketname.s3-accelerate.amazonaws.com</li><li>bucketname.s3-accelerate.dualstack.amazonaws.com</li></ul><p>重新使用标准上传速度，只需将名称更改回 <code>mybucket.s3.us-east-1.amazonaws.com</code></p><h4 id="CLI示例"><a href="#CLI示例" class="headerlink" title="CLI示例"></a>CLI示例</h4><ol><li><p>下示例设置 Status=Enabled 以对存储桶启用 Transfer Acceleration。可使用 Status=Suspended 暂停 Transfer Acceleration</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3api put-bucket-accelerate-configuration --bucket bucketname --accelerate-configuration Status=Enabled</span><br></pre></td></tr></table></figure></li><li><p>下示例在默认配置文件中将 use_accelerate_endpoint 设置为 true</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws configure set default.s3.use_accelerate_endpoint true</span><br></pre></td></tr></table></figure></li><li><p>需要对某些 AWS CLI 命令使用加速终端节点，但不对其他此类命令使用加速终端节点，则可使用以下两种方法中的任一方法：</p><ul><li>通过将任何 s3 或 s3api 命令的 –endpoint-url 参数设置为 <a href="https://s3-accelerate.amazonaws.com" target="_blank" rel="noopener">https://s3-accelerate.amazonaws.com</a> 或 <a href="http://s3-accelerate.amazonaws.com" target="_blank" rel="noopener">http://s3-accelerate.amazonaws.com</a> 来对每条命令使用加速终端节点</li><li>可以在 AWS Config 文件中设置单独的配置文件。例如，创建一个将 use_accelerate_endpoint 设置为 true 的配置文件和一个不设置 use_accelerate_endpoint 的配置文件。在运行一条命令时，根据是否需要使用加速终端节点来指定要使用的配置文件</li></ul></li><li><p>将对象上传到已启用 Transfer Acceleration 的存储桶的 AWS CLI 示例<br>以下示例通过使用已配置为使用加速终端节点的默认配置文件来将文件上传到已启用 Transfer Acceleration 的存储桶。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws s3 cp file.txt s3://bucketname/keyname --profile Enable_Acceleration</span><br></pre></td></tr></table></figure><p>以下示例通过使用 –endpoint-url 参数指定加速终端节点来将文件上传到已启用 Transfer Acceleration 的存储桶。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aws configure set s3.addressing_style virtual</span><br><span class="line">aws s3 cp file.txt s3://bucketname/keyname --region region --endpoint-url http://s3-accelerate.amazonaws.com</span><br></pre></td></tr></table></figure></li></ol><h3 id="版本控制"><a href="#版本控制" class="headerlink" title="版本控制"></a>版本控制</h3><p><a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/Versioning.html" target="_blank" rel="noopener">版本控制详情</a></p><p>版本控制可帮助恢复意外覆盖和删除。一旦对存储桶启用了版本控制，它将无法返回到无版本控制状态。但是，可以在该存储桶上暂停版本控制。存储桶可处于以下三种状态之一：非版本化 (默认) 、启用版本控制或暂停版本控制.启用版本控制，Amazon S3 会自动为要存储的对象生成唯一版本 ID。例如，在一个存储桶中，可以拥有两个具有相同键的对象，但版本 ID 却不同，例如 photo.gif (版本 111111) 和 photo.gif (版本 121212)。</p><p>版本控制状态将应用到该存储桶中的所有 (不是某些) 对象。第一次对存储桶启用版本控制后，该存储桶中的对象将在之后一直受版本控制，并具有唯一的版本 ID。请注意以下几点：</p><ul><li>在设置版本控制状态之前存储在存储桶中的对象具有版本 ID null。启用版本控制时，存储桶中的现有对象不会更改。更改的是 Amazon S3 在以后的请求中处理这些对象的方式。</li><li>存储桶拥有者 (或任何具有适当权限的用户) 可以暂停版本控制以停止累积对象版本。暂停版本控制时，存储桶中的现有对象不会更改。更改的是 Amazon S3 在以后的请求中处理对象的方式。</li></ul><p>通过启用了版本控制的存储桶可以恢复因意外删除或覆盖操作而失去的对象。例如：</p><ul><li>如果删除对象 (而不是永久移除它)，则 Amazon S3 会插入删除标记，并创建新的版本作为当前版本,访问时会有noSuchKey。始终可以恢复以前的版本。</li><li>如果覆盖对象，则会导致存储桶中出现新的对象版本。始终可以恢复以前的版本。</li></ul><p>版本控制的其中一个价值主张是能够检索对象的早期版本。有两种方法可执行该操作：</p><ul><li>将对象的早期版本复制到同一存储桶中<br>复制的对象将成为该对象的当前版本，且所有对象版本都保留。</li><li>永久删除对象的当前版本<br>当您删除当前对象版本时，实际上会将先前版本转换为该对象的当前版本。</li></ul><p>在存储桶上暂停版本控制后，Amazon S3 会自动将后续对象的存储操作(Put,Post,Copy)添加 null 版本 ID,如果存储桶原本就具有版本ID为 null的对象,那么这个对象将被覆盖</p><p>在存储桶上暂停版本控制后，DELETE 请求：</p><ul><li>可以仅删除其版本 ID 为 null 的对象<br>如果存储桶中没有对象的空版本，则不删除任何内容。</li><li>将删除标记插入到存储桶。<br>Amazon S3 会插入删除标记，并创建新的版本作为当前版本,访问时会有noSuchKey。</li></ul><p><strong>永久删除启用版本控制的对象需要在DELETE 请求带上version ID</strong></p><p>版本对象最好与生命周期结合使用.版本控制会收取所有版本的存储费用.</p><h4 id="MFA-删除"><a href="#MFA-删除" class="headerlink" title="MFA 删除"></a>MFA 删除</h4><p>所有授权 IAM 用户都可以启用版本控制，但只有存储桶拥有者 (根账户) 才能启用 MFA 删除。 启用后<code>更改存储桶的版本控制状态</code>以及<code>永久删除对象版本</code>需要MFA认证.更安全.</p><p><a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/Versioning.html" target="_blank" rel="noopener">版本控制详解</a><br><a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/troubleshooting.html#troubleshooting-by-symptom-increase-503-reponses" target="_blank" rel="noopener">启用版本控制后，Amazon S3 对存储桶请求的 HTTP 503 响应显著增加</a></p><h3 id="网站"><a href="#网站" class="headerlink" title="网站"></a>网站</h3><p>可以配置存储桶以便用于静态网站托管。Amazon S3 通过创建网站 子资源来存储此配置。</p><h3 id="账单和使用率报告"><a href="#账单和使用率报告" class="headerlink" title="账单和使用率报告"></a>账单和使用率报告</h3><p><a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/BucketBilling.html" target="_blank" rel="noopener">https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/BucketBilling.html</a></p><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>以上完全基于<a href="https://docs.aws.amazon.com/" target="_blank" rel="noopener">AWS官方文档</a>，并结合自身理解创作</p><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> 存储类 </category>
          
          <category> S3 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS S3 </tag>
            
            <tag> S3基础入门 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AWS-S3-1-概述</title>
      <link href="2020/11/13/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/S3/AWS-S3-1-%E6%A6%82%E8%BF%B0/"/>
      <url>2020/11/13/AWS/%E5%AD%98%E5%82%A8%E7%B1%BB/S3/AWS-S3-1-%E6%A6%82%E8%BF%B0/</url>
      
        <content type="html"><![CDATA[<p>描述: AWS-S3-1-概述</p><a id="more"></a><!-- TOC --><ul><li><a href="#概述">概述</a><ul><li><a href="#基本概念">基本概念</a></li></ul></li><li><a href="#对象">对象</a><ul><li><a href="#对象命名要注意的问题">对象命名要注意的问题</a></li><li><a href="#对象元数据httpsdocsawsamazoncomzh_cnamazons3latestdevusingmetadatahtmlobject-metadata"><a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/UsingMetadata.html#object-metadata" target="_blank" rel="noopener">对象元数据</a></a></li></ul></li><li><a href="#存储类别和定价">存储类别和定价</a><ul><li><a href="#s3-存储分类">S3 存储分类</a></li><li><a href="#对象存储类别httpsdocsawsamazoncomzh_cnamazons3latestdevstorage-class-introhtml"><a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/storage-class-intro.html" target="_blank" rel="noopener">对象存储类别</a></a></li><li><a href="#s3-价格">S3 价格</a><ul><li><a href="#存储费用">存储费用</a></li><li><a href="#数据传输费用">数据传输费用</a></li></ul></li></ul></li><li><a href="#amazon-s3-数据一致性模型">Amazon S3 数据一致性模型</a></li><li><a href="#限制">限制</a></li><li><a href="#注意事项">注意事项</a></li><li><a href="#aws-集成">AWS 集成</a></li><li><a href="#结语">结语</a></li></ul><!-- /TOC --><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Amazon Simple Storage Service (Amazon S3) 是一项面向 Internet 的对象存储服务。您可以通过 Amazon S3 随时在 Web 上的任何位置存储和检索的任意大小的数据。Amazon S3 仅按照实际使用容量收费，没有任何隐性收费和超容量收费。这为开发人员提供了一种可变成本服务，这种服务可以伴随业务共同发展，同时还可以享受 AWS 的基础设施成本优势。</p><p>我们使用一个东西我们会问，它能用来干什么：</p><ol><li>备份和存储 – 为其他应用程序提供数据备份和存储服务。</li><li>应用程序托管 – 提供部署、安装和管理 Web 应用程序的服务。</li><li>媒体托管 – 构建托管视频、照片或音乐上传和下载的高可用性、冗余式、可扩展基础设施。</li><li>软件传输 – 托管可供客户下载的软件应用程序。</li></ol><p>下一个问题，对象存储服务很多公司都有，为什么选择S3：</p><ol><li>无限容量 - 单个bucket没有容量限制，可以无限存储，但是单个对象最大为5T</li><li>对象版本控制 - 版本控制无需解释吧</li><li>对象生命周期控制 - 例如对象只存储7天，自动删除</li><li>智能分层 - 短时间频繁访问的数据，一周后不一定还有人访问，可以将不频繁访问的数据自动归档节约成本</li><li>可以托管静态网站 - 例如放入html可以当个网站来用</li><li>精细的权限控制</li><li>可以使用 BitTorrent 协议</li><li>使用基于标准的 REST 接口</li><li>在指定年度内为对象提供 99.999999999% 的持久性和 99.99% 的可用性</li><li>落盘加密,Amazon S3 在将对象保存到其磁盘上之前对其进行加密，并在下载对象时对其进行解密。</li></ol><h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><ul><li>存储桶 - bucket 存储对象的容器</li><li>对象 - object 要存储的对象（文件，音频，视频等）</li><li>键 - key 对象存入存储桶后唯一的标识符</li><li>区域 - 你选择的AWS S3服务的所在位置</li></ul><h3 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h3><p>Amazon S3 存储桶和对象没有层次结构。但是，通过在对象键名中使用前缀和分隔符，Amazon S3 控制台和 AWS 开发工具包可以推断层次结构并引入文件夹的概念。</p><h4 id="对象命名要注意的问题"><a href="#对象命名要注意的问题" class="headerlink" title="对象命名要注意的问题"></a>对象命名要注意的问题</h4><ol><li>可能需要特殊处理的字符</li></ol><p>键名中的以下字符可能需要另外进行代码处理，并且可能需要以十六进制形式在 URL 中编码或引用。其中部分字符是不可打印的字符，浏览器可能无法处理它们，这也需要特殊处理：</p><ul><li>表示和的符号 (“&amp;”)</li><li>美元 (“$”)</li><li>ASCII 字符范围 00–1F 十六进制（0–31 十进制）和 7F（127 十进制）</li><li>“At”符号 (“@”)</li><li>等于 (“=”)</li><li>分号 (“;”)</li><li>冒号 (“:”)</li><li>加号 (“+”)</li><li>空格 – 大量连续空格可能会在某些使用情形中丢失（特别是多个空格）</li><li>逗号 (“,”)</li><li>问号 (“?”)</li></ul><ol start="2"><li>要避免的字符</li></ol><p>避免在键名中使用以下字符，因为这些字符需要进行大量的特殊处理，才能在所有应用程序间保持一致性。</p><ul><li>反斜杠 (“&quot;)</li><li>左大括号 (“{”)</li><li>不可打印的 ASCII 字符（128–255 十进制字符）</li><li>插入符号 (“^”)</li><li>右大括号 (“}”)</li><li>百分比字符 (“%”)</li><li>重音符/反勾号 (“`”)</li><li>右方括号 (“]”)</li><li>引号</li><li>“大于”符号 (“&gt;”)</li><li>左方括号 (“[”)</li><li>波浪字符 (“~”)</li><li>“小于”符号（“&lt;”）</li><li>“井号”字符 (“#”)</li><li>竖线 (“|”)</li></ul><h4 id="对象元数据"><a href="#对象元数据" class="headerlink" title="对象元数据"></a><a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/UsingMetadata.html#object-metadata" target="_blank" rel="noopener">对象元数据</a></h4><h3 id="存储类别和定价"><a href="#存储类别和定价" class="headerlink" title="存储类别和定价"></a>存储类别和定价</h3><h4 id="S3-存储分类"><a href="#S3-存储分类" class="headerlink" title="S3 存储分类"></a>S3 存储分类</h4><p>存储大致分为4类，每种的适用性不同，</p><ol><li>经常访问对象的存储类 </li></ol><p>S3标准，频繁访问层，适用于经常访问的数据，标准费用</p><ol start="2"><li>不经常访问对象的存储类</li></ol><p>S3标准-IA（Infrequent Access），不频繁访问层，不经常访问对象的存储类称为IA，费用比标准费用低一些。又分为两类，S3 标准-IA（也就是多可用区）和S3 单区-IA</p><table><thead><tr><th>类别</th><th>价格</th><th>可用性</th></tr></thead><tbody><tr><td>S3 标准-IA</td><td>高</td><td>高</td></tr><tr><td>S3 单区-IA</td><td>低</td><td>低</td></tr></tbody></table><ol start="3"><li>S3智能分层</li></ol><p>结合了<code>1</code>和<code>2</code>，当数据30天内没有访问就自动将对象从<code>S3标准</code>转变为<code>S3标准IA</code>,如果不频繁访问层中的对象被访问，则对象将自动移回频繁访问层。但是智能分层要收取一个0.0025 USD/1000 个对象的管理费. 在 S3 智能分层存储类中的访问层之间移动对象时，不会产生额外的分层费用。</p><ol start="4"><li>存档对象的存储类</li></ol><p><code>S3 Glacier</code> 和 <code>S3 Glacier Deep Archive</code> 存储类别是专门为低成本的数据存档而设计的。费用很低，只有标准存储的5分之一，适合在政策层面上要求长时间存储的数据，对象不可用于实时访问。而上述<code>1</code>，<code>2</code>，<code>3</code>都可以实时访问。</p><p>例如，证券公司或者财务公司要求对客户资料必须存储2年以上，但其实存储之后并不会频繁访问而仅是用于备份。如果需要访问存档对象的话，需要提前<code>解冻</code>时间在几分钟到2天不等。</p><p>简单理解就是存档对象进行了加压，读取时需要解压所以需要时间</p><p>存储类别   |设计专门针对                              |持久性(设计目标)|可用性|可用区|最小存储持续时间|最小可计费对象|其他考虑因素<br>|-|-|-|-|-|-|-|-|<br>S3 标准    |经常访问的数据                            |99.999999999%   |99.99%|&gt;=3   |无              |无            |无<br>S3 标准-IA |长时间存在的、不经常访问的数据            |99.999999999%   |99.9% |&gt;=3   |30 天           |128 KB        |按每GB收取检索费用。<br>S3 智能分层|访问模式发生变化或未知的长时间存在的数据  |99.999999999%   |99.9% |&gt;=3   |30 天           |无            |按对象收取监控和自动化费用。无检索费用。<br>S3 单区-IA |长时间存在的、不经常访问的、非关键数据    |99.999999999%   |99.5% |1     |30 天           |128 KB        |按每GB收取检索费用。无法灵活地应对可用区丢失的情况。<br>S3 Glacier |检索时间从数分钟到数小时不等的长期数据存档|99.999999999%     |99.99%|&gt;=3   |90 天           |40 KB         |按每GB收取检索费用。必须先还原存档对象，然后才可以访问它<br>S3 Glacier Deep Archive|存档很少访问的数据，默认检索时间为 12 小时    |99.999999999%    |99.99% (在您还原对象之后)|&gt;=3|180 天|40 KB|按每GB收取检索费用。必须先还原存档对象，然后才可以访问它们</p><h4 id="对象存储类别"><a href="#对象存储类别" class="headerlink" title="对象存储类别"></a><a href="https://docs.aws.amazon.com/zh_cn/AmazonS3/latest/dev/storage-class-intro.html" target="_blank" rel="noopener">对象存储类别</a></h4><h4 id="S3-价格"><a href="#S3-价格" class="headerlink" title="S3 价格"></a>S3 价格</h4><p>S3价格由4各方面组成</p><ol><li>存储费用</li><li>请求和检索费用 - 可以理解为API的调用费用，PUT，LIST</li><li>数据传输费用 - 带宽也是要钱的</li><li>管理和复制费用 - 这个可以理解为S3 bucket的功能费用，使用了相关功能就需要付费，例如跨区复制功能和对象标记功能</li></ol><p>我主要讲讲存储和数据传输费用,因为请求和检索费用以及管理和复制费用取决于个人的使用情况不太好分析。</p><h5 id="存储费用"><a href="#存储费用" class="headerlink" title="存储费用"></a>存储费用</h5><p>这个价格基于<code>us-east-1</code>区域<br>存储类别|价格<br>-|-<br>S3标准|每 GB 0.023 USD<br>S3标准-IA|每 GB 0.0125 USD<br>S3单区-IA|每 GB 0.01 USD<br>S3 Glacier|每 GB 0.004 USD<br>S3 Glacier Deep Archive|每 GB 0.00099 USD</p><p>智能分层还要收取一个0.0025 USD/1000 个对象的管理费.</p><h5 id="数据传输费用"><a href="#数据传输费用" class="headerlink" title="数据传输费用"></a>数据传输费用</h5><ol><li>所有传入不收费</li><li>传出到同一区域的EC2（不论是不是你的）不收费</li><li>传出到CloudFront不收费，因为CloudFront要收费,CloudFront是AWS的CDN服务，以后单讲</li></ol><p>所以传出费用大概是每 GB 0.09 USD，这是传出的最高值，具体规则参考官方文档。</p><p>所以举例说明，假如你只存了1G数据在S3上并公开，但是有人疯狂下载，S3费用可能也会很高。</p><p>费用详情请参考官方文档：<a href="https://amazonaws-china.com/cn/s3/pricing/" target="_blank" rel="noopener">https://amazonaws-china.com/cn/s3/pricing/</a></p><h3 id="Amazon-S3-数据一致性模型"><a href="#Amazon-S3-数据一致性模型" class="headerlink" title="Amazon S3 数据一致性模型"></a>Amazon S3 数据一致性模型</h3><p>Amazon S3 在所有区域为 S3 存储桶中的<strong>新对象的 PUTS 提供写后读一致性</strong>，不过有一条警告。需要注意的是，如果在创建对象之前向键名称发出 HEAD 或 GET 请求，然后在此之后不久创建对象，则由于最终一致性，后续 GET 可能不会返回该对象。</p><p>Amazon S3 在所有区域提供最终一致性用于覆盖 PUTS 和 DELETES。</p><p>单个键的更新是原子更新。例如，如果您对一个现有键执行 PUT 操作，则后续读取可能会返回旧数据或已更新的数据，但它永远不会返回损坏的数据或部分数据。</p><p>Amazon S3 通过在 AWS 数据中心内的多个服务器之间复制数据，从而实现高可用性。如果 PUT 请求成功，则数据已安全存储。但是，有关更改的信息必须在 Amazon S3 间进行复制，这可能需要一些时间，因此您可能会观察到以下行为：</p><ul><li>这是一个过程，会将一个新对象写入 Amazon S3，并立即列出其存储桶内的密钥。在充分传播此更改前，此对象可能不会显示在列表中。</li><li>这是一个过程，会替换一个现有的对象，并立即尝试读取此对象。在充分传播此更改前，Amazon S3 可能会返回先前的数据。</li><li>这是一个过程，会删除一个现有的对象，并立即尝试读取此对象。在充分传播此删除前，Amazon S3 可能会返回删除的数据。</li><li>这是一个过程，会删除一个现有的对象，并立即列出其存储桶内的键。在充分传播此删除前，Amazon S3 可能会列出删除的对象。</li></ul><h3 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h3><ol><li>分区中bucket名字必须唯一,只能由小写字母、数字、句点 (.) 和连字符 (-) 组成。<br>分区唯一 ，分区是一组区域。AWS 目前有三个分区：aws（标准区域）、aws-cn（中国区域）和 aws-us-gov（AWS GovCloud [美国] 区域）</li><li>单个文件5T大小限制</li><li>每个 AWS 账户中创建多达 100 个存储桶,通过提交服务限制提高请求将账户的存储桶限制提高至最多 1,000 个存储桶</li><li>存储桶归创建它的 AWS 账户所有。存储桶所有权不可转让</li></ol><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol><li>使用S3最重要就是注意S3的权限，千万不能把机密的bucket公开可访问。创建bucket时默认是不公开的。</li><li>因为bucket名字是唯一的，可能某些原因你删除了bucket，再想创建时可能就被其他人提前创建，而导致你无法创建。跟进一步的问题可能是，程序代码中有写到向这个S3发送东西，会造成意想不到的事。尤其是bucket的访问日志存储桶。所以如果bucket后续还要使用，请不要删除。</li><li>S3存储是最终一致性的，存储了一个对象，马上去访问不一定能拿到你要的结果，但最终会是你要的结果。A和B同时存储一个对象</li><li>所有未经身份验证的请求均由匿名用户发起。此用户在访问控制列表 (ACL) 中由特定的规范用户 ID 65a011a29cdf8ec533ec3d1ccaae921c 表示。</li></ol><h3 id="AWS-集成"><a href="#AWS-集成" class="headerlink" title="AWS 集成"></a>AWS 集成</h3><p>可以单独使用 Amazon S3，也可以将其与一个或多个 Amazon 产品配合使用。以下是最常用于 Amazon S3 的产品：</p><ul><li>Amazon EC2</li><li>Amazon EMR</li><li>Amazon SQS</li><li>Amazon CloudFront</li></ul><h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>以上完全基于<a href="https://docs.aws.amazon.com/" target="_blank" rel="noopener">AWS官方文档</a>，并结合自身理解创作</p><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> AWS </category>
          
          <category> 存储类 </category>
          
          <category> S3 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> AWS S3 </tag>
            
            <tag> S3基础入门 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bash基础入门（11）临时文件mktemp和trap</title>
      <link href="2020/11/11/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%8811%EF%BC%89%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6mktemp%E5%92%8Ctrap/"/>
      <url>2020/11/11/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%8811%EF%BC%89%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6mktemp%E5%92%8Ctrap/</url>
      
        <content type="html"><![CDATA[<p>描述: 临时文件安全性以及mktemp和trap的使用</p><a id="more"></a><h3 id="mktemp"><a href="#mktemp" class="headerlink" title="mktemp"></a>mktemp</h3><p><code>mktemp</code>命令可生成的临时文件名为随机值，且权限是只有用户本人可读写的临时文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mktemp</span><br><span class="line">/tmp/tmp.4GcsWSG4vj</span><br><span class="line"></span><br><span class="line">$ ls -l /tmp/tmp.4GcsWSG4vj</span><br><span class="line">-rw------- 1 ruanyf ruanyf 0 12月 28 12:49 /tmp/tmp.4GcsWSG4vj</span><br></pre></td></tr></table></figure><p>Bash 脚本使用<code>mktemp</code>命令的用法如下.为了确保临时文件创建成功，<code>mktemp</code>命令后面最好使用 <code>OR</code>运算符（||），保证创建失败时退出脚本。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">TMPFILE=$(mktemp) || exit 1</span><br><span class="line">echo &quot;Our temp file is $TMPFILE&quot;</span><br></pre></td></tr></table></figure><p>参数</p><ul><li>-d: 参数可以创建一个临时目录。</li><li>-p: 参数可以指定临时文件所在的目录。默认是使用$TMPDIR环境变量指定的目录，如果这个变量没设置，那么使用/tmp目录。</li><li>-t: 参数可以指定临时文件的文件名模板，模板的末尾必须至少包含三个连续的X字符，表示随机字符，建议至少使用六个X。默认的文件名模板是tmp.后接十个随机字符。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ TMPDIR=$(mktemp -d)</span><br><span class="line">$ echo $&#123;TMPDIR&#125;</span><br><span class="line">/tmp/tmp.Wcau5UjmN6</span><br><span class="line"></span><br><span class="line">$ mktemp -p /home/ruanyf/</span><br><span class="line">/home/ruanyf/tmp.FOKEtvs2H3</span><br><span class="line"></span><br><span class="line">$ mktemp -t mytemp.XXXXXXX</span><br><span class="line">/tmp/mytemp.yZ1HgZV</span><br></pre></td></tr></table></figure></li></ul><h3 id="trap"><a href="#trap" class="headerlink" title="trap"></a>trap</h3><p><code>trap</code>命令用来在 Bash 脚本中响应系统信号。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ trap -l</span><br><span class="line"> 1) SIGHUP 2) SIGINT 3) SIGQUIT 4) SIGILL 5) SIGTRAP</span><br><span class="line"> 6) SIGABRT 7) SIGBUS 8) SIGFPE 9) SIGKILL10) SIGUSR1</span><br><span class="line">11) SIGSEGV12) SIGUSR213) SIGPIPE14) SIGALRM15) SIGTERM</span><br><span class="line">16) SIGSTKFLT17) SIGCHLD18) SIGCONT19) SIGSTOP20) SIGTSTP</span><br><span class="line">21) SIGTTIN22) SIGTTOU23) SIGURG24) SIGXCPU25) SIGXFSZ</span><br><span class="line">26) SIGVTALRM27) SIGPROF28) SIGWINCH29) SIGIO30) SIGPWR</span><br><span class="line">31) SIGSYS34) SIGRTMIN35) SIGRTMIN+136) SIGRTMIN+237) SIGRTMIN+3</span><br><span class="line">38) SIGRTMIN+439) SIGRTMIN+540) SIGRTMIN+641) SIGRTMIN+742) SIGRTMIN+8</span><br><span class="line">43) SIGRTMIN+944) SIGRTMIN+1045) SIGRTMIN+1146) SIGRTMIN+1247) SIGRTMIN+13</span><br><span class="line">48) SIGRTMIN+1449) SIGRTMIN+1550) SIGRTMAX-1451) SIGRTMAX-1352) SIGRTMAX-12</span><br><span class="line">53) SIGRTMAX-1154) SIGRTMAX-1055) SIGRTMAX-956) SIGRTMAX-857) SIGRTMAX-7</span><br><span class="line">58) SIGRTMAX-659) SIGRTMAX-560) SIGRTMAX-461) SIGRTMAX-362) SIGRTMAX-2</span><br><span class="line">63) SIGRTMAX-164) SIGRTMAX</span><br></pre></td></tr></table></figure><p><code>trap</code>的命令格式如下。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ trap [动作] [信号1] [信号2] ...</span><br></pre></td></tr></table></figure><p>上面代码中，“动作”是一个 Bash 命令，“信号”常用的有以下几个。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HUP：编号1，脚本与所在的终端脱离联系。</span><br><span class="line">INT：编号2，用户按下 Ctrl + C，意图让脚本终止运行。</span><br><span class="line">QUIT：编号3，用户按下 Ctrl + 斜杠，意图退出脚本。</span><br><span class="line">KILL：编号9，该信号用于杀死进程。</span><br><span class="line">TERM：编号15，这是kill命令发出的默认信号。</span><br><span class="line">EXIT：编号0，这不是系统信号，而是 Bash 脚本特有的信号，不管什么情况，只要退出脚本就会产生。</span><br></pre></td></tr></table></figure><p><code>trap</code>命令响应EXIT信号的写法如下。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ trap &apos;rm -f &quot;$TMPFILE&quot;&apos; EXIT</span><br></pre></td></tr></table></figure><p>上面命令中，脚本遇到<code>EXIT</code>信号时，就会执行<code>rm -f &quot;$TMPFILE&quot;</code>。</p><p><code>trap</code> 命令的常见使用场景，就是在 Bash 脚本中指定退出时执行的清理命令。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">trap &apos;rm -f &quot;$TMPFILE&quot;&apos; EXIT</span><br><span class="line"></span><br><span class="line">TMPFILE=$(mktemp) || exit 1</span><br><span class="line">ls /etc &gt; $TMPFILE</span><br><span class="line">if grep -qi &quot;kernel&quot; $TMPFILE; then</span><br><span class="line">  echo &apos;find&apos;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>上面代码中，不管是脚本正常执行结束，还是用户按 <code>Ctrl + C</code> 终止，都会产生<code>EXIT</code>信号，从而触发删除临时文件。</p><p><strong>注意，<code>trap</code>命令必须放在脚本的开头。否则，它上方的任何命令导致脚本退出，都不会被它捕获。</strong></p><p>如果<code>trap</code>需要触发多条命令，可以封装一个 Bash 函数。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function egress &#123;</span><br><span class="line">  command1</span><br><span class="line">  command2</span><br><span class="line">  command3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">trap egress EXIT</span><br></pre></td></tr></table></figure><p>来自网道项目：<a href="https://wangdoc.com/bash/" target="_blank" rel="noopener">https://wangdoc.com/bash/</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协&gt;议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> Bash基础入门 </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bash基础入门（10）脚本设置set和shopt</title>
      <link href="2020/11/11/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%8810%EF%BC%89%E8%84%9A%E6%9C%AC%E8%AE%BE%E7%BD%AE/"/>
      <url>2020/11/11/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%8810%EF%BC%89%E8%84%9A%E6%9C%AC%E8%AE%BE%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>描述: 脚本设置set,shopt和排错</p><a id="more"></a><h3 id="set"><a href="#set" class="headerlink" title="set"></a>set</h3><p><code>set</code>命令用来修改子 Shell 环境的运行参数，即定制环境。一共有十几个参数可以定制，<a href="https://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html" target="_blank" rel="noopener">官方手册</a>有完整清单，本章介绍其中最常用的几个。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">set -u # 脚本中遇到未定义变量时报错并退出</span><br><span class="line">set -x # 运行代码前先将代码输出，排错推荐</span><br><span class="line"></span><br><span class="line"># 到 -e遇到管道命令时只有管道的最后命令成功-e就会认为成功</span><br><span class="line">set -e # 返回值不为0时终止脚本</span><br><span class="line">set -o pipefail # 解决-e的管道问题</span><br></pre></td></tr></table></figure><p>如果命令可能失败，但是希望继续运行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">command || true</span><br><span class="line"># 或在某段代码前暂时关闭set -e</span><br><span class="line">set +e</span><br><span class="line">command1</span><br><span class="line">command2</span><br><span class="line">set -e</span><br></pre></td></tr></table></figure><p>最后推荐，写脚本时</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set -euxo pipefail</span><br><span class="line"># 或</span><br><span class="line">set -eux</span><br><span class="line">set -o pipefail</span><br></pre></td></tr></table></figure><h3 id="shopt"><a href="#shopt" class="headerlink" title="shopt"></a>shopt</h3><p><code>set</code>是从 <code>Ksh</code> 继承的，属于 <code>POSIX</code> 规范的一部分，而<code>shopt</code>是 <code>Bash</code> 特有的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ shopt         # 查看所有参数的状态</span><br><span class="line">$ shopt &lt;p&gt;     # 查看所有参数p的状态</span><br><span class="line"></span><br><span class="line">$ shopt -s &lt;p&gt;  # 开启参数p</span><br><span class="line">$ shopt -u &lt;p&gt;  # 关闭参数p</span><br></pre></td></tr></table></figure><p>目前我还是习惯用set,运行脚本前使用<code>bash -n script</code>可以检查脚本语法是否正确</p><p>来自网道项目：<a href="https://wangdoc.com/bash/" target="_blank" rel="noopener">https://wangdoc.com/bash/</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协&gt;议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> Bash基础入门 </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bash基础入门（9）函数</title>
      <link href="2020/11/11/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%889%EF%BC%89%E5%87%BD%E6%95%B0/"/>
      <url>2020/11/11/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%889%EF%BC%89%E5%87%BD%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<p>描述: Bash脚本中的函数</p><a id="more"></a><h3 id="函数定义"><a href="#函数定义" class="headerlink" title="函数定义"></a>函数定义</h3><p>函数定义一定要在函数使用之前</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function today() &#123;</span><br><span class="line">  echo -n &quot;Today&apos;s date is: &quot;</span><br><span class="line">  date +&quot;%A, %B %-d, %Y&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数返回值</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function func_return_value &#123;</span><br><span class="line">  return 10</span><br><span class="line">&#125;</span><br><span class="line">$ func_return_value</span><br><span class="line">$ echo &quot;Value returned by function is: $?&quot;</span><br><span class="line">Value returned by function is: 10</span><br></pre></td></tr></table></figure><p>函数内变量<code>local</code>,很好理解函数内变量只能被函数使用，非函数内变量都是全局变量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/bash</span><br><span class="line">foo=0</span><br><span class="line">function fn () &#123;</span><br><span class="line">  local bar=0</span><br><span class="line">  bar=1</span><br><span class="line">  foo=1</span><br><span class="line">  echo &quot;fn: foo = $foo&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fn</span><br><span class="line">echo &quot;global: foo = $foo&quot;</span><br></pre></td></tr></table></figure><p>查看现有函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 查看所有函数和定义</span><br><span class="line">$ declare -f </span><br><span class="line"></span><br><span class="line"># 查看所有函数</span><br><span class="line">$ declare -F </span><br><span class="line"></span><br><span class="line"># 查看指定函数</span><br><span class="line">$ declare -f function</span><br></pre></td></tr></table></figure><p>删除函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unset -f functionName</span><br></pre></td></tr></table></figure><p>常用函数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">function usage() &#123;</span><br><span class="line">  echo "Usage:</span><br><span class="line"></span><br><span class="line">./deploy.sh -p &lt;profile&gt; -k &lt;keypair&gt;</span><br><span class="line"></span><br><span class="line">Example:</span><br><span class="line"></span><br><span class="line">  ./deploy.sh -p &lt;profile&gt; -k &lt;keypair&gt;</span><br><span class="line">"</span><br><span class="line">  exit 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">while getopts "p:k:h" opt; do</span><br><span class="line">  case "$opt" in</span><br><span class="line">  p) PROFILE="$OPTARG" ;;</span><br><span class="line">  k) KeyName="$OPTARG" ;;</span><br><span class="line">  *) usage ;;</span><br><span class="line">  esac</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>来自网道项目：<a href="https://wangdoc.com/bash/" target="_blank" rel="noopener">https://wangdoc.com/bash/</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协&gt;议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> Bash基础入门 </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bash基础入门（8）循环语句</title>
      <link href="2020/11/11/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%888%EF%BC%89%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5/"/>
      <url>2020/11/11/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%888%EF%BC%89%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5/</url>
      
        <content type="html"><![CDATA[<p>描述: while</p><a id="more"></a><h3 id="while"><a href="#while" class="headerlink" title="while"></a>while</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">number=0</span><br><span class="line">while [ &quot;$number&quot; -lt 10 ]; do</span><br><span class="line">  echo &quot;Number = $number&quot;</span><br><span class="line">  number=$((number + 1))</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="until"><a href="#until" class="headerlink" title="until"></a>until</h3><p>until循环与while循环恰好相反，只要不符合判断条件（判断条件失败），就不断循环执行指定的语句。一旦符合判断条件，就退出循环。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">number=0</span><br><span class="line">until [ &quot;$number&quot; -ge 10 ]; do</span><br><span class="line">  echo &quot;Number = $number&quot;</span><br><span class="line">  number=$((number + 1))</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="for…in循环"><a href="#for…in循环" class="headerlink" title="for…in循环"></a>for…in循环</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for i in $(ls *.md); do</span><br><span class="line">  echo $i</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for (( i=0; i&lt;5; i=i+1 )); do</span><br><span class="line">  echo $i</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="break，continue"><a href="#break，continue" class="headerlink" title="break，continue"></a>break，continue</h3><p><code>break</code>命令立即终止循环，程序继续执行循环块之后的语句，即不再执行剩下的循环。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">for number in 1 2 3 4 5 6</span><br><span class="line">do</span><br><span class="line">  echo &quot;number is $number&quot;</span><br><span class="line">  if [ &quot;$number&quot; = &quot;3&quot; ]; then</span><br><span class="line">    break</span><br><span class="line">  fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>上面例子只会打印3行结果。一旦变量<code>$number</code>等于3，就会跳出循环，不再继续执行。</p><p><code>continue</code>命令立即终止本轮循环，开始执行下一轮循环。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">while read -p &quot;What file do you want to test?&quot; filename</span><br><span class="line">do</span><br><span class="line">  if [ ! -e &quot;$filename&quot; ]; then</span><br><span class="line">    echo &quot;The file does not exist.&quot;</span><br><span class="line">    continue</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  echo &quot;You entered a valid file..&quot;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="select"><a href="#select" class="headerlink" title="select"></a>select</h3><p><code>select</code>结构主要用来生成简单的菜单。它的语法与<code>for...in</code>循环基本一致。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">echo &quot;Which Operating System do you like?&quot;</span><br><span class="line"></span><br><span class="line">select os in Ubuntu LinuxMint Windows8 Windows7 WindowsXP</span><br><span class="line">do</span><br><span class="line">  case $os in</span><br><span class="line">    &quot;Ubuntu&quot;|&quot;LinuxMint&quot;)</span><br><span class="line">      echo &quot;I also use $os.&quot;</span><br><span class="line">    ;;</span><br><span class="line">    &quot;Windows8&quot; | &quot;Windows7&quot; | &quot;WindowsXP&quot;)</span><br><span class="line">      echo &quot;Why don&apos;t you try Linux?&quot;</span><br><span class="line">    ;;</span><br><span class="line">    *)</span><br><span class="line">      echo &quot;Invalid entry.&quot;</span><br><span class="line">      break</span><br><span class="line">    ;;</span><br><span class="line">  esac</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>来自网道项目：<a href="https://wangdoc.com/bash/" target="_blank" rel="noopener">https://wangdoc.com/bash/</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协&gt;议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> Bash基础入门 </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bash基础入门（7）条件判断if和case</title>
      <link href="2020/11/11/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%887%EF%BC%89%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%ADif%E5%92%8Ccase/"/>
      <url>2020/11/11/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%887%EF%BC%89%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%ADif%E5%92%8Ccase/</url>
      
        <content type="html"><![CDATA[<p>描述: if和case</p><a id="more"></a><h3 id="if-结构"><a href="#if-结构" class="headerlink" title="if 结构"></a>if 结构</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if commands; then</span><br><span class="line">  commands</span><br><span class="line">[elif commands; then</span><br><span class="line">  commands...]</span><br><span class="line">[else</span><br><span class="line">  commands]</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>if 还能与逻辑运算结合</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 使用否定操作符!时，最好用圆括号确定转义的范围 -a </span><br><span class="line">if [ ! \( $INT -ge $MIN_VAL -a $INT -le $MAX_VAL \) ]; then</span><br><span class="line">    echo &quot;$INT is outside $MIN_VAL to $MAX_VAL.&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;$INT is in range.&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>AND运算：符号&amp;&amp;，也可使用参数-a。<br>OR运算：符号||，也可使用参数-o。<br>NOT运算：符号!。</p><h3 id="文件和目录判定"><a href="#文件和目录判定" class="headerlink" title="文件和目录判定"></a>文件和目录判定</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[ -e filename ]  如果 filename存在，则为真  [ -e /var/log/syslog ]</span><br><span class="line">[ -d filename ]  如果 filename为目录，则为真  [ -d /tmp/mydir ]</span><br><span class="line">[ -f filename ]  如果 filename为常规文件，则为真  [ -f /usr/bin/grep ]</span><br><span class="line">[ -L filename ]  如果 filename为符号链接，则为真  [ -L /usr/bin/grep ]</span><br><span class="line">[ -r filename ]  如果 filename可读，则为真  [ -r /var/log/syslog ]</span><br><span class="line">[ -w filename ]  如果 filename可写，则为真  [ -w /var/mytmp.txt ]</span><br><span class="line">[ -x filename ]  如果 filename可执行，则为真  [ -L /usr/bin/grep ]</span><br><span class="line">[ filename1 -nt filename2 ] 如果 filename1比 filename2新，则为真  [ /tmp/install/etc/services -nt /etc/services ]</span><br><span class="line">[ filename1 -ot filename2 ] 如果 filename1比 filename2旧，则为真  [ /boot/bzImage -ot arch/i386/boot/bzImage ]</span><br></pre></td></tr></table></figure><h3 id="字符串比较运算符"><a href="#字符串比较运算符" class="headerlink" title="字符串比较运算符"></a>字符串比较运算符</h3><p>请注意引号的使用，这是防止空格扰乱代码的好方法</p><p><code>[[]]</code> 和 <code>[]</code>的区别是双括号内支持正则表达式, <code>=~</code>是正则比较运算符</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[ string ] 如果string不为空（长度大于0），则判断为真 [ &quot;$&#123;myvar1&#125;&quot; ]</span><br><span class="line">[ -z string ] 如果 string长度为零，则为真  [ -z &quot;$&#123;myvar1&#125;&quot; ]</span><br><span class="line">[ -n string ] 如果 string长度非零，则为真  [ -n &quot;$&#123;myvar1&#125;&quot; ]</span><br><span class="line">[ string1 = string2 ] 如果 string1与 string2相同，则为真  [ &quot;$&#123;myvar1&#125;&quot; = &quot;$&#123;myvar2&#125;&quot; ]</span><br><span class="line">[ string1 == string2 ] 如果 string1与 string2相同，则为真  [ &quot;$&#123;myvar1&#125;&quot; == &quot;$&#123;myvar2&#125;&quot; ]</span><br><span class="line">[ string1 != string2 ] 如果 string1与 string2不同，则为真  [ &quot;$&#123;myvar1&#125;&quot; != &quot;$&#123;myvar2&#125;&quot; ]</span><br><span class="line">[[ string1 =~ string2 ]] 如果 string2是 string1的一部分，则为真  [[ &quot;$&#123;myvar1&#125;&quot; =~ &quot;$&#123;myvar2&#125;&quot; ]]</span><br><span class="line">[[ string1 = *string2* ]] 如果 string2是 string1的一部分，则为真  [[ &quot;$&#123;myvar1&#125;&quot; =~ *&quot;$&#123;myvar2&#125;&quot;* ]]</span><br></pre></td></tr></table></figure><h3 id="算术比较运算符"><a href="#算术比较运算符" class="headerlink" title="算术比较运算符"></a>算术比较运算符</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[ num1 -eq num2 ] 等于 [ 3 -eq $&#123;mynum&#125; ]</span><br><span class="line">[ num1 -ne num2 ] 不等于 [ 3 -ne $&#123;mynum&#125; ]</span><br><span class="line">[ num1 -lt num2 ] 小于 [ 3 -lt $&#123;mynum&#125; ]</span><br><span class="line">[ num1 -le num2 ] 小于或等于 [ 3 -le $&#123;mynum&#125; ]</span><br><span class="line">[ num1 -gt num2 ] 大于 [ 3 -gt $&#123;mynum&#125; ]</span><br><span class="line">[ num1 -ge num2 ] 大于或等于 [ 3 -ge $&#123;mynum&#125; ]</span><br></pre></td></tr></table></figure><h3 id="case"><a href="#case" class="headerlink" title="case"></a>case</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">case expression in</span><br><span class="line">  pattern )</span><br><span class="line">    commands ;;</span><br><span class="line">  pattern )</span><br><span class="line">    commands ;;</span><br><span class="line">  * )</span><br><span class="line">    commands ;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure><p>case的匹配模式可以使用各种通配符，下面是一些例子。</p><ul><li>a)：匹配a。</li><li>a|b)：匹配a或b。</li><li>[[:alpha:]])：匹配单个字母。</li><li>???)：匹配3个字符的单词。</li><li>*.txt)：匹配.txt结尾。</li><li>*)：匹配任意输入，通过作为case结构的最后一个模式。</li></ul><p>来自网道项目：<a href="https://wangdoc.com/bash/" target="_blank" rel="noopener">https://wangdoc.com/bash/</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协&gt;议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> Bash基础入门 </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bash基础入门（6）脚本基础参数及用户输入</title>
      <link href="2020/11/10/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%886%EF%BC%89%E8%84%9A%E6%9C%AC%E5%9F%BA%E7%A1%80%E5%8F%82%E6%95%B0%E5%8F%8A%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5/"/>
      <url>2020/11/10/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%886%EF%BC%89%E8%84%9A%E6%9C%AC%E5%9F%BA%E7%A1%80%E5%8F%82%E6%95%B0%E5%8F%8A%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<p>描述: Bash脚本入门</p><a id="more"></a><h3 id="Shebang-行"><a href="#Shebang-行" class="headerlink" title="Shebang 行"></a>Shebang 行</h3><p>  脚本的第一行通常是指定解释器，Bash 脚本的解释器一般是<code>/bin/sh</code>或<code>/bin/bash</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"># 或者</span><br><span class="line">#!/bin/bash</span><br></pre></td></tr></table></figure><p>  如果 Bash 解释器不放在目录<code>/bin</code>，脚本就无法执行了。为了保险，可以写成下面这样。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env bash</span><br></pre></td></tr></table></figure><p>  通过环境变量寻找<code>bash</code>所在位置并执行</p><h3 id="脚本执行位置"><a href="#脚本执行位置" class="headerlink" title="脚本执行位置"></a>脚本执行位置</h3><p>当写了一个经常使用的脚本时，可以在主目录新建一个<code>~/bin</code>子目录，专门存放可执行脚本，然后把<code>~/bin</code>加入<code>$PATH</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=$PATH:~/bin</span><br></pre></td></tr></table></figure><p>上面命令改变环境变量<code>$PATH</code>，将<code>~/bin</code>添加到<code>$PATH</code>的末尾。可以将这一行加到<code>~/.bashrc</code>文件里面，然后重新加载一次<code>.bashrc</code>，这个配置就可以生效了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ source ~/.bashrc</span><br></pre></td></tr></table></figure><p>以后不管在什么目录，直接输入脚本文件名，脚本就会执行。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ script.sh</span><br></pre></td></tr></table></figure><h3 id="脚本参数"><a href="#脚本参数" class="headerlink" title="脚本参数"></a>脚本参数</h3><p>  脚本文件内部，可以使用特殊变量，引用参数。<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">`$0`：脚本文件名，即script.sh。</span><br><span class="line">`$1~$9`：对应脚本的第一个参数到第九个参数。</span><br><span class="line">`$#`：参数的总数。</span><br><span class="line">`$@`：全部的参数，参数之间使用空格分隔。</span><br><span class="line">`$*`：全部的参数，参数之间使用变量$IFS值的第一个字符分隔，默认为空格，但是可以自定义。</span><br></pre></td></tr></table></figure></p><p>  下面是一个脚本内部读取命令行参数的例子。<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># script.sh</span><br><span class="line"></span><br><span class="line">echo &quot;全部参数：&quot; $@</span><br><span class="line">echo &quot;命令行参数数量：&quot; $#</span><br><span class="line">echo &apos;$0 = &apos; $0</span><br><span class="line">echo &apos;$1 = &apos; $1</span><br><span class="line">echo &apos;$2 = &apos; $2</span><br><span class="line">echo &apos;$3 = &apos; $3</span><br></pre></td></tr></table></figure></p><p>  执行结果如下。<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ./script.sh a b c</span><br><span class="line">全部参数：a b c</span><br><span class="line">命令行参数数量：3</span><br><span class="line">$0 =  script.sh</span><br><span class="line">$1 =  a</span><br><span class="line">$2 =  b</span><br><span class="line">$3 =  c</span><br></pre></td></tr></table></figure></p><p>  用户可以输入任意数量的参数，利用<code>for</code>循环，可以读取每一个参数。<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for i in &quot;$@&quot;; do</span><br><span class="line">  echo $i</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p><h3 id="getopts-命令"><a href="#getopts-命令" class="headerlink" title="getopts 命令"></a>getopts 命令</h3><p>  <code>getopts</code>命令用在脚本内部，可以解析复杂的脚本命令行参数，通常与<code>while</code>循环一起使用，取出脚本所有的带有前置连词线（-）的参数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">while getopts &apos;lhsa:&apos; OPTION; do</span><br><span class="line">  case &quot;$OPTION&quot; in</span><br><span class="line">    l) echo &quot;linuxconfig&quot;;;</span><br><span class="line">    s) echo &quot;s stands for s&quot;;;</span><br><span class="line">    a) avalue=&quot;$OPTARG&quot;</span><br><span class="line">       echo &quot;The value provided is $OPTARG&quot;</span><br><span class="line">       ;;</span><br><span class="line">    h) echo &quot;script usage: $(basename $0) [-l] [-s] [-h] [-a somevalue]&quot; &gt;&amp;2 ;;</span><br><span class="line">    *)</span><br><span class="line">      echo &quot;script usage: $(basename $0) [-l] [-s] [-h] [-a somevalue]&quot; &gt;&amp;2 # 消息重定向到标准错误里面</span><br><span class="line">      exit 1</span><br><span class="line">      ;;</span><br><span class="line">  esac</span><br><span class="line">done</span><br><span class="line">shift &quot;$(($OPTIND - 1))&quot; # 移除参数</span><br></pre></td></tr></table></figure><h3 id="read-命令接受用户输入"><a href="#read-命令接受用户输入" class="headerlink" title="read 命令接受用户输入"></a>read 命令接受用户输入</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">echo -n &quot;输入一些文本 &gt; &quot;</span><br><span class="line">read text</span><br><span class="line">echo &quot;你的输入：$text&quot;</span><br><span class="line"></span><br><span class="line">常用选项</span><br><span class="line"># -t 设置等待时间</span><br><span class="line"># -p 设置提示信息</span><br><span class="line"># -s 使得用户的输入不显示在屏幕上，这常常用于输入密码或保密信息。</span><br></pre></td></tr></table></figure><p>read命令除了读取键盘输入，可以用来读取文件。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">filename=&apos;/etc/hosts&apos;</span><br><span class="line"></span><br><span class="line">while read myline</span><br><span class="line">do</span><br><span class="line">  echo &quot;$myline&quot;</span><br><span class="line">done &lt; $filename</span><br></pre></td></tr></table></figure><p>来自网道项目：<a href="https://wangdoc.com/bash/" target="_blank" rel="noopener">https://wangdoc.com/bash/</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协&gt;议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> Bash基础入门 </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bash基础入门（5）history</title>
      <link href="2020/11/10/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%885%EF%BC%89history/"/>
      <url>2020/11/10/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%885%EF%BC%89history/</url>
      
        <content type="html"><![CDATA[<p>描述: 介绍history命令</p><a id="more"></a><ol><li><p>history<br><code>history</code>命令能显示操作历史，即用户目录下<code>.bash_history</code>文件的内容。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ history     # 能显示过去执行过的命令</span><br><span class="line">$ history -c  # 清除历史操作</span><br></pre></td></tr></table></figure></li><li><p><code>HISTTIMEFORMAT</code>环境变量</p><p>通过设置<code>HISTTIMEFORMAT</code>环境变量，可以让<code>history</code>显示操作时间</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 将HISTTIMEFORMAT写入/etc/profile可以全局通用</span><br><span class="line">$ echo &apos;export HISTTIMEFORMAT=&quot;%F %T  `whoami`: &quot;&apos; &gt;&gt; /etc/profile &amp;&amp; source /etc/profile</span><br><span class="line"></span><br><span class="line">HISTTIMEFORMAT=&quot;%Y-%m-%d:%H-%M-%S `whoami`:  &quot;    #记录每条历史命令的执行时间和执行者        </span><br><span class="line"></span><br><span class="line">export HISTTIMEFORMAT    # 仅对当前用户有效，应设置全局环境变量/etc/profile或用户.bashrc</span><br><span class="line"></span><br><span class="line"># 其中： date +%Y-%m-%d    ==2017-06-09</span><br><span class="line"># </span><br><span class="line"># %Y:4位数的年份；        </span><br><span class="line"># </span><br><span class="line"># %m:2位数的月份数；        </span><br><span class="line"># </span><br><span class="line"># %d:2位数的一个月中的日期数；        </span><br><span class="line"># </span><br><span class="line"># %H：2位数的小时数（24小时制）；        </span><br><span class="line"># </span><br><span class="line"># %M：2位数的分钟数；        </span><br><span class="line"># </span><br><span class="line"># %S：2位数的秒数</span><br></pre></td></tr></table></figure></li><li><p>size</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HISTFILESIZE=2000   # 设置保存历史命令的文件大小        </span><br><span class="line"></span><br><span class="line">HISTSIZE=2000       # 保存历史命令条数        </span><br><span class="line"></span><br><span class="line">export HISTSIZE=0   # 将不保存操作记录</span><br></pre></td></tr></table></figure></li></ol><p>来自网道项目：<a href="https://wangdoc.com/bash/" target="_blank" rel="noopener">https://wangdoc.com/bash/</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协&gt;议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> Bash基础入门 </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bash基础入门（4）快捷键</title>
      <link href="2020/11/10/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%884%EF%BC%89%E5%BF%AB%E6%8D%B7%E9%94%AE/"/>
      <url>2020/11/10/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%884%EF%BC%89%E5%BF%AB%E6%8D%B7%E9%94%AE/</url>
      
        <content type="html"><![CDATA[<p>描述: Bash命令行快捷键</p><a id="more"></a><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Ctrl+l:清除屏幕</span><br><span class="line">Ctrl+a:跳到本行的行首</span><br><span class="line">Ctrl+e:跳到页尾</span><br><span class="line">Ctrl+u:删除当前光标前面的文字 （还有剪切功能）</span><br><span class="line">Ctrl+k:删除当前光标后面的文字(还有剪切功能)</span><br><span class="line">Ctrl+w:删除当前光标前一个单词</span><br><span class="line">Ctrl+y:粘贴</span><br><span class="line">Ctrl+c:终止当前命令</span><br><span class="line">Ctrl+d:删除当前字符，没有字符时会退出shell</span><br><span class="line">Alt+f:移动光标到后一个单词</span><br><span class="line">Alt+b:移动光标到前一个单词</span><br></pre></td></tr></table></figure><p>来自网道项目：<a href="https://wangdoc.com/bash/" target="_blank" rel="noopener">https://wangdoc.com/bash/</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协&gt;议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> Bash基础入门 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bash基础入门（3）字符串</title>
      <link href="2020/11/09/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%883%EF%BC%89%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
      <url>2020/11/09/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%883%EF%BC%89%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
      
        <content type="html"><![CDATA[<p>描述:Bash基础入门（3）之字符串</p><a id="more"></a><h3 id="字符串的长度"><a href="#字符串的长度" class="headerlink" title="字符串的长度"></a>字符串的长度</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ myPath=/home/cam/book/long.file.name</span><br><span class="line">$ echo $&#123;#myPath&#125;</span><br><span class="line">29</span><br></pre></td></tr></table></figure><h3 id="子字符串"><a href="#子字符串" class="headerlink" title="子字符串"></a>子字符串</h3><p>语法<code>${varname:offset:length}</code>返回变量<code>$varname</code>的子字符串，从位置<code>offset</code>开始（从0开始计算），长度为<code>length</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ count=frogfootman</span><br><span class="line">$ echo $&#123;count:4:4&#125;</span><br><span class="line">foot</span><br><span class="line">$ echo $&#123;count:4&#125;</span><br><span class="line">footman</span><br><span class="line"></span><br><span class="line">$ foo=&quot;This string is long.&quot;</span><br><span class="line">$ echo $&#123;foo: -5&#125;</span><br><span class="line">long.</span><br><span class="line">$ echo $&#123;foo: -5:2&#125;</span><br><span class="line">lo</span><br><span class="line">$ echo $&#123;foo: -5:-2&#125;</span><br><span class="line">lon</span><br></pre></td></tr></table></figure><h3 id="搜索和替换"><a href="#搜索和替换" class="headerlink" title="搜索和替换"></a>搜索和替换</h3><ol><li><p>字符串头部的模式匹配</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 如果 pattern 匹配变量 variable 的开头，</span><br><span class="line"># 删除最短匹配（非贪婪匹配）的部分，返回剩余部分</span><br><span class="line">$&#123;variable#pattern&#125;</span><br><span class="line"></span><br><span class="line"># 如果 pattern 匹配变量 variable 的开头，</span><br><span class="line"># 删除最长匹配（贪婪匹配）的部分，返回剩余部分</span><br><span class="line">$&#123;variable##pattern&#125;</span><br><span class="line"></span><br><span class="line">$ myPath=/home/cam/book/long.file.name</span><br><span class="line"></span><br><span class="line">$ echo $&#123;myPath#/*/&#125;</span><br><span class="line">cam/book/long.file.name</span><br><span class="line"></span><br><span class="line">$ echo $&#123;myPath##/*/&#125;</span><br><span class="line">long.file.name</span><br><span class="line"></span><br><span class="line"># 示例：匹配文件名</span><br><span class="line">$ path=/home/cam/book/long.file.name</span><br><span class="line"></span><br><span class="line">$ echo $&#123;path##*/&#125;</span><br><span class="line">long.file.name</span><br><span class="line"></span><br><span class="line"># 示例：匹配替换</span><br><span class="line"># 模式必须出现在字符串的开头</span><br><span class="line">$&#123;variable/#pattern/string&#125;</span><br><span class="line"></span><br><span class="line">$ foo=JPG.JPG</span><br><span class="line">$ echo $&#123;foo/#JPG/jpg&#125;</span><br><span class="line">jpg.JPG</span><br></pre></td></tr></table></figure><p>如果匹配不成功，则返回原始字符串。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ phone=&quot;555-456-1414&quot;</span><br><span class="line">$ echo $&#123;phone#444&#125;</span><br><span class="line">555-456-1414</span><br></pre></td></tr></table></figure></li><li><p>字符串尾部的模式匹配</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 如果 pattern 匹配变量 variable 的结尾，</span><br><span class="line"># 删除最短匹配（非贪婪匹配）的部分，返回剩余部分</span><br><span class="line">$&#123;variable%pattern&#125;</span><br><span class="line"></span><br><span class="line"># 如果 pattern 匹配变量 variable 的结尾，</span><br><span class="line"># 删除最长匹配（贪婪匹配）的部分，返回剩余部分</span><br><span class="line">$&#123;variable%%pattern&#125;</span><br><span class="line"></span><br><span class="line">$ path=/home/cam/book/long.file.name</span><br><span class="line"></span><br><span class="line">$ echo $&#123;path%.*&#125;</span><br><span class="line">/home/cam/book/long.file</span><br><span class="line"></span><br><span class="line">$ echo $&#123;path%%.*&#125;</span><br><span class="line">/home/cam/book/long</span><br><span class="line"></span><br><span class="line"># 示例：匹配目录</span><br><span class="line">$ path=/home/cam/book/long.file.name</span><br><span class="line"></span><br><span class="line">$ echo $&#123;path%/*&#125;</span><br><span class="line">/home/cam/book</span><br><span class="line"></span><br><span class="line"># 示例：匹配替换</span><br><span class="line"># 模式必须出现在字符串的结尾</span><br><span class="line">$&#123;variable/%pattern/string&#125;</span><br><span class="line"></span><br><span class="line">$ foo=JPG.JPG</span><br><span class="line">$ echo $&#123;foo/%JPG/jpg&#125;</span><br><span class="line">JPG.jpg</span><br></pre></td></tr></table></figure></li><li><p>任意位置的模式匹配</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 如果 pattern 匹配变量 variable 的一部分，</span><br><span class="line"># 最长匹配（贪婪匹配）的那部分被 string 替换，但仅替换第一个匹配</span><br><span class="line">$&#123;variable/pattern/string&#125;</span><br><span class="line"></span><br><span class="line"># 如果 pattern 匹配变量 variable 的一部分，</span><br><span class="line"># 最长匹配（贪婪匹配）的那部分被 string 替换，所有匹配都替换</span><br><span class="line">$&#123;variable//pattern/string&#125;</span><br><span class="line"></span><br><span class="line">$ path=/home/cam/foo/foo.name</span><br><span class="line"></span><br><span class="line">$ echo $&#123;path/foo/bar&#125;</span><br><span class="line">/home/cam/bar/foo.name</span><br><span class="line"></span><br><span class="line">$ echo $&#123;path//foo/bar&#125;</span><br><span class="line">/home/cam/bar/bar.name</span><br><span class="line"></span><br><span class="line"># 示例：将分隔符从:换成换行符</span><br><span class="line">$ echo -e $&#123;PATH//:/&apos;\n&apos;&#125;</span><br><span class="line">/usr/local/bin</span><br><span class="line">/usr/bin</span><br><span class="line">/bin</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li><li><p>改变大小写<br>下面的语法可以改变变量的大小写。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 转为大写</span><br><span class="line">$&#123;varname^^&#125;</span><br><span class="line"></span><br><span class="line"># 转为小写</span><br><span class="line">$&#123;varname,,&#125;</span><br><span class="line">下面是一个例子。</span><br><span class="line"></span><br><span class="line">$ foo=heLLo</span><br><span class="line">$ echo $&#123;foo^^&#125;</span><br><span class="line">HELLO</span><br><span class="line">$ echo $&#123;foo,,&#125;</span><br><span class="line">hello</span><br></pre></td></tr></table></figure></li></ol><p>来自网道项目：<a href="https://wangdoc.com/bash/" target="_blank" rel="noopener">https://wangdoc.com/bash/</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协&gt;议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> Bash基础入门 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bash基础入门（2）变量相关</title>
      <link href="2020/11/09/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%882%EF%BC%89%E5%8F%98%E9%87%8F%E7%9B%B8%E5%85%B3/"/>
      <url>2020/11/09/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%882%EF%BC%89%E5%8F%98%E9%87%8F%E7%9B%B8%E5%85%B3/</url>
      
        <content type="html"><![CDATA[<p>描述:Bash基础入门（2）之环境变量</p><a id="more"></a><h3 id="查看环境变量"><a href="#查看环境变量" class="headerlink" title="查看环境变量"></a>查看环境变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ env</span><br><span class="line"># 或者</span><br><span class="line">$ printenv</span><br></pre></td></tr></table></figure><h3 id="变量声明"><a href="#变量声明" class="headerlink" title="变量声明"></a>变量声明</h3><p>定义变量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ variable=value          # 定义变量</span><br><span class="line">$ myvar=&quot;hello world&quot;     # 如果变量的值包含空格，则必须将值放在引号中</span><br><span class="line">$ e=$(ls -l foo.txt)      # 变量值可以是命令的执行结果</span><br><span class="line">$ foo=1;bar=2             # 定义多个变量</span><br></pre></td></tr></table></figure><p>注意，变量区分大小写，变量也会被覆盖</p><h3 id="读取变量"><a href="#读取变量" class="headerlink" title="读取变量"></a>读取变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ a=1</span><br><span class="line">$ echo log_$&#123;a&#125;</span><br><span class="line">log_1</span><br></pre></td></tr></table></figure><p>如果变量的值本身也是变量，可以使用${!varname}的语法，读取最终的值。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ a=SHELL</span><br><span class="line">$ echo $a</span><br><span class="line">SHELL</span><br><span class="line">$ echo $&#123;!a&#125;</span><br><span class="line">/bin/bash</span><br></pre></td></tr></table></figure><h3 id="数组变量"><a href="#数组变量" class="headerlink" title="数组变量"></a>数组变量</h3><p>声明变量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ array[0]=a</span><br><span class="line">$ array[1]=b</span><br><span class="line">$ array[2]=c</span><br><span class="line">$ array[3]=d</span><br><span class="line"></span><br><span class="line">$ array=(a b c d)</span><br><span class="line"></span><br><span class="line">$ files=($(ls *.txt))</span><br></pre></td></tr></table></figure><p>读取数组元素</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 读取单个元素</span><br><span class="line">$ echo $&#123;array[1]&#125;</span><br><span class="line"></span><br><span class="line"># 读取所有元素元素</span><br><span class="line">$ echo $&#123;array[@]&#125;</span><br><span class="line"></span><br><span class="line"># 配合for循环读取所有元素,一定要放在双引号内，避免数组中元素有空格出现意料之外的结果</span><br><span class="line">for i in &quot;$&#123;array[@]&#125;&quot;; do</span><br><span class="line">  echo $&#123;i&#125;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>如果直接读取数组变量不带下标的话，会返回下标为0的元素</p><p>数组长度</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$&#123;#array[@]&#125;</span><br><span class="line">$&#123;#array[*]&#125;</span><br><span class="line"></span><br><span class="line"># 字符串长度也是一样的语法格式</span><br><span class="line">$&#123;#myval&#125;</span><br></pre></td></tr></table></figure><p>提取数组成员</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 从数组1号位置开始提取3个成员,原数组不变</span><br><span class="line">$&#123;array[@]:1:3&#125;</span><br><span class="line"></span><br><span class="line"># 从数组1号位置开始提取后面所有成员,原数组不变</span><br><span class="line">$&#123;array[@]:1&#125;</span><br><span class="line"></span><br><span class="line">array2=($&#123;array[@]:1&#125;)</span><br></pre></td></tr></table></figure><p>追加数组成员</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ foo=(a b c)</span><br><span class="line">$ foo+=(d e f)</span><br><span class="line">$ echo $&#123;foo[@]&#125;</span><br><span class="line">a b c d e f</span><br></pre></td></tr></table></figure><h3 id="删除变量"><a href="#删除变量" class="headerlink" title="删除变量"></a>删除变量</h3><p>删除数组和删除变量一样</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ unset NAME</span><br><span class="line"># 或</span><br><span class="line">$ NAME=&apos;&apos;</span><br></pre></td></tr></table></figure><p>删除数组单个元素会导致该元素为<code>&#39;&#39;</code>,但不会减少数组长度</p><h3 id="输出变量"><a href="#输出变量" class="headerlink" title="输出变量"></a>输出变量</h3><p>用户创建的变量仅可用于当前 Shell，子 Shell 默认读取不到父 Shell 定义的变量。为了把变量传递给子 Shell，需要使用export命令。这样输出的变量，对于子 Shell 来说就是环境变量。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export NAME=value</span><br></pre></td></tr></table></figure><p>子 Shell 如果修改继承的变量，不会影响父 Shell。</p><h3 id="特殊变量"><a href="#特殊变量" class="headerlink" title="特殊变量"></a>特殊变量</h3><ol><li><p>$?<br>为上一个命令的退出码，用来判断上一个命令是否执行成功。返回值是0，表示上一个命令执行成功；如果是非零，上一个命令执行失败。</p></li><li><p>$$<br>为当前 Shell 的进程 ID，这个特殊变量可以用来命名临时文件。Like <code>LOGFILE=/tmp/output_log.$$</code>,有时也可以用来杀死自己</p></li><li><p>$_<br>为上一个命令的最后一个参数，也可以使用<code>esc + .</code></p></li><li><p>$0<br>为当前 Shell 的名称（在命令行直接执行时）或者脚本名（在脚本中执行时）。</p></li></ol><h3 id="变量的默认值"><a href="#变量的默认值" class="headerlink" title="变量的默认值"></a>变量的默认值</h3><p>Bash 提供四个特殊语法，跟变量的默认值有关，目的是保证变量不为空。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$&#123;varname:-word&#125;# 如果变量varname存在且不为空，则返回它的值，否则返回word</span><br><span class="line">$&#123;varname:=word&#125;# 如果变量varname存在且不为空，则返回它的值，否则将它设为word，并且返回word</span><br><span class="line">$&#123;varname:+word&#125;# 如果变量名存在且不为空，则返回word，否则返回空值。</span><br><span class="line">$&#123;varname:?message&#125;# 如果变量varname存在且不为空，则返回它的值，否则打印出varname: message，并中断脚本的执行</span><br><span class="line">filename=$&#123;1:?&quot;filename missing.&quot;&#125; # 如果参数1不存在，就退出脚本并报错。</span><br></pre></td></tr></table></figure><h3 id="declare-命令"><a href="#declare-命令" class="headerlink" title="declare 命令"></a>declare 命令</h3><p>declare命令可以声明一些特殊类型的变量，为变量设置一些限制，比如声明只读类型的变量和整数类型的变量。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">declare OPTION VARIABLE=value</span><br><span class="line"></span><br><span class="line"># -a：声明数组变量。</span><br><span class="line"># -f：输出所有函数定义。</span><br><span class="line"># -F：输出所有函数名。</span><br><span class="line"># -i：声明整数变量。</span><br><span class="line"># -l：声明变量为小写字母。</span><br><span class="line"># -p：查看变量信息。</span><br><span class="line"># -r：声明只读变量。</span><br><span class="line"># -u：声明变量为大写字母。</span><br><span class="line"># -x：该变量输出为环境变量。</span><br><span class="line"></span><br><span class="line">$ declare -x foo# 等同于 export foo</span><br><span class="line"></span><br><span class="line">$ declare -r bar=1# 只读变量不可更改,不可unset</span><br><span class="line"></span><br><span class="line">$ a=10;b=20</span><br><span class="line">$ declare -i c=a*b# 将参数声明整数变量以后，可以直接进行数学运算</span><br><span class="line">$ echo $&#123;c&#125;</span><br><span class="line">200</span><br><span class="line"></span><br><span class="line">$ declare -l foo=“foo”# 变量小写 Mac中不支持</span><br><span class="line">$ declare -u bar=&quot;bar&quot;# 变量大写 Mac中不支持</span><br><span class="line"></span><br><span class="line">$ declare -p a # 输出变量信息</span><br><span class="line">declare -- a=&quot;10&quot;</span><br><span class="line"></span><br><span class="line">$ declare -f# 输出当前环境的所有函数，包括它的定义。</span><br><span class="line">$ declare -F# 输出当前环境的所有函数，包括它的定义</span><br></pre></td></tr></table></figure><p>来自网道项目：<a href="https://wangdoc.com/bash/" target="_blank" rel="noopener">https://wangdoc.com/bash/</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协&gt;议进行授权。</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> Bash基础入门 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bash基础入门（1）</title>
      <link href="2020/11/08/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%881%EF%BC%89/"/>
      <url>2020/11/08/Bash/Bash%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%EF%BC%881%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h1 id="描述-Bash基础入门（1）"><a href="#描述-Bash基础入门（1）" class="headerlink" title="描述: Bash基础入门（1）"></a>描述: Bash基础入门（1）</h1><a id="more"></a><h3 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h3><p><code>Ctrl + L</code>：清除屏幕并将当前行移到页面顶部。<br><code>Ctrl + C</code>：中止当前正在执行的命令。<br><code>Ctrl + U</code>：从光标位置删除到行首。<br><code>Ctrl + K</code>：从光标位置删除到行尾。<br><code>Ctrl + D</code>：关闭 Shell 会话。<br><code>Tab</code>：自动补全</p><h3 id="分号"><a href="#分号" class="headerlink" title="分号"></a>分号</h3><p>分号（<code>;</code>）是命令的结束符，使得一行可以放置多个命令，上一个命令执行结束后，再执行第二个命令。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 例1</span><br><span class="line">for i in `ls`;do </span><br><span class="line">    echo $i is file name\!;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"># 例2</span><br><span class="line">touch file; ls</span><br></pre></td></tr></table></figure><p>例如for循环，例2中，Bash 先执行touch命令，执行完成后，再执行ls命令。</p><p>注意，使用分号时，第二个命令总是接着第一个命令执行，无论touch执行成功或失败。</p><h3 id="amp-amp-和"><a href="#amp-amp-和" class="headerlink" title="&amp;&amp; 和 ||"></a>&amp;&amp; 和 ||</h3><p><code>&amp;&amp;</code>和<code>||</code>可以处理命令之间的执行关系</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls &amp;&amp; echo &quot;Hello&quot;</span><br></pre></td></tr></table></figure><p>表示如果<code>ls</code>命令成功，才运行<code>echo</code>命令。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch 123 || ls</span><br></pre></td></tr></table></figure><p>表示如果<code>touch</code>命令运行失败，才运行<code>ls</code>命令，如果<code>touch</code>成功则不执行<code>ls</code>。</p><h3 id="和-匹配"><a href="#和-匹配" class="headerlink" title="?和*匹配"></a><code>?</code>和<code>*</code>匹配</h3><p><code>?</code>匹配单个字符,<code>*</code>匹配任意数量的任意字符</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ls ?.txt</span><br><span class="line">1.txt 2.txt</span><br><span class="line"></span><br><span class="line">$ ls *.txt</span><br><span class="line">1.txt 2.txt 123.txt</span><br></pre></td></tr></table></figure><p>注意，<code>*</code>不会匹配隐藏文件（以<code>.</code>开头的文件），即<code>ls *</code>不会输出隐藏文件。</p><p>如果要匹配隐藏文件，需要写成<code>.*</code>。</p><h3 id="方括号匹配"><a href="#方括号匹配" class="headerlink" title="方括号匹配"></a>方括号匹配</h3><p>匹配括号之中的任意一个字符。比如，[12345]可以匹配五个数字的任意一个。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ls [12345].txt</span><br><span class="line">1.txt 2.txt</span><br><span class="line"></span><br><span class="line"># 只存在文件 a.txt</span><br><span class="line">$ ls [12345].txt</span><br><span class="line">1.txt</span><br></pre></td></tr></table></figure><p>反向匹配，<code>[^abc]</code>或<code>[!abc]</code>表示匹配除了a、b、c以外的字符.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 存在 111、123、222 三个文件</span><br><span class="line">$ ls ?[!2]?</span><br><span class="line">111</span><br></pre></td></tr></table></figure><p>连续匹配<code>[0-9]</code>,<code>[a-z]</code>,<code>[A-Z]</code>，还有<code>[!1-9]</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls demo[0-9].txt</span><br><span class="line">demo1.txt demo3.txt</span><br></pre></td></tr></table></figure><ul><li>[a-z]：所有小写字母。</li><li>[a-zA-Z]：所有小写字母与大写字母。</li><li>[a-zA-Z0-9]：所有小写字母、大写字母与数字。</li><li>[abc]*：所有以a、b、c字符之一开头的文件名。</li><li>program.[co]：文件program.c与文件program.o。</li><li>BACKUP.[0-9][0-9][0-9]：所有以BACKUP.开头，后面是三个数字的文件名。</li></ul><p>注意，如果需要匹配<code>[</code>字符，可以放在方括号内，比如<code>[[aeiou]</code>。如果需要匹配连字号<code>-</code>，只能放在方括号内部的开头或结尾，比如<code>[-aeiou]</code>或<code>[aeiou-]</code></p><h3 id="大括号扩展"><a href="#大括号扩展" class="headerlink" title="大括号扩展"></a>大括号扩展</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 例1,创建3个文件</span><br><span class="line">$ touch &#123;1,2,3&#125;.txt</span><br><span class="line"></span><br><span class="line"># 例2，创建9个文件夹</span><br><span class="line">$ mkdir &#123;1,2,3&#125;/&#123;1,2,3&#125;</span><br><span class="line"></span><br><span class="line"># 例3，嵌套扩展</span><br><span class="line">$ touch 1.&#123;j&#123;p,pe&#125;g,png&#125;</span><br><span class="line">1.jpeg  1.jpg   1.png</span><br><span class="line"></span><br><span class="line"># 例4，for循环连用</span><br><span class="line">for i in &#123;1..4&#125;</span><br><span class="line">do</span><br><span class="line">  echo $i</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>注意，大括号扩展内部的逗号前后不能有空格。否则，大括号扩展会失效。</p><h3 id="字符"><a href="#字符" class="headerlink" title="$字符"></a><code>$</code>字符</h3><p>Bash将<code>$</code>开头的的词视为变量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$SHELL</span><br><span class="line">或</span><br><span class="line">$&#123;SHELL&#125;</span><br></pre></td></tr></table></figure><p>Bash会先返回<code>$(Command)</code>中<code>Command</code>的运行结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo $(date)</span><br></pre></td></tr></table></figure><h3 id="特别匹配"><a href="#特别匹配" class="headerlink" title="特别匹配"></a>特别匹配</h3><ul><li>[[:alnum:]]：匹配任意英文字母与数字</li><li>[[:alpha:]]：匹配任意英文字母</li><li>[[:blank:]]：空格和 Tab 键。</li><li>[[:cntrl:]]：ASCII 码 0-31 的不可打印字符。</li><li>[[:digit:]]：匹配任意数字 0-9。</li><li>[[:graph:]]：A-Z、a-z、0-9 和标点符号。</li><li>[[:lower:]]：匹配任意小写字母 a-z。</li><li>[[:print:]]：ASCII 码 32-127 的可打印字符。</li><li>[[:punct:]]：标点符号（除了 A-Z、a-z、0-9 的可打印字符）。</li><li>[[:space:]]：空格、Tab、LF（10）、VT（11）、FF（12）、CR（13）。</li><li>[[:upper:]]：匹配任意大写字母 A-Z。</li><li>[[:xdigit:]]：16进制字符（A-F、a-f、0-9）。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 列出所有以大写字母开头的文件</span><br><span class="line">$ ls [[:upper:]]*</span><br></pre></td></tr></table></figure></li></ul><h3 id="量词匹配"><a href="#量词匹配" class="headerlink" title="量词匹配"></a>量词匹配</h3><p><code>?(XXX)</code>匹配0个或1个<code>XXX</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 匹配0个或1个.txt</span><br><span class="line">$ ls abc?(.txt)</span><br><span class="line">abc abc.txt</span><br></pre></td></tr></table></figure><p><code>+(XXX)</code>匹配1个或多个<code>XXX</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls abc+(.txt)</span><br><span class="line">abc.txt abc.txt.txt</span><br></pre></td></tr></table></figure><h3 id="引号和转义"><a href="#引号和转义" class="headerlink" title="引号和转义"></a>引号和转义</h3><p><code>&#39;</code>单引号效力最强，会让一切转义失效保留原样。<code>&quot;</code>双引号保留美元符号（<code>$</code>）、反引号（<code>\``）和反斜杠（</code>`）的效力</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ a=1</span><br><span class="line"></span><br><span class="line">$ echo &apos;$a&apos;</span><br><span class="line">$a</span><br><span class="line"></span><br><span class="line"># 双引号使用变量</span><br><span class="line">$ echo &quot;$a&quot;</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line"># -e 参数转义</span><br><span class="line">$ echo -e &quot;a\tb&quot;</span><br><span class="line">ab</span><br><span class="line"></span><br><span class="line"># 反引号</span><br><span class="line">$ echo &quot;I&apos;d say: \&quot;hello!\&quot;&quot;</span><br><span class="line">I&apos;d say: &quot;hello!&quot;</span><br><span class="line"></span><br><span class="line"># 输出多行文本</span><br><span class="line">$ echo &quot;hello</span><br><span class="line">world&quot;</span><br><span class="line">hello</span><br><span class="line">world</span><br><span class="line"></span><br><span class="line"># 单行输出</span><br><span class="line">$ echo $(cal)</span><br><span class="line">一月 2020 日 一 二 三 四 五 六 1 2 3 ... 31</span><br><span class="line"></span><br><span class="line"># 原始格式输出</span><br><span class="line">$ echo &quot;$(cal)&quot;</span><br><span class="line">      一月 2020</span><br><span class="line">日 一 二 三 四 五 六</span><br><span class="line">          1  2  3  4</span><br><span class="line"> 5  6  7  8  9 10 11</span><br><span class="line">12 13 14 15 16 17 18</span><br><span class="line">19 20 21 22 23 24 25</span><br><span class="line">26 27 28 29 30 31</span><br></pre></td></tr></table></figure><p>来自网道项目：<a href="https://wangdoc.com/bash/" target="_blank" rel="noopener">https://wangdoc.com/bash/</a></p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权。</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> Bash基础入门 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell别名alias</title>
      <link href="2020/11/08/Bash/shell%E5%88%AB%E5%90%8Dalias/"/>
      <url>2020/11/08/Bash/shell%E5%88%AB%E5%90%8Dalias/</url>
      
        <content type="html"><![CDATA[<h3 id="描述-为命令添加别名"><a href="#描述-为命令添加别名" class="headerlink" title="描述: 为命令添加别名"></a>描述: 为命令添加别名</h3><a id="more"></a><ol><li><p>新建或打开 ~/.bashrc</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.bashrc</span><br></pre></td></tr></table></figure><p>输入以下内容，这是git常用的几个命令。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">alias pull="git pull"</span><br><span class="line">alias commit="git commit"</span><br><span class="line">alias push="git push"</span><br><span class="line">alias branch="git branch"</span><br><span class="line">alias check="git checkout"</span><br><span class="line">alias st="git status"</span><br></pre></td></tr></table></figure></li><li><p>让别名立即生效</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure></li><li><p>让别名永久生效，新建或打开 ~/.bash_profile</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.bash_profile</span><br><span class="line">if [ -f ~/.bashrc ]; then</span><br><span class="line">  source ~/.bashrc</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>如果别名特别多，我们可以创建单独的<code>~/.alias</code>文件存放别名,并在<code>~/.bashrc</code>中读取</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if [ -f ~/.alias ]; then</span><br><span class="line">  source ~/.alias</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></li><li><p>alias相关操作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 新增别名 只在当前终端有效</span><br><span class="line">$ alias hw=&apos;echo &quot;hello world&quot;&apos;</span><br><span class="line"></span><br><span class="line"># 查看现有别名</span><br><span class="line">$ alias</span><br><span class="line">alias ll=&apos;ls -al&apos;</span><br><span class="line">alias hw=&apos;echo &quot;hello world&quot;&apos;</span><br><span class="line"></span><br><span class="line"># 取消别名</span><br><span class="line">$ unalias ll</span><br><span class="line"></span><br><span class="line"># 取消所有别名</span><br><span class="line">$ unalias -a</span><br></pre></td></tr></table></figure></li></ol><p>如果别名是写在文件中，即使使用命令取消了别名，用户重新登陆别名还是存在的.</p><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell-history添加时间戳</title>
      <link href="2020/11/08/Bash/shell-history%E6%B7%BB%E5%8A%A0%E6%97%B6%E9%97%B4%E6%88%B3/"/>
      <url>2020/11/08/Bash/shell-history%E6%B7%BB%E5%8A%A0%E6%97%B6%E9%97%B4%E6%88%B3/</url>
      
        <content type="html"><![CDATA[<h1 id="描述-为history添加时间戳"><a href="#描述-为history添加时间戳" class="headerlink" title="描述: 为history添加时间戳"></a>描述: 为history添加时间戳</h1><a id="more"></a><h4 id="设置系统环境变量"><a href="#设置系统环境变量" class="headerlink" title="设置系统环境变量"></a>设置系统环境变量</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;export HISTTIMEFORMAT=&quot;%F %T  `whoami` &quot;&apos; &gt;&gt; /etc/profile &amp;&amp; source /etc/profile</span><br></pre></td></tr></table></figure><h3 id="时间参数解析"><a href="#时间参数解析" class="headerlink" title="时间参数解析"></a>时间参数解析</h3><ol><li><p>history的历史命令保存在~/.bash_history 文件中   #仅仅对当前用户有效，应设置全局环境变量/etc/profile</p></li><li><p>~/.bashrc文件可添加的history相关的说明        </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">HISTFILESIZE=2000      #设置保存历史命令的文件大小        </span><br><span class="line"></span><br><span class="line">HISTSIZE=2000           #保存历史命令条数        </span><br><span class="line"></span><br><span class="line">HISTTIMEFORMAT=&quot;%Y-%m-%d:%H-%M-%S `whoami`:  &quot;    #记录每条历史命令的执行时间和执行者        </span><br><span class="line"></span><br><span class="line">export HISTTIMEFORMAT    </span><br><span class="line"></span><br><span class="line"># 其中： date +%Y-%m-%d    ==2017-06-09</span><br><span class="line"># </span><br><span class="line"># %Y:4位数的年份；        </span><br><span class="line"># </span><br><span class="line"># %m:2位数的月份数；        </span><br><span class="line"># </span><br><span class="line"># %d:2位数的一个月中的日期数；        </span><br><span class="line"># </span><br><span class="line"># %H：2位数的小时数（24小时制）；        </span><br><span class="line"># </span><br><span class="line"># %M：2位数的分钟数；        </span><br><span class="line"># </span><br><span class="line"># %S：2位数的秒数</span><br></pre></td></tr></table></figure></li></ol><p>如果打开了多个终端会话，仍然可以使用history -a命令在打开的会话中 向.bash_history文件中添加记录。但是对于其他打开的终端会话，历史记录并不会自动更 新。这是因为.bash_history文件只有在打开首个终端会话时才会被读取。要想强制重新读 取.bash_history文件，更新终端会话的历史记录，可以使用history -n命令。</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo博客中图片插入</title>
      <link href="2020/11/08/Hexo%E5%8D%9A%E5%AE%A2%E4%B8%AD%E5%9B%BE%E7%89%87%E6%8F%92%E5%85%A5/"/>
      <url>2020/11/08/Hexo%E5%8D%9A%E5%AE%A2%E4%B8%AD%E5%9B%BE%E7%89%87%E6%8F%92%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<h3 id="描述-Hexo博客中图片插入"><a href="#描述-Hexo博客中图片插入" class="headerlink" title="描述: Hexo博客中图片插入"></a>描述: Hexo博客中图片插入</h3><a id="more"></a><ol><li>绝对路径</li></ol><p>可以将图片统一放在Hexo根目录的source/images文件夹中，在文章中通过markdown语法访问它们。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![](/images/image.jpg)</span><br></pre></td></tr></table></figure><p>图片既可以在首页内容中访问到，也可以在文章正文中访问到。</p><ol start="2"><li>相对路径</li></ol><p>在Hexo项目根目录中修改<code>_config.yml</code>并找到<code>post_asset_folder</code>字段</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim _config.yml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 将post_asset_folder修改为true</span><br><span class="line">post_asset_folder: true</span><br></pre></td></tr></table></figure><p>之后<code>hexo new article</code>除了会在<code>source/_posts</code>目录下生成同名文章之外，还会有同名文件夹，图片放入文件夹中即可引用</p><p>在文章中引用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 插入图片，当图片无法载入时会显示[]内的文字</span><br><span class="line">![](1.png)</span><br></pre></td></tr></table></figure><p>如果希望图片在文章和首页中同时显示，可以使用标签插件语法。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% asset_img image.jpg This is an image %&#125;</span><br></pre></td></tr></table></figure><p>Like this:<br><img src="1.png" alt></p>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 个人实践 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo Next主题下添加搜索功能</title>
      <link href="2020/11/08/Hexo-Next%E4%B8%BB%E9%A2%98%E4%B8%8B%E6%B7%BB%E5%8A%A0%E6%90%9C%E7%B4%A2%E5%8A%9F%E8%83%BD/"/>
      <url>2020/11/08/Hexo-Next%E4%B8%BB%E9%A2%98%E4%B8%8B%E6%B7%BB%E5%8A%A0%E6%90%9C%E7%B4%A2%E5%8A%9F%E8%83%BD/</url>
      
        <content type="html"><![CDATA[<h3 id="描述-在Next主题下添加搜索功能"><a href="#描述-在Next主题下添加搜索功能" class="headerlink" title="描述: 在Next主题下添加搜索功能"></a>描述: 在Next主题下添加搜索功能</h3><a id="more"></a><p>有两种插件可用，安装一种即可</p><ol><li><p>hexo-generator-search插件<br>在hexo根目录安装<code>hexo-generator-search</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-generator-search --save</span><br></pre></td></tr></table></figure></li><li><p>hexo-generator-searchdb插件<br>在hexo根目录安装<code>hexo-generator-searchdb</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-generator-searchdb --save</span><br></pre></td></tr></table></figure></li></ol><p>附上searchdb的repo: <a href="https://github.com/theme-next/hexo-generator-searchdb" target="_blank" rel="noopener">https://github.com/theme-next/hexo-generator-searchdb</a></p><p>剩下的步骤是一样的</p><p>在hexo根目录修改<code>_config.yml</code>文件,添加以下内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">search:</span><br><span class="line">  path: search.xml</span><br><span class="line">  field: post</span><br><span class="line">  content: true</span><br><span class="line">  format: html</span><br></pre></td></tr></table></figure><p>参数：</p><ul><li>path - file path. By default is search.xml. If the file extension is .json, the output format will be JSON. Otherwise XML format file will be exported.</li><li>field - the search scope you want to search, you can chose:<ul><li>post (Default) - will only cover all the posts of your blog.</li><li>page - will only cover all the pages of your blog.</li><li>all - will cover all the posts and pages of your blog.</li></ul></li><li>content - whether contains the whole content of each article. If false, the generated results only cover title and other meta info without mainbody. By default is true.</li><li>format - the form of the page contents, options are:<ul><li>html (Default) - original html string being minified.</li><li>striptags - original html string being minified, and remove all the tags.</li><li>raw - markdown text of each posts or pages.</li></ul></li></ul><p>最后在next主题的<code>_config.yml</code>文件中修改<code>local_search</code>配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim themes/next/_config.yml</span><br><span class="line"></span><br><span class="line"># 找到并修改</span><br><span class="line">local_search:</span><br><span class="line">  enable: true</span><br><span class="line">  trigger: auto</span><br><span class="line">  top_n_per_article: 1</span><br></pre></td></tr></table></figure><p>参数：</p><ul><li>enable 启用搜索</li></ul><p>补充:</p><p>当安装了搜索功能之后,我发现如果在非主页搜索会出现问题.<br>能够正常搜索,但是当你点击跳转时,目标URL会在当前URL的基础上添加真正的目标地址.就会显示404.<br><a href="https://hkcm.github.io/2020/11/18/AWS-CLI(2)使用/2020/11/16/AWS-CLI(1)安装和配置" target="_blank" rel="noopener">https://hkcm.github.io/2020/11/18/AWS-CLI(2)使用/2020/11/16/AWS-CLI(1)安装和配置</a></p><p>其根本原因在于<code>search.xml</code>中的<code>&lt;URL&gt;</code>是相对地址,所以就会带上当前页面的地址.<br>所以解决方案就是将相对地址变成绝对地址,方法有两个:</p><ol><li><p>读取<code>search.xml</code>时,添加跟路径<br>在<code>themes/next/source/js/local-search.js</code>中,找到以下代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (slicesOfTitle.length !== 0) &#123;</span><br><span class="line">    resultItem += `&lt;li&gt;&lt;a href=&quot;$&#123;url&#125;&quot; class=&quot;search-result-title&quot;&gt;$&#123;highlightKeyword(title, slicesOfTitle[0])&#125;&lt;/a&gt;`;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    resultItem += `&lt;li&gt;&lt;a href=&quot;$&#123;url&#125;&quot; class=&quot;search-result-title&quot;&gt;$&#123;title&#125;&lt;/a&gt;`;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">slicesOfContent.forEach(slice =&gt; &#123;</span><br><span class="line">    resultItem += `&lt;a href=&quot;$&#123;url&#125;&quot;&gt;&lt;p class=&quot;search-result&quot;&gt;$&#123;highlightKeyword(content, slice)&#125;...&lt;/p&gt;&lt;/a&gt;`;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>改为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (slicesOfTitle.length !== 0) &#123;</span><br><span class="line">    resultItem += `&lt;li&gt;&lt;a href=&quot;\/$&#123;url&#125;&quot; class=&quot;search-result-title&quot;&gt;$&#123;highlightKeyword(title, slicesOfTitle[0])&#125;&lt;/a&gt;`;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    resultItem += `&lt;li&gt;&lt;a href=&quot;\/$&#123;url&#125;&quot; class=&quot;search-result-title&quot;&gt;$&#123;title&#125;&lt;/a&gt;`;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">slicesOfContent.forEach(slice =&gt; &#123;</span><br><span class="line">    resultItem += `&lt;a href=&quot;\/$&#123;url&#125;&quot;&gt;&lt;p class=&quot;search-result&quot;&gt;$&#123;highlightKeyword(content, slice)&#125;...&lt;/p&gt;&lt;/a&gt;`;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li><p>生成<code>search.xml</code>就在<code>&lt;URL&gt;</code>字段前添加<code>/</code>.<br>这个是理论可行的,但是我没找到生成的代码,有人找到了欢迎指正</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 个人实践 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell日志</title>
      <link href="2020/11/08/Bash/shell%E6%97%A5%E5%BF%97/"/>
      <url>2020/11/08/Bash/shell%E6%97%A5%E5%BF%97/</url>
      
        <content type="html"><![CDATA[<h3 id="描述-Ubuntu-日志相关"><a href="#描述-Ubuntu-日志相关" class="headerlink" title="描述: Ubuntu 日志相关"></a>描述: Ubuntu 日志相关</h3><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/var/log/messages：常规日志消息</span><br><span class="line">/var/log/boot：系统启动日志</span><br><span class="line">/var/log/debug：调试日志消息</span><br><span class="line">/var/log/auth.log：用户登录和身份验证日志</span><br><span class="line">/var/log/daemon.log：运行squid，ntpd等其他日志消息到这个文件</span><br><span class="line">/var/log/dmesg：Linux内核环缓存日志</span><br><span class="line">/var/log/dpkg.log：所有二进制包日志都包括程序包安装和其他信息</span><br><span class="line">/var/log/faillog：用户登录日志文件失败</span><br><span class="line">/var/log/kern.log：内核日志文件</span><br><span class="line">/var/log/lpr.log：打印机日志文件</span><br><span class="line">/var/log/mail.*：所有邮件服务器消息日志文件</span><br><span class="line">/var/log/mysql.*：MySQL服务器日志文件</span><br><span class="line">/var/log/user.log：所有用户级日志</span><br><span class="line">/var/log/xorg.0.log：X.org日志文件</span><br><span class="line">/var/log/apache2/*：Apache Web服务器日志文件目录</span><br><span class="line">/var/log/lighttpd/*：Lighttpd Web服务器日志文件目录</span><br><span class="line">/var/log/fsck/*：fsck命令日志</span><br><span class="line">/var/log/apport.log：应用程序崩溃报告/日志文件</span><br><span class="line">/var/log/syslog：系统日志</span><br><span class="line">/var/log/ufw：ufw防火墙日志</span><br><span class="line">/var/log/gufw：gufw防火墙日志</span><br></pre></td></tr></table></figure><h3 id="在脚本中写入系统日志"><a href="#在脚本中写入系统日志" class="headerlink" title="在脚本中写入系统日志"></a>在脚本中写入系统日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger –t ScriptName "Hello World"</span><br></pre></td></tr></table></figure><h3 id="在脚本中输出并记录日志"><a href="#在脚本中输出并记录日志" class="headerlink" title="在脚本中输出并记录日志"></a>在脚本中输出并记录日志</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo "$(date +"%Y-%m-%d_%H-%M-%S") somethong wrong" | tee -a /var/log/script_log</span><br></pre></td></tr></table></figure><h3 id="在脚本中写日志函数"><a href="#在脚本中写日志函数" class="headerlink" title="在脚本中写日志函数"></a>在脚本中写日志函数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">LOG_FILE='/var/log/script_'$(date +"%Y-%m-%d_%H-%M-%S")'.log'</span><br><span class="line"></span><br><span class="line">function write_log()</span><br><span class="line">&#123;</span><br><span class="line">  now_time='['$(date +"%Y-%m-%d %H:%M:%S")']'</span><br><span class="line">  echo $&#123;now_time&#125; $1 | tee -a $&#123;log_file&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">write_log "everything is ok"</span><br></pre></td></tr></table></figure><h3 id="使用cat-tail-more-less和grep命令。"><a href="#使用cat-tail-more-less和grep命令。" class="headerlink" title="使用cat, tail, more,less和grep命令。"></a>使用cat, tail, more,less和grep命令。</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat -n /var/log/syslog |grep "key" |more</span><br><span class="line">tail -f /var/log/apport.log</span><br><span class="line">more /var/log/xorg.0.log</span><br><span class="line">cat /var/log/mysql.err</span><br><span class="line">less /var/log/messages</span><br><span class="line">grep -i fail /var/log/boot</span><br></pre></td></tr></table></figure><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell提示用户确认操作</title>
      <link href="2020/11/08/Bash/shell%E6%8F%90%E7%A4%BA%E7%94%A8%E6%88%B7%E7%A1%AE%E8%AE%A4%E6%93%8D%E4%BD%9C/"/>
      <url>2020/11/08/Bash/shell%E6%8F%90%E7%A4%BA%E7%94%A8%E6%88%B7%E7%A1%AE%E8%AE%A4%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h3 id="描述-shell脚本中提示用户确认操作"><a href="#描述-shell脚本中提示用户确认操作" class="headerlink" title="描述: shell脚本中提示用户确认操作"></a>描述: shell脚本中提示用户确认操作</h3><a id="more"></a><h4 id="例1：确认提示（一次）"><a href="#例1：确认提示（一次）" class="headerlink" title="例1：确认提示（一次）"></a>例1：确认提示（一次）</h4><p>这个示例代码将为确认提示一次，如果你给输入错误，程序会以状态1退出。这个例子将只接受Y或N或YES或NO（不区分大小写）。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line">read -r -p "Are You Sure? [Y/n] " input</span><br><span class="line"></span><br><span class="line">case $input in</span><br><span class="line">    [yY][eE][sS]|[yY])</span><br><span class="line">echo "Yes"</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">    [nN][oO]|[nN])</span><br><span class="line">echo "No"</span><br><span class="line">       ;;</span><br><span class="line"></span><br><span class="line">    *)</span><br><span class="line">echo "Invalid input..."</span><br><span class="line">exit 1</span><br><span class="line">;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure><h4 id="例2：提示进行确认（输入正常退出，输入错误则需重新输入）"><a href="#例2：提示进行确认（输入正常退出，输入错误则需重新输入）" class="headerlink" title="例2：提示进行确认（输入正常退出，输入错误则需重新输入）"></a>例2：提示进行确认（输入正常退出，输入错误则需重新输入）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">read -r -p "Are You Sure? [Y/n] " input</span><br><span class="line"></span><br><span class="line">case $input in</span><br><span class="line">    [yY][eE][sS]|[yY])</span><br><span class="line">echo "Yes"</span><br><span class="line">exit 1</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">    [nN][oO]|[nN])</span><br><span class="line">echo "No"</span><br><span class="line">exit 1       </span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">    *)</span><br><span class="line">echo "Invalid input..."</span><br><span class="line">;;</span><br><span class="line">esac</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell获取本机IP</title>
      <link href="2020/11/08/Bash/shell%E8%8E%B7%E5%8F%96%E6%9C%AC%E6%9C%BAIP/"/>
      <url>2020/11/08/Bash/shell%E8%8E%B7%E5%8F%96%E6%9C%AC%E6%9C%BAIP/</url>
      
        <content type="html"><![CDATA[<h3 id="shell获取本机IP"><a href="#shell获取本机IP" class="headerlink" title="shell获取本机IP"></a>shell获取本机IP</h3><a id="more"></a><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl icanhazip.com</span><br><span class="line">curl ifconfig.me</span><br><span class="line">curl http://checkip.amazonaws.com</span><br><span class="line">wget http://ipecho.net/plain -O - -q</span><br></pre></td></tr></table></figure><h3 id="EC2"><a href="#EC2" class="headerlink" title="EC2"></a>EC2</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> Get private IPv4:</span><br><span class="line">curl http://169.254.169.254/latest/meta-data/local-ipv4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> Get public IPv4</span><br><span class="line">curl http://169.254.169.254/latest/meta-data/public-ipv4</span><br></pre></td></tr></table></figure><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell获取用户家目录</title>
      <link href="2020/11/08/Bash/shell%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E5%AE%B6%E7%9B%AE%E5%BD%95/"/>
      <url>2020/11/08/Bash/shell%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E5%AE%B6%E7%9B%AE%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<h3 id="获取用户家目录"><a href="#获取用户家目录" class="headerlink" title="获取用户家目录"></a>获取用户家目录</h3><a id="more"></a><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo $HOME</span><br><span class="line"></span><br><span class="line">env|grep ^HOME=|cut -c 6-</span><br></pre></td></tr></table></figure><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell脚本菜单目录实现</title>
      <link href="2020/11/08/Bash/shell%E8%84%9A%E6%9C%AC%E8%8F%9C%E5%8D%95%E7%9B%AE%E5%BD%95%E5%AE%9E%E7%8E%B0/"/>
      <url>2020/11/08/Bash/shell%E8%84%9A%E6%9C%AC%E8%8F%9C%E5%8D%95%E7%9B%AE%E5%BD%95%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h3 id="一个简单shell菜单实现"><a href="#一个简单shell菜单实现" class="headerlink" title="一个简单shell菜单实现"></a>一个简单shell菜单实现</h3><a id="more"></a><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line">cat &lt;&lt; EOF</span><br><span class="line">********please enter your choice:(1-6)****</span><br><span class="line">(1) List you selected directory</span><br><span class="line">(2) Change to you selected directory</span><br><span class="line">(3) Create a new file</span><br><span class="line">(4) Edit you selected file</span><br><span class="line">(5) Remove you selected file.</span><br><span class="line">(6) Exit Menu.</span><br><span class="line">EOF</span><br><span class="line">read -p "Now select the top option to: " input</span><br><span class="line">case $input in </span><br><span class="line">1) ls;;</span><br><span class="line">2) echo "Enter target directory:"</span><br><span class="line">read dir</span><br><span class="line">cd $dir;;</span><br><span class="line">3) echo "Enter a file name:"</span><br><span class="line">read file</span><br><span class="line">touch $file;;</span><br><span class="line">4) echo "Enter a file name:"</span><br><span class="line">read file</span><br><span class="line">vi $file;;</span><br><span class="line">5) echo "Enter a file name:"</span><br><span class="line">read file</span><br><span class="line">rm $file;;</span><br><span class="line">6) echo "Bye"</span><br><span class="line">exit 0;;</span><br><span class="line">*) echo "Invalid input,bye"</span><br><span class="line">exit 1;;</span><br><span class="line">esac</span><br></pre></td></tr></table></figure><p>也可以通过<code>while ture</code> 循环菜单</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">while true</span><br><span class="line">do</span><br><span class="line">  cat &lt;&lt; EOF</span><br><span class="line">  ********please enter your choice:(1-6)****</span><br><span class="line"></span><br><span class="line">  (1) List you selected directory</span><br><span class="line">  (2) Change to you selected directory</span><br><span class="line">  (3) Create a new file</span><br><span class="line">  (4) Edit you selected file</span><br><span class="line">  (5) Remove you selected file.</span><br><span class="line">  (6) Exit Menu.</span><br><span class="line">  EOF</span><br><span class="line">  read -p "Now select the top option to: " input</span><br><span class="line">  case $input in </span><br><span class="line">  1) ls;;</span><br><span class="line">  2) echo "Enter target directory:"</span><br><span class="line">  read dir</span><br><span class="line">  cd $dir;;</span><br><span class="line">  3) echo "Enter a file name:"</span><br><span class="line">  read file</span><br><span class="line">  touch $file;;</span><br><span class="line">  4) echo "Enter a file name:"</span><br><span class="line">  read file</span><br><span class="line">  vi $file;;</span><br><span class="line">  5) echo "Enter a file name:"</span><br><span class="line">  read file</span><br><span class="line">  rm $file;;</span><br><span class="line">  6) echo "Bye"</span><br><span class="line">  exit 0;;</span><br><span class="line">  *) echo "Invalid input,bye"</span><br><span class="line">  exit 1;;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> Bash </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Bash </tag>
            
            <tag> shell技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo疑难</title>
      <link href="2020/11/07/Hexo%E7%96%91%E9%9A%BE/"/>
      <url>2020/11/07/Hexo%E7%96%91%E9%9A%BE/</url>
      
        <content type="html"><![CDATA[<p>描述: 主要记录在配置hexo过程中遇到的问题</p><a id="more"></a><ol><li>部署时<code>hexo d</code>出现问题<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeError [ERR_INVALID_ARG_TYPE]: The &quot;mode&quot; argument must be integer. Received an instance of Object</span><br></pre></td></tr></table></figure></li></ol><p>node版本太高，我在node v14.15遇到切到v12.12问题解决，虽然出现了warning，hexo对node有一定要求，最好v14以下v10以上</p><ol start="2"><li>迁移</li></ol><p>本身hexo的根目录其实也是一个repo,所以定时push也是好的。</p><p>当使用了主题，并且<code>git add</code>时，可能会出现</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">warning: adding embedded git repository: themes/&lt;hexo-theme-name&gt;</span><br><span class="line">hint: You&apos;ve added another git repository inside your current repository.</span><br><span class="line">hint: Clones of the outer repository will not contain the contents of</span><br><span class="line">hint: the embedded repository and will not know how to obtain it.</span><br><span class="line">hint: If you meant to add a submodule, use:</span><br><span class="line">hint: </span><br><span class="line">hint:   git submodule add &lt;url&gt; themes/&lt;hexo-theme-name&gt;</span><br><span class="line">hint: </span><br><span class="line">hint: If you added this path by mistake, you can remove it from the</span><br><span class="line">hint: index with:</span><br><span class="line">hint: </span><br><span class="line">hint:   git rm --cached themes/&lt;hexo-theme-name&gt;</span><br><span class="line">hint: </span><br><span class="line">hint: See &quot;git help submodule&quot; for more information.</span><br></pre></td></tr></table></figure><p>这时有两个方案<br>    1. 可以按照提示，将相关主题作为子模块<br>    2. 进入该主题目录，删除隐藏的<code>.git</code>文件夹,并且重新<code>git add themes/&lt;hexo-theme-name&gt;/</code></p><ol start="3"><li>主题设置</li></ol><p>这里有位仁兄很详细的next的主题设置</p><p><a href="https://blog.csdn.net/nightmare_dimple/article/details/86661502" target="_blank" rel="noopener">https://blog.csdn.net/nightmare_dimple/article/details/86661502</a></p><ol start="4"><li><p>更换电脑clone hexo到本地后<code>hexo server</code>启动主页空白</p><ol><li><p>检查相关的depends是否安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm ls --depth 0 </span><br><span class="line"># 如果没有安装，进入hexo根目录</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure></li><li><p>检查hexo根目录下<code>_config.yml</code>的<code>theme</code>字段和<code>themes</code>文件夹中的名字是否一致</p></li></ol></li><li><p>hexo部署时遇到<code>fatal: in unpopulated submodule &#39;.deploy_git&#39;</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rm -rf .deploy_git</span><br><span class="line">$ hexo g</span><br><span class="line">$ hexo d</span><br></pre></td></tr></table></figure></li></ol>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 个人实践 </tag>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo分类和标签</title>
      <link href="2020/11/07/Hexo%E5%88%86%E7%B1%BB%E5%92%8C%E6%A0%87%E7%AD%BE/"/>
      <url>2020/11/07/Hexo%E5%88%86%E7%B1%BB%E5%92%8C%E6%A0%87%E7%AD%BE/</url>
      
        <content type="html"><![CDATA[<h3 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h3><p>为Hexo创建分类和标签管理</p><a id="more"></a><ol><li>创建分类</li><li>1 打开命令行，进入博客所在文件夹。执行命令<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> hexo new page categories</span><br></pre></td></tr></table></figure></li></ol><p>成功后会提示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INFO  Created: ~/Hexo_blog/source/categories/index.md</span><br></pre></td></tr></table></figure><p>根据上面的路径，找到index.md这个文件，打开后默认内容是这样的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: categories</span><br><span class="line">date: 2020-11-07 14:06:16</span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>1.2 添加type: “categories”到内容中，添加后是这样的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: categories</span><br><span class="line">date: 2020-11-07 14:06:16</span><br><span class="line">type: &quot;categories&quot;</span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>保存并关闭文件。</p><p>1.3 给文章添加“categories”属性<br>打开需要添加分类的文章，为其添加categories属性。下方的categories: web前端表示添加这篇文章到“web前端”这个分类。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: Hexo + GitHub搭建个人博客</span><br><span class="line">date: 2019-10-09 07:17:26</span><br><span class="line">categories:</span><br><span class="line">- 个人实践</span><br><span class="line">tags:</span><br><span class="line">- 个人实践</span><br><span class="line">---</span><br></pre></td></tr></table></figure><p><strong>注意：hexo一篇文章只能属于一个分类，也就是说如果在“- 个人实践”下方添加“-xxx”，hexo不会产生两个分类，而是把分类嵌套（即该文章属于 “- 个人实践”下的 “-xxx ”分类）。</strong></p><p>至此，成功给文章添加分类，点击首页的“分类”可以看到该分类下的所有文章。当然，只有添加了categories: xxx的文章才会被收录到首页的“分类”中。</p><ol start="2"><li>创建“标签”选项</li><li>1 和上面类似，打开命令行，进入博客所在文件夹。执行命令<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> hexo new page tags</span><br></pre></td></tr></table></figure></li></ol><p>成功后会提示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INFO  Created: ~/Hexo_blog/source/tags/index.md</span><br></pre></td></tr></table></figure><p>2.2 根据上面的路径，找到index.md这个文件，打开后默认内容是这样的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: tags</span><br><span class="line">date: 2020-11-07 14:07:08</span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>添加type: “tags”到内容中，添加后是这样的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: tags</span><br><span class="line">date: 2020-11-07 14:07:08</span><br><span class="line">type: &quot;tags&quot;</span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>保存并关闭文件。</p><p>2.3 给文章添加“tags”属性<br>打开需要添加标签的文章，为其添加tags属性。下方的tags<code>- 个人实践</code>就是这篇文章的标签了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: Hexo + GitHub搭建个人博客</span><br><span class="line">date: 2019-10-09 07:17:26</span><br><span class="line">categories:</span><br><span class="line">- 个人实践</span><br><span class="line">tags:</span><br><span class="line">- 个人实践</span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>至此，成功给文章添加分类，点击首页的“标签”可以看到该标签下的所有文章。当然，只有添加了tags: xxx的文章才会被收录到首页的“标签”中。</p><ol start="3"><li>修改模版</li></ol><p>我们可以打开scaffolds/post.md文件，</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim scaffolds/post.md</span><br></pre></td></tr></table></figure><p>可以看到</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: &#123;&#123; title &#125;&#125;</span><br><span class="line">date: &#123;&#123; date &#125;&#125;</span><br><span class="line">tags:</span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>在tages:上面加入categories:,</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: &#123;&#123; title &#125;&#125;</span><br><span class="line">date: &#123;&#123; date &#125;&#125;</span><br><span class="line">categories:</span><br><span class="line">tags:</span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>保存后，之后执行hexo new 文章名命令生成的文件，页面里就有categories:项了。</p><p>scaffolds目录下，是新建页面的模板，执行新建命令时，是根据这里的模板页来完成的，所以可以在这里根据你自己的需求添加一些默认值。</p><p>参考链接：<a href="https://www.jianshu.com/p/e17711e44e00" target="_blank" rel="noopener">https://www.jianshu.com/p/e17711e44e00</a></p>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 个人实践 </tag>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu下ntfs硬盘只读问题</title>
      <link href="2020/11/07/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/Ubuntu%E4%B8%8Bntfs%E7%A1%AC%E7%9B%98%E5%8F%AA%E8%AF%BB%E9%97%AE%E9%A2%98/"/>
      <url>2020/11/07/%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/Ubuntu%E4%B8%8Bntfs%E7%A1%AC%E7%9B%98%E5%8F%AA%E8%AF%BB%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>Ubuntu挂载ntfs格式的硬盘后可以读取，无法写入</p><a id="more"></a><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><ol><li><p>打开日志,查看插入硬盘（U）盘后的日志,根据日志修复，下方是通用方式</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f /var/log/syslog</span><br></pre></td></tr></table></figure></li><li><p>查看挂载位置,并记录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fdisk -l</span><br><span class="line"><span class="meta">#</span> 或</span><br><span class="line">df -h</span><br></pre></td></tr></table></figure></li><li><p>卸载挂载,以sdb1为例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount /dev/sdb1</span><br></pre></td></tr></table></figure></li><li><p>修复，安装ntfsfix</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install ntfsfix</span><br><span class="line">netsfix /dev/sdb1</span><br></pre></td></tr></table></figure></li></ol><p>附：有一种可能是Windows系统盘休眠导致的，需要将硬盘连接Windows,关闭休眠功能并正常关机后再连接Ubuntu</p><p><a href="https://github.com/HKCM/HKCM.github.io/issues" target="_blank" rel="noopener">全文有任何错误或疏漏，烦请不吝指正</a></p><p>本文采用知识共享 署名-相同方式共享 3.0协议</p><p>署名-相同方式共享（BY-SA）：使用者可以对本创作进行转载、节选、混编、二次创作，可以将其运用于商业用途，唯须署名作者，并且采用本创作的内容必须同样采用本协议进行授权</p>]]></content>
      
      
      <categories>
          
          <category> 疑难杂症 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ubuntu </tag>
            
            <tag> 疑难杂症 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MarkDown语法基础</title>
      <link href="2019/10/09/MarkDown%E8%AF%AD%E6%B3%95%E5%9F%BA%E7%A1%80/"/>
      <url>2019/10/09/MarkDown%E8%AF%AD%E6%B3%95%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<p>Markdown基础语法</p><p>新搭建好了博客,编辑内容时,需要标点和相关格式,hexo支持markdown语法.于是记录一下</p><a id="more"></a><p>标题</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 一级标题</span><br><span class="line">## 二级标题</span><br><span class="line">### 三级标题</span><br></pre></td></tr></table></figure><p>单行代码<br><code></code>echo “hello world”`<br>代码块</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">`echo &quot;hello world&quot;`</span><br><span class="line">`echo &quot;This is markdown&quot;`</span><br></pre></td></tr></table></figure><p>粗体斜体删除线</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*斜体*或_斜体_</span><br><span class="line">**粗体**</span><br><span class="line">***加粗斜体***</span><br><span class="line">~删除线~~</span><br></pre></td></tr></table></figure><p>列表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. 有序列表1</span><br><span class="line">2. 有序列表2</span><br><span class="line"></span><br><span class="line">- 无序列表</span><br><span class="line">- 无序列表</span><br></pre></td></tr></table></figure><p>超链接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">行内式</span><br><span class="line">[HKCM](https://hkcm.github.io)</span><br><span class="line"></span><br><span class="line">直接式</span><br><span class="line">&lt;https://hkcm.github.io&gt;</span><br><span class="line"></span><br><span class="line">参考式</span><br><span class="line">这是我的个人博客[HKCM][1]</span><br><span class="line">[1]:https://hkcm.github.io</span><br></pre></td></tr></table></figure><p>锚点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">锚点只支持标题</span><br><span class="line">## 目录&#123;#index&#125;</span><br><span class="line"></span><br><span class="line">跳转到[目录](#index)</span><br></pre></td></tr></table></figure><p>图像</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">行内式</span><br><span class="line">美丽花儿：</span><br><span class="line">![美丽花儿](http://ww2.sinaimg.cn/large/56d258bdjw1eugeubg8ujj21kw16odn6.jpg  &quot;美丽花儿&quot;)</span><br><span class="line"></span><br><span class="line">参考式</span><br><span class="line">美丽花儿：</span><br><span class="line">![美丽花儿][flower]</span><br><span class="line">[flower]:http://ww2.sinaimg.cn/large/56d258bdjw1eugeubg8ujj21kw16odn6.jpg  &quot;美丽花儿&quot;</span><br></pre></td></tr></table></figure><p>目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在段落中填写[TOC]</span><br></pre></td></tr></table></figure><p>表格</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">学号|姓名|分数</span><br><span class="line">-|-|-</span><br><span class="line">小明|男|75</span><br><span class="line">小红|女|79</span><br><span class="line">小陆|男|92</span><br></pre></td></tr></table></figure><p>最后附上Markdown中文官网链接: <a href="https://markdown-zh.readthedocs.io/en/latest/" target="_blank" rel="noopener">Markdown中文文档</a></p>]]></content>
      
      
      <categories>
          
          <category> 基础入门 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 基础入门 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo + GitHub搭建个人博客</title>
      <link href="2019/10/09/Hexo-GitHub%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/"/>
      <url>2019/10/09/Hexo-GitHub%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</url>
      
        <content type="html"><![CDATA[<p>通过Github结合hexo搭建个人博客</p><a id="more"></a><p>环境: Ubuntu18.04<br>前置条件1: 注册github账号并设置ssh key</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/#github地址</span><br></pre></td></tr></table></figure><p>创建新仓库,仓库名必须为”username.github.io”(username必须为你的用户名)</p><p>获取Repository地址,必须为ssh的,后面有用,地址格式为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git@github.com:username/username.github.io.git</span><br></pre></td></tr></table></figure><p>配置ssh key,然后找到密钥文件将密钥添加到你的github配置文件中,并测试是否添加成功</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ls -al ~/.ssh#查看是否已有ssh key</span><br><span class="line">ssh-keygen -t rsa -C &quot;youremail@example.com&quot;#生成新的key</span><br><span class="line">cat ~/.ssh/id_rsa.pub#查看公钥并上传到github</span><br><span class="line">ssh -T git@github.com #测试是否添加成功(输入yes)</span><br><span class="line">git config --global user.name &quot;uesrname&quot;#配置用户名</span><br><span class="line">git config --global user.email &quot;youremail@example.com&quot;#配置邮箱</span><br></pre></td></tr></table></figure><p>前置条件2: 安装git和Node.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install git#安装git</span><br><span class="line">sudo apt install Node.js#安装Node.js</span><br><span class="line">sudo apt install npm#安装npm</span><br><span class="line">npm install -g hexo-cli#安装hexo</span><br></pre></td></tr></table></figure><p>Node.js版本6.0以上,确认Node.js版本在v4时会出现报错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Node.js安装方式:</span><br><span class="line">https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-ubuntu-16-04</span><br></pre></td></tr></table></figure><p>创建文件夹hexo,并做相关配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/hexo# 创建文件夹</span><br><span class="line">cd ~/hexo</span><br><span class="line">hexo init# 初始化</span><br><span class="line">hexo install# 安装依赖包(非必须)</span><br><span class="line">npm install hexo-deployer-git --save# 安装git插件</span><br></pre></td></tr></table></figure><p>修改hexo中的_config.yml文件deploy部分,注意”deploy:”后面有一个空格</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim _config.yml#编辑配置文件</span><br><span class="line">deploy: </span><br><span class="line">  type: git</span><br><span class="line">  repository: git@github.com:username/username.github.io.git#这里要用上文中提到的clone地址</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure><p>尝试发布一篇新的博客</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd ~/hexo</span><br><span class="line">hexo new &quot;title&quot;#创建新文章,会在~/hexo/source/_posts目录下生成title.md文件</span><br><span class="line">vim source/_post/tile.md#编辑该文件内容即可</span><br><span class="line">hexo g -d#生成并发布</span><br><span class="line">hexo clean#清除当前缓存,尽量每次发布后执行一次</span><br></pre></td></tr></table></figure><p>以上github + hexo搭建个人博客相关配置就完成了,我们可以去username.github.io查看了</p><p>也可以进入到hexo目录下使用以下命令进行本地预览</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo s</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 个人实践 </tag>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
